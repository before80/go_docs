<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.111.3">
<link rel="canonical" type="text/html" href="http://ngd.cn/docs/UsingAndUnderstandingGo/AccessingDatabases/">
<link rel="alternate" type="application/rss&#43;xml" href="http://ngd.cn/docs/UsingAndUnderstandingGo/AccessingDatabases/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>访问数据库 | go文档集</title>
<meta name="description" content="The most popular HTML, CSS, and JS library in the world.">
<meta property="og:title" content="访问数据库" />
<meta property="og:description" content="The most popular HTML, CSS, and JS library in the world." />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://ngd.cn/docs/UsingAndUnderstandingGo/AccessingDatabases/" />
<meta itemprop="name" content="访问数据库">
<meta itemprop="description" content="The most popular HTML, CSS, and JS library in the world."><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="访问数据库"/>
<meta name="twitter:description" content="The most popular HTML, CSS, and JS library in the world."/>




<link rel="preload" href="/scss/main.min.bb1f3a37154c4661ae02d3cb1a733edd8005db70f626370ca004c689a63ab7d4.css" as="style">
<link href="/scss/main.min.bb1f3a37154c4661ae02d3cb1a733edd8005db70f626370ca004c689a63ab7d4.css" rel="stylesheet" integrity="">

<link href="/css/extra.css" rel="stylesheet">
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-00000000-0');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">go文档集</span></a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link active" href="/docs/"><span class="active">文档</span></a>
      </li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    <div class="td-search">
  <div class="td-search__icon"></div>
  <input type="search" class="td-search__input form-control td-search-input" placeholder="" aria-label="" autocomplete="off">
</div>

  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/docs/UsingAndUnderstandingGo/AccessingDatabases/"></a>.
</p>
</div>



<h1 class="title">访问数据库</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-86563934400c94be245ac338fd26a603">访问关系型数据库</a></li>


    
  
    
    
	
<li>2: <a href="#pg-42d595491e1585d79dd5b5bef1ea2b3e">打开一个数据库句柄</a></li>


    
  
    
    
	
<li>3: <a href="#pg-6f0765d11129073b820ce005805beee4">执行不返回数据的SQL语句</a></li>


    
  
    
    
	
<li>4: <a href="#pg-8dbd333e5db3daf03f3ae397f9564c2b">查询数据</a></li>


    
  
    
    
	
<li>5: <a href="#pg-c5858600d7babffd325d37bb0b207ba8">使用预处理语句</a></li>


    
  
    
    
	
<li>6: <a href="#pg-290927c232ccde52de6f12a80617f3a8">执行事务</a></li>


    
  
    
    
	
<li>7: <a href="#pg-4784cd31c145b2e3eaed935268e74931">取消正在进行的操作</a></li>


    
  
    
    
	
<li>8: <a href="#pg-b543af54c119472b0081204612c8645a">管理连接</a></li>


    
  
    
    
	
<li>9: <a href="#pg-96f2d73f83fdbd82143ebeae2e86894d">避免SQL注入风险</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-86563934400c94be245ac338fd26a603">1 - 访问关系型数据库</h1>
    
	<h1 id="accessing-relational-databases---访问关系型数据库">Accessing relational databases - 访问关系型数据库</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/" target="_blank" rel="noopener">https://go.dev/doc/database/</a></p>
</blockquote>
<p>​	使用 Go，您可以将各种数据库和数据访问方法纳入您的应用程序中。本节的主题描述了如何使用标准库的<a href="https://pkg.go.dev/database/sql" target="_blank" rel="noopener">database/sql</a>包来访问关系型数据库。</p>
<p>​	关于Go的数据访问的介绍性教程，请看 <a href="../../../GettingStarted/TutorialAccessingARelationalDatabase">Tutorial: Accessing a relational database</a>。</p>
<p>​	Go 也支持其他数据访问技术，包括用于更高级别的访问关系型数据库的 ORM 库，以及非关系型 NoSQL 数据存储。</p>
<ul>
<li><strong>对象-关系映射（ORM）库（Object-relational mapping (ORM) libraries）</strong>。虽然<code>database/sql</code> 包包括用于低级数据访问逻辑的函数，但您也可以使用 Go 来访问更高抽象级别的数据存储。关于Go的两个流行的对象-关系映射（ORM）库的更多信息，请参见<a href="https://gorm.io/index.html" target="_blank" rel="noopener">GORM</a>和<a href="https://entgo.io/" target="_blank" rel="noopener">ent</a> (<a href="https://pkg.go.dev/entgo.io/ent" target="_blank" rel="noopener">package reference</a>)。</li>
<li><strong>NoSQL 数据存储.</strong> Go 社区已经为大多数 NoSQL 数据存储开发了驱动程序，包括 <a href="https://docs.mongodb.com/drivers/go/" target="_blank" rel="noopener">MongoDB</a>和 <a href="https://docs.couchbase.com/go-sdk/current/hello-world/overview.html" target="_blank" rel="noopener">Couchbase</a>。您可以搜索<a href="https://pkg.go.dev/" target="_blank" rel="noopener">pkg.go.dev</a> 获取更多信息。</li>
</ul>
<h3 id="supported-database-management-systems-支持的数据库管理系统">Supported database management systems 支持的数据库管理系统</h3>
<p>​	Go 支持所有最常见的关系型数据库管理系统，包括 <code>MySQL</code>、<code>Oracle</code>、<code>Postgres</code>、<code>SQL Server</code>、<code>SQLite</code> 等。</p>
<p>​	你可以在 <a href="https://github.com/golang/go/wiki/SQLDrivers" target="_blank" rel="noopener">SQLDrivers</a>页面找到完整的驱动列表。</p>
<h3 id="functions-to-execute-queries-or-make-database-changes-执行查询或更改数据库的函数">Functions to execute queries or make database changes 执行查询或更改数据库的函数</h3>
<p>​	<code>database/sql</code>包包含专门为你正在执行的数据库操作设计的函数。例如，虽然你可以使用<code>Query</code>或<code>QueryRow</code>来执行查询，但<code>QueryRow</code>是为只需要一行的情况而设计的，省去了返回只包括一行记录的<code>sql.Rows</code>的开销。你可以使用<code>Exec</code>函数用SQL语句对数据库进行修改，如<code>INSERT</code>, <code>UPDATE</code>, 或<code>DELETE</code>。</p>
<p>​	更多内容，请参见以下内容：</p>
<ul>
<li><a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing SQL statements that don’t return data （执行不返回数据的SQL语句）</a></li>
<li><a href="../QueryingForData">Querying for data （查询数据）</a></li>
</ul>
<h3 id="transactions-事务">Transactions 事务</h3>
<p>​	通过<code>sql.Tx</code>，您可以编写代码来执行事务中的数据库操作。在一个事务中，多个操作可以一起执行，并以最后的提交（commit）来结束，以便在一个原子步骤中应用所有的更改，或者以回滚（rollback）来丢弃（discard ）它们。</p>
<p>​	关于事务的更多信息，请参见<a href="../ExecutingTransactions">Executing transactions （执行事务）</a>。</p>
<h3 id="query-cancellation-查询的取消">Query cancellation 查询的取消</h3>
<p>​	当你希望能够取消一个数据库操作时，你可以使用<code>context.Context</code>，例如，当客户端的连接关闭或操作运行的时间超过期望时。</p>
<p>​	对于任何数据库操作，你可以使用一个<code>database/sql</code>包函数，该函数将<code>Context</code>作为一个实参。使用<code>Context</code>，你可以为操作指定一个超时或最后期限。你还可以使用 <code>Context</code> 将取消请求通过应用程序传播到执行 SQL 语句的函数，确保在不再需要资源时释放资源。</p>
<p>​	更多信息请参见<a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations （取消正在进行的操作）</a>。</p>
<h3 id="managed-connection-pool-管理连接池">Managed connection pool 管理连接池</h3>
<p>​	当你使用<code>sql.DB</code>数据库句柄时，你正在与一个内置的连接池连接，该连接池根据你代码的需要创建和处置连接。通过<code>sql.DB</code>的句柄是用Go进行数据库访问的最常见方式。更多信息请参见<a href="../OpeningADatabaseHandle">Opening a database handle （打开数据库句柄）</a> 。</p>
<p>​	<code>database/sql</code>包为你管理连接池。然而，对于更高级的需求，可以按照<a href="https://go.dev/doc/database/manage-connections#connection_pool_properties" target="_blank" rel="noopener">Setting connection pool properties （设置连接池属性）</a>中的说明设置连接池属性。</p>
<p>​	对于那些需要单一保留连接的操作，<code>database/sql</code>包提供了<a href="https://pkg.go.dev/database/sql#Conn" target="_blank" rel="noopener">sql.Conn</a>。当使用<code>sql.Tx</code>的事务是一个糟糕的选择时，<code>Conn</code>就特别有用。</p>
<p>​	例如，你的代码可能需要：</p>
<ul>
<li>通过<code>DDL</code>进行模式更改，包括包含其自身事务语义的逻辑。将<code>sql</code>包的事务函数与SQL事务语句混合在一起是一种不好的做法，正如在<a href="https://go.dev/doc/database/execute-transactions" target="_blank" rel="noopener">Executing transactions （执行事务）</a> 中所描述的那样。</li>
<li>执行创建临时表的查询锁定操作。</li>
</ul>
<p>​	更多内容请参见 <a href="../ManagingConnections#using-dedicated-connections">Using dedicated connections （使用专用连接）</a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-42d595491e1585d79dd5b5bef1ea2b3e">2 - 打开一个数据库句柄</h1>
    
	<h1 id="opening-a-database-handle---打开一个数据库句柄">Opening a database handle - 打开一个数据库句柄</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/open-handle" target="_blank" rel="noopener">https://go.dev/doc/database/open-handle</a></p>
</blockquote>
<p>​	<a href="https://pkg.go.dev/database/sql" target="_blank" rel="noopener">database/sql</a>包通过减少你需要的管理连接来简化数据库访问。与许多数据访问API不同，使用<code>database/sql</code>，你不需要明确地打开一个连接，进行工作，然后关闭连接。相反，你的代码会打开一个代表连接池的数据库句柄，然后用这个句柄执行数据访问操作，仅在需要释放资源（比如那些被检索的行或预处理语句所持有的资源）时才调用<code>Close</code>方法。</p>
<p>​	换句话说，它是由<a href="https://pkg.go.dev/database/sql#DB" target="_blank" rel="noopener">sql.DB</a>表示的数据库句柄，代表你的代码来处理连接、打开和关闭连接。当你的代码使用句柄来执行数据库操作时，这些操作对数据库有并发的访问。更多信息请参见<a href="../ManagingConnections">Managing connections （管理连接）</a>。</p>
<p>注意：你也可以保留一个数据库连接。更多信息，请参见 <a href="../ManagingConnections#using-dedicated-connections">Using dedicated connections （使用专用连接）</a>。</p>
<p>​	除了<code>database/sql</code>包中的API之外，Go社区还为所有最常见的（以及许多不常见的）数据库管理系统（DBMSes）开发了驱动程序。</p>
<p>当打开一个数据库句柄时，请遵循以下高级步骤：</p>
<ol>
<li>
<p>找到一个驱动程序。</p>
<p>驱动程序会在你的Go代码和数据库之间转换（translates）请求和响应。更多信息，请参见 <a href="#locating-and-importing-a-database-driver">Locating and importing a database driver （找到并导入数据库驱动程序）</a>。</p>
</li>
<li>
<p>打开一个数据库句柄。</p>
<p>在你导入驱动程序后，你可以为特定的数据库打开一个句柄。更多信息，请参见<a href="#opening-a-database-handle">Opening a database handle （打开一个数据库句柄）</a>。</p>
</li>
<li>
<p>确认连接。</p>
<p>一旦你打开了一个数据库句柄，你的代码就可以检查是否有连接可用。更多信息，请参见<a href="#confirming-a-connection">Confirming a connection （确认连接）</a>。</p>
</li>
</ol>
<p>​	你的代码通常不会明确地打开或关闭数据库连接——那是由数据库句柄完成的。<strong>然而，你的代码应该释放它沿途获得的资源</strong>，例如包含查询结果的<code>sql.Rows</code>。更多信息请参见<a href="#freeing-resources">Freeing resources（释放资源）</a>。</p>
<h3 id="locating-and-importing-a-database-driver-找到并导入数据库驱动程序">Locating and importing a database driver 找到并导入数据库驱动程序</h3>
<p>​	你需要一个支持你所使用的数据库管理系统的数据库驱动程序。要为你的数据库找到一个驱动，请看<a href="https://github.com/golang/go/wiki/SQLDrivers" target="_blank" rel="noopener">SQLDrivers</a>。</p>
<p>​	为了使你的代码能够使用该驱动程序，你可以像导入其他Go包一样导入它。下面是一个例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#98c379">&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	注意，如果你没有直接从驱动包中调用任何函数——比如它被<code>sql</code>包隐式使用——你需要使用空白导入，它在导入路径前加了一个下划线：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">_</span> <span style="color:#98c379">&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：作为一个最佳实践，请避免使用数据库驱动程序自己的API进行数据库操作。相反，使用`database/sql`包中的函数。这将有助于保持你的代码与DBMS的松耦合，使你在需要时更容易切换到不同的DBMS。
</code></pre>
<h3 id="opening-a-database-handle-打开一个数据库句柄">Opening a database handle 打开一个数据库句柄</h3>
<p>​	<code>sql.DB</code>数据库句柄提供了从数据库读取和写入数据库的能力，无论是单独的还是在一个事务中。</p>
<p>​	你可以通过调用<code>sql.Open</code>（它接收一个连接字符串）或者<code>sql.OpenDB</code>（它接收一个<code>driver.Connector</code>）来获得一个数据库句柄。两者都返回一个指向<a href="https://pkg.go.dev/database/sql#DB" target="_blank" rel="noopener">sql.DB</a>的指针。</p>
<p>注意：请确保你的数据库凭证不在你的Go源代码中。更多信息请参见<a href="#storing-database-credentials">Storing database credentials （存储数据库凭证）</a> 。</p>
<h4 id="opening-with-a-connection-string-用连接字符串打开">Opening with a connection string 用连接字符串打开</h4>
<p>​	当你想使用连接字符串进行连接时，请使用<a href="https://pkg.go.dev/database/sql#Open" target="_blank" rel="noopener">sql.Open</a>函数。字符串的格式将根据你使用的驱动程序而有所不同。</p>
<p>下面是一个关于MySQL的例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">db</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;mysql&#34;</span>, <span style="color:#98c379">&#34;username:password@tcp(127.0.0.1:3306)/jazzrecords&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	然而，你可能会发现，以更结构化的方式捕获连接属性会使你的代码更具可读性。这些细节会因驱动而异。</p>
<p>​	例如，你可以把前面的例子换成下面的例子，它使用MySQL驱动的<a href="https://pkg.go.dev/github.com/go-sql-driver/mysql#Config" target="_blank" rel="noopener">Config</a>来指定属性，并使用<a href="https://pkg.go.dev/github.com/go-sql-driver/mysql#Config.FormatDSN" target="_blank" rel="noopener">FormatDSN</a>方法来构建一个连接字符串。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Specify connection properties.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">cfg</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">mysql</span>.<span style="color:#e06c75">Config</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">User</span>:   <span style="color:#e06c75">username</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Passwd</span>: <span style="color:#e06c75">password</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Net</span>:    <span style="color:#98c379">&#34;tcp&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Addr</span>:   <span style="color:#98c379">&#34;127.0.0.1:3306&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DBName</span>: <span style="color:#98c379">&#34;jazzrecords&#34;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Get a database handle.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">db</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;mysql&#34;</span>, <span style="color:#e06c75">cfg</span>.<span style="color:#61afef;font-weight:bold">FormatDSN</span>())
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="opening-with-a-connector-用一个连接器打开">Opening with a Connector 用一个连接器打开</h4>
<p>​	当你想利用连接字符串中没有的特定驱动程序的连接特性时，请使用<a href="https://pkg.go.dev/database/sql#OpenDB" target="_blank" rel="noopener">sql.OpenDB</a>函数。每个驱动都支持自己的连接属性集，通常提供了定制特定于DBMS的连接请求的方式。</p>
<p>​	将前面的<code>sql.Open</code>例子改成使用<code>sql.OpenDB</code>，你可以用下面的代码创建一个句柄：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Specify connection properties.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">cfg</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">mysql</span>.<span style="color:#e06c75">Config</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">User</span>:   <span style="color:#e06c75">username</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Passwd</span>: <span style="color:#e06c75">password</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Net</span>:    <span style="color:#98c379">&#34;tcp&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Addr</span>:   <span style="color:#98c379">&#34;127.0.0.1:3306&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DBName</span>: <span style="color:#98c379">&#34;jazzrecords&#34;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Get a driver-specific connector.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">connector</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">mysql</span>.<span style="color:#61afef;font-weight:bold">NewConnector</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">cfg</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Get a database handle.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">db</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">OpenDB</span>(<span style="color:#e06c75">connector</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="handling-errors-处理错误">Handling errors 处理错误</h4>
<p>​	你的代码应该检查是否在尝试创建句柄时出错，比如用<code>sql.Open</code>。这不会是一个连接错误。相反，如果<code>sql.Open</code>无法初始化句柄，你会得到一个错误。这可能发生，例如，如果它无法解析你指定的<code>DSN</code>。</p>
<h3 id="confirming-a-connection-确认一个连接">Confirming a connection 确认一个连接</h3>
<p>​	当你打开一个数据库句柄时，<code>sql</code>包可能不会立即自己创建一个新的数据库连接。相反，它可能会在你的代码需要它时创建连接。如果你不会马上使用数据库，并且想确认连接可以被建立，可以调用<a href="https://pkg.go.dev/database/sql#DB.Ping" target="_blank" rel="noopener">Ping</a>或<a href="https://pkg.go.dev/database/sql#DB.PingContext" target="_blank" rel="noopener">PingContext</a>。</p>
<p>下面的例子中的代码对数据库进行ping，以确认连接。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">db</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;mysql&#34;</span>, <span style="color:#e06c75">connString</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Confirm a successful connection.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Ping</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="storing-database-credentials-存储数据库凭证">Storing database credentials 存储数据库凭证</h3>
<p>​	避免在你的Go源代码中存储数据库凭证（credentials ），这可能会将你的数据库内容暴露给其他人。相反，要想办法将其存储在代码之外的位置，但对代码是可用的。例如，考虑一个保密应用程序，该应用程序存储凭据并提供一个 API，您的代码可以使用该 API 检索凭据，以便对 DBMS 进行身份验证。</p>
<p>​	一种流行的方法是在程序启动前将秘密存储在环境中，可能是从秘密管理器中加载，然后你的 Go 程序可以使用 <a href="https://pkg.go.dev/os#Getenv" target="_blank" rel="noopener">os.Getenv</a> 读取这些秘密：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">username</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;DB_USER&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">password</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;DB_PASS&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这种方法还允许你为本地测试自己设置环境变量。</p>
<h3 id="freeing-resources-释放资源">Freeing resources 释放资源</h3>
<p>​	虽然您没有显式地管理或关闭<code>database/sql</code>包提供连接，但你的代码应该在不再需要时释放它所获得的资源。这些可能包括由表示从查询返回的数据的<code>sql.Rows</code>或代表预处理语句的<code>sql.Stmt</code>持有的资源。</p>
<p>​	通常，你通过推迟对<code>Close</code>函数的调用来关闭资源，以便在外层函数退出之前释放资源。</p>
<p>​	在下面的例子中，代码延迟<code>Close</code>，以释放由<a href="https://pkg.go.dev/database/sql#Rows" target="_blank" rel="noopener">sql.Rows</a>持有的资源。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * FROM album WHERE artist = ?&#34;</span>, <span style="color:#e06c75">artist</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop through returned rows.
</span></span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6f0765d11129073b820ce005805beee4">3 - 执行不返回数据的SQL语句</h1>
    
	<h1 id="executing-sql-statements-that-dont-return-data---执行不返回数据的sql语句">Executing SQL statements that don&rsquo;t return data - 执行不返回数据的SQL语句</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/change-data" target="_blank" rel="noopener">https://go.dev/doc/database/change-data</a></p>
</blockquote>
<p>​	当你执行不返回数据的数据库操作时，请使用<code>database/sql</code>包的<code>Exec</code>或<code>ExecContext</code>方法。以这种方式执行的SQL语句包括<code>INSERT</code>, <code>DELETE</code>, 和<code>UPDATE</code>。</p>
<p>​	当你的查询可能返回行时，请改为使用<code>Query</code>或<code>QueryContext</code>方法。更多信息请参见 <a href="../QueryingForData">Querying a database （查询数据库）</a>。</p>
<p>​	<code>ExecContext</code>方法的工作原理与<code>Exec</code>方法相同，但有一个额外的<code>context.Context</code>参数，如 <a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations （取消正在进行的操作）</a> 中所述。</p>
<p>​	下面的例子中的代码使用<a href="https://pkg.go.dev/database/sql#DB.Exec" target="_blank" rel="noopener">DB.Exec</a>来执行一条语句，将一个新的记录专辑添加到一个<code>album</code>表中。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">AddAlbum</span>(<span style="color:#e06c75">alb</span> <span style="color:#e06c75">Album</span>) (<span style="color:#e5c07b">int64</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">result</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Exec</span>(<span style="color:#98c379">&#34;INSERT INTO album (title, artist) VALUES (?, ?)&#34;</span>, <span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Title</span>, <span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Artist</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;AddAlbum: %v&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Get the new album&#39;s generated ID for the client.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">id</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">result</span>.<span style="color:#61afef;font-weight:bold">LastInsertId</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;AddAlbum: %v&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Return the new album&#39;s ID.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">id</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>DB.Exec</code>返回值：一个<a href="https://pkg.go.dev/database/sql#Result" target="_blank" rel="noopener">sql.Result</a>和一个错误。当错误为<code>nil</code>时，你可以使用<code>Result</code>来获得最后插入的项目的ID（如在例子中）或检索受操作影响的行数。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：预处理语句中的参数占位符根据你所使用的`DBMS`和驱动而不同。例如，`Postgres`的[pq driver](https://pkg.go.dev/github.com/lib/pq)需要一个类似于`$1`的占位符，而不是`?`.
</code></pre>
<p>​	如果你的代码将重复执行相同的SQL语句，考虑使用一个<code>sql.Stmt</code>来从SQL语句中创建一个可重复使用的预处理语句。更多信息请参见 <a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：不要使用字符串格式化函数，如`fmt.Sprintf`来组合一个SQL语句！ 你可能会引入一个[SQL注入的风险](https://go.dev/doc/database/sql-injection)。更多信息，请参见[Avoiding SQL injection risk（避免SQL注入风险）](../AvoidingSQLInjectionRisk)。
</code></pre>
<h4 id="functions-for-executing-sql-statements-that-dont-return-rows-用于执行不返回行的sql语句的函数">Functions for executing SQL statements that don’t return rows 用于执行不返回行的SQL语句的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description 描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.Exec</code> <code>DB.ExecContext</code></td>
<td>单独执行一条 SQL 语句。</td>
</tr>
<tr>
<td><code>Tx.Exec</code> <code>Tx.ExecContext</code></td>
<td>在较大的事务中执行 SQL 语句。有关详细信息，请参阅请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Stmt.Exec</code> <code>Stmt.ExecContext</code></td>
<td>执行一个预处理SQL语句。更多信息，请参见 <a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</td>
</tr>
<tr>
<td><code>Conn.ExecContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8dbd333e5db3daf03f3ae397f9564c2b">4 - 查询数据</h1>
    
	<h1 id="querying-for-data---查询数据">Querying for data - 查询数据</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/querying" target="_blank" rel="noopener">https://go.dev/doc/database/querying</a></p>
</blockquote>
<p>​	当执行一个返回数据的SQL语句时，使用<code>database/sql</code>包中提供的<code>Query</code>方法之一。每个方法都会返回一个行（<code>Row</code>）或多个行（<code>Rows</code>），你可以使用<code>Scan</code>方法将其数据复制到变量。你会使用这些方法，例如，执行<code>SELECT</code>语句。</p>
<p>​	当执行一个不返回数据的语句时，你可以改用<code>Exec</code>或<code>ExecContext</code>方法。更多信息请参见 <a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing statements that don’t return data（执行不返回数据的语句）</a>。</p>
<p>​	<code>database/sql</code>包提供了两种执行结果查询的方法：</p>
<ul>
<li><strong>查询单行</strong>  —— <code>QueryRow</code> 最多只能从数据库中返回一个单行。更多信息请参见 <a href="#querying-for-a-single-row">Querying for a single row （查询单行）</a>。</li>
<li>查询多行 —— <code>Query</code> 将所有匹配的行作为一个<code>Rows</code>结构体（你的代码可以循环遍历）返回，。更多信息，请参见 <a href="#querying-for-multiple-rows">Querying for multiple rows 查询多行</a>。</li>
</ul>
<p>​	如果你的代码将重复执行相同的SQL语句，请考虑使用预处理语句。更多信息，请参见 <a href="../UsingPreparedStatements">Using prepared statements （使用预处理语句）</a> 。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：不要使用字符串格式化函数，如`fmt.Sprintf`来组合一个SQL语句！你可能会引入一个SQL注入的风险。更多信息，请参见避免[SQL注入风险](https://go.dev/doc/database/sql-injection)。
</code></pre>
<h3 id="querying-for-a-single-row-查询单行">Querying for a single row 查询单行</h3>
<p>​	<code>QueryRow</code>最多只能检索一条数据库记录，例如当你想通过一个唯一的ID来查询数据。如果查询返回多条记录，<code>Scan</code>方法会丢弃除第一条以外的所有记录。</p>
<p>​	<code>QueryRowContext</code>的工作方式与<code>QueryRow</code>类似，但有一个<code>context.Context</code>实参。更多信息请参见 <a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations（取消正在进行的操作）</a>。</p>
<p>​	下面的例子使用一个查询来找出是否有足够的库存来支持购买。如果有足够的库存，该SQL语句返回<code>true</code>，如果没有则返回<code>false</code>。<a href="https://pkg.go.dev/database/sql#Row.Scan" target="_blank" rel="noopener">Row.Scan</a>通过一个指针将布尔型的返回值复制到<code>enough</code>变量中。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">canPurchase</span>(<span style="color:#e06c75">id</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">quantity</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e5c07b">bool</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">enough</span> <span style="color:#e5c07b">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Query for a value based on a single row.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">QueryRow</span>(<span style="color:#98c379">&#34;SELECT (quantity &gt;= ?) from album where id = ?&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">id</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">enough</span>); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">ErrNoRows</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;canPurchase %d: unknown album&#34;</span>, <span style="color:#e06c75">id</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;canPurchase %d: %v&#34;</span>, <span style="color:#e06c75">id</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">enough</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意：准备预处理语句中的参数占位符根据你所使用的<code>DBMS</code>和驱动而不同。例如，<code>Postgres</code>的<a href="https://pkg.go.dev/github.com/lib/pq" target="_blank" rel="noopener">pq driver</a>需要一个类似于<code>$1</code>的占位符，而不是<code>?</code>。</p>
<h4 id="handling-errors-处理错误">Handling errors 处理错误</h4>
<p>​	<code>QueryRow</code>本身不返回错误。相反，<code>Scan</code>报告来自组合查询和扫描的任何错误。当查询没有找到记录时，它返回<a href="https://pkg.go.dev/database/sql#ErrNoRows" target="_blank" rel="noopener">sql.ErrNoRows</a>。</p>
<h4 id="functions-for-returning-a-single-row-用于返回单行的函数">Functions for returning a single row 用于返回单行的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description <strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.QueryRow</code> <code>DB.QueryRowContext</code></td>
<td>单独运行一个单行查询。</td>
</tr>
<tr>
<td><code>Tx.QueryRow</code> <code>Tx.QueryRowContext</code></td>
<td>在较大的事务中运行一个单行查询。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Stmt.QueryRow</code> <code>Stmt.QueryRowContext</code></td>
<td>使用预处理语句运行一个单行查询。更多信息，请参见 <a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</td>
</tr>
<tr>
<td><code>Conn.QueryRowContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>
<h3 id="querying-for-multiple-rows-查询多行">Querying for multiple rows 查询多行</h3>
<p>​	你可以使用<code>Query</code>或<code>QueryContext</code>查询多条记录，它们返回一个代表查询结果的<code>Rows</code>。你的代码使用<a href="https://pkg.go.dev/database/sql#Rows.Next" target="_blank" rel="noopener">Rows.Next</a>对返回的行进行迭代。每次迭代都会调用<code>Scan</code>来将列值复制到变量中。</p>
<p>​	<code>QueryContext</code>的工作方式与<code>Query</code>类似，但有一个<code>context.Context</code>实参。更多信息请参见 <a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations （取消正在进行的操作）</a>。</p>
<p>​	下面的例子执行了一个查询，返回指定艺术家的专辑。这些专辑被返回到一个<code>sql.Rows</code>中。该代码使用<a href="https://pkg.go.dev/database/sql#Rows.Scan" target="_blank" rel="noopener">Rows.Scan</a>将列值复制到由指针表示的变量中。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">albumsByArtist</span>(<span style="color:#e06c75">artist</span> <span style="color:#e5c07b">string</span>) ([]<span style="color:#e06c75">Album</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * FROM album WHERE artist = ?&#34;</span>, <span style="color:#e06c75">artist</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">nil</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// An album slice to hold data from returned rows.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">albums</span> []<span style="color:#e06c75">Album</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Loop through rows, using Scan to assign column data to struct fields.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Next</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">var</span> <span style="color:#e06c75">alb</span> <span style="color:#e06c75">Album</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">ID</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Title</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Artist</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Price</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Quantity</span>); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">albums</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">albums</span> = <span style="color:#e5c07b">append</span>(<span style="color:#e06c75">albums</span>, <span style="color:#e06c75">album</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> = <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Err</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">albums</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">albums</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意对[rows.Close](https://pkg.go.dev/database/sql#Rows.Close)的延迟调用。无论函数如何返回，这都会释放rows所持有的任何资源。循环处理所有的行也会隐式地关闭它，但最好使用`defer`来确保无论如何都会关闭`rows`。
</code></pre>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：预处理语句中的参数占位符根据你所使用的`DBMS`和驱动而不同。例如，`Postgres`的[pq driver](https://pkg.go.dev/github.com/lib/pq)需要一个类似于`$1`的占位符，而不是`?`。
</code></pre>
<h4 id="handling-errors-处理错误-1">Handling errors 处理错误</h4>
<p>Be sure to check for an error from <code>sql.Rows</code> after looping over query results. If the query failed, this is how your code finds out.</p>
<p>​	在循环查询结果后，一定要从<code>sql.Rows</code>中检查是否有错误。如果查询失败了，代码就是这样查找的。</p>
<h4 id="functions-for-returning-multiple-rows-返回多行记录的函数">Functions for returning multiple rows 返回多行记录的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description 描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.Query</code> <code>DB.QueryContext</code></td>
<td>单独运行一个查询。</td>
</tr>
<tr>
<td><code>Tx.Query</code> <code>Tx.QueryContext</code></td>
<td>在较大的事务中运行一个查询。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Stmt.Query</code> <code>Stmt.QueryContext</code></td>
<td>使用预处理语句运行一个查询。更多信息，请参见<a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</td>
</tr>
<tr>
<td><code>Conn.QueryContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>
<h3 id="handling-nullable-column-values-处理可为null的列值">Handling nullable column values 处理可为null的列值</h3>
<p>​	<code>database/sql</code>包提供了几种特殊的类型，当一个列的值可能为<code>null</code>时，你可以作为<code>Scan</code>函数的实参使用。每种类型都包括一个<code>Valid</code>字段，用于报告值是否为非<code>null</code>，如果是的话，还包括一个持有该值的字段。</p>
<p>​	下面的例子中的代码查询了一个客户名称。如果名字的值是<code>null</code>的，代码会替换另一个值在应用程序中使用。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">s</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">NullString</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">QueryRow</span>(<span style="color:#98c379">&#34;SELECT name FROM customer WHERE id = ?&#34;</span>, <span style="color:#e06c75">id</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">s</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Find customer name, using placeholder if not present.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">name</span> <span style="color:#56b6c2">:=</span> <span style="color:#98c379">&#34;Valued Customer&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">s</span>.<span style="color:#e06c75">Valid</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">name</span> = <span style="color:#e06c75">s</span>.<span style="color:#e06c75">String</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>sql</code>包参考资料中可以看到更多关于每种类型的信息：</p>
<ul>
<li><a href="https://pkg.go.dev/database/sql#NullBool" target="_blank" rel="noopener"><code>NullBool</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullFloat64" target="_blank" rel="noopener"><code>NullFloat64</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullInt32" target="_blank" rel="noopener"><code>NullInt32</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullInt64" target="_blank" rel="noopener"><code>NullInt64</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullString" target="_blank" rel="noopener"><code>NullString</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullTime" target="_blank" rel="noopener"><code>NullTime</code></a></li>
</ul>
<h3 id="getting-data-from-columns-从列中获取数据">Getting data from columns 从列中获取数据</h3>
<p>​	在循环查询返回的行时，您可以使用<code>Scan</code>将行的列值复制到Go值，如<a href="https://pkg.go.dev/database/sql#Rows.Scan" target="_blank" rel="noopener">Rows.Scan</a>参考中所述。</p>
<p>​	所有驱动程序都支持一组基本的数据转换，例如将SQL <code>INT</code>转换为Go <code>int</code>。一些驱动程序扩展了这一转换集；详情请参见各个驱动程序的文档。</p>
<p>​	正如你所期望的，<code>Scan</code>将从列类型转换为类似的Go类型。例如，<code>Scan</code>将从SQL <code>CHAR</code>、<code>VARCHAR</code>和<code>TEXT</code>转换为Go <code>string</code>。但是，<code>Scan</code>也会执行转换为另一种适合列值的Go类型。例如，如果列是一个总是包含数字的<code>VARCHAR</code>，你可以指定一个数值Go类型，比如<code>int</code>，来接收这个值，<code>Scan</code>将使用<code>strconv.Atoi</code>对其进行转换。</p>
<p>​	关于<code>Scan</code>函数进行转换的更多细节，请参见<a href="https://pkg.go.dev/database/sql#Rows.Scan" target="_blank" rel="noopener">Rows.Scan</a>参考。</p>
<h3 id="handling-multiple-result-sets-处理多个结果集">Handling multiple result sets 处理多个结果集</h3>
<p>​	当你的数据库操作可能返回多个结果集时，你可以通过使用<a href="https://pkg.go.dev/database/sql#Rows.NextResultSet" target="_blank" rel="noopener">Rows.NextResultSet</a>来检索这些结果。这可能很有用，例如，当你发送分别查询多个表的 SQL 时，为每个表返回一个结果集。</p>
<p>​	<code>Rows.NextResultSet</code>准备好下一个结果集，以便调用<code>Rows.Next</code>检索下一个结果集的第一条记录。它返回一个布尔值，表明是否存在下一个结果集。</p>
<p>​	下面的例子中的代码使用<code>DB.Query</code>来执行两个SQL语句。第一个结果集来自过程中的第一个查询，检索<code>album</code>表中的所有记录。下一个结果集是来自于第二个查询，从<code>song</code>表中检索记录。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * from album; SELECT * from song;&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop through the first result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Next</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Advance to next result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">NextResultSet</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop through the second result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Next</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle second set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Check for any error in either result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Err</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c5858600d7babffd325d37bb0b207ba8">5 - 使用预处理语句</h1>
    
	<h1 id="using-prepared-statements---使用预处理语句">Using prepared statements - 使用预处理语句</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/prepared-statements" target="_blank" rel="noopener">https://go.dev/doc/database/prepared-statements</a></p>
</blockquote>
<p>​	你可以为重复使用定义一个预处理语句。这可以避免每次代码执行数据库操作时<code>重新创建语句的开销</code>，从而帮助代码更快地运行。</p>
<p>注意：预处理语句中的参数占位符根据你所使用的<code>DBMS</code>和驱动而不同。例如，<code>Postgres</code>的<a href="https://pkg.go.dev/github.com/lib/pq" target="_blank" rel="noopener">pq driver</a>需要一个像<code>$1</code>这样的占位符，而不是<code>?</code>。</p>
<h3 id="what-is-a-prepared-statement-什么是预处理语句">What is a prepared statement? 什么是预处理语句？</h3>
<p>​	预处理语句是由<code>DBMS</code>解析并保存的SQL，通常包含占位符，但没有实际参数值。之后，可以用一组参数值来执行该语句。</p>
<h3 id="how-you-use-prepared-statements-你如何使用预处理语句">How you use prepared statements 你如何使用预处理语句</h3>
<p>​	当你希望重复执行相同的SQL时，你可以使用一个<code>sql.Stmt</code>来提前准备SQL语句，然后根据需要执行它。</p>
<p>​	下面的例子创建了一个预处理语句，从数据库中选择一个特定的相册。<a href="https://pkg.go.dev/database/sql#DB.Prepare" target="_blank" rel="noopener">DB.Prepare</a>返回一个<code>sql.Stmt</code>，代表一个给定的SQL文本的预处理语句。你可以将SQL语句的参数传递给<code>Stmt.Exec</code>、<code>Stmt.QueryRow</code>或<code>Stmt.Query</code>来运行该语句。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// AlbumByID retrieves the specified album.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">AlbumByID</span>(<span style="color:#e06c75">id</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e06c75">Album</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Define a prepared statement. You&#39;d typically define the statement
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// elsewhere and save it for use in functions such as this one.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">stmt</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Prepare</span>(<span style="color:#98c379">&#34;SELECT * FROM album WHERE id = ?&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">album</span> <span style="color:#e06c75">Album</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Execute the prepared statement, passing in an id value for the
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// parameter whose placeholder is ?
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">stmt</span>.<span style="color:#61afef;font-weight:bold">QueryRow</span>(<span style="color:#e06c75">id</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">ID</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Title</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Artist</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Price</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Quantity</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">ErrNoRows</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// Handle the case of no rows returned.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">album</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">album</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="prepared-statement-behavior-预处理语句的行为">Prepared statement behavior 预处理语句的行为</h3>
<p>​	一个准备好的<a href="https://pkg.go.dev/database/sql#Stmt" target="_blank" rel="noopener">sql.Stmt</a>提供了常用的<code>Exec</code>、<code>QueryRow</code>和<code>Query</code>方法来调用其语句。关于使用这些方法的更多信息，请参阅<a href="../QueryingForData">Querying for data （查询数据）</a> 和 <a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing SQL statements that don’t return data（执行不返回数据的SQL语句）</a>。</p>
<p>​	然而，由于一个<code>sql.Stmt</code>已经代表了一个预设的SQL语句，它的<code>Exec</code>、<code>QueryRow</code>和<code>Query</code>方法只接受与占位符对应的SQL参数值，而忽略了SQL文本。</p>
<p>​	你可以用不同的方式定义一个新的<code>sql.Stmt</code>，这取决于你将如何使用它。</p>
<ul>
<li><code>DB.Prepare</code>和<code>DB.PrepareContext</code>创建了一个预处理语句，该语句可以在事务外单独执行，就像<code>DB.Exec</code>和<code>DB.Query</code>一样。</li>
<li><code>Tx.Prepare</code>、<code>Tx.PrepareContext</code>、<code>Tx.Stmt</code>和<code>Tx.StmtContext</code>创建一个预处理语句，以便在一个特定的事务中使用。<code>Prepare</code>和<code>PrepareContext</code>使用SQL文本来定义语句。<code>Stmt</code>和<code>StmtContext</code>使用<code>DB.Prepare</code>或<code>DB.PrepareContext</code>的结果。也就是说，它们将一个非事务用的<code>sql.Stmt</code>转换为这个事务用的<code>sql.Stmt</code>。</li>
<li><code>Conn.PrepareContext</code>从一个代表保留连接的<code>sql.Conn</code>创建一个预处理语句。</li>
</ul>
<p>​	一定要记住，在代码使用语句完成时，调用<code>stmt.Close</code>。这将释放任何可能与之相关的数据库资源（如底层连接）。对于只是一个函数中的局部变量的语句，<code>defer stmt.Close()</code>就足够了。</p>
<h4 id="functions-for-creating-a-prepared-statement-创建预处理语句的函数">Functions for creating a prepared statement 创建预处理语句的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description 描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.Prepare</code> <code>DB.PrepareContext</code></td>
<td>准备独立执行的语句，或者使用 <code>Tx.Stmt</code> 将其转换为事务内准备的语句。</td>
</tr>
<tr>
<td><code>Tx.Prepare</code> <code>Tx.PrepareContext</code> <code>Tx.Stmt</code> <code>Tx.StmtContext</code></td>
<td>准备一个在特定事务中使用的语句。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Conn.PrepareContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-290927c232ccde52de6f12a80617f3a8">6 - 执行事务</h1>
    
	<h1 id="executing-transactions---执行事务">Executing transactions - 执行事务</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/execute-transactions" target="_blank" rel="noopener">https://go.dev/doc/database/execute-transactions</a></p>
</blockquote>
<p>​	你可以使用表示事务的<a href="https://pkg.go.dev/database/sql#Tx" target="_blank" rel="noopener">sql.Tx</a>来执行数据库事务。除了表示特定于事务语义的<code>Commit</code>和<code>Rollback</code>方法之外，<code>sql.Tx</code>还有所有用来执行普通数据库操作的方法。要获取<code>sql.Tx</code>，可以调用<code>DB.Begin</code>或<code>DB.BeginTx</code>。</p>
<p>​	一个<a href="https://en.wikipedia.org/wiki/Database_transaction" target="_blank" rel="noopener">数据库事务</a>将多个操作作为更大目标的一部分进行分组。所有的操作都必须成功，或者都不能成功，在这两种情况下都要保持数据的完整性。通常，一个事务的工作流程包括：</p>
<ol>
<li>开始事务。</li>
<li>执行一系列的数据库操作。</li>
<li>如果没有发生错误，提交事务以进行数据库更改。</li>
<li>如果发生错误，回滚事务使数据库保持不变。</li>
</ol>
<p>​	<code>sql</code>包提供了开始和结束事务的方法，以及执行中间的数据库操作的方法。这些方法与上述工作流程中的四个步骤相对应。</p>
<ul>
<li>
<p>开始一个事务</p>
<p><a href="https://pkg.go.dev/database/sql#DB.Begin" target="_blank" rel="noopener">DB.Begin</a>或<a href="https://pkg.go.dev/database/sql#DB.BeginTx" target="_blank" rel="noopener">DB.BeginTx</a>开始一个新的数据库事务，返回一个代表它的<code>sql.Tx</code>。</p>
</li>
<li>
<p>执行数据库操作。</p>
<p>使用一个<code>sql.Tx</code>，你可以在一系列使用单一连接的操作中查询或更新数据库。为了支持这一点，<code>Tx</code>导出了以下方法：</p>
<ul>
<li>
<p><a href="https://pkg.go.dev/database/sql#Tx.Exec" target="_blank" rel="noopener">Exec</a> 和 <a href="https://pkg.go.dev/database/sql#Tx.ExecContext" target="_blank" rel="noopener">ExecContext</a> ，用于通过SQL语句（如<code>INSERT</code>、<code>UPDATE</code>和<code>DELETE</code>）进行数据库更改。</p>
<p>更多信息请参见<a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing statements that don’t return data（执行不返回数据的语句）</a>。</p>
</li>
<li>
<p><a href="https://pkg.go.dev/database/sql#Tx.Query" target="_blank" rel="noopener">Query</a>，<a href="https://pkg.go.dev/database/sql#Tx.QueryContext" target="_blank" rel="noopener">QueryContext</a>，<a href="https://pkg.go.dev/database/sql#Tx.QueryRow" target="_blank" rel="noopener">QueryRow</a> ，<a href="https://pkg.go.dev/database/sql#Tx.QueryRowContext" target="_blank" rel="noopener">QueryRowContext</a> 用于返回行的操作。</p>
<p>更多信息，请参见 <a href="../QueryingForData">Querying for data （查询数据）</a>。</p>
</li>
<li>
<p><a href="https://pkg.go.dev/database/sql#Tx.Prepare" target="_blank" rel="noopener">Prepare</a>，<a href="https://pkg.go.dev/database/sql#Tx.PrepareContext" target="_blank" rel="noopener">PrepareContext</a>，<a href="https://pkg.go.dev/database/sql#Tx.Stmt" target="_blank" rel="noopener">Stmt</a>，<a href="https://pkg.go.dev/database/sql#Tx.StmtContext" target="_blank" rel="noopener">StmtContext</a>用于预先定义预处理语句。</p>
<p>更多信息，请参见<a href="../UsingPreparedStatements">Using prepared statements （使用预处理语句）</a>。</p>
</li>
</ul>
</li>
<li>
<p>用以下方法之一结束事务：</p>
<ul>
<li>
<p>使用<a href="https://pkg.go.dev/database/sql#Tx.Commit" target="_blank" rel="noopener">Tx.Commit</a>提交事务。</p>
<p>如果<code>Commit</code>成功（返回<code>nil</code>错误），那么所有的查询结果都被确认为有效，所有执行的更新都作为一个单一的原子变化应用到数据库中。如果<code>Commit</code>失败，那么<code>Tx</code>上的所有<code>Query</code>和<code>Exec</code>的结果都应该被视为无效而丢弃。</p>
</li>
<li>
<p>使用<a href="https://pkg.go.dev/database/sql#Tx.Rollback" target="_blank" rel="noopener">Tx.Rollback</a>来回滚事务。</p>
<p>即使<code>Tx.Rollback</code>失败，该事务也不再有效，也不会被提交到数据库。</p>
</li>
</ul>
</li>
</ul>
<h3 id="best-practices-最佳实践">Best practices 最佳实践</h3>
<p>​	遵循下面的最佳实践，可以更好地了解事务有时需要的复杂语义和连接管理。</p>
<ul>
<li>使用本节中描述的API来管理事务。<strong>不要直接使用与事务相关的SQL语句</strong>，如<code>BEGIN</code>和<code>COMMIT</code>——这样做会使你的数据库处于不可预测的状态，尤其是在并发程序中。</li>
<li>当使用事务时，注意<strong>不要直接调用非事务的</strong><code>sql.DB</code>方法，因为这些方法会在事务之外执行，将会给你的代码提供一个不一致的数据库状态，甚至导致<strong>死锁</strong>。</li>
</ul>
<h3 id="example-例子">Example 例子</h3>
<p>​	下面的例子中的代码使用一个事务来创建新专辑的客户订单。在这一过程中，代码将：</p>
<ol>
<li>开始一个事务。</li>
<li>延迟该事务的回滚。如果事务成功，它将在函数退出前被提交，使延迟的回滚调用成为no-op。如果事务失败，它将不会被提交，这意味着回滚将在函数退出时被调用。</li>
<li>确认客户订购的专辑有足够的库存。</li>
<li>如果有足够的存货，更新存货数量，用订购的专辑数量来减少它。</li>
<li>创建一个新的订单，并为客户检索新订单的生成ID。</li>
<li>提交事务并返回ID。</li>
</ol>
<p>​	这个例子使用了<code>Tx</code>方法，这些方法需要一个<code>context.Context</code>实参。这使得函数的执行——包括数据库操作——在其运行时间过长或客户端连接关闭的情况下有可能被取消。更多信息请参见<a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations（取消正在进行的操作）</a>。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// CreateOrder creates an order for an album and returns the new order ID. =&gt; CreateOrder 为 album 创建一个订单，并返回新的订单 ID。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">CreateOrder</span>(<span style="color:#e06c75">ctx</span> <span style="color:#e06c75">context</span>.<span style="color:#e06c75">Context</span>, <span style="color:#e06c75">albumID</span>, <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">custID</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e06c75">orderID</span> <span style="color:#e5c07b">int64</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Create a helper function for preparing failure results.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">fail</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">func</span>(<span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) (<span style="color:#e5c07b">int64</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;CreateOrder: %v&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Get a Tx for making transaction requests.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">tx</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">BeginTx</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#e5c07b">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Defer a rollback in case anything fails.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">Rollback</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Confirm that album inventory is enough for the order. =&gt; 确认专辑有足够的库存。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">enough</span> <span style="color:#e5c07b">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> = <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">QueryRowContext</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#98c379">&#34;SELECT (quantity &gt;= ?) from album where id = ?&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">albumID</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">enough</span>); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">ErrNoRows</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;no such album&#34;</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> !<span style="color:#e06c75">enough</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;not enough inventory&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Update the album inventory to remove the quantity in the order.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">_</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">ExecContext</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#98c379">&#34;UPDATE album SET quantity = quantity - ? WHERE id = ?&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">albumID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Create a new row in the album_order table.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">result</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">ExecContext</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#98c379">&#34;INSERT INTO album_order (album_id, cust_id, quantity, date) VALUES (?, ?, ?, ?)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">albumID</span>, <span style="color:#e06c75">custID</span>, <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">time</span>.<span style="color:#61afef;font-weight:bold">Now</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Get the ID of the order item just created.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">orderID</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">result</span>.<span style="color:#61afef;font-weight:bold">LastInsertId</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Commit the transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> = <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">Commit</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Return the order ID.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">orderID</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4784cd31c145b2e3eaed935268e74931">7 - 取消正在进行的操作</h1>
    
	<h1 id="canceling-in-progress-operations---取消正在进行的操作">Canceling in-progress operations - 取消正在进行的操作</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/cancel-operations" target="_blank" rel="noopener">https://go.dev/doc/database/cancel-operations</a></p>
</blockquote>
<p>​	你可以通过使用Go <a href="https://pkg.go.dev/context#Context" target="_blank" rel="noopener">context.Context</a>来管理正在进行的操作。<code>Context</code>是一个标准的Go数据值，可以报告它所表示的整体操作是否已经被取消，是否不再需要。通过在应用程序中的函数调用和服务中传递<code>context.Context</code>，这些（函数调用和服务）可以提前停止工作，并在不再需要其处理时返回一个错误。关于<code>Context</code>的更多信息，请参阅 <a href="../../../GoBlog/2014/GoConcurrencyPatternsContext">Go并发模式：Context</a>。</p>
<p>例如，你可能想：</p>
<ul>
<li>结束长期运行的操作，包括需要太长时间才能完成的数据库操作。</li>
<li>传播来自其他地方的取消请求，例如当客户端关闭连接时。</li>
</ul>
<p>​	许多为Go开发者提供的API都包含接受<code>Context</code>实参的方法，这使得在整个应用程序中更容易使用<code>Context</code>。</p>
<h3 id="canceling-database-operations-after-a-timeout-在超时后取消数据库操作">Canceling database operations after a timeout 在超时后取消数据库操作</h3>
<p>​	你可以使用 <code>Context</code> 来设置一个超时或最后期限，超时后的操作将被取消。要派生一个带有超时或最后期限的<code>Context</code>，请调用<a href="https://pkg.go.dev/context#WithTimeout" target="_blank" rel="noopener">context.WithTimeout</a>或<a href="https://pkg.go.dev/context#WithDeadline" target="_blank" rel="noopener">context.WithDeadline</a>。</p>
<p>​	下面的超时例子中的代码派生了一个Context，并将其传递给<code>sql.DB</code> <a href="https://pkg.go.dev/database/sql#DB.QueryContext" target="_blank" rel="noopener">QueryContext</a>方法。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">QueryWithTimeout</span>(<span style="color:#e06c75">ctx</span> <span style="color:#e06c75">context</span>.<span style="color:#e06c75">Context</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Create a Context with a timeout.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">queryCtx</span>, <span style="color:#e06c75">cancel</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">context</span>.<span style="color:#61afef;font-weight:bold">WithTimeout</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#d19a66">5</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">time</span>.<span style="color:#e06c75">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#61afef;font-weight:bold">cancel</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Pass the timeout Context with a query.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">QueryContext</span>(<span style="color:#e06c75">queryCtx</span>, <span style="color:#98c379">&#34;SELECT * FROM album&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle returned rows.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	当一个上下文派生自一个外部上下文时，就像本例中<code>queryCtx</code>派生自<code>ctx</code>一样，如果外部上下文被取消，那么派生的上下文也会被自动取消。例如，在HTTP服务器中，<code>http.Request.Context</code>方法返回一个与请求相关的上下文。如果HTTP客户端断开连接或取消HTTP请求（在HTTP/2中可能），则该上下文就会被取消。将HTTP请求的上下文传递给上面的<code>QueryWithTimeout</code>会导致数据库查询提前停止，如果整个HTTP请求被取消或者查询时间超过5秒的话。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：当你创建一个有超时或截止日期的新`Context`时，（一定记得）始终推迟对`cancel`函数的调用。这将在外层函数退出时释放新`Context`所持有的资源。它也会取消`queryCtx`，但是当函数返回时，就不会再有任何东西使用 `queryCtx` 了。
</code></pre>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b543af54c119472b0081204612c8645a">8 - 管理连接</h1>
    
	<h1 id="managing-connections---管理连接">Managing connections - 管理连接</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/manage-connections" target="_blank" rel="noopener">https://go.dev/doc/database/manage-connections</a></p>
</blockquote>
<p>​	对于绝大多数程序，你不需要调整<code>sql.DB</code>连接池的默认值。但是对于一些高级程序，你可能需要优化连接池的参数或者显式地处理连接。本主题解释了如何做。</p>
<p>​	<a href="https://pkg.go.dev/database/sql#DB" target="_blank" rel="noopener">sql.DB</a>数据库句柄对于多个goroutine的并发使用是安全的（意味着该句柄是其他语言可能称之为 &ldquo;<code>线程安全（thread-safe）</code> &ldquo;的）。其他一些数据库访问库是基于一次只能用于一个操作的连接。为了弥合这一差距，每个<code>sql.DB</code>都管理着一个与底层数据库的活动连接池，根据你 Go 程序的并行性需要创建新连接池。</p>
<p>​	连接池适用于大多数数据访问需求。当你调用一个<code>sql.DB</code>的<code>Query</code>或<code>Exec</code>方法时，<code>sql.DB</code>实现从池中检索一个可用的连接，或者在需要时创建一个连接。当不再需要连接时，包会将其返回到池中。这支持了数据库访问的高度并行性。</p>
<h3 id="setting-connection-pool-properties-设置连接池属性">Setting connection pool properties 设置连接池属性</h3>
<p>​	你可以设置属性来指导<code>sql</code>包如何管理连接池。要获得关于这些属性的效果的统计信息，请使用<a href="https://pkg.go.dev/database/sql#DB.Stats" target="_blank" rel="noopener">DB.Stats</a>。</p>
<h4 id="setting-the-maximum-number-of-open-connections-设置开放连接的最大数量">Setting the maximum number of open connections 设置开放连接的最大数量</h4>
<p>​	<a href="https://pkg.go.dev/database/sql#DB.SetMaxOpenConns" target="_blank" rel="noopener">DB.SetMaxOpenConns</a>对开放连接的数量进行了限制。超过这个限制，新的数据库操作将等待一个现有的操作完成，这时<code>sql.DB</code>将创建另一个连接。默认情况下，当需要一个连接的时候，<code>sql.DB</code>会在所有现有的连接都处于使用状态时创建一个新的连接。</p>
<p>​	请记住，设置限制使得数据库的使用类似于获取一个锁或信号，其结果是你的应用程序可能会在等待新的数据库连接时发生死锁（deadlock ）。</p>
<h4 id="setting-the-maximum-number-of-idle-connections-设置空闲连接的最大数量">Setting the maximum number of idle connections 设置空闲连接的最大数量</h4>
<p>​	<a href="https://pkg.go.dev/database/sql#DB.SetMaxIdleConns" target="_blank" rel="noopener">DB.SetMaxIdleConns</a>更改<code>sql.DB</code>维护的最大空闲连接数的限制。</p>
<p>​	当一个SQL操作在一个给定的数据库连接上完成后，它通常不会立即关闭：应用程序可能很快就会再次需要一个连接，保持开放的连接可以避免在下一个操作中重新连接到数据库。默认情况下，<code>sql.DB</code>在任何时候都保持两个空闲连接。提高这个限制可以避免在有大量并行性的程序中频繁的重新连接。</p>
<h4 id="setting-the-maximum-amount-a-time-a-connection-can-be-idle-设置一个连接可以空闲的最大时间量">Setting the maximum amount a time a connection can be idle 设置一个连接可以空闲的最大时间量</h4>
<p>​	<a href="https://pkg.go.dev/database/sql#DB.SetConnMaxIdleTime" target="_blank" rel="noopener">DB.SetConnMaxIdleTime</a>设置了一个连接在被关闭之前可以空闲的最大时间。这将导致<code>sql.DB</code>关闭那些空闲时间超过给定时间的连接。</p>
<p>​	默认情况下，当将空闲连接添加到连接池时，它将一直保持在那里，直到再次需要它为止。当使用<code>DB.SetMaxIdleConns</code>来增加并行活动爆发期间允许的空闲连接数时，也可以使用<code>DB.SetConnMaxIdleTime</code>安排在系统安静时释放这些连接。</p>
<h4 id="setting-the-maximum-lifetime-of-connections-设置连接的最大生存期">Setting the maximum lifetime of connections 设置连接的最大生存期</h4>
<p>​	使用<a href="https://pkg.go.dev/database/sql#DB.SetConnMaxLifetime" target="_blank" rel="noopener">DB.SetConnMaxLifetime</a>可以设置一个连接在被关闭之前可以保持开放的最大时间长度。</p>
<p>​	默认情况下，一个连接可以在任意长的时间内被使用和重复使用，但要遵守上述的限制。在一些系统中，比如那些使用负载平衡的数据库服务器的系统，确保应用程序在不重新连接的情况下不会使用某个特定的连接太久是很有帮助的。</p>
<h3 id="using-dedicated-connections-使用专用连接">Using dedicated connections 使用专用连接</h3>
<p>​	<code>database/sql</code>包包含一些函数，当数据库可能为在特定连接上执行的操作序列赋予隐式含义时，你可以使用这些函数。</p>
<p>​	最常见的例子是事务，它通常以<code>BEGIN</code>命令开始，以<code>COMMIT</code>或<code>ROLLBACK</code>命令结束，并在整个事务中包括这些命令之间的连接上发出的所有命令。对于这种使用情况，请使用<code>sql</code>包的事务支持。参见 在较大的事务中运行一个查询。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</p>
<p>​	对于其他必须在同一连接上执行一系列单独操作的使用情况，<code>sql</code>包提供了专用连接。<a href="https://pkg.go.dev/database/sql#DB.Conn" target="_blank" rel="noopener">DB.Conn</a>获得一个专用连接，即<a href="https://pkg.go.dev/database/sql#Conn" target="_blank" rel="noopener">sql.Conn</a>。<code>sql.Conn</code>有<code>BeginTx</code>、<code>ExecContext</code>、<code>PingContext</code>、<code>PrepareContext</code>、<code>QueryContext</code>和<code>QueryRowContext</code>等方法，这些方法的行为与DB上的同类方法类似，但只使用专用连接。当完成专用连接后，你的代码必须使用<code>Conn.Close</code>释放它。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96f2d73f83fdbd82143ebeae2e86894d">9 - 避免SQL注入风险</h1>
    
	<h1 id="avoiding-sql-injection-risk---避免sql注入风险">Avoiding SQL injection risk - 避免SQL注入风险</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/sql-injection" target="_blank" rel="noopener">https://go.dev/doc/database/sql-injection</a></p>
</blockquote>
<p>​	你可以通过提供SQL参数值作为<code>sql</code>包的函数实参来避免SQL注入风险。<code>sql</code>包中的许多函数为SQL语句和用于该语句的参数值提供了参数（其他函数为预处理语句和参数提供一个参数）。</p>
<p>​	下面的例子中的代码使用<code>?</code> 符号作为<code>id</code>参数的占位符，该参数是作为函数实参提供的：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Correct format for executing an SQL statement with parameters. =&gt; 执行带参数的SQL语句的正确格式。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * FROM user WHERE id = ?&#34;</span>, <span style="color:#e06c75">id</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	执行数据库操作的<code>sql</code>包函数从你提供的实参中创建预处理语句。在运行时，<code>sql</code>包将SQL语句变成一个预处理语句，并将其与独立的参数一起发送。</p>
<p>注意：参数占位符因你所使用的<code>DBMS</code>和驱动而不同。例如，<code>Postgres</code>的<a href="https://pkg.go.dev/github.com/lib/pq" target="_blank" rel="noopener">pq driver</a>接受<code>$1</code>这样的占位符形式，而不是 <code>?</code>。</p>
<p>​	你可能会想使用<code>fmt</code>包中的一个函数来把SQL语句组合成一个包含参数的字符串——比如这样：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// SECURITY RISK! =&gt; 安全风险!
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;SELECT * FROM user WHERE id = %s&#34;</span>, <span style="color:#e06c75">id</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<strong>这是不安全的!</strong> 当你这样做时，Go会组装整个SQL语句，用参数值替换<code>%s</code>格式的动词，然后再将完整的语句发送给DBMS。<strong>这会带来<a href="https://en.wikipedia.org/wiki/SQL_injection" target="_blank" rel="noopener">SQL注入</a>的风险</strong>，因为代码的调用者可能会发送一个意外的SQL代码片段作为<code>id</code>参数。该代码片段可能以不可预测的方式完成SQL语句，对你的应用程序造成危险。</p>
<p>​	例如，通过传递某个<code>%s</code>值，你可能会得到如下语句，这可能会返回你数据库中的所有用户记录：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#c678dd">SELECT</span> <span style="color:#56b6c2">*</span> <span style="color:#c678dd">FROM</span> <span style="color:#c678dd">user</span> <span style="color:#c678dd">WHERE</span> <span style="color:#e06c75">id</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">OR</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">1</span>;
</span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 The Docsy Authors </small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
  <script src="/js/main.min.9069af235eb4d4956fc4dc29e5ca46caef0cdcae593856be4e33c99075bc5ea2.js" integrity="sha256-kGmvI1601JVvxNwp5cpGyu8M3K5ZOFa&#43;TjPJkHW8XqI=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>
<script src='/js/deal-zero-width-space.js'></script>
  </body>
</html>
