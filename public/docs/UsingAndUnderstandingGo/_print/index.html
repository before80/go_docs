<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.111.3">
<link rel="canonical" type="text/html" href="http://ngd.cn/docs/UsingAndUnderstandingGo/">
<link rel="alternate" type="application/rss&#43;xml" href="http://ngd.cn/docs/UsingAndUnderstandingGo/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>使用和理解Go | go文档集</title>
<meta name="description" content="The most popular HTML, CSS, and JS library in the world.">
<meta property="og:title" content="使用和理解Go" />
<meta property="og:description" content="The most popular HTML, CSS, and JS library in the world." />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://ngd.cn/docs/UsingAndUnderstandingGo/" />
<meta itemprop="name" content="使用和理解Go">
<meta itemprop="description" content="The most popular HTML, CSS, and JS library in the world."><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用和理解Go"/>
<meta name="twitter:description" content="The most popular HTML, CSS, and JS library in the world."/>




<link rel="preload" href="/scss/main.min.bb1f3a37154c4661ae02d3cb1a733edd8005db70f626370ca004c689a63ab7d4.css" as="style">
<link href="/scss/main.min.bb1f3a37154c4661ae02d3cb1a733edd8005db70f626370ca004c689a63ab7d4.css" rel="stylesheet" integrity="">

<link href="/css/extra.css" rel="stylesheet">
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-00000000-0');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">go文档集</span></a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link active" href="/docs/"><span class="active">文档</span></a>
      </li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    <div class="td-search">
  <div class="td-search__icon"></div>
  <input type="search" class="td-search__input form-control td-search-input" placeholder="" aria-label="" autocomplete="off">
</div>

  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/docs/UsingAndUnderstandingGo/"></a>.
</p>
</div>



<h1 class="title">使用和理解Go</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-f8e3762ad284f8e10bce2ca5cfd0c983">Effective Go</a></li>


    
  
    
    
	
<li>2: <a href="#pg-f7e354cc6775c1e27d6c64bc392338ad">Go Fuzzing</a></li>


    
  
    
    
	
<li>3: <a href="#pg-64347b3c9393800b1cbd487bdfc4157f">Go垃圾收集器指南</a></li>


    
  
    
    
	
<li>4: <a href="#pg-e44c1396e12544d7a53fb01b7eb37b34">开发模块</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-388c645443b15a8b90e9ac0a6e58db20">开发和发布模块</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-28b79d99d0eba6421a1ed3af03cc3fcb">模块发布和版本管理的工作流程</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-3fcbbc0c292c78a6aa83a34dd6c946a2">管理模块来源</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-53061c1f4e0b7a54f74893a63869a0fc">开发主版本更新</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-17f6e72f0c269f4326bd16907a32d204">发布模块</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-dfd8c9c2a4a530522308f654362d2b44">模块的版本编号</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-d66f876e1b2cca6160e41de2ccdbcb68">管理依赖项</a></li>


    
  
    
    
	
<li>6: <a href="#pg-4448fa1622a7c7da135f42cb4c56e6db">编辑器插件和IDEs</a></li>


    
  
    
    
	
<li>7: <a href="#pg-94848c962fb3b9db41da11bf016f896d">访问数据库</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-86563934400c94be245ac338fd26a603">访问关系型数据库</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-42d595491e1585d79dd5b5bef1ea2b3e">打开一个数据库句柄</a></li>


    
  
    
    
	
<li>7.3: <a href="#pg-6f0765d11129073b820ce005805beee4">执行不返回数据的SQL语句</a></li>


    
  
    
    
	
<li>7.4: <a href="#pg-8dbd333e5db3daf03f3ae397f9564c2b">查询数据</a></li>


    
  
    
    
	
<li>7.5: <a href="#pg-c5858600d7babffd325d37bb0b207ba8">使用预处理语句</a></li>


    
  
    
    
	
<li>7.6: <a href="#pg-290927c232ccde52de6f12a80617f3a8">执行事务</a></li>


    
  
    
    
	
<li>7.7: <a href="#pg-4784cd31c145b2e3eaed935268e74931">取消正在进行的操作</a></li>


    
  
    
    
	
<li>7.8: <a href="#pg-b543af54c119472b0081204612c8645a">管理连接</a></li>


    
  
    
    
	
<li>7.9: <a href="#pg-96f2d73f83fdbd82143ebeae2e86894d">避免SQL注入风险</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-ae4ef6beba2d885dff11c2a3a8afa065">诊断</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f8e3762ad284f8e10bce2ca5cfd0c983">1 - Effective Go</h1>
    
	<h1 id="effective-go">Effective Go</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/effective_go" target="_blank" rel="noopener">https://go.dev/doc/effective_go</a></p>
</blockquote>
<h2 id="简介">简介</h2>
<p>​	Go是一种新的语言。虽然它借鉴了现有语言的思想，但它具有不寻常的特性，使得有效的Go程序在性质上不同于其亲属编写的程序。将C++或Java程序直接翻译成Go不太可能产生令人满意的结果——Java 程序是用 Java 而不是 Go 编写的。另一方面，从Go的角度来考虑问题可能会产生一个成功的但完全不同的程序。换句话说，要写好Go，了解它的属性和习语（idioms）是很重要的。了解 Go 编程的既定约定也很重要，例如命名、格式化、程序构造等等，这样你写的程序才能让其他 Go 程序员容易理解。</p>
<p>​	本文档给出了编写清晰、惯用的 Go 代码的技巧。它是对<a href="../../References/LanguageSpecification/Introduction">语言规范</a>、<a href="../../GoTour/UsingTheTour/welcome">Tour of Go</a>和<a href="../../GettingStarted/HowToWriteGoCode">How to Write Go Code</a>的补充，您应该首先阅读这些内容。</p>
<p>​	<code>2022年1月添加的注释</code>：<strong>本文档是为2009年发布的Go编写的，此后没有进行过重大更新</strong>。虽然它是了解如何使用语言本身的好指南，但由于语言的稳定性，它<strong>几乎没有提到库</strong>，也<strong>没有提到Go生态系统自编写以来的重大变化</strong>，如构建系统、测试、模块和多态性。<strong>目前还没有计划对其进行更新</strong>，因为已经发生了太多的事情，而且有一大批不断增加的文档、博客和书籍对现代Go的使用做了很好的描述。<strong>Effective Go仍然是有用的，但读者应该明白它远不是一个完整的指南</strong>。请参阅<a href="https://github.com/golang/go/issues/28782" target="_blank" rel="noopener">issue 28782</a>，了解相关情况。</p>
<h3 id="示例">示例</h3>
<p>​	<a href="https://go.dev/src/" target="_blank" rel="noopener">Go package sources</a>不仅是作为核心库，也是作为如何使用该语言的示例。此外，许多包都包含了可以工作的、独立的可执行的示例，你可以直接从 <a href="https://golang.org/" target="_blank" rel="noopener">golang.org</a>网站上运行，比如这个<a href="https://go.dev/pkg/strings/#example_Map" target="_blank" rel="noopener">示例</a>（如果需要，点击 &ldquo;Example&quot;一词来打开它）。如果你对如何处理一个问题或如何实现某些东西有疑问，库中的文档、代码和示例可以提供答案、想法和背景。</p>
<h2 id="格式化">格式化</h2>
<p>​	格式化问题是最有争议但最不重要的问题。人们可以适应不同的格式风格，但最好是不必这样做，如果每个人都遵循相同的风格，就会花费更少的时间来讨论此问题。问题是如何在没有长篇指导手册的情况下实现这个理想。</p>
<p>​	在Go中，我们采取了一种不同寻常的方法，让机器来处理大多数的格式化问题。<code>gofmt</code>程序（也可以用<code>go fmt</code>，它在包级别而不是源文件级别操作）读取Go程序，并以缩进和垂直对齐的标准风格发出（emit）源代码，保留并在必要时重新格式化注释。如果你想知道如何处理一些新的布局情况，请运行<code>gofmt</code>；如果答案似乎不对，请重新排列你的程序（或提交关于<code>gofmt</code>的bug），而不是绕过它。</p>
<p>​	举例来说，没有必要花时间排列结构体字段上的注释。<code>Gofmt</code>会帮你做到这一点。给出的声明：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">T</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">name</span> <span style="color:#e5c07b">string</span> <span style="color:#7f848e">// name of the object
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">value</span> <span style="color:#e5c07b">int</span> <span style="color:#7f848e">// its value
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>gofmt</code>会对齐列：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">T</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">name</span>    <span style="color:#e5c07b">string</span> <span style="color:#7f848e">// name of the object
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">value</span>   <span style="color:#e5c07b">int</span>    <span style="color:#7f848e">// its value
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	标准包中的所有Go代码都已经用<code>gofmt</code>格式化过了。</p>
<p>​	一些格式化的细节仍然保留。非常简单：</p>
<ul>
<li>
<p>缩进（Indentation）</p>
<p>我们使用制表符来缩进，<code>gofmt</code>默认会发出（emit）制表符。只有在必须时才使用空格。</p>
</li>
<li>
<p>行的长度（Line length）</p>
<p>Go没有行长限制。不要担心会超出打孔卡。如果一行太长，请换行并使用额外的制表符进行缩进。</p>
</li>
<li>
<p>圆括号（Parentheses）</p>
<p>Go需要的圆括号比C和Java少：控制结构（if、for、switch）的语法中没有圆括号。另外，运算符的优先级层次更短，更清晰，因此</p>
<pre tabindex="0"><code>x&lt;&lt;8 + y&lt;&lt;16
</code></pre><p>意思就像空格所示，不像其他语言那样。</p>
</li>
</ul>
<h2 id="注释">注释</h2>
<p>​	Go 提供了 C风格 <code>/* */</code> 块注释 和 C++风格 <code>//</code> 行注释。行注释是常规（norm）注释；块注释主要作为包注释出现，但在表达式内部或禁用大量代码时也很有用。</p>
<p>​	如果在顶级声明之前出现没有换行符的注释，则认为该注释记录了该声明本身。这些&quot;文档注释（doc comments） &ldquo;是给定 Go 包或命令的主要文档。有关文档注释的更多信息，请参见<a href="../../GoDocComments">Go Doc Comments</a>。</p>
<h2 id="命名">命名</h2>
<p>​	在 Go 中，命名与任何其他语言一样重要。它们甚至具有语义效果：名称在包外部的可见性取决于其第一个字符是否大写。因此，值得花费一点时间谈论 Go 程序中的命名约定。</p>
<h3 id="包名">包名</h3>
<p>​	当一个包被导入后，包名就成为内容的访问器。在</p>
<p>​	当导入一个包时，包名称变成该内容的访问器。在执行：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#98c379">&#34;bytes&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后，导入的包可以使用 <code>byte.Buffer</code>。如果每个使用该包的人都可以使用相同的名称来引用其内容，这将很有帮助，这意味着包名称应该很好：简短，简洁，意义明确。**按照惯例，包名称应为小写的单词名称；不需要使用下划线或混合大小写。**应该更注重简洁，因为使用您的包的每个人都将输入该名称。并且不必担心引用次序冲突。包名称仅是导入的默认名称；它不需要在所有源代码中唯一，并且在冲突的罕见情况下，导入包可以选择不同的名称在本地使用。无论如何，混淆是罕见的，因为导入中的文件名确定正在使用的包。</p>
<p>​	另一个约定是包名是其源代码目录的基本名称。<code>src/encoding/base64</code>中的包以 <code>&quot;encoding/base64&quot;</code>被导入，其包名是<code>base64</code>，而不是<code>encoding_base64</code>，也不是<code>encodingBase64</code>。</p>
<p>​	另一个惯例是包名称是其源目录的基本名称；在 <code>src/encoding/base64</code> 中导入的包被称为 <code>&quot;encoding/base64&quot;</code>，但名称是 <code>base64</code>，而不是 <code>encoding_base64</code> 或 <code>encodingBase64</code>。</p>
<p>​	包的导入方将使用该名称来引用其内容，因此，包中导出的名称可以利用这一点避免重复。 （不要使用 <code>import .</code> 表示法，它可以简化必须在它们正在测试的包之外运行的测试，但在其他情况下应避免使用。）例如，在 <code>bufio</code> 包中称为 <code>Reader</code> 的缓冲读取器类型，而不是 <code>BufReader</code>，因为用户将其视为 <code>bufio.Reader</code>，这是一个清晰、简洁的名称。此外，由于导入的实体始终带有其包名称，所以 <code>bufio.Reader</code> 不会与 <code>io.Reader</code> 冲突。同样，用于创建 <code>ring.Ring</code> 新实例的函数——这是 Go 中构造函数的定义——通常被称为 <code>NewRing</code>，但由于<code>Ring</code>是包中唯一导出的类型，并且包叫做<code>ring</code>，所以它只被称为<code>New</code>，客户端将其视为<code>ring.New</code>。使用包结构来帮助您选择良好的名称。</p>
<p>​	另一个简短的例子是<code>once.Do</code>；<code>once.Do(setup)</code>读起来很好，不需要写成<code>once.DoOrWaitUntilDone(setup)</code>。长名称并不能自动使事情更易读。一个有用的文档注释往往比一个额外的长名称更有价值。</p>
<h3 id="getters">Getters</h3>
<p>​	Go不提供getter和setter的自动支持。自己提供getter和setter没有问题，而且通常是适当的，但在getter的名称中添加<code>Get</code>既不符合惯例，也不必要。如果你有一个名为<code>owner</code>（小写，未公开）的字段，getter方法应该被称为<code>Owner</code>（大写，公开），而不是<code>GetOwner</code>。大写名称的使用为导出提供了钩子，以区分字段和方法。如果需要setter函数，它很可能被称为<code>SetOwner</code>。在实践中，这两个名称都很好读：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">owner</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">obj</span>.<span style="color:#61afef;font-weight:bold">Owner</span>()
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">owner</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">user</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">obj</span>.<span style="color:#61afef;font-weight:bold">SetOwner</span>(<span style="color:#e06c75">user</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="接口名称">接口名称</h3>
<p>​	按照惯例，单一方法的接口通过方法名称加上<code>-er</code>后缀或类似的修改来构建一个代理名词：<code>Reader</code>、<code>Writer</code>、<code>Formatter</code>、<code>CloseNotifier</code>等等。</p>
<p>​	有许多这样的名称，遵循它们和它们捕获的函数名称是很有成效的。<code>Read</code>、<code>Write</code>、<code>Close</code>、<code>Flush</code>、<code>String</code>等等具有规范的签名和含义。为避免混淆，除非具有相同的签名和含义，否则不要给您的方法赋予这些名称之一。相反，如果您的类型实现了一个与已知类型上的方法相同含义的方法，请使用相同的名称和签名，将您的字符串转换方法称为<code>String</code>而不是<code>ToString</code>。</p>
<h3 id="驼峰式命名">驼峰式命名</h3>
<p>​	最后，Go 的惯例是使用 <code>MixedCaps</code> 或 <code>mixedCaps</code> 而不是下划线来编写多单词名称。</p>
<h2 id="分号">分号</h2>
<p>​	与 C 一样，Go 的正式语法使用分号来终止语句，但与 C 不同的是，这些分号不会出现在源代码中。相反，词法分析器在扫描源代码时会自动插入分号，因此输入文本大多没有分号。</p>
<p>​	规则如下。如果换行符之前的最后一个标记是标识符（包括像 <code>int</code> 和 <code>float64</code> 这样的单词）、基本字面量（如数字或字符串常量）或以下任一标记：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">break</span> <span style="color:#c678dd">continue</span> <span style="color:#c678dd">fallthrough</span> <span style="color:#c678dd">return</span> <span style="color:#56b6c2">++</span> <span style="color:#56b6c2">--</span> ) }
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	词法分析器（lexer）总是在标记之后插入分号。可以总结为，&ldquo;如果换行符出现在可能结束语句的标记之后，就插入分号&rdquo;。</p>
<p>​	分号也可以省略在一个右花括号之前，因此像这样的语句</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">go</span> <span style="color:#c678dd">func</span>() { <span style="color:#c678dd">for</span> { <span style="color:#e06c75">dst</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">src</span> } }()
</span></span></code></pre></td></tr></table>
</div>
</div><p>不需要分号。惯用的 Go 程序只在诸如 for 循环的条件中使用分号，用于分隔初始化器、条件和增减量元素。你若在一行中写多个语句，也需要用分号隔开。</p>
<p>​	分号插入规则的一个后果是，您不能将控制结构（<code>if</code>、<code>for</code>、<code>switch</code> 或 <code>select</code>）的开头括号放在下一行。如果您这样做，会在括号之前插入一个分号，这可能会导致意外的效果。应该这样写：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">i</span> &lt; <span style="color:#61afef;font-weight:bold">f</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">g</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>而不是这样写：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">i</span> &lt; <span style="color:#61afef;font-weight:bold">f</span>()  <span style="color:#7f848e">// wrong!
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>{           <span style="color:#7f848e">// wrong!
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">g</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="控制结构">控制结构</h2>
<p>​	Go的控制结构与C语言的控制结构有关，但在一些重要方面有所不同。没有<code>do</code>或<code>while</code>循环，只有略微通用的<code>for</code>；<code>switch</code>更加灵活；<code>if</code>和<code>switch</code>接受一个可选的初始化语句，就像<code>for</code>一样；<code>break</code>和<code>continue</code>语句接受一个可选的标签，以确定中断或继续的内容；还有一些新的控制结构，包括一个<code>类型开关（type switch）</code>和一个多路通信复用器（multiplexer），<code>select</code>。语法也略有不同：没有圆括号，主体必须始终以花括号为界。</p>
<h3 id="if">If</h3>
<p>​	在Go中，一个简单的<code>if</code>看起来像这样：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">x</span> &gt; <span style="color:#d19a66">0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">y</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>强制的花括号鼓励将简单的<code>if</code>语句写在多行上。这样做是很好的风格，特别是当语句的主体包含控制语句，如<code>return</code>或<code>break</code>。</p>
<p>​	由于<code>if</code>和<code>switch</code>接受初始化语句，因此经常看到用它来设置局部变量。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">file</span>.<span style="color:#61afef;font-weight:bold">Chmod</span>(<span style="color:#d19a66">0664</span>); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Print</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	在Go库中，你会发现当<code>if</code>语句不流入下一条语句时——也就是说，主体以<code>break</code>、<code>continue</code>、<code>goto</code>或<code>return</code>结束——不必要的<code>else</code>被省略了。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">f</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#e06c75">name</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">codeUsing</span>(<span style="color:#e06c75">f</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这是一个常见情况的例子，代码必须防范一系列的错误条件。如果满足条件的控制流顺着页面运行，在出现错误时消除错误情况，那么代码读起来就很容易。由于错误情况往往在<code>return</code>语句中结束，因此之后的代码不需要<code>else</code>语句。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">f</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#e06c75">name</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">d</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">f</span>.<span style="color:#61afef;font-weight:bold">Stat</span>()
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">codeUsing</span>(<span style="color:#e06c75">f</span>, <span style="color:#e06c75">d</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="redeclaration-and-reassignment-重新声明和重新赋值">Redeclaration and reassignment 重新声明和重新赋值</h3>
<p>​	提示：上一节中最后一个例子演示了<code>:=</code>短声明形式如何工作的一个细节。调用<code>os.Open</code>的声明是这样的</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">f</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#e06c75">name</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个语句声明了两个变量，<code>f</code>和<code>err</code>。几行之后，对<code>f.Stat</code>的调用是这样的</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">d</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">f</span>.<span style="color:#61afef;font-weight:bold">Stat</span>()
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这看起来好像是声明了<code>d</code>和<code>err</code>。但是请注意，<code>err</code>出现在两个语句中。这种重复是合法的：<code>err</code>在第一条语句中声明，<strong>但在第二条语句中只是重新赋值</strong>。这意味着对<code>f.Stat</code>的调用使用了上面已经声明的<code>err</code>变量，只是给它一个新的值。</p>
<p>​	在<code>:=</code>声明中，即使变量<code>v</code>已经被声明，也可以出现，条件是：</p>
<ul>
<li>
<p>本次声明与已声明的<code>v</code>在同一作用域内（如果<code>v</code>已经在外层作用域中声明过，则本次声明将创建一个新变量  :material-information:）。</p>
</li>
<li>
<p>本次初始化中的对应值是可分配给<code>v</code>的（即需要注意值的类型），并且</p>
</li>
<li>
<p>本次声明中至少有一个变量被创建（即本次声明的中新声明的）。</p>
</li>
</ul>
<p>​	这个不寻常的属性是纯粹的实用主义，它使得在一个长的<code>if-else</code>链中使用一个单一的<code>err</code>值很容易。你会看到它经常被使用。</p>
<p>!!! warning &ldquo;值得注意的&rdquo;</p>
<pre><code>:material-information:  这里值得注意的是，在Go中，函数参数和返回值的作用域与函数主体相同，尽管它们在词法上出现在包围函数体的花括号之外。
</code></pre>
<h3 id="for">For</h3>
<p>​	Go 的 <code>for</code> 循环与 C 的类似，但不一样。它统一了<code>for</code>和<code>while</code>，没有<code>do-while</code>。有三种形式，其中只有一种有分号。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Like a C for
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">init</span>; <span style="color:#e06c75">condition</span>; <span style="color:#e06c75">post</span> { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Like a C while
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">condition</span> { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Like a C for(;;)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> { }
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	短声明使我们很容易在循环中直接声明索引变量。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">sum</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#d19a66">10</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">sum</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">i</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	如果你在一个数组、切片、字符串或映射上进行循环，或者从一个通道中读取，一个<code>range</code>子句可以管理循环。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">key</span>, <span style="color:#e06c75">value</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">oldMap</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">newMap</span>[<span style="color:#e06c75">key</span>] = <span style="color:#e06c75">value</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果你只需要遍历中的第一个项（键或索引），去掉第二个就行：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">key</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">m</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">key</span>.<span style="color:#61afef;font-weight:bold">expired</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">delete</span>(<span style="color:#e06c75">m</span>, <span style="color:#e06c75">key</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	如果你只需要遍历中的第二个项（值），使用空白标识符（即<code>_</code>），来丢弃第一个项：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">sum</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">_</span>, <span style="color:#e06c75">value</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">array</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">sum</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">value</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	空白标识符有很多用途，在<a href="#the-blank-identifier">后面的章节</a>中会介绍。</p>
<p>​	对于字符串，<code>range</code>为你做了更多的工作，通过解析<code>UTF-8</code>来分解出各个Unicode码点。错误的编码将会占用一个字节并用符文（rune）<code>U+FFFD</code>来替换。(名称(带有相关的内建类型)<code>rune</code>，是Go对单个Unicode码点的称谓。详见<a href="../../References/LanguageSpecification/LexicalElements#rune-literals-rune">语言规范</a>）。循环</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">pos</span>, <span style="color:#e06c75">char</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#98c379">&#34;日本\x80語&#34;</span> { <span style="color:#7f848e">// \x80 is an illegal UTF-8 encoding =&gt; \x80 是一个非法的 UTF-8编码（字符）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;character %#U starts at byte position %d\n&#34;</span>, <span style="color:#e06c75">char</span>, <span style="color:#e06c75">pos</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印：</p>
<pre tabindex="0"><code>character U+65E5 &#39;日&#39; starts at byte position 0
character U+672C &#39;本&#39; starts at byte position 3
character U+FFFD &#39;�&#39; starts at byte position 6
character U+8A9E &#39;語&#39; starts at byte position 7
</code></pre><p>​	最后，<strong>Go没有逗号运算符</strong>，<strong><code>++</code>和<code>--</code>是语句而不是表达式</strong>。因此，如果你想在一个<code>for</code>中使用多个变量，你应该采用平行赋值（虽然它会拒绝<code>++</code>和<code>--</code>）。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Reverse a =&gt; 反转 a
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span>, <span style="color:#e06c75">j</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>, <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">a</span>)<span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#e06c75">j</span>; <span style="color:#e06c75">i</span>, <span style="color:#e06c75">j</span> = <span style="color:#e06c75">i</span><span style="color:#56b6c2">+</span><span style="color:#d19a66">1</span>, <span style="color:#e06c75">j</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">a</span>[<span style="color:#e06c75">i</span>], <span style="color:#e06c75">a</span>[<span style="color:#e06c75">j</span>] = <span style="color:#e06c75">a</span>[<span style="color:#e06c75">j</span>], <span style="color:#e06c75">a</span>[<span style="color:#e06c75">i</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="switch">Switch</h3>
<p>​	Go的<code>switch</code>比C的<code>switch</code>更通用。其表达式无需为常量，甚至无需为整数，<code>case</code> 从上到下进行求值，直到找到匹配的<code>case</code>，如果<code>switch</code>没有表达式，则它将匹配<code>true</code>。因此，可以将<code>if</code>-<code>else</code>-<code>if</code>-<code>else</code>链写成一个`switch，而且这也更符合 Go 的风格。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">unhex</span>(<span style="color:#e06c75">c</span> <span style="color:#e5c07b">byte</span>) <span style="color:#e5c07b">byte</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">switch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#98c379">&#39;0&#39;</span> <span style="color:#56b6c2">&lt;=</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&lt;=</span> <span style="color:#98c379">&#39;9&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">-</span> <span style="color:#98c379">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#98c379">&#39;a&#39;</span> <span style="color:#56b6c2">&lt;=</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&lt;=</span> <span style="color:#98c379">&#39;f&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">-</span> <span style="color:#98c379">&#39;a&#39;</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#98c379">&#39;A&#39;</span> <span style="color:#56b6c2">&lt;=</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&lt;=</span> <span style="color:#98c379">&#39;F&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">c</span> <span style="color:#56b6c2">-</span> <span style="color:#98c379">&#39;A&#39;</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>switch</code> 并不会自动下溯，但<code>case</code>可以用逗号分隔的列表呈现。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">shouldEscape</span>(<span style="color:#e06c75">c</span> <span style="color:#e5c07b">byte</span>) <span style="color:#e5c07b">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">switch</span> <span style="color:#e06c75">c</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#98c379">&#39; &#39;</span>, <span style="color:#98c379">&#39;?&#39;</span>, <span style="color:#98c379">&#39;&amp;&#39;</span>, <span style="color:#98c379">&#39;=&#39;</span>, <span style="color:#98c379">&#39;#&#39;</span>, <span style="color:#98c379">&#39;+&#39;</span>, <span style="color:#98c379">&#39;%&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Although they are not nearly as common in Go as some other C-like languages, <code>break</code> statements can be used to terminate a <code>switch</code> early. Sometimes, though, it&rsquo;s necessary to break out of a surrounding loop, not the switch, and in Go that can be accomplished by putting a label on the loop and &ldquo;breaking&rdquo; to that label. This example shows both uses.</p>
<p>​	尽管它们在Go中并不像其他类 C语言那样常见，但<code>break</code>语句可以用来提前终止<code>switch</code>。有时候也必须打破层层的循环，而不仅仅是<code>switch</code>，在Go中可以通过在循环上加一个标签并 &ldquo;breaking&quot;该标签来实现。这个例子展示了这两种用法。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">Loop</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">n</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">n</span> &lt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">src</span>); <span style="color:#e06c75">n</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">size</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">switch</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">src</span>[<span style="color:#e06c75">n</span>] &lt; <span style="color:#e06c75">sizeOne</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#e06c75">validateOnly</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">break</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">size</span> = <span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">update</span>(<span style="color:#e06c75">src</span>[<span style="color:#e06c75">n</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">src</span>[<span style="color:#e06c75">n</span>] &lt; <span style="color:#e06c75">sizeTwo</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#e06c75">n</span><span style="color:#56b6c2">+</span><span style="color:#d19a66">1</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">src</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">err</span> = <span style="color:#e06c75">errShortInput</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">break</span> <span style="color:#e06c75">Loop</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#e06c75">validateOnly</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">break</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">size</span> = <span style="color:#d19a66">2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">update</span>(<span style="color:#e06c75">src</span>[<span style="color:#e06c75">n</span>] <span style="color:#56b6c2">+</span> <span style="color:#e06c75">src</span>[<span style="color:#e06c75">n</span><span style="color:#56b6c2">+</span><span style="color:#d19a66">1</span>]<span style="color:#56b6c2">&lt;&lt;</span><span style="color:#e06c75">shift</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	当然，<code>continue</code>语句也接受一个可选的标签，不过它只能在循环中使用。</p>
<p>​	作为本节的结束，下面是一个使用两个<code>switch</code>语句的字节片比较例程。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Compare returns an integer comparing the two byte slices,lexicographically.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// =&gt; 比较两个字节型切片，返回一个整数，按字典顺序。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// The result will be 0 if a == b, -1 if a &lt; b, and +1 if a &gt; b
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// =&gt; 如果a == b，结果为0；如果a &lt; b，结果为-1；如果a &gt; b，结果为+1。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Compare</span>(<span style="color:#e06c75">a</span>, <span style="color:#e06c75">b</span> []<span style="color:#e5c07b">byte</span>) <span style="color:#e5c07b">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">a</span>) <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">i</span> &lt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">b</span>); <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">switch</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">a</span>[<span style="color:#e06c75">i</span>] &gt; <span style="color:#e06c75">b</span>[<span style="color:#e06c75">i</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">a</span>[<span style="color:#e06c75">i</span>] &lt; <span style="color:#e06c75">b</span>[<span style="color:#e06c75">i</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">switch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">a</span>) &gt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">b</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">a</span>) &lt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">b</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="类型开关-type-switch">类型开关 Type switch</h3>
<p>​	<code>switch</code>也可以用来判断接口变量的动态类型。这样的<code>type switch</code>使用类型断言的语法，圆括号内有关键字<code>type</code>。如果<code>switch</code>在表达式中声明了一个变量，那么该变量将在每个子句中具有对应的类型。在每一个 <code>case</code> 子句中，重复利用该变量名字也是惯常的做法，实际上这是在每一个 <code>case</code> 子句中，分别声明一个拥有相同名字，但类型不同的新变量。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">t</span> <span style="color:#c678dd">interface</span>{}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">t</span> = <span style="color:#61afef;font-weight:bold">functionOfSomeType</span>()
</span></span><span style="display:flex;"><span><span style="color:#c678dd">switch</span> <span style="color:#e06c75">t</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">t</span>.(<span style="color:#c678dd">type</span>) {
</span></span><span style="display:flex;"><span><span style="color:#c678dd">default</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;unexpected type %T\n&#34;</span>, <span style="color:#e06c75">t</span>) <span style="color:#7f848e">// %T 打印任何类型的 t 的 类型名
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">case</span> <span style="color:#e5c07b">bool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;boolean %t\n&#34;</span>, <span style="color:#e06c75">t</span>) <span style="color:#7f848e">// t 是 bool 类型
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">case</span> <span style="color:#e5c07b">int</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;integer %d\n&#34;</span>, <span style="color:#e06c75">t</span>) <span style="color:#7f848e">// t 是 int 类型
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">case</span> <span style="color:#56b6c2">*</span><span style="color:#e5c07b">bool</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;pointer to boolean %t\n&#34;</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">t</span>) <span style="color:#7f848e">// t 是 *bool 类型
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">case</span> <span style="color:#56b6c2">*</span><span style="color:#e5c07b">int</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;pointer to integer %d\n&#34;</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">t</span>) <span style="color:#7f848e">// t 是 *int 类型
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="functions-函数">Functions 函数</h2>
<h3 id="multiple-return-values-多重返回值">Multiple return values 多重返回值</h3>
<p>​	Go的一个不寻常的特点是，函数和方法可以返回多个值。这种形式可以用来改进C语言程序中的一些笨拙的习惯：带内错误返回（例如用 <code>-1</code> 表示 <code>EOF</code>），以及修改按地址传递的实参。</p>
<p>​	在C语言中，写入操作发生的错误会用一个负数标记，而错误代码被隐藏在一个易失性位置。在Go中，<code>Write</code>可以返回一个计数以及一个错误：&ldquo;是的，你写了一些字节，但不是全部，因为你填满了设备&rdquo;。<code>os</code>包中的文件的<code>Write</code>方法的签名是：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">file</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">File</span>) <span style="color:#61afef;font-weight:bold">Write</span>(<span style="color:#e06c75">b</span> []<span style="color:#e5c07b">byte</span>) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>正如文档所述，它返回写入的字节数，当<code>n != len(b)</code>时返回一个非<code>nil</code>的<code>error</code>。这是一种常见的风格，更多的例子见错误处理一节。</p>
<p>​	我们可以采用一种简单的方法来避免为模拟引用参数而传入指针。下面是一个简单的函数，从一个字节切片的某个位置抓取一个数字，并返回该数值和下一个位置。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">nextInt</span>(<span style="color:#e06c75">b</span> []<span style="color:#e5c07b">byte</span>, <span style="color:#e06c75">i</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e5c07b">int</span>, <span style="color:#e5c07b">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> ; <span style="color:#e06c75">i</span> &lt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">b</span>) <span style="color:#56b6c2">&amp;&amp;</span> !<span style="color:#61afef;font-weight:bold">isDigit</span>(<span style="color:#e06c75">b</span>[<span style="color:#e06c75">i</span>]); <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">x</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> ; <span style="color:#e06c75">i</span> &lt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">b</span>) <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#61afef;font-weight:bold">isDigit</span>(<span style="color:#e06c75">b</span>[<span style="color:#e06c75">i</span>]); <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">x</span> = <span style="color:#e06c75">x</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">10</span> <span style="color:#56b6c2">+</span> <span style="color:#e5c07b">int</span>(<span style="color:#e06c75">b</span>[<span style="color:#e06c75">i</span>]) <span style="color:#56b6c2">-</span> <span style="color:#98c379">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">x</span>, <span style="color:#e06c75">i</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	你可以用下面这样的（代码）来扫描一个输入切片<code>b</code>中的数字：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">b</span>); {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">x</span>, <span style="color:#e06c75">i</span> = <span style="color:#61afef;font-weight:bold">nextInt</span>(<span style="color:#e06c75">b</span>, <span style="color:#e06c75">i</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">x</span>)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="named-result-parameters-命名的结果参数">Named result parameters 命名的结果参数</h3>
<p>​	Go函数的返回或结果 &ldquo;参数 &ldquo;可以被命名并作为常规变量使用，<strong>就像传入参数一样</strong>。<strong>当命名后，它们在函数开始时被初始化为其类型的零值</strong>；如果函数执行没有参数的<code>return</code>语句，则结果形参的当前值被用作返回值。</p>
<p>​	这些名称不是强制性的，但它们可以使代码更短、更清晰：它们就是文档。如果我们给 <code>nextInt</code> 的结果命名，那么哪个返回的是 <code>int</code> 就很明显了。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">nextInt</span>(<span style="color:#e06c75">b</span> []<span style="color:#e5c07b">byte</span>, <span style="color:#e06c75">pos</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e06c75">value</span>, <span style="color:#e06c75">nextPos</span> <span style="color:#e5c07b">int</span>) {
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	由于被命名的结果已经初始化，且已经关联至无参数的返回，它们就能让代码简单而清晰。下面是<code>io.ReadFull</code>的一个版本，就是很好地使用了它们：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">ReadFull</span>(<span style="color:#e06c75">r</span> <span style="color:#e06c75">Reader</span>, <span style="color:#e06c75">buf</span> []<span style="color:#e5c07b">byte</span>) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">buf</span>) &gt; <span style="color:#d19a66">0</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">var</span> <span style="color:#e06c75">nr</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nr</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">r</span>.<span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">buf</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">n</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">nr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">buf</span> = <span style="color:#e06c75">buf</span>[<span style="color:#e06c75">nr</span>:]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="defer">Defer</h3>
<p>​	Go的<code>defer</code>语句预设了一个函数调用（即<strong>推迟执行</strong>函数），该函数会在执行 <code>defer</code> 的函数返回之前立即执行。这是一种不寻常但有效的方法，可以处理诸如资源必须被释放的情况，而不管一个函数采取哪种路径返回。典型的例子是解锁<code>mutex</code>和关闭文件。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Contents returns the file&#39;s contents as a string. =&gt; Contents将文件的内容作为一个字符串返回。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Contents</span>(<span style="color:#e06c75">filename</span> <span style="color:#e5c07b">string</span>) (<span style="color:#e5c07b">string</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#e06c75">filename</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#98c379">&#34;&#34;</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">f</span>.<span style="color:#61afef;font-weight:bold">Close</span>()  <span style="color:#7f848e">// f.Close will run when we&#39;re finished.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">result</span> []<span style="color:#e5c07b">byte</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">buf</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">byte</span>, <span style="color:#d19a66">100</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">n</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">f</span>.<span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">buf</span>[<span style="color:#d19a66">0</span>:])
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">result</span> = <span style="color:#e5c07b">append</span>(<span style="color:#e06c75">result</span>, <span style="color:#e06c75">buf</span>[<span style="color:#d19a66">0</span>:<span style="color:#e06c75">n</span>]<span style="color:#56b6c2">...</span>) <span style="color:#7f848e">// append is discussed later. =&gt; append稍后讨论。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">io</span>.<span style="color:#e06c75">EOF</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">break</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#98c379">&#34;&#34;</span>, <span style="color:#e06c75">err</span>  <span style="color:#7f848e">// f will be closed if we return here.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">string</span>(<span style="color:#e06c75">result</span>), <span style="color:#e5c07b">nil</span> <span style="color:#7f848e">// f will be closed if we return here.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	推迟对<code>Close</code>这样的函数的调用有两个好处。首先，它保证你永远不会忘记关闭文件，如果你以后又为该函数添加了新的返回路径时， 这种情况往往就会发生。其次，它意味着关闭位于打开附近，这比把它放在函数的最后要清楚得多。</p>
<p>​	被延迟函数的实参（如果函数是方法的话，还包括接收器）在<strong>推迟</strong>执行时就会求值，而不是在<strong>调用</strong>执行时。这样不仅无需担心变量值在函数执行时被改变， 同时还意味着单个已推迟的调用可推迟多个函数的执行。这里有一个简单的例子。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#d19a66">5</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%d &#34;</span>, <span style="color:#e06c75">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	被推迟的函数是按<code>后进先出（LIFO）</code>的顺序执行，所以这段代码会导致函数返回时打印出<code>4 3 2 1 0</code>。一个更合理的例子是通过程序追踪函数执行的简单方法。我们可以这样写几个简单的追踪程序：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">trace</span>(<span style="color:#e06c75">s</span> <span style="color:#e5c07b">string</span>)   { <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;entering:&#34;</span>, <span style="color:#e06c75">s</span>) }
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">untrace</span>(<span style="color:#e06c75">s</span> <span style="color:#e5c07b">string</span>) { <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;leaving:&#34;</span>, <span style="color:#e06c75">s</span>) }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Use them like this:
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">a</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">trace</span>(<span style="color:#98c379">&#34;a&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#61afef;font-weight:bold">untrace</span>(<span style="color:#98c379">&#34;a&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// do something....
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	我们可以充分利用这个特点，即被推迟函数的实参在<code>defer</code>执行时就会求值。追踪例程可以为反追踪例程设置实参。这个例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">trace</span>(<span style="color:#e06c75">s</span> <span style="color:#e5c07b">string</span>) <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;entering:&#34;</span>, <span style="color:#e06c75">s</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">s</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">un</span>(<span style="color:#e06c75">s</span> <span style="color:#e5c07b">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;leaving:&#34;</span>, <span style="color:#e06c75">s</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">a</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#61afef;font-weight:bold">un</span>(<span style="color:#61afef;font-weight:bold">trace</span>(<span style="color:#98c379">&#34;a&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;in a&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">b</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#61afef;font-weight:bold">un</span>(<span style="color:#61afef;font-weight:bold">trace</span>(<span style="color:#98c379">&#34;b&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;in b&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">a</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">b</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印</p>
<pre tabindex="0"><code>entering: b
in b
entering: a
in a
leaving: a
leaving: b
</code></pre><p>​	对于习惯了其他语言的块级资源管理的程序员来说，<code>defer</code>可能看起来很奇怪，但它最有趣和强大的应用正是来自于<strong>它不是基于块而是基于函数</strong>的事实。在关于<code>panic</code>和<code>recover</code>的章节中，我们将看到它的另一个可能性的例子。</p>
<h2 id="data-数据">Data 数据</h2>
<h3 id="allocation-with-new-用new进行分配">Allocation with <code>new</code> 用new进行分配</h3>
<p>​	Go有两个分配原语，即内置函数<code>new</code>和<code>make</code>。它们做不同的事情，适用于不同的类型，这可能会令人困惑，但规则很简单。我们先来谈谈<code>new</code>。这是一个分配内存的内置函数，但与其他一些语言中的同名函数不同，它并不初始化内存，只是将其置零。也就是说，<code>new(T)</code>为一个类型为<code>T</code>的新项分配了已置零的内存空间，并返回其地址，即一个类型为<code>*T</code>的值。用Go的术语来说，它<strong>返回</strong>一个指向新分配的<code>T</code>类型的零值的<strong>指针</strong>。</p>
<p>​	由于<code>new</code>返回的内存是已置零，所以在设计数据结构时，安排每种类型的零值无需进一步初始化就可以使用是很有帮助的。这意味着数据结构的用户可以用<code>new</code>创建一个数据结构并直接开始工作。例如，<code>bytes.Buffer</code>的文档指出，&ldquo;&ldquo;零值的 <code>Buffer</code> 就是已准备就绪的缓冲区。&rdquo; 同样，<code>sync.Mutex</code>也没有一个显式的构造函数或<code>Init</code>方法。相反，零值的 <code>sync.Mutex</code> 就已经被定义为已解锁的互斥锁了。</p>
<p>​	&ldquo;零值属性&rdquo; 可以带来各种好处。考虑一下这个类型声明。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">SyncedBuffer</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">lock</span>    <span style="color:#e06c75">sync</span>.<span style="color:#e06c75">Mutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">buffer</span>  <span style="color:#e06c75">bytes</span>.<span style="color:#e06c75">Buffer</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>SyncedBuffer</code>类型的值也是在分配或声明时就可以立即使用。后续代码中， <code>p</code> 和 <code>v</code> 无需进一步处理即可正确工作。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">p</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">new</span>(<span style="color:#e06c75">SyncedBuffer</span>)  <span style="color:#7f848e">// type *SyncedBuffer
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">var</span> <span style="color:#e06c75">v</span> <span style="color:#e06c75">SyncedBuffer</span>      <span style="color:#7f848e">// type  SyncedBuffer
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="constructors-and-composite-literals-构造函数和复合字面量">Constructors and composite literals 构造函数和复合字面量</h3>
<p>​	有时零值还不够好，这时需要一个初始化构造函数，就像这个源自<code>os</code>包的例子。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">NewFile</span>(<span style="color:#e06c75">fd</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">name</span> <span style="color:#e5c07b">string</span>) <span style="color:#56b6c2">*</span><span style="color:#e06c75">File</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">fd</span> &lt; <span style="color:#d19a66">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">new</span>(<span style="color:#e06c75">File</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span>.<span style="color:#e06c75">fd</span> = <span style="color:#e06c75">fd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span>.<span style="color:#e06c75">name</span> = <span style="color:#e06c75">name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span>.<span style="color:#e06c75">dirinfo</span> = <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span>.<span style="color:#e06c75">nepipe</span> = <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">f</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这里面有很多繁文缛节。<strong>我们可以使用复合字面量来简化它</strong>，复合字面是一个表达式，每次求值都会创建一个新的实例。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">NewFile</span>(<span style="color:#e06c75">fd</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">name</span> <span style="color:#e5c07b">string</span>) <span style="color:#56b6c2">*</span><span style="color:#e06c75">File</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">fd</span> &lt; <span style="color:#d19a66">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">File</span>{<span style="color:#e06c75">fd</span>, <span style="color:#e06c75">name</span>, <span style="color:#e5c07b">nil</span>, <span style="color:#d19a66">0</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">f</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，与C语言不同的是，<code>返回局部变量的地址是完全可以的</code>；与该变量相关的存储（数据）在函数返回后仍然存在。事实上，获取一个复合字面量的地址在每次求值时都会分配一个新的实例，所以我们可以将最后两行合并起来。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">File</span>{<span style="color:#e06c75">fd</span>, <span style="color:#e06c75">name</span>, <span style="color:#e5c07b">nil</span>, <span style="color:#d19a66">0</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	复合字面量的字段必须按顺序全部列出。但如果以 <strong>字段</strong><code>:</code><strong>值</strong> 对的形式明确地标出元素，初始化字段时就可以按任何顺序出现，未给出的字段值将赋予零值。因此我们可以用如下形式</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">File</span>{<span style="color:#e06c75">fd</span>: <span style="color:#e06c75">fd</span>, <span style="color:#e06c75">name</span>: <span style="color:#e06c75">name</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	少数情况下，如果复合字面量不包含任何字段，它就会为该类型创建一个零值。<code>new(File)</code> 和 <code>&amp;File{}</code> 的表达式是等价的。</p>
<p>​	复合字面量同样可用于创建数组、切片和映射，字段标签（field labels）可以是索引或映射的键值。在这些例子中，不管<code>Enone</code>、<code>Eio</code>和<code>Einval</code>的值是什么，只要它们的标签不同，初始化就会正常进行。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">a</span> <span style="color:#56b6c2">:=</span> [<span style="color:#56b6c2">...</span>]<span style="color:#e5c07b">string</span>   {<span style="color:#e06c75">Enone</span>: <span style="color:#98c379">&#34;no error&#34;</span>, <span style="color:#e06c75">Eio</span>: <span style="color:#98c379">&#34;Eio&#34;</span>, <span style="color:#e06c75">Einval</span>: <span style="color:#98c379">&#34;invalid argument&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">s</span> <span style="color:#56b6c2">:=</span> []<span style="color:#e5c07b">string</span>      {<span style="color:#e06c75">Enone</span>: <span style="color:#98c379">&#34;no error&#34;</span>, <span style="color:#e06c75">Eio</span>: <span style="color:#98c379">&#34;Eio&#34;</span>, <span style="color:#e06c75">Einval</span>: <span style="color:#98c379">&#34;invalid argument&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">m</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">map</span>[<span style="color:#e5c07b">int</span>]<span style="color:#e5c07b">string</span>{<span style="color:#e06c75">Enone</span>: <span style="color:#98c379">&#34;no error&#34;</span>, <span style="color:#e06c75">Eio</span>: <span style="color:#98c379">&#34;Eio&#34;</span>, <span style="color:#e06c75">Einval</span>: <span style="color:#98c379">&#34;invalid argument&#34;</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="allocation-with-make-用make进行分配">Allocation with <code>make </code>用make进行分配</h3>
<p>​	回到内存分配上。内置函数<code>make(T, args)</code>的目的与<code>new(T)</code>不同。<code>它只用于创建切片、映射和通道</code>，并返回一个初始化（<strong>非置零</strong>）的<code>T</code>（而不是<code>*T</code>）类型的值。出现这种用差异的原因在于，<strong>这三种类型本质上为引用数据类型，它们在使用前必须初始化</strong>。例如，切片是一个包含指向（在一个数组内）数据的指针、长度和容量的三个项的描述符，在这些项被初始化之前，这个切片为<code>nil</code>。对于切片、映射和通道，<code>make</code>初始化内部数据结构，并准备好使用的值。例如，</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">int</span>, <span style="color:#d19a66">10</span>, <span style="color:#d19a66">100</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>分配了一个具有100个<code>int</code>的数组，然后创建了一个长度为10，容量为 100 并指向该数组中前 10 个元素的切片结构。(当创建一个切片时，容量可以省略；更多信息请看切片部分)。相反，<code>new([]int)</code>返回一个指向新分配的、已置零的切片结构的指针，即一个指向<code>nil</code>切片值的指针。</p>
<p>​	这些例子说明了<code>new</code>和<code>make</code>的区别。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">p</span> <span style="color:#56b6c2">*</span>[]<span style="color:#e5c07b">int</span> = <span style="color:#e5c07b">new</span>([]<span style="color:#e5c07b">int</span>)       <span style="color:#7f848e">// allocates slice structure; *p == nil; rarely useful =&gt; 分配切片结构；*p == nil；很少用到
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">var</span> <span style="color:#e06c75">v</span>  []<span style="color:#e5c07b">int</span> = <span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">int</span>, <span style="color:#d19a66">100</span>) <span style="color:#7f848e">// the slice v now refers to a new array of 100 ints =&gt; 切片 v 现在引用了一个具有 100 个 int 元素的新数组
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Unnecessarily complex: 没必要的复杂用法
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">var</span> <span style="color:#e06c75">p</span> <span style="color:#56b6c2">*</span>[]<span style="color:#e5c07b">int</span> = <span style="color:#e5c07b">new</span>([]<span style="color:#e5c07b">int</span>)
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">*</span><span style="color:#e06c75">p</span> = <span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">int</span>, <span style="color:#d19a66">100</span>, <span style="color:#d19a66">100</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Idiomatic: 惯用法
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">v</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">int</span>, <span style="color:#d19a66">100</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>记住，<code>make</code>只适用于映射、切片和通道，且不返回指针。要获得一个显式的指针，需要用<code>new</code>来分配或者显式地获取一个变量的地址。</p>
<h3 id="arrays-数组">Arrays 数组</h3>
<p>​	在规划内存的详细布局时，数组是很有用的，有时还能避免过多的内存分配，但它们主要用作切片的构件，这将是下一节的主题。为了给这一主题打下基础，这里有一些关于数组的话。</p>
<p>​	在Go和C中，数组的工作方式有很大的不同：</p>
<ul>
<li>数组是值。将一个数组分配给另一个数组会复制所有的元素。</li>
<li>特别是，如果你把一个数组传递给一个函数，它将接收到一个数组的副本，而不是一个指针。</li>
<li>数组的大小是其类型的一部分。类型<code>[10]int</code>和<code>[20]int</code>是不同的。</li>
</ul>
<p>​	数组为值属性可能很有用，但也代价高昂；如果你想获得类似C语言那样的行为和效率，你可以传递一个指向数组的指针。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Sum</span>(<span style="color:#e06c75">a</span> <span style="color:#56b6c2">*</span>[<span style="color:#d19a66">3</span>]<span style="color:#e5c07b">float64</span>) (<span style="color:#e06c75">sum</span> <span style="color:#e5c07b">float64</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">_</span>, <span style="color:#e06c75">v</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">a</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">sum</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">v</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">array</span> <span style="color:#56b6c2">:=</span> [<span style="color:#56b6c2">...</span>]<span style="color:#e5c07b">float64</span>{<span style="color:#d19a66">7.0</span>, <span style="color:#d19a66">8.5</span>, <span style="color:#d19a66">9.1</span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">x</span> <span style="color:#56b6c2">:=</span> <span style="color:#61afef;font-weight:bold">Sum</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">array</span>)  <span style="color:#7f848e">// Note the explicit address-of operator =&gt; 注意这里显示的 &amp;运算符
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>​	但这并不是 Go 的惯用法，切片才是。</p>
<h3 id="slices-切片">Slices 切片</h3>
<p>​	切片通过对数组进行封装，为数据序列提供了一个更通用、更强大、更方便的接口。除了矩阵变换这类需要明确维度的情况外，Go 中的大部分数组编程都是通过切片来完成的。</p>
<p>Slices hold references to an underlying array, and if you assign one slice to another, both refer to the same array. If a function takes a slice argument, changes it makes to the elements of the slice will be visible to the caller, analogous to passing a pointer to the underlying array. A <code>Read</code> function can therefore accept a slice argument rather than a pointer and a count; the length within the slice sets an upper limit of how much data to read. Here is the signature of the <code>Read</code> method of the <code>File</code> type in package <code>os</code>:</p>
<p>​	切片持有对底层数组的引用，如果你把一个切片赋予另一个切片，两者都会引用同一个数组。如果某个函数接受一个切片参数，那么它对切片中的元素所做的改变对调用者来说是可见的，类似于传递一个指向底层数组的指针。因此，<code>Read</code>函数可以接受一个切片实参，而不是一个指针和一个计数；切片中的长度决定了可读取数据的上限。下面是<code>os</code>包中文件类型的读取方法的签名：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">f</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">File</span>) <span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">buf</span> []<span style="color:#e5c07b">byte</span>) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	该方法返回读取的字节数和一个错误值（如果有的话）。要读入一个更大的缓冲区<code>buf</code>的前32个字节，可以对缓冲区进行切片（这里作为动词使用）。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#e06c75">n</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">f</span>.<span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">buf</span>[<span style="color:#d19a66">0</span>:<span style="color:#d19a66">32</span>])
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这样的切片是很常见的，而且很有效。若不谈效率，下面的切片也会读取缓冲区的前32个字节。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#d19a66">32</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nbytes</span>, <span style="color:#e06c75">e</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">f</span>.<span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">buf</span>[<span style="color:#e06c75">i</span>:<span style="color:#e06c75">i</span><span style="color:#56b6c2">+</span><span style="color:#d19a66">1</span>])  <span style="color:#7f848e">// Read one byte.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">n</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">nbytes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">nbytes</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span> <span style="color:#56b6c2">||</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">err</span> = <span style="color:#e06c75">e</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	切片的长度可以改变，只要它仍然符合底层数组的限制；只需将它赋予其自身的切片即可。一个切片的容量，可以通过内置函数<code>cap</code>获得，它将给出该切片可能取得的最大长度。以下有一个将数据追加到切片的函数。如果数据超过了容量，切片将被重新分配。返回值即为所得的切片。该函数利用<code>len</code>和<code>cap</code>在应用于<code>nil</code> 切片时是合法的，它将返回0。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Append</span>(<span style="color:#e06c75">slice</span>, <span style="color:#e06c75">data</span> []<span style="color:#e5c07b">byte</span>) []<span style="color:#e5c07b">byte</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">l</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">slice</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">l</span> <span style="color:#56b6c2">+</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">data</span>) &gt; <span style="color:#e5c07b">cap</span>(<span style="color:#e06c75">slice</span>) {  <span style="color:#7f848e">// reallocate =&gt; 重新分配
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">// Allocate double what&#39;s needed, for future growth. =&gt; 为未来的增长,两倍分配所需的长度.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">newSlice</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">byte</span>, (<span style="color:#e06c75">l</span><span style="color:#56b6c2">+</span><span style="color:#e5c07b">len</span>(<span style="color:#e06c75">data</span>))<span style="color:#56b6c2">*</span><span style="color:#d19a66">2</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// The copy function is predeclared and works for any slice type. =&gt; copy 函数是预先声明的，适用于任何切片类型。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e5c07b">copy</span>(<span style="color:#e06c75">newSlice</span>, <span style="color:#e06c75">slice</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">slice</span> = <span style="color:#e06c75">newSlice</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">slice</span> = <span style="color:#e06c75">slice</span>[<span style="color:#d19a66">0</span>:<span style="color:#e06c75">l</span><span style="color:#56b6c2">+</span><span style="color:#e5c07b">len</span>(<span style="color:#e06c75">data</span>)]
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">copy</span>(<span style="color:#e06c75">slice</span>[<span style="color:#e06c75">l</span>:], <span style="color:#e06c75">data</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">slice</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	最终我们必须返回切片，因为尽管<code>Append</code>可以修改<code>slice</code>的元素，但<code>slice</code>本身（其运行时数据结构包含指针、长度和容量）是通过值传递的。</p>
<p>​	向切片中追加的想法非常有用，因此有专门的内置函数 <code>append</code>。为了理解这个函数的设计，我们需要更多的信息，我们将稍后再介绍它。</p>
<h3 id="two-dimensional-slices-二维切片">Two-dimensional slices 二维切片</h3>
<p>​	Go 的数组和切片都是一维的。要创建相当于二维数组或切片，必须定义一个数组的数组或切片的切片，像这样：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Transform</span> [<span style="color:#d19a66">3</span>][<span style="color:#d19a66">3</span>]<span style="color:#e5c07b">float64</span>  <span style="color:#7f848e">// A 3x3 array, really an array of arrays.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">LinesOfText</span> [][]<span style="color:#e5c07b">byte</span>     <span style="color:#7f848e">// A slice of byte slices.
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>​	由于切片是可变长度的，因此有可能让每个内部的切片都是不同的长度。这可能是一种常见的情况，就像我们的<code>LinesOfText</code>例子：每行都有其自己的长度：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">text</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">LinesOfText</span>{
</span></span><span style="display:flex;"><span>    []<span style="color:#e5c07b">byte</span>(<span style="color:#98c379">&#34;Now is the time&#34;</span>),
</span></span><span style="display:flex;"><span>    []<span style="color:#e5c07b">byte</span>(<span style="color:#98c379">&#34;for all good gophers&#34;</span>),
</span></span><span style="display:flex;"><span>    []<span style="color:#e5c07b">byte</span>(<span style="color:#98c379">&#34;to bring some fun to the party.&#34;</span>),
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Sometimes it&rsquo;s necessary to allocate a 2D slice, a situation that can arise when processing scan lines of pixels, for instance. There are two ways to achieve this. One is to allocate each slice independently; the other is to allocate a single array and point the individual slices into it. Which to use depends on your application. If the slices might grow or shrink, they should be allocated independently to avoid overwriting the next line; if not, it can be more efficient to construct the object with a single allocation. For reference, here are sketches of the two methods. First, a line at a time:</p>
<p>​	有时，有必要分配一个二维切片，例如，在处理像素的扫描行时，这种情况就会发生。有两种方式可以实现这一点。一种是独立地分配每个切片；另一种是分配一个数组，将各个切片指向它。使用哪种方法取决于你的应用。如果切片可能会增长或缩小，则它们应该独立分配，以避免覆盖下一行；如果不会，用单次分配构建对象可能更有效率。以下是这两种方法的大概代码，仅供参考。首先是一次分配一行。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Allocate the top-level slice. =&gt; 分配底层切片
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">picture</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>([][]<span style="color:#e5c07b">uint8</span>, <span style="color:#e06c75">YSize</span>) <span style="color:#7f848e">// One row per unit of y. =&gt; 每 y 个单元一行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop over the rows, allocating the slice for each row.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">picture</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">picture</span>[<span style="color:#e06c75">i</span>] = <span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">uint8</span>, <span style="color:#e06c75">XSize</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在是作为一个分配，对行进行切片：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Allocate the top-level slice, the same as before. =&gt; 分配底层切片， 和上面的一样
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">picture</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>([][]<span style="color:#e5c07b">uint8</span>, <span style="color:#e06c75">YSize</span>) <span style="color:#7f848e">// One row per unit of y. =&gt; 每 y 个单元一行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// Allocate one large slice to hold all the pixels. =&gt; 分配一个大一点的切片用来容纳所有的像素
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">pixels</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>([]<span style="color:#e5c07b">uint8</span>, <span style="color:#e06c75">XSize</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">YSize</span>) <span style="color:#7f848e">// Has type []uint8 even though picture is [][]uint8. =&gt; 指定类型[]uint8, 即使图片是 [][]uint8。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop over the rows, slicing each row from the front of the remaining pixels slice. =&gt; 循环遍历行，从剩余像素切片的前面对每一行进行切片。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">picture</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">picture</span>[<span style="color:#e06c75">i</span>], <span style="color:#e06c75">pixels</span> = <span style="color:#e06c75">pixels</span>[:<span style="color:#e06c75">XSize</span>], <span style="color:#e06c75">pixels</span>[<span style="color:#e06c75">XSize</span>:]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="maps-映射">Maps 映射</h3>
<p>​	映射是一种方便而强大的内置数据结构，它将一种类型的值（键）与另一种类型的值（元素或值）关联起来。其<code>键</code>可以是任何相等性操作符支持的类型，如<code>整数</code>、<code>浮点数</code>和<code>复数</code>、<code>字符串</code>、<code>指针</code>、<code>接口</code>（只要其动态类型支持相等性判断）、<code>结构体</code>和<code>数组</code>。切片不能被用作映射的键，因为它们的相等性还未定义。与切片一样，映射也持有对一个底层数据结构的引用。<strong>若将映射传入函数中，并更改了该映射的内容，则此修改对调用者同样可见</strong>。</p>
<p>​	映射可以使用一般的复合字面量语法和冒号分隔的键值对来构建，所以在初始化过程中很容易构建它们。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">timeZone</span> = <span style="color:#c678dd">map</span>[<span style="color:#e5c07b">string</span>]<span style="color:#e5c07b">int</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;UTC&#34;</span>:  <span style="color:#d19a66">0</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;EST&#34;</span>: <span style="color:#56b6c2">-</span><span style="color:#d19a66">5</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;CST&#34;</span>: <span style="color:#56b6c2">-</span><span style="color:#d19a66">6</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;MST&#34;</span>: <span style="color:#56b6c2">-</span><span style="color:#d19a66">7</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;PST&#34;</span>: <span style="color:#56b6c2">-</span><span style="color:#d19a66">8</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span><span style="color:#56b6c2">*</span><span style="color:#d19a66">60</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	赋值和获取映射值在语法上看起来就像对数组和切片做同样的事情，只是索引无需是一个整数。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">offset</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">timeZone</span>[<span style="color:#98c379">&#34;EST&#34;</span>]
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	试图通过映射中不存在的键来获取值，就会返回与该映射中项的类型对应的零值。例如，如果映射包含整数，查找一个不存在的键将返回<code>0</code>。集合可以被实现为一个值类型为<code>bool</code>的映射。将该映射中的项置为 <code>true</code> 可将该值放入集合中，此后通过简单的索引操作即可判断是否存在。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">attended</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">map</span>[<span style="color:#e5c07b">string</span>]<span style="color:#e5c07b">bool</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;Ann&#34;</span>: <span style="color:#e5c07b">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;Joe&#34;</span>: <span style="color:#e5c07b">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">attended</span>[<span style="color:#e06c75">person</span>] { <span style="color:#7f848e">// will be false if person is not in the map =&gt; 若 person不在映射中，则返回 false
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">person</span>, <span style="color:#98c379">&#34;was at the meeting&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	有时你需要区分某项是不存在还是其值为零值。是有一个 &ldquo;<code>UTC</code> &ldquo;的条目，还是因为它根本就不在映射中，所以是<code>0</code>？你可以用一种<code>多重赋值</code>的形式进行区分。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">seconds</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">ok</span> <span style="color:#e5c07b">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">seconds</span>, <span style="color:#e06c75">ok</span> = <span style="color:#e06c75">timeZone</span>[<span style="color:#e06c75">tz</span>]
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	由于明显的原因，这被称为 &ldquo;逗号ok &ldquo;惯用法。在这个例子中，如果<code>tz</code>存在，<code>seconds</code>将被适当地设置，<code>ok</code>将为<code>true</code>；如果不存在，<code>seconds</code>将被设置为零，<code>ok</code>将为<code>false</code>。下面是一个函数，它把它和一个很好的错误报告放在一起：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">offset</span>(<span style="color:#e06c75">tz</span> <span style="color:#e5c07b">string</span>) <span style="color:#e5c07b">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">seconds</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">timeZone</span>[<span style="color:#e06c75">tz</span>]; <span style="color:#e06c75">ok</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">seconds</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;unknown time zone:&#34;</span>, <span style="color:#e06c75">tz</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	若仅需判断映射中是否存在某项而不关心实际的值，你可以用<a href="#the-blank-identifier">空白标识符</a>（<code>_</code>）来代替该值的一般变量。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">_</span>, <span style="color:#e06c75">present</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">timeZone</span>[<span style="color:#e06c75">tz</span>]
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	要删除映射中的项，请使用<code>delete</code>内置函数，它以映射及要被删除的键为实参。即使该键已经不在映射中，此操作也是安全的。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e5c07b">delete</span>(<span style="color:#e06c75">timeZone</span>, <span style="color:#98c379">&#34;PDT&#34;</span>)  <span style="color:#7f848e">// Now on Standard Time
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="printing-打印">Printing 打印</h3>
<p>​	Go中的格式化打印使用类似于C的<code>printf</code>系列的风格，但更丰富，更通用。这些函数存在于<code>fmt</code>包中，且函数名首字母均为大写：<code>fmt.Printf</code>, <code>fmt.Fprintf</code>, <code>fmt.Sprintf</code>等等。字符串函数（<code>Sprintf</code>等）会返回一个字符串，而非填充给定的缓冲区。</p>
<p>​	你无需提供一个格式字符串。对于<code>Printf</code>、<code>Fprintf</code>和<code>Sprintf</code>中的每一个，都分别有对应另外的函数，例如<code>Print</code>和<code>Println</code>。这些函数不接受格式字符串，而是为每个实参生成一种默认格式。<code>Println</code>版本的函数还在实参之间插入一个空白，并在输出中附加一个换行符，而<code>Print</code>版本的函数仅在两边的操作数都不是字符串的情况下添加空白。在这个例子中，每一行都产生相同的输出。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;Hello %d\n&#34;</span>, <span style="color:#d19a66">23</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Fprint</span>(<span style="color:#e06c75">os</span>.<span style="color:#e06c75">Stdout</span>, <span style="color:#98c379">&#34;Hello &#34;</span>, <span style="color:#d19a66">23</span>, <span style="color:#98c379">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;Hello&#34;</span>, <span style="color:#d19a66">23</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprint</span>(<span style="color:#98c379">&#34;Hello &#34;</span>, <span style="color:#d19a66">23</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>fmt.Fprint</code> 一类的格式化打印函数可接受任何实现了 <code>io.Writer</code> 接口的对象作为第一个实参；变量 <code>os.Stdout</code> 和 <code>os.Stderr</code> 是人们熟悉的实例。</p>
<p>​	从这里开始，就与 C 有些不同了。首先，像 <code>%d</code> 这样的数值格式并不接受表示符号或大小的标记， 打印例程会根据实参的类型来决定这些属性。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">x</span> <span style="color:#e5c07b">uint64</span> = <span style="color:#d19a66">1</span><span style="color:#56b6c2">&lt;&lt;</span><span style="color:#d19a66">64</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%d %x; %d %x\n&#34;</span>, <span style="color:#e06c75">x</span>, <span style="color:#e06c75">x</span>, <span style="color:#e5c07b">int64</span>(<span style="color:#e06c75">x</span>), <span style="color:#e5c07b">int64</span>(<span style="color:#e06c75">x</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印</p>
<pre tabindex="0"><code>18446744073709551615 ffffffffffffffff; -1 -1
</code></pre><p>​	如果你只想得到默认的转换，比如整数的十进制，你可以使用通用格式<code>%v</code>（代表 &ldquo;值&rdquo;）；其结果与 <code>Print</code>和<code>Println</code>的输出完全相同。此外，这种格式可以打印任何数值，甚至是数组、切片、结构体和映射。下面是上一节中定义的时区映射的打印语句。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%v\n&#34;</span>, <span style="color:#e06c75">timeZone</span>)  <span style="color:#7f848e">// or just fmt.Println(timeZone)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>即可得到输出：</p>
<pre tabindex="0"><code>map[CST:-21600 EST:-18000 MST:-25200 PST:-28800 UTC:0]
</code></pre><p>​	对于映射，<code>Printf</code>一类的函数会按照键的字典顺序排序输出。</p>
<p>​	在打印结构体时，修改后的格式<code>%+v</code>对结构体的字段进行注解，对于任何值，替代格式<code>%#v</code>以完整的Go语法打印出该值。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">T</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">a</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">b</span> <span style="color:#e5c07b">float64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">c</span> <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">t</span> <span style="color:#56b6c2">:=</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">T</span>{ <span style="color:#d19a66">7</span>, <span style="color:#56b6c2">-</span><span style="color:#d19a66">2.35</span>, <span style="color:#98c379">&#34;abc\tdef&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%v\n&#34;</span>, <span style="color:#e06c75">t</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%+v\n&#34;</span>, <span style="color:#e06c75">t</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%#v\n&#34;</span>, <span style="color:#e06c75">t</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%#v\n&#34;</span>, <span style="color:#e06c75">timeZone</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>prints 打印</p>
<pre tabindex="0"><code>&amp;{7 -2.35 abc   def}
&amp;{a:7 b:-2.35 c:abc     def}
&amp;main.T{a:7, b:-2.35, c:&#34;abc\tdef&#34;}
map[string]int{&#34;CST&#34;:-21600, &#34;EST&#34;:-18000, &#34;MST&#34;:-25200, &#34;PST&#34;:-28800, &#34;UTC&#34;:0}
</code></pre><p>(请注意其中的 &amp; 符号）当遇到<code>string</code>或<code>[]byte</code>类型的值时，可使用 <code>%q</code> 产生带引号的字符串。而格式 <code>%#q</code> 会尽可能使用反引号。(<code>%q</code>格式也可用于整数和符文，它会产生一个单引号符文常量)。另外，<code>%x</code>也适用于字符串、字节数组、字节切片以及整数，生成一个很长的十六进制字符串，并且在格式中加入空格（<code>% x</code>），它还会在字节之间插入空格。</p>
<p>​	另一种实用的格式是<code>%T</code>，它打印出某个值的类型。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%T\n&#34;</span>, <span style="color:#e06c75">timeZone</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">map</span>[<span style="color:#e5c07b">string</span>]<span style="color:#e5c07b">int</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	如果你想控制自定义类型的默认格式，只需要在该类型上定义一个具有<code>String() string</code>签名的方法。对于我们的简单类型<code>T</code>，可能看起来像这样。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">t</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">T</span>) <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%d/%g/%q&#34;</span>, <span style="color:#e06c75">t</span>.<span style="color:#e06c75">a</span>, <span style="color:#e06c75">t</span>.<span style="color:#e06c75">b</span>, <span style="color:#e06c75">t</span>.<span style="color:#e06c75">c</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%v\n&#34;</span>, <span style="color:#e06c75">t</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印格式为</p>
<pre tabindex="0"><code>7/-2.35/&#34;abc\tdef&#34;
</code></pre><p>(如果你需要像指向 <code>T</code> 的指针那样打印类型 <code>T</code> 的<strong>值</strong>，那么<code>String</code>的接收器必须是值类型的；上面这个例子（中的接收器）使用一个指针，因为这对结构体类型来说更加有效和惯用。更多信息请参见下面关于<a href="#pointers-vs-values">指针与值接收器</a>的部分）。</p>
<p>​	我们的<code>String</code>方法能够调用<code>Sprintf</code>，因为打印例程是完全可重入的，并可以用这种方式进行封装。不过，关于这种方法有一个重要的细节需要知道：<strong>请勿通过调用<code>Sprintf</code>的方式来构造<code>String</code>方法，这样它会无限递归你的<code>String</code>方法</strong>。如果<code>Sprintf</code>调用试图将接收器直接打印成字符串，而该字符串又将再次调用该方法，则会发生这种情况。这是一个常见且容易犯的错误，正如本例所示。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">MyString</span> <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">m</span> <span style="color:#e06c75">MyString</span>) <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;MyString=%s&#34;</span>, <span style="color:#e06c75">m</span>) <span style="color:#7f848e">// Error: will recur forever. =&gt; 错误：会无限递归
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这也很容易解决：将实参转换为基本字符串类型，该实参没有这个方法。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">MyString</span> <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">m</span> <span style="color:#e06c75">MyString</span>) <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;MyString=%s&#34;</span>, <span style="color:#e5c07b">string</span>(<span style="color:#e06c75">m</span>)) <span style="color:#7f848e">// OK: note conversion. =&gt;  可以：注意转换
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	在<a href="#initialization">初始化一节</a>，我们将看到另一种避免这种递归的技术。</p>
<p>​	另一种打印技术是将打印例程的实参直接传递给另一个这样的例程。<code>Printf</code>的签名为它的最后一个参数使用了<code>...interface{}</code>类型，这样格式的后面就能出现（任意类型之一的）任意数量的参数。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#e06c75">format</span> <span style="color:#e5c07b">string</span>, <span style="color:#e06c75">v</span> <span style="color:#56b6c2">...</span><span style="color:#c678dd">interface</span>{}) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) {
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	在函数<code>Printf</code>中，<code>v</code>的行为就像一个<code>[]interface{}</code>类型的变量，<strong>但如果它被传递给另一个变参函数，它的行为就像一个普通的实参列表</strong>。以下是我们之前用过的 <code>log.Println</code> 的实现。它直接将实参传递给 <code>fmt.Sprintln</code> 来进行实际格式化。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Println prints to the standard logger in the manner of fmt.Println.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// =&gt; Println 通过 fmt.Println 的方式将日志打印到标准记录器
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">v</span> <span style="color:#56b6c2">...</span><span style="color:#c678dd">interface</span>{}) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">std</span>.<span style="color:#61afef;font-weight:bold">Output</span>(<span style="color:#d19a66">2</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintln</span>(<span style="color:#e06c75">v</span><span style="color:#56b6c2">...</span>))  <span style="color:#7f848e">// Output takes parameters (int, string) =&gt; Output 接收参数 (int, string)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	我们在嵌套调用 <code>Sprintln</code> 的 <code>v</code> 后面写上 <code>...</code> 来告诉编译器把 <code>v</code> 当作一个实参列表；否则它就会把 <code>v</code> 作为一个单一的切片实参来传递。</p>
<p>​	还有很多关于打印知识点没有提及。详情请参见<a href="../../StdLib/fmt">fmt</a>包的<code>godoc</code>文档。</p>
<p>​	顺便说一下，<strong><code>...</code>形参可指定具体的类型</strong>，例如<code>...int</code>用于<code>min</code>函数，该函数选择整数列表中的最小值。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Min</span>(<span style="color:#e06c75">a</span> <span style="color:#56b6c2">...</span><span style="color:#e5c07b">int</span>) <span style="color:#e5c07b">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">min</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">int</span>(^<span style="color:#e5c07b">uint</span>(<span style="color:#d19a66">0</span>) <span style="color:#56b6c2">&gt;&gt;</span> <span style="color:#d19a66">1</span>)  <span style="color:#7f848e">// largest int
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">_</span>, <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">a</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">i</span> &lt; <span style="color:#e06c75">min</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">min</span> = <span style="color:#e06c75">i</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">min</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="append-追加">Append 追加</h3>
<p>​	现在我们有了解释<code>append</code>内置函数的设计所需的缺失部分。<code>append</code>的签名与我们上面的自定义<code>Append</code>函数不同。大致来说，它是这样的：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#e5c07b">append</span>(<span style="color:#e06c75">slice</span> []<span style="color:#e06c75">T</span>, <span style="color:#e06c75">elements</span> <span style="color:#56b6c2">...</span><span style="color:#e06c75">T</span>) []<span style="color:#e06c75">T</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中<code>T</code>是任何给定类型的占位符。<strong>实际上，你不能在Go中写一个由调用者决定类型<code>T</code>的函数</strong>。<strong>这就是为什么<code>append</code>是内置的：它需要编译器的支持</strong>。</p>
<p>​	<code>append</code>所做的是将元素追加到切片的末尾并返回结果。结果需要被返回，原因与我们手写的<code>Append</code>一样，即底层数组可能会改变。这个简单的例子</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">x</span> <span style="color:#56b6c2">:=</span> []<span style="color:#e5c07b">int</span>{<span style="color:#d19a66">1</span>,<span style="color:#d19a66">2</span>,<span style="color:#d19a66">3</span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">x</span> = <span style="color:#e5c07b">append</span>(<span style="color:#e06c75">x</span>, <span style="color:#d19a66">4</span>, <span style="color:#d19a66">5</span>, <span style="color:#d19a66">6</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">x</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印出<code>[1 2 3 4 5 6]</code>。所以<code>append</code>的工作方式有点像<code>Printf</code>，接收任意数量的实参。</p>
<p>​	但如果我们要像 <code>Append</code> 那样将一个切片追加到另一个切片中呢？很简单：在调用处使用<code>...</code>，就像我们在上面调用<code>Output</code>时那样。以下代码片段的输出与上一个相同。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">x</span> <span style="color:#56b6c2">:=</span> []<span style="color:#e5c07b">int</span>{<span style="color:#d19a66">1</span>,<span style="color:#d19a66">2</span>,<span style="color:#d19a66">3</span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">y</span> <span style="color:#56b6c2">:=</span> []<span style="color:#e5c07b">int</span>{<span style="color:#d19a66">4</span>,<span style="color:#d19a66">5</span>,<span style="color:#d19a66">6</span>}
</span></span><span style="display:flex;"><span><span style="color:#e06c75">x</span> = <span style="color:#e5c07b">append</span>(<span style="color:#e06c75">x</span>, <span style="color:#e06c75">y</span><span style="color:#56b6c2">...</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">x</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	如果没有那个<code>...</code>，它就会由于类型错误而无法编译；因为<code>y</code>不是int类型。</p>
<h2 id="initialization-初始化">Initialization 初始化</h2>
<p>​	虽然从表面上看Go与C或C++的初始化没有什么不同，但Go的初始化功能更强大。在初始化过程中，不仅可以构建复杂的结构，还能正确处理不同包对象间的初始化顺序。</p>
<h3 id="constants-常量">Constants 常量</h3>
<p>​	Go中的常量就是constant。它们在编译时被创建，即便它们可能是函数中定义的局部变量，常量只能是数字、字符（符文）、字符串或布尔值。由于编译时的限制，定义它们的表达式必须也是可被编译器求值的常量表达式。例如，<code>1&lt;&lt;3</code>是一个常量表达式，而<code>math.Sin(math.Pi/4)</code>则不是，因为对<code>math.Sin</code>的函数调用在运行时才会发生。</p>
<p>​	在Go中，枚举常量是使用<code>iota</code>枚举器创建的。由于<code>iota</code>可以是表达式的一部分，而且表达式可以隐式地重复，这样也就更容易构建复杂的值的集合了。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">ByteSize</span> <span style="color:#e5c07b">float64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">const</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">_</span>           = <span style="color:#e5c07b">iota</span> <span style="color:#7f848e">// ignore first value by assigning to blank identifier =&gt; 通过赋予空白标识符来忽略第一个值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">KB</span> <span style="color:#e06c75">ByteSize</span> = <span style="color:#d19a66">1</span> <span style="color:#56b6c2">&lt;&lt;</span> (<span style="color:#d19a66">10</span> <span style="color:#56b6c2">*</span> <span style="color:#e5c07b">iota</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">MB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">GB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">TB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">PB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">EB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">ZB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">YB</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	由于可将 <code>String</code> 之类的方法附加在用户定义的类型上， 因此它就为打印时自动格式化任意值提供了可能性。虽然你会看到它最常被应用于结构体，但这种技术对标量类型也很有用，如<code>ByteSize</code>等浮点类型。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">b</span> <span style="color:#e06c75">ByteSize</span>) <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">switch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">YB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fYB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">YB</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">ZB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fZB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">ZB</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">EB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fEB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">EB</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">PB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fPB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">PB</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">TB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fTB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">TB</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">GB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fGB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">GB</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">MB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fMB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">MB</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">KB</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fKB&#34;</span>, <span style="color:#e06c75">b</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">KB</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;%.2fB&#34;</span>, <span style="color:#e06c75">b</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>表达式<code>YB</code>打印为<code>1.00YB</code>，而<code>ByteSize(1e13)</code>打印为<code>9.09TB</code>。</p>
<p>​	这里使用<code>Sprintf</code>来实现<code>ByteSize</code>的<code>String</code>方法是安全的（不会无限递归），这倒不是因为类型转换，而是它以 <code>%f</code> 调用了 <code>Sprintf</code>，它并不是一个字符串格式。<strong><code>Sprintf</code>只有在需要字符串时才会调用<code>String</code>方法</strong>，而<code>%f</code>需要的是一个浮点值。</p>
<h3 id="variables-变量">Variables 变量</h3>
<p>​	变量可以像常量一样被初始化，而且可以初始化为一个可在运行时得出结果的普通表达式。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">home</span>   = <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;HOME&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">user</span>   = <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;USER&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">gopath</span> = <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;GOPATH&#34;</span>)
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="the-init-function---init-函数">The init function - init 函数</h3>
<p>​	最后，每个源文件都可以定义自己的无参数（niladic） <code>init</code>函数来设置任何需要的状态。(实际上每个文件可以有多个<code>init</code>函数。)而它的结束就意味着初始化结束： <strong>只有该包中的所有变量声明都通过它们的初始化器求值后 <code>init</code> 才会被调用</strong>， <strong>而包中的变量只有在所有已导入的包都被初始化后才会被求值</strong>。</p>
<p>​	除了那些不能被表示成声明的初始化外，<code>init</code> 函数还常被用在程序真正开始执行前，检验或校正程序的状态。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">init</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">user</span> <span style="color:#56b6c2">==</span> <span style="color:#98c379">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#98c379">&#34;$USER not set&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">home</span> <span style="color:#56b6c2">==</span> <span style="color:#98c379">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">home</span> = <span style="color:#98c379">&#34;/home/&#34;</span> <span style="color:#56b6c2">+</span> <span style="color:#e06c75">user</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">gopath</span> <span style="color:#56b6c2">==</span> <span style="color:#98c379">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">gopath</span> = <span style="color:#e06c75">home</span> <span style="color:#56b6c2">+</span> <span style="color:#98c379">&#34;/go&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// gopath may be overridden by --gopath flag on command line. =&gt; gopath 可通过命令行中的 --gopath 标记覆盖掉。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">flag</span>.<span style="color:#61afef;font-weight:bold">StringVar</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">gopath</span>, <span style="color:#98c379">&#34;gopath&#34;</span>, <span style="color:#e06c75">gopath</span>, <span style="color:#98c379">&#34;override default GOPATH&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="methods-方法">Methods 方法</h2>
<h3 id="pointers-vs-values-指针与值">Pointers vs. Values 指针与值</h3>
<p>​	正如 <code>ByteSize</code> 那样，我们可以为任何已命名的类型（除了指针或接口）定义方法； 接收器可不必为结构体。</p>
<p>​	在上面关于切片的讨论中，我们写了一个<code>Append</code>函数。我们可以把它定义为切片上的方法。要做到这一点，我们首先声明一个命名的类型，我们可以将该方法与之绑定，然后使该方法的接收器成为该类型的值。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">ByteSlice</span> []<span style="color:#e5c07b">byte</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">slice</span> <span style="color:#e06c75">ByteSlice</span>) <span style="color:#61afef;font-weight:bold">Append</span>(<span style="color:#e06c75">data</span> []<span style="color:#e5c07b">byte</span>) []<span style="color:#e5c07b">byte</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Body exactly the same as the Append function defined above. =&gt; 主体与上面定义的Append函数完全相同。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这仍然需要该方法返回更新后的切片。为了消除这种不便，我们可通过重新定义该方法， 将一个指向 <code>ByteSlice</code> 的指针作为该方法的接收器， 这样该方法就能重写调用者提供的切片了。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">p</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">ByteSlice</span>) <span style="color:#61afef;font-weight:bold">Append</span>(<span style="color:#e06c75">data</span> []<span style="color:#e5c07b">byte</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">slice</span> <span style="color:#56b6c2">:=</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">p</span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Body as above, without the return.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">p</span> = <span style="color:#e06c75">slice</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	事实上，我们可以做得更好。如果我们修改我们的函数，使它看起来像一个标准的<code>Write</code>方法，像这样：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">p</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">ByteSlice</span>) <span style="color:#61afef;font-weight:bold">Write</span>(<span style="color:#e06c75">data</span> []<span style="color:#e5c07b">byte</span>) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">slice</span> <span style="color:#56b6c2">:=</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">p</span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Again as above.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">p</span> = <span style="color:#e06c75">slice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">data</span>), <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>then the type <code>*ByteSlice</code> satisfies the standard interface <code>io.Writer</code>, which is handy. For instance, we can print into one.</p>
<p>那么<code>*ByteSlice</code>类型就满足标准接口<code>io.Writer</code>，这会很实用。例如，我们可以通过打印将内容写入。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">b</span> <span style="color:#e06c75">ByteSlice</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Fprintf</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">b</span>, <span style="color:#98c379">&#34;This hour has %d days\n&#34;</span>, <span style="color:#d19a66">7</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	我们传递一个<code>ByteSlice</code>的地址，因为只有<code>*ByteSlice</code>才满足<code>io.Writer</code>。以指针或值为接收器的区别在于：值方法可通过指针和值调用， 而指针方法只能通过指针来调用。</p>
<p>​	之所以会有这条规则是因为指针方法可以修改接收器；通过值调用它们会导致方法接收到该值的副本，故任何修改都会被丢弃。因此，Go语言不允许这种错误。不过，有一个方便的例外。<strong>当值是可寻址的，那么Go语言通过自动插入取地址操作符来处理在值上调用指针方法的常见情况</strong>。在我们的例子中，变量<code>b</code>是可寻址的，所以我们可以只用<code>b.Write</code>来调用它的<code>Write</code>方法。编译器将为我们把它重写成<code>(&amp;b).Write</code>。</p>
<p>​	顺便说一下，在字节切片上使用<code>Write</code>的想法是实现<code>bytes.Buffer</code>的核心。</p>
<h2 id="接口和其他类型">接口和其他类型</h2>
<h3 id="接口">接口</h3>
<p>​	在Go中，接口提供了一种指定对象行为的方式：如果某个东西可以做这个，那么它就可以在这里使用。我们已经见过许多简单的示例了；通过实现 <code>String</code> 方法，我们可以自定义打印函数，而<code>Fprintf</code>可以将生成输出到任何具有<code>Write</code>方法的地方。在 Go 代码中， 仅包含一两种方法的接口很常见，且其名称通常来自于实现它的方法， 如 <code>io.Writer</code> 就是实现了 <code>Write</code> 的一类对象。</p>
<p>​	每种类型都能实现多个接口。例如一个实现了 <code>sort.Interface</code> 接口的集合就可通过 <code>sort</code> 包中的例程进行排序。该接口包括了 <code>Len()</code>、<code>Less(i, j int) bool</code> 以及 <code>Swap(i, j int)</code>，另外，该集合仍然可以有一个自定义的格式化器。 以下特意构建的例子 <code>Sequence</code> 就同时满足这两种情况。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Sequence</span> []<span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// sort.Interface所需的方法。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">s</span> <span style="color:#e06c75">Sequence</span>) <span style="color:#61afef;font-weight:bold">Len</span>() <span style="color:#e5c07b">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">s</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">s</span> <span style="color:#e06c75">Sequence</span>) <span style="color:#61afef;font-weight:bold">Less</span>(<span style="color:#e06c75">i</span>, <span style="color:#e06c75">j</span> <span style="color:#e5c07b">int</span>) <span style="color:#e5c07b">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">s</span>[<span style="color:#e06c75">i</span>] &lt; <span style="color:#e06c75">s</span>[<span style="color:#e06c75">j</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">s</span> <span style="color:#e06c75">Sequence</span>) <span style="color:#61afef;font-weight:bold">Swap</span>(<span style="color:#e06c75">i</span>, <span style="color:#e06c75">j</span> <span style="color:#e5c07b">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">s</span>[<span style="color:#e06c75">i</span>], <span style="color:#e06c75">s</span>[<span style="color:#e06c75">j</span>] = <span style="color:#e06c75">s</span>[<span style="color:#e06c75">j</span>], <span style="color:#e06c75">s</span>[<span style="color:#e06c75">i</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//  Copy方法返回Sequence的副本。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">s</span> <span style="color:#e06c75">Sequence</span>) <span style="color:#61afef;font-weight:bold">Copy</span>() <span style="color:#e06c75">Sequence</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">copy</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>(<span style="color:#e06c75">Sequence</span>, <span style="color:#d19a66">0</span>, <span style="color:#e5c07b">len</span>(<span style="color:#e06c75">s</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">append</span>(<span style="color:#e06c75">copy</span>, <span style="color:#e06c75">s</span><span style="color:#56b6c2">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 用于打印的方法-在打印之前对元素进行排序。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">s</span> <span style="color:#e06c75">Sequence</span>) <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">s</span> = <span style="color:#e06c75">s</span>.<span style="color:#61afef;font-weight:bold">Copy</span>() <span style="color:#7f848e">// 创建副本；不要覆盖实参本身
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">sort</span>.<span style="color:#61afef;font-weight:bold">Sort</span>(<span style="color:#e06c75">s</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">str</span> <span style="color:#56b6c2">:=</span> <span style="color:#98c379">&#34;[&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span>, <span style="color:#e06c75">elem</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">s</span> { <span style="color:#7f848e">// 循环的时间复杂度是O(N²);将在下一个例子中修复它。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">i</span> &gt; <span style="color:#d19a66">0</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">str</span> <span style="color:#56b6c2">+=</span> <span style="color:#98c379">&#34; &#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">str</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprint</span>(<span style="color:#e06c75">elem</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">str</span> <span style="color:#56b6c2">+</span> <span style="color:#98c379">&#34;]&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="转换">转换</h3>
<p>​	<code>Sequence</code> 的 <code>String</code> 方法重新实现了 <code>Sprint</code> 为切片实现的功能。（它还具有O(N²)的复杂度，这是很差的。）若我们在调用 <code>Sprint</code> 之前将 <code>Sequence</code> 转换为纯粹的 <code>[]int</code>，就能共享已实现的功能。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">s</span> <span style="color:#e06c75">Sequence</span>) <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">s</span> = <span style="color:#e06c75">s</span>.<span style="color:#61afef;font-weight:bold">Copy</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">sort</span>.<span style="color:#61afef;font-weight:bold">Sort</span>(<span style="color:#e06c75">s</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprint</span>([]<span style="color:#e5c07b">int</span>(<span style="color:#e06c75">s</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	该方法是通过类型转换技术，在 <code>String</code> 方法中安全调用 <code>Sprintf</code> 的另个一例子。若我们忽略类型名的话，这两种类型（<code>Sequence</code> 和 <code>[]int</code>）其实是相同的，因此在二者之间进行转换是合法的。 转换过程并不会创建新值，它只是暂时让现有的值看起来有个新类型而已。 （还有些合法转换则会创建新值，如从整数转换为浮点数等。）</p>
<p>​	在Go程序中，为访问不同的方法集而进行类型转换的情况非常常见。例如，我们可以使用现有的<code>sort.IntSlice</code>类型类型来简化整个示例：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Sequence</span> []<span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 打印方法-在打印之前对元素进行排序
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">s</span> <span style="color:#e06c75">Sequence</span>) <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">s</span> = <span style="color:#e06c75">s</span>.<span style="color:#61afef;font-weight:bold">Copy</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">sort</span>.<span style="color:#61afef;font-weight:bold">IntSlice</span>(<span style="color:#e06c75">s</span>).<span style="color:#61afef;font-weight:bold">Sort</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprint</span>([]<span style="color:#e5c07b">int</span>(<span style="color:#e06c75">s</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	现在，不必让 <code>Sequence</code> 实现多个接口（排序和打印）， 我们可通过将数据项转换为多种类型（<code>Sequence</code>、<code>sort.IntSlice</code>和<code>[]int</code>）来使用相应的功能。这在实践中比较少见，但往往却很有效。</p>
<h3 id="接口转换和类型断言">接口转换和类型断言</h3>
<p>​	<a href="#type-switch">类型开关</a>是一种类型转换形式：它们接受一种接口，在开关 （switch）中根据其判断选择对应的情况（case），并在某种意义上将其转换为该种类型。以下代码为<code>fmt.Printf</code>通过使用类型开关将一个值变成一个字符串的简化版本。若它已经为字符串，我们想要接口持有的实际字符串值，若它有 String 方法，我们想要调用该方法所得的结果。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Stringer</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">String</span>() <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">value</span> <span style="color:#c678dd">interface</span>{} <span style="color:#7f848e">// value 由调用者提供
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">switch</span> <span style="color:#e06c75">str</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">value</span>.(<span style="color:#c678dd">type</span>) {
</span></span><span style="display:flex;"><span><span style="color:#c678dd">case</span> <span style="color:#e5c07b">string</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">str</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">case</span> <span style="color:#e06c75">Stringer</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">str</span>.<span style="color:#61afef;font-weight:bold">String</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	第一个<code>case</code>获取了一个具体的值；第二个<code>case</code>将该接口转换为另一个接口。这种方式对于混合类型来说非常完美。</p>
<p>​	如果我们只关心一种类型呢？如果我们知道这个值持有一个<code>string</code>类型，而我们只想提取它？ 只需一种情况的类型开关就行，但它需要<strong>类型断言</strong>。类型断言接受一个接口值并从中提取一个指定的显式类型的值。这种语法借鉴自类型开关开头的子句，但它需要一个显式的类型名， 而非 <code>type</code> 关键字：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">value</span>.(<span style="color:#e06c75">typeName</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>而其结果则是具有静态类型 <code>typeName</code> 的新值。该类型必须是该接口所持有的具体类型，或者是该值可以被转换为的第二种接口类型。为了提取我们知道在该值中的字符串，我们可以写：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">str</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">value</span>.(<span style="color:#e5c07b">string</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>以下给出示例来解释下：该类型必须是该接口所持有的具体类型，或者是该值可以被转换为的第二种接口类型。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Animal</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">MakeSound</span>() <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Dog</span> <span style="color:#c678dd">struct</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">d</span> <span style="color:#e06c75">Dog</span>) <span style="color:#61afef;font-weight:bold">MakeSound</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#98c379">&#34;Bark!&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Cat</span> <span style="color:#c678dd">struct</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">c</span> <span style="color:#e06c75">Cat</span>) <span style="color:#61afef;font-weight:bold">MakeSound</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#98c379">&#34;Meow!&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">MakeSpecificSound</span>(<span style="color:#e06c75">a</span> <span style="color:#e06c75">Animal</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">d</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">a</span>.(<span style="color:#e06c75">Dog</span>); <span style="color:#e06c75">ok</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">d</span>.<span style="color:#61afef;font-weight:bold">MakeSound</span>())
</span></span><span style="display:flex;"><span>    } <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#e06c75">c</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">a</span>.(<span style="color:#e06c75">Cat</span>); <span style="color:#e06c75">ok</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">c</span>.<span style="color:#61afef;font-weight:bold">MakeSound</span>())
</span></span><span style="display:flex;"><span>    } <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;Unknown animal type!&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>​	但是如果结果发现值不包含字符串，程序就会因运行时错误而崩溃。为了防止这种情况的发生，可以使用&quot;comma, ok&quot;惯用测试它能安全地判断该值是否为字符串：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">str</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">value</span>.(<span style="color:#e5c07b">string</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">ok</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;string value is: %q\n&#34;</span>, <span style="color:#e06c75">str</span>)
</span></span><span style="display:flex;"><span>} <span style="color:#c678dd">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;value is not a string\n&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	如果类型断言失败，<code>str</code>仍然存在，并且是字符串类型，但它将拥有零值，即空字符串。</p>
<p>​	作为（&ldquo;comma, ok&rdquo;）能力的说明，这里有一个<code>if-else</code>语句，相当于本节开头的类型开关。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">str</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">value</span>.(<span style="color:#e5c07b">string</span>); <span style="color:#e06c75">ok</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">str</span>
</span></span><span style="display:flex;"><span>} <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#e06c75">str</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">value</span>.(<span style="color:#e06c75">Stringer</span>); <span style="color:#e06c75">ok</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">str</span>.<span style="color:#61afef;font-weight:bold">String</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="通用性">通用性</h3>
<p>​	如果一个类型只是为了实现一个接口而存在，并且永远不会有除了这个接口以外的导出方法，那么就没必要导出这个类型本身。仅导出接口可以清晰地表明该值除了接口描述的行为之外没有其他有趣的行为。它还避免了在每个常见方法的实例上重复文档的必要。</p>
<p>​	在这种情况下，构造函数应该返回一个接口值而非实现的类型。举个例子，在 hash 库中，<code>crc32.NewIEEE</code>和<code>adler32.New</code>都返回接口类型<code>hash.Hash32</code>。在Go程序中用<code>CRC-32算法</code>代替<code>Adler-32</code>，只需要改变构造函数的调用；其余的代码不受算法改变的影响。</p>
<p>​	在这种情况下，构造函数应该返回一个接口值而不是实现的类型。例如，在hash 库中，<code>crc32.NewIEEE</code> 和 <code>adler32.New</code> 都返回接口类型 <code>hash.Hash32</code>。在 Go 程序中，将 <code>CRC-32</code> 算法替换为 <code>Adler-32</code> 算法仅需要更改构造函数调用；其余代码不受算法更改的影响。</p>
<p>​	类似的方法也允许将各种<code>crypto</code>包中的流式加密算法与它们连接在一起的块加密算法分离开来。在 <code>crypto/cipher</code> 包中，<code>Block</code> 接口指定了块加密的行为，它提供单个数据块的加密。然后，与 <code>bufio</code> 包类似，任何实现了该接口的加密包都能被用于构造以 Stream 为接口表示的流加密，而无需知道块加密的细节。</p>
<p>​	<code>crypto/cipher</code> 接口如下：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Block</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">BlockSize</span>() <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">Encrypt</span>(<span style="color:#e06c75">dst</span>, <span style="color:#e06c75">src</span> []<span style="color:#e5c07b">byte</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">Decrypt</span>(<span style="color:#e06c75">dst</span>, <span style="color:#e06c75">src</span> []<span style="color:#e5c07b">byte</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Stream</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">XORKeyStream</span>(<span style="color:#e06c75">dst</span>, <span style="color:#e06c75">src</span> []<span style="color:#e5c07b">byte</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	以下是计数器模式（CTR）流的定义，它将块加密转换为流加密；请注意块加密的细节已被抽象掉：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// NewCTR returns a Stream that encrypts/decrypts using the given Block in
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// counter mode. The length of iv must be the same as the Block&#39;s block size.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">NewCTR</span>(<span style="color:#e06c75">block</span> <span style="color:#e06c75">Block</span>, <span style="color:#e06c75">iv</span> []<span style="color:#e5c07b">byte</span>) <span style="color:#e06c75">Stream</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>NewCTR</code> 的应用并不仅限于特定的加密算法和数据源，它适用于任何对 <code>Block</code> 接口和 <code>Stream</code> 的实现。因为它们返回接口值，所以将 CTR 加密替换为其他加密模式是一种局部化的变更。构造函数的调用过程必须被修改， 但由于其周围的代码只能将它看做 <code>Stream</code>，因此它们不会注意到其中的区别。</p>
<h3 id="接口和方法">接口和方法</h3>
<p>​	由于几乎任何类型都能添加方法，因此几乎任何类型都能满足一个接口。一个很直观的例子就是 <code>http</code> 包中定义的 <code>Handler</code> 接口。任何实现了 <code>Handler</code> 的对象都能够处理 HTTP 请求。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Handler</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">ServeHTTP</span>(<span style="color:#e06c75">ResponseWriter</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>ResponseWriter</code> 本身是一个接口，它提供了返回给客户端响应所需的方法。这些方法包括标准的 <code>Write</code> 方法，因此 <code>http.ResponseWriter</code> 可以在任何需要 <code>io.Writer</code> 的地方使用。<code>Request</code> 是一个包含来自客户端的请求的解析表示的结构体。</p>
<p>​	为简单起见，我们假设所有的 HTTP 请求都是 GET 方法，而忽略 POST 方法， 这种简化不会影响处理程序的建立方式。这里有个短小却完整的处理程序实现， 它用于记录某个页面被访问的次数。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// 简单的计数器服务器。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Counter</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">ctr</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Counter</span>) <span style="color:#61afef;font-weight:bold">ServeHTTP</span>(<span style="color:#e06c75">w</span> <span style="color:#e06c75">http</span>.<span style="color:#e06c75">ResponseWriter</span>, <span style="color:#e06c75">req</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">http</span>.<span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">ctr</span>.<span style="color:#e06c75">n</span><span style="color:#56b6c2">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Fprintf</span>(<span style="color:#e06c75">w</span>, <span style="color:#98c379">&#34;counter = %d\n&#34;</span>, <span style="color:#e06c75">ctr</span>.<span style="color:#e06c75">n</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>(与我们的主题保持一致，注意<code>Fprintf</code>如何打印到<code>http.ResponseWriter</code>。) 在一个真正的服务器中，对 <code>ctr.n</code> 的访问将需要防止并发访问。请参见<code>sync</code>和<code>atomic</code>包以获取建议。</p>
<p>​	作为参考，这里演示了如何将这样一个服务器添加到 URL 树的一个节点上。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#98c379">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">ctr</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">new</span>(<span style="color:#e06c75">Counter</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">Handle</span>(<span style="color:#98c379">&#34;/counter&#34;</span>, <span style="color:#e06c75">ctr</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	但是为什么要将<code>Counter</code>定义为一个结构体呢？只需要一个整数即可。（接收器必须为指针，增量操作对于调用者才可见。）</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// 简单的计数器服务器。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Counter</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">ctr</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Counter</span>) <span style="color:#61afef;font-weight:bold">ServeHTTP</span>(<span style="color:#e06c75">w</span> <span style="color:#e06c75">http</span>.<span style="color:#e06c75">ResponseWriter</span>, <span style="color:#e06c75">req</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">http</span>.<span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">ctr</span><span style="color:#56b6c2">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Fprintf</span>(<span style="color:#e06c75">w</span>, <span style="color:#98c379">&#34;counter = %d\n&#34;</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">ctr</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	当页面被访问时，怎样通知你的程序去更新一些内部状态呢？为 Web 页面绑定个通道吧。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// 每次浏览该通道都会发送一个提醒。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// （可能需要带缓冲的通道。）
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Chan</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">http</span>.<span style="color:#e06c75">Request</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">ch</span> <span style="color:#e06c75">Chan</span>) <span style="color:#61afef;font-weight:bold">ServeHTTP</span>(<span style="color:#e06c75">w</span> <span style="color:#e06c75">http</span>.<span style="color:#e06c75">ResponseWriter</span>, <span style="color:#e06c75">req</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">http</span>.<span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">ch</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#e06c75">req</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Fprint</span>(<span style="color:#e06c75">w</span>, <span style="color:#98c379">&#34;notification sent&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	最后，假设我们想在<code>/args</code>上展示调用服务器二进制文件时使用的参数。编写一个函数来打印这些参数是很容易的。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">ArgServer</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">os</span>.<span style="color:#e06c75">Args</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	我们如何将它转换为 HTTP 服务器呢？我们可以将 <code>ArgServer</code> 实现为某种可忽略值的方法，不过还有种更简单的方法。 既然我们可以为除指针和接口以外的任何类型定义方法，同样也能为一个函数写一个方法。 <code>http</code> 包里有这样的代码：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// HandlerFunc 类型是一个适配器，
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 它允许将普通函数用做HTTP处理程序。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 若 f 是个具有适当签名的函数，
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// HandlerFunc(f) 就是个调用 f 的处理程序对象。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">HandlerFunc</span> <span style="color:#c678dd">func</span>(<span style="color:#e06c75">ResponseWriter</span>, <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// ServeHTTP 调用f(w, req).
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">f</span> <span style="color:#e06c75">HandlerFunc</span>) <span style="color:#61afef;font-weight:bold">ServeHTTP</span>(<span style="color:#e06c75">w</span> <span style="color:#e06c75">ResponseWriter</span>, <span style="color:#e06c75">req</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">f</span>(<span style="color:#e06c75">w</span>, <span style="color:#e06c75">req</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>HandlerFunc</code>是一个具有<code>ServeHTTP</code>方法的类型，因此该类型的值可以用作HTTP请求的处理程序。看看该方法的实现：接收器是一个函数<code>f</code>，而该方法调用<code>f</code>。这可能看起来有些奇怪，但与接收器是通道并且方法在通道上发送的情况并没有太大的区别。</p>
<p>​	为了使<code>ArgServer</code>成为一个HTTP服务器，我们首先要修改它，使其具有正确的签名。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Argument server.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">ArgServer</span>(<span style="color:#e06c75">w</span> <span style="color:#e06c75">http</span>.<span style="color:#e06c75">ResponseWriter</span>, <span style="color:#e06c75">req</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">http</span>.<span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Fprintln</span>(<span style="color:#e06c75">w</span>, <span style="color:#e06c75">os</span>.<span style="color:#e06c75">Args</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>ArgServer</code>现在具有与<code>HandlerFunc</code>相同的签名，所以它可以被转换为该类型以访问其方法，就像我们将<code>Sequence</code>转换为<code>IntSlice</code>以访问<code>IntSlice.Sort</code>一样。设置它的代码很简洁：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">Handle</span>(<span style="color:#98c379">&#34;/args&#34;</span>, <span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">HandlerFunc</span>(<span style="color:#e06c75">ArgServer</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	当有人访问页面<code>/args</code>时，在该页面安装的处理程序具有值<code>ArgServer</code>和类型<code>HandlerFunc</code>。HTTP服务器将调用该类型的<code>ServeHTTP</code>方法，并以<code>ArgServer</code>作为接收器，接着调用<code>ArgServer</code>（通过<code>HandlerFunc.ServeHTTP</code>内的<code>f(w, req)</code>调用）。然后，参数将被显示出来。</p>
<p>​	在本节中，我们从结构体、整数、通道和函数制作了一个HTTP服务器，这是因为接口只是方法集，可以为（几乎）任何类型定义方法。</p>
<h2 id="the-blank-identifier-空白标识符">The blank identifier 空白标识符</h2>
<p>We&rsquo;ve mentioned the blank identifier a couple of times now, in the context of <a href="https://go.dev/doc/effective_go#for" target="_blank" rel="noopener"><code>for</code> <code>range</code> loops</a> and <a href="https://go.dev/doc/effective_go#maps" target="_blank" rel="noopener">maps</a>. The blank identifier can be assigned or declared with any value of any type, with the value discarded harmlessly. It&rsquo;s a bit like writing to the Unix <code>/dev/null</code> file: it represents a write-only value to be used as a place-holder where a variable is needed but the actual value is irrelevant. It has uses beyond those we&rsquo;ve seen already.</p>
<p>我们已经在for range循环和map的背景下提到过几次空白标识符。空白标识符可以被分配或声明为任何类型的任何值，其值会被无害地丢弃。它有点像写到Unix的/dev/null文件：它代表一个只写的值，在需要变量但实际值不相关的情况下作为一个占位符使用。它的用途超出了我们已经看到的那些。</p>
<h3 id="the-blank-identifier-in-multiple-assignment-多重赋值中的空白标识符">The blank identifier in multiple assignment 多重赋值中的空白标识符</h3>
<p>The use of a blank identifier in a <code>for</code> <code>range</code> loop is a special case of a general situation: multiple assignment.</p>
<p>在for range循环中使用空白标识符是一般情况下的一个特殊情况：多重赋值。</p>
<p>If an assignment requires multiple values on the left side, but one of the values will not be used by the program, a blank identifier on the left-hand-side of the assignment avoids the need to create a dummy variable and makes it clear that the value is to be discarded. For instance, when calling a function that returns a value and an error, but only the error is important, use the blank identifier to discard the irrelevant value.</p>
<p>如果一个赋值在左边需要多个值，但其中一个值不会被程序使用，在赋值的左边使用空白标识符可以避免创建一个虚拟变量，并清楚地表明该值将被丢弃。例如，当调用一个返回一个值和一个错误的函数，但只有错误是重要的，使用空白标识符来丢弃不相关的值。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">_</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Stat</span>(<span style="color:#e06c75">path</span>); <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">IsNotExist</span>(<span style="color:#e06c75">err</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%s does not exist\n&#34;</span>, <span style="color:#e06c75">path</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Occasionally you&rsquo;ll see code that discards the error value in order to ignore the error; this is terrible practice. Always check error returns; they&rsquo;re provided for a reason.</p>
<p>偶尔你会看到为了忽略错误而丢弃错误值的代码；这是很糟糕的做法。一定要检查错误返回；它们的出现是有原因的。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Bad! This code will crash if path does not exist.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">fi</span>, <span style="color:#e06c75">_</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Stat</span>(<span style="color:#e06c75">path</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">fi</span>.<span style="color:#61afef;font-weight:bold">IsDir</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%s is a directory\n&#34;</span>, <span style="color:#e06c75">path</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="unused-imports-and-variables-未使用的导入和变量">Unused imports and variables 未使用的导入和变量</h3>
<p>It is an error to import a package or to declare a variable without using it. Unused imports bloat the program and slow compilation, while a variable that is initialized but not used is at least a wasted computation and perhaps indicative of a larger bug. When a program is under active development, however, unused imports and variables often arise and it can be annoying to delete them just to have the compilation proceed, only to have them be needed again later. The blank identifier provides a workaround.</p>
<p>导入一个包或声明一个变量而不使用它是一个错误。未使用的导入会使程序变得臃肿，并使编译速度变慢，而一个被初始化但未使用的变量至少是一个浪费的计算，并可能表明一个更大的错误。然而，当一个程序处于活跃的开发阶段时，未使用的导入和变量经常出现，为了让编译继续进行而删除它们是很烦人的，但以后又会再次需要它们。空白标识符提供了一个变通办法。</p>
<p>This half-written program has two unused imports (<code>fmt</code> and <code>io</code>) and an unused variable (<code>fd</code>), so it will not compile, but it would be nice to see if the code so far is correct.</p>
<p>这个写了一半的程序有两个未使用的导入（fmt和io）和一个未使用的变量（fd），所以它不会被编译，但是看看到目前为止的代码是否正确也不错。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">package</span> <span style="color:#e06c75">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fd</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;test.go&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// TODO: use fd.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>To silence complaints about the unused imports, use a blank identifier to refer to a symbol from the imported package. Similarly, assigning the unused variable <code>fd</code> to the blank identifier will silence the unused variable error. This version of the program does compile.</p>
<p>为了消除对未使用的导入的抱怨，使用一个空白标识符来引用导入包中的符号。同样地，将未使用的变量fd分配给空白标识符，将使未使用的变量错误不再出现。这个版本的程序确实可以编译。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">package</span> <span style="color:#e06c75">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">_</span> = <span style="color:#e06c75">fmt</span>.<span style="color:#e06c75">Printf</span> <span style="color:#7f848e">// For debugging; delete when done.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">var</span> <span style="color:#e06c75">_</span> <span style="color:#e06c75">io</span>.<span style="color:#e06c75">Reader</span>    <span style="color:#7f848e">// For debugging; delete when done.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fd</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;test.go&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// TODO: use fd.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">_</span> = <span style="color:#e06c75">fd</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>By convention, the global declarations to silence import errors should come right after the imports and be commented, both to make them easy to find and as a reminder to clean things up later.</p>
<p>按照约定，用于消除导入错误的全局声明应该紧跟在导入之后，并加以注释，这既是为了让它们容易被发现，也是为了提醒人们以后要清理好。</p>
<h3 id="import-for-side-effect-导入的副作用">Import for side effect 导入的副作用</h3>
<p>An unused import like <code>fmt</code> or <code>io</code> in the previous example should eventually be used or removed: blank assignments identify code as a work in progress. But sometimes it is useful to import a package only for its side effects, without any explicit use. For example, during its <code>init</code> function, the <code>net/http/pprof</code> package registers HTTP handlers that provide debugging information. It has an exported API, but most clients need only the handler registration and access the data through a web page. To import the package only for its side effects, rename the package to the blank identifier:</p>
<p>像前面例子中的fmt或io这样的未使用的导入，最终应该被使用或删除：空白的赋值表明代码正在进行中。但有时导入一个包只是为了它的副作用，而没有任何明确的用途，是很有用的。例如，在其初始函数中，net/http/pprof 包注册了提供调试信息的 HTTP 处理程序。它有一个导出的API，但大多数客户端只需要注册处理程序，并通过网页访问数据。要想只为它的副作用导入包，请将包重命名为空白标识符：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">_</span> <span style="color:#98c379">&#34;net/http/pprof&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This form of import makes clear that the package is being imported for its side effects, because there is no other possible use of the package: in this file, it doesn&rsquo;t have a name. (If it did, and we didn&rsquo;t use that name, the compiler would reject the program.)</p>
<p>这种形式的导入清楚地表明该包是为了其副作用而被导入的，因为该包没有其他可能的用途：在这个文件中，它没有一个名字。(如果它有，而我们没有使用这个名字，编译器会拒绝这个程序）。</p>
<h3 id="interface-checks-接口检查">Interface checks 接口检查</h3>
<p>As we saw in the discussion of <a href="https://go.dev/doc/effective_go#interfaces_and_types" target="_blank" rel="noopener">interfaces</a> above, a type need not declare explicitly that it implements an interface. Instead, a type implements the interface just by implementing the interface&rsquo;s methods. In practice, most interface conversions are static and therefore checked at compile time. For example, passing an <code>*os.File</code> to a function expecting an <code>io.Reader</code> will not compile unless <code>*os.File</code> implements the <code>io.Reader</code> interface.</p>
<p>正如我们在上面关于接口的讨论中看到的，一个类型不需要明确声明它实现了一个接口。相反，一个类型只是通过实现该接口的方法来实现该接口。在实践中，大多数接口的转换都是静态的，因此在编译时进行检查。例如，将一个<em>os.File传递给一个期望有io.Reader的函数，除非</em>os.File实现了io.Reader接口，否则不会被编译。</p>
<p>Some interface checks do happen at run-time, though. One instance is in the <code>encoding/json</code> package, which defines a <code>Marshaler</code> interface. When the JSON encoder receives a value that implements that interface, the encoder invokes the value&rsquo;s marshaling method to convert it to JSON instead of doing the standard conversion. The encoder checks this property at run time with a <a href="https://go.dev/doc/effective_go#interface_conversions" target="_blank" rel="noopener">type assertion</a> like:</p>
<p>不过，有些接口检查确实发生在运行时。一个例子是在编码/json包中，它定义了一个Marshaler接口。当JSON编码器收到一个实现该接口的值时，编码器会调用该值的marshaling方法将其转换为JSON，而不是做标准转换。编码器在运行时用一个类型断言来检查这个属性，比如：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">m</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">val</span>.(<span style="color:#e06c75">json</span>.<span style="color:#e06c75">Marshaler</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>If it&rsquo;s necessary only to ask whether a type implements an interface, without actually using the interface itself, perhaps as part of an error check, use the blank identifier to ignore the type-asserted value:</p>
<p>如果只需要询问一个类型是否实现了一个接口，而没有实际使用该接口本身，也许是作为错误检查的一部分，使用空白标识符来忽略类型断言的值：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">_</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">val</span>.(<span style="color:#e06c75">json</span>.<span style="color:#e06c75">Marshaler</span>); <span style="color:#e06c75">ok</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;value %v of type %T implements json.Marshaler\n&#34;</span>, <span style="color:#e06c75">val</span>, <span style="color:#e06c75">val</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>One place this situation arises is when it is necessary to guarantee within the package implementing the type that it actually satisfies the interface. If a type—for example, <code>json.RawMessage</code>—needs a custom JSON representation, it should implement <code>json.Marshaler</code>, but there are no static conversions that would cause the compiler to verify this automatically. If the type inadvertently fails to satisfy the interface, the JSON encoder will still work, but will not use the custom implementation. To guarantee that the implementation is correct, a global declaration using the blank identifier can be used in the package:</p>
<p>这种情况出现的一个地方是，当有必要在实现该类型的包中保证它确实满足接口。如果一个类型——例如json.RawMessage——需要一个自定义的JSON表示法，它应该实现json.Marshaler，但是没有静态转换可以使编译器自动验证这一点。如果该类型无意中未能满足接口，JSON编码器仍将工作，但不会使用自定义的实现。为了保证实现的正确性，可以在包中使用一个使用空白标识符的全局声明：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">_</span> <span style="color:#e06c75">json</span>.<span style="color:#e06c75">Marshaler</span> = (<span style="color:#56b6c2">*</span><span style="color:#e06c75">RawMessage</span>)(<span style="color:#e5c07b">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this declaration, the assignment involving a conversion of a <code>*RawMessage</code> to a <code>Marshaler</code> requires that <code>*RawMessage</code> implements <code>Marshaler</code>, and that property will be checked at compile time. Should the <code>json.Marshaler</code> interface change, this package will no longer compile and we will be on notice that it needs to be updated.</p>
<p>在这个声明中，涉及到将<em>RawMessage转换为Marshaler的赋值要求</em>RawMessage实现Marshaler，并且该属性将在编译时被检查。如果json.Marshaler接口发生变化，这个包将不再编译，我们将注意到它需要被更新。</p>
<p>The appearance of the blank identifier in this construct indicates that the declaration exists only for the type checking, not to create a variable. Don&rsquo;t do this for every type that satisfies an interface, though. By convention, such declarations are only used when there are no static conversions already present in the code, which is a rare event.</p>
<p>在这个结构中出现的空白标识符表明，这个声明只是为了进行类型检查而存在，而不是为了创建一个变量。不过，不要对每个满足接口的类型都这样做。根据约定，只有在代码中没有静态转换时才会使用这种声明，而这是一种罕见的情况。</p>
<h2 id="嵌入">嵌入</h2>
<p>​	Go语言并没有提供传统的基于类型的子类概念，但它可以通过在结构体或接口中嵌入类型来&quot;借用&quot;实现的一部分。</p>
<p>​	接口嵌入非常简单。我们之前提到了<code>io.Reader</code>和<code>io.Writer</code>接口; 以下是它们的定义。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Reader</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">p</span> []<span style="color:#e5c07b">byte</span>) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Writer</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">Write</span>(<span style="color:#e06c75">p</span> []<span style="color:#e5c07b">byte</span>) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>io</code>包还导出了几个其他接口，用于指定可以实现多个这样的方法的对象。例如，有一个<code>io.ReadWriter</code>，一个包含<code>Read</code>和<code>Write</code>方法的接口。我们可以通过显式列出这两种方法来指定<code>io.ReadWriter</code>，但通过嵌入这两个接口来形成新接口更容易且更具启示性，就像这样：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// ReadWriter是将Reader和Writer接口结合在一起的接口。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">ReadWriter</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Reader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Writer</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这就是它看起来的样子：<code>ReadWriter</code>可以像<code>Reader</code>和<code>Writer</code>一样执行操作；它是嵌入接口们的并集。只有接口可以嵌入到接口中。</p>
<p>​	相同的基本思想也适用于结构体，但影响更为深远。<code>bufio</code>包有两个结构体类型<code>bufio.Reader</code>和<code>bufio.Writer</code>，它们分别实现了来自<code>io</code>包的相应接口。而且<code>bufio</code>还实现了一个缓冲reader/writer，它通过使用嵌入将reader 和writer组合成一个结构体来实现：它列出了结构体内的类型，但不给它们字段名。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// ReadWriter存储Reader和Writer的指针。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 它实现了io.ReadWriter。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">ReadWriter</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">Reader</span>  <span style="color:#7f848e">// *bufio.Reader
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">Writer</span>  <span style="color:#7f848e">// *bufio.Writer
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	嵌入的元素是结构体的指针，在使用之前必须初始化为指向有效的结构体。<code>ReadWriter</code>结构体可以编写为：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">ReadWriter</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">reader</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Reader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">writer</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Writer</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	但是为了促进字段的方法并满足<code>io</code>接口，我们还需要提供转发方法，就像这样：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">rw</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">ReadWriter</span>) <span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">p</span> []<span style="color:#e5c07b">byte</span>) (<span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">rw</span>.<span style="color:#e06c75">reader</span>.<span style="color:#61afef;font-weight:bold">Read</span>(<span style="color:#e06c75">p</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	通过直接嵌入结构体，我们避免了这种繁琐的工作。嵌入类型的方法会自动继承，这意味着<code>bufio.ReadWriter</code>不仅具有<code>bufio.Reader</code>和<code>bufio.Writer</code>的方法，还满足了所有三个接口：<code>io.Reader</code>，<code>io.Writer</code>和<code>io.ReadWriter</code>。</p>
<p>​	嵌入与子类化的一个重要区别是，当我们嵌入类型时，该类型的方法成为外部类型的方法，但是当它们被调用时，方法的接收器是内部类型，而不是外部类型。在我们的例子中，当<code>bufio.ReadWriter</code>的<code>Read</code>方法被调用时，它的效果与上面写出的转发方法完全相同；接收器是<code>ReadWriter</code>的<code>reader</code>字段，而不是<code>ReadWriter</code>本身。</p>
<p>​	嵌入也可以是一个简单的便利。这个例子展示了一个嵌入字段和一个常规命名字段。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Job</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Command</span> <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">*</span><span style="color:#e06c75">log</span>.<span style="color:#e06c75">Logger</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	现在，<code>Job</code>类型具有<code>*log.Logger</code>的<code>Print</code>，<code>Printf</code>，<code>Println</code>和其他方法。当然，我们可以给<code>Logger</code>一个字段名，但没有必要这样做。现在，一旦初始化，我们就可以用<code>Job</code>记录：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">job</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;starting now...&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>Logger</code>是<code>Job</code>结构的常规字段，因此我们可以在<code>Job</code>的构造函数中按照通常的方式进行初始化，例如：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">NewJob</span>(<span style="color:#e06c75">command</span> <span style="color:#e5c07b">string</span>, <span style="color:#e06c75">logger</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">log</span>.<span style="color:#e06c75">Logger</span>) <span style="color:#56b6c2">*</span><span style="color:#e06c75">Job</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">Job</span>{<span style="color:#e06c75">command</span>, <span style="color:#e06c75">logger</span>}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>或者使用复合字面值，例如：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">job</span> <span style="color:#56b6c2">:=</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">Job</span>{<span style="color:#e06c75">command</span>, <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">New</span>(<span style="color:#e06c75">os</span>.<span style="color:#e06c75">Stderr</span>, <span style="color:#98c379">&#34;Job: &#34;</span>, <span style="color:#e06c75">log</span>.<span style="color:#e06c75">Ldate</span>)}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	如果我们需要直接引用嵌入字段，则字段名称作为字段名，忽略包限定符，就像在我们的<code>ReadWriter</code>结构的<code>Read</code>方法中一样。在这里，如果我们需要访问<code>Job</code>变量<code>job</code>的<code>*log.Logger</code>，则会写成<code>job.Logger</code>，这对于我们想完善<code>Logger</code>的方法很有用。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">job</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Job</span>) <span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#e06c75">format</span> <span style="color:#e5c07b">string</span>, <span style="color:#e06c75">args</span> <span style="color:#56b6c2">...</span><span style="color:#c678dd">interface</span>{}) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">job</span>.<span style="color:#e06c75">Logger</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;%q: %s&#34;</span>, <span style="color:#e06c75">job</span>.<span style="color:#e06c75">Command</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#e06c75">format</span>, <span style="color:#e06c75">args</span><span style="color:#56b6c2">...</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	嵌入类型引入了名称冲突的问题，但解决它们的规则很简单。首先，一个名为<code>X</code>的字段或方法会覆盖在类型的更深嵌套部分中出现的任何其他<code>X</code>项。如果<code>log.Logger</code>包含一个名为<code>Command</code>的字段或方法，则<code>Job</code>的<code>Command</code>字段将覆盖它。</p>
<p>​	其次，如果在相同的嵌套级别上出现相同的名称，通常会出现错误；如果Job结构包含另一个名为<code>Logger</code>的字段或方法，则嵌入<code>log.Logger</code>将是错误的。但是，如果在程序类型定义之外从未提到重复的名称，则没有问题。这种限定提供了一些保护，以防从外部嵌入的类型进行更改；如果添加了与另一个子类型中的另一个字段冲突的字段，但若两个字段都从未被使用，则没有问题。（不好理解，以下给出ChatGPT给出的示例）</p>
<blockquote>
<p>下面是一个示例，演示了嵌入类型中出现相同名称时，只要名称没有被使用，程序就不会有问题：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">package</span> <span style="color:#e06c75">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#98c379">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">A</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Field</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">B</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Field</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">C</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">A</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">B</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">c</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">C</span>{<span style="color:#e06c75">A</span>{<span style="color:#d19a66">1</span>}, <span style="color:#e06c75">B</span>{<span style="color:#d19a66">2</span>}}
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">c</span>.<span style="color:#e06c75">A</span>.<span style="color:#e06c75">Field</span>) <span style="color:#7f848e">// 输出 1
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">c</span>.<span style="color:#e06c75">B</span>.<span style="color:#e06c75">Field</span>) <span style="color:#7f848e">// 输出 2
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个例子中，我们定义了三个类型 <code>A</code>、<code>B</code> 和 <code>C</code>。类型 <code>C</code> 嵌入了类型 <code>A</code> 和类型 <code>B</code>，这两个类型中都包含一个名为 <code>Field</code> 的字段。然而，在程序中，我们只是用 <code>A.Field</code> 和 <code>B.Field</code> 分别访问了这两个字段，而没有直接使用 <code>Field</code> 这个名称。因此，即使 <code>A</code> 和 <code>B</code> 中的 <code>Field</code> 字段有名称冲突，程序仍然能够正确编译和运行。</p>
<p>这个例子说明了 Effective Go 中提到的规则，即只要冲突的名称没有被使用到，就不会有问题。但需要注意的是，这并不代表名称冲突是可以被忽略的，因为一旦使用了相同名称的字段或方法，就会导致编译错误或运行错误。</p>
</blockquote>
<h2 id="并发">并发</h2>
<h3 id="通过通信共享">通过通信共享</h3>
<p>​	并发编程是一个广泛的主题，在这里只有一些与 Go 有关的亮点。</p>
<p>​	在许多环境中，并发编程由于需要实现对共享变量的正确访问而变得困难。Go 鼓励采用一种不同的方法，在其中共享值通过通道传递，实际上，不由执行的分离线程主动共享。任何时候只有一个 goroutine 可以访问该值。由于设计原因，数据竞争不会发生。为了鼓励这种思考方式，我们将其简化为一个口号：</p>
<blockquote>
<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>
<p>不要通过共享内存来通信；相反，通过通信来共享内存。</p>
</blockquote>
<p>​	这种方法可能会走得太远。例如，引用计数最好通过在整数变量周围放置互斥锁来完成。但作为一种高级方法，使用通道来控制访问，使编写清晰、正确的程序更容易。</p>
<p>​	从某种角度来看，这种模型可以理解为在一个 CPU 上运行的典型单线程程序。它不需要同步原语。现在再运行另一个实例；它也不需要同步。现在让这两个实例通信；如果通信是同步器，那么就没有其他同步的需要。例如，Unix 管道完全符合这个模型。虽然 Go 的并发方法起源于 Hoare 的通信顺序进程 (CSP)，但它也可以看作是 Unix 管道的类型安全的概括。</p>
<h3 id="goroutines">Goroutines</h3>
<p>​	它们被称为 goroutines，因为现有的术语——线程、协程、进程等——传达了不准确的内涵。goroutine 有一个简单的模型：它是一个与同一地址空间中的其他 goroutine 并发执行的函数。它是轻量级的，成本几乎只有栈空间的分配。栈开始很小，所以它们很便宜，并通过根据需要分配（和释放）堆存储来增长。</p>
<p>​	Goroutines 被多路复用到多个操作系统线程中，因此如果其中一个线程阻塞，例如在等待 I/O 时，其他线程继续运行。它们的设计隐藏了许多线程创建和管理的复杂性。</p>
<p>​	在一个函数或方法调用之前加上 <code>go</code> 关键字以在新的 goroutine 中运行该调用。当调用完成时，goroutine 静默退出。（效果类似于 Unix shell 的<code>&amp;</code>符号，用于在后台运行命令。）</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">go</span> <span style="color:#e06c75">list</span>.<span style="color:#61afef;font-weight:bold">Sort</span>()  <span style="color:#7f848e">// 并发运行 list.Sort；不等待它。
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>​	函数字面量在goroutine调用中非常方便。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Announce</span>(<span style="color:#e06c75">message</span> <span style="color:#e5c07b">string</span>, <span style="color:#e06c75">delay</span> <span style="color:#e06c75">time</span>.<span style="color:#e06c75">Duration</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">go</span> <span style="color:#c678dd">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">time</span>.<span style="color:#61afef;font-weight:bold">Sleep</span>(<span style="color:#e06c75">delay</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#e06c75">message</span>)
</span></span><span style="display:flex;"><span>    }()  <span style="color:#7f848e">// 注意该括号 - 必须调用该函数。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	在Go中，函数字面量是闭包：实现上确保函数引用的变量在其活动期间存活。</p>
<p>​	这些示例并不太实用，因为这些函数无法发出完成信号。为此，我们需要使用通道。</p>
<h3 id="通道">通道</h3>
<p>​	与映射一样，通道是使用<code>make</code>分配的，而生成的值充当底层数据结构的引用。如果提供了可选的整数参数，则会为通道设置缓冲区大小。默认值为零，表示无缓冲或同步通道。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">ci</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>)            <span style="color:#7f848e">// 整数无缓冲通道
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">cj</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>, <span style="color:#d19a66">0</span>)         <span style="color:#7f848e">// 整数无缓冲通道
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">cs</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">os</span>.<span style="color:#e06c75">File</span>, <span style="color:#d19a66">100</span>)  <span style="color:#7f848e">// 100个指向文件的缓冲通道
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>​	无缓冲通道结合了通信 - 交换值 - 与同步 —— 确保两个计算（goroutines）处于已知状态。</p>
<p>​	有很多使用通道的好习惯。这里有一个开始的例子。在前一节中，我们在后台启动了一个排序。通道可以让启动的goroutine等待排序完成。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">c</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>)  <span style="color:#7f848e">// 分配一个通道。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 在goroutine中启动排序；当它完成时，向通道发出信号。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">go</span> <span style="color:#c678dd">func</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">list</span>.<span style="color:#61afef;font-weight:bold">Sort</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#d19a66">1</span>  <span style="color:#7f848e">// 发送信号；值不重要。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}()
</span></span><span style="display:flex;"><span><span style="color:#61afef;font-weight:bold">doSomethingForAWhile</span>()
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">c</span>   <span style="color:#7f848e">// 等待排序完成；忽略已发送的值。
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>​	接收器始终阻塞，直到有数据可接收。如果通道无缓冲，则发送器将阻塞，直到接收器接收到该值。如果通道具有缓冲区，则发送器仅阻塞，直到该值已复制到缓冲区；如果缓冲区已满，则这意味着等待，直到某个接收器检索到一个值。</p>
<p>A buffered channel can be used like a semaphore, for instance to limit throughput. In this example, incoming requests are passed to <code>handle</code>, which sends a value into the channel, processes the request, and then receives a value from the channel to ready the &ldquo;semaphore&rdquo; for the next consumer. The capacity of the channel buffer limits the number of simultaneous calls to <code>process</code>.</p>
<p>缓冲通道可以像信号灯一样使用，例如用来限制吞吐量。在这个例子中，传入的请求被传递给handle，handle向通道发送一个值，处理请求，然后从通道接收一个值，为下一个消费者准备 &ldquo;信号&rdquo;。通道缓冲区的容量限制了同时调用处理的数量。</p>
<p>​	缓冲通道可用作信号量，例如限制吞吐量。在此示例中，传入的请求传递给<code>handle</code>，handle将一个值发送到通道中，处理请求，然后从通道中接收一个值以准备好下一个使用者的&quot;信号量&rdquo;。通道缓冲区的容量限制了对进程的同时调用数量。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">sem</span> = <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">MaxOutstanding</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">handle</span>(<span style="color:#e06c75">r</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">sem</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#d19a66">1</span>    <span style="color:#7f848e">// 等待活动队列排空。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#61afef;font-weight:bold">process</span>(<span style="color:#e06c75">r</span>)  <span style="color:#7f848e">// 可能需要很长时间。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">sem</span>       <span style="color:#7f848e">// 完成；启用下一个请求运行。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Serve</span>(<span style="color:#e06c75">queue</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">req</span> <span style="color:#56b6c2">:=</span> <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">queue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">go</span> <span style="color:#61afef;font-weight:bold">handle</span>(<span style="color:#e06c75">req</span>)  <span style="color:#7f848e">// 不等待handle完成。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	一旦<code>MaxOutstanding</code>个处理程序正在执行，任何进一步的处理程序都会尝试发送到已填充的通道缓冲区并被阻塞，直到现有的处理程序完成并从缓冲区接收。</p>
<p>​	但这种设计存在问题：即使只有<code>MaxOutstanding</code>中的一部分可以运行，<code>Serve</code>还是会为每个传入的请求创建一个新的goroutine。结果，如果请求过于频繁，程序可能会消耗无限的资源。我们可以通过更改<code>Serve</code>来限制goroutine的创建来解决这个问题。下面是一个显而易见的解决方案，但要注意它有一个bug，我们随后会修复：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Serve</span>(<span style="color:#e06c75">queue</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">req</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">queue</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">sem</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">go</span> <span style="color:#c678dd">func</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">process</span>(<span style="color:#e06c75">req</span>) <span style="color:#7f848e">// 有Bug;请参见下面的解释。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">sem</span>
</span></span><span style="display:flex;"><span>        }()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	bug在于，在Go for循环中，循环变量在每次迭代中都会被重用，因此<code>req</code>变量会在所有goroutine之间共享。这不是我们想要的。我们需要确保对于每个goroutine，<code>req</code>都是唯一的。下面是一种将<code>req</code>的值作为参数传递给goroutine中的闭包的方法：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Serve</span>(<span style="color:#e06c75">queue</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">req</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">queue</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">sem</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">go</span> <span style="color:#c678dd">func</span>(<span style="color:#e06c75">req</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">process</span>(<span style="color:#e06c75">req</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">sem</span>
</span></span><span style="display:flex;"><span>        }(<span style="color:#e06c75">req</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	将此版本与之前的版本进行比较，查看闭包声明和运行方式的差异。另一个解决方案是仅创建一个具有相同名称的新变量，如以下示例所示：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Serve</span>(<span style="color:#e06c75">queue</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">req</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">queue</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">req</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">req</span> <span style="color:#7f848e">// 为goroutine创建req的新实例。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">sem</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#d19a66">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">go</span> <span style="color:#c678dd">func</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#61afef;font-weight:bold">process</span>(<span style="color:#e06c75">req</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">sem</span>
</span></span><span style="display:flex;"><span>        }()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>写成</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">req</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">req</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可能看起来有些奇怪，但在Go中这样做是合法且惯用的。您将获得一个具有相同名称的新变量的新版本，它在本地有意遮蔽了循环变量，但对于每个goroutine都是唯一的。</p>
<p>​	回到编写服务器的一般问题上，另一种管理资源的好方法是启动一定数量的处理goroutine，它们都从请求通道中读取。goroutine的数量限制了对<code>process</code>的同时调用次数。此<code>Serve</code>函数还接受一个通道，在该通道上将告诉它退出；在启动goroutine后，它会阻塞接收该通道。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">handle</span>(<span style="color:#e06c75">queue</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">r</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">queue</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">process</span>(<span style="color:#e06c75">r</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Serve</span>(<span style="color:#e06c75">clientRequests</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>, <span style="color:#e06c75">quit</span> <span style="color:#c678dd">chan</span> <span style="color:#e5c07b">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 启动处理程序
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#e06c75">MaxOutstanding</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">go</span> <span style="color:#61afef;font-weight:bold">handle</span>(<span style="color:#e06c75">clientRequests</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">quit</span>  <span style="color:#7f848e">// 等待被告知退出。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="通道的通道">通道的通道</h3>
<p>​	Go的一个最重要的特性是通道是一种一等值，可以像其他值一样分配和传递。这种特性的常见用途是实现安全的并行复用。</p>
<p>​	在前一节的示例中，<code>handle</code>是一个理想化的处理程序，但我们没有定义它处理的类型。如果该类型包含一个通道来回复，每个客户端都可以提供自己的答案路径。这是<code>Request</code>类型的示意定义。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Request</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">args</span>        []<span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">f</span>           <span style="color:#c678dd">func</span>([]<span style="color:#e5c07b">int</span>) <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">resultChan</span>  <span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	客户端提供一个函数和它的参数，以及一个请求对象内部的通道，用于接收答案。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">sum</span>(<span style="color:#e06c75">a</span> []<span style="color:#e5c07b">int</span>) (<span style="color:#e06c75">s</span> <span style="color:#e5c07b">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">_</span>, <span style="color:#e06c75">v</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">a</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">s</span> <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">v</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">request</span> <span style="color:#56b6c2">:=</span> <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">Request</span>{[]<span style="color:#e5c07b">int</span>{<span style="color:#d19a66">3</span>, <span style="color:#d19a66">4</span>, <span style="color:#d19a66">5</span>}, <span style="color:#e06c75">sum</span>, <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>)}
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Send request
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">clientRequests</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#e06c75">request</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Wait for response.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Printf</span>(<span style="color:#98c379">&#34;answer: %d\n&#34;</span>, <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">request</span>.<span style="color:#e06c75">resultChan</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	在服务器端，处理函数是唯一需要更改的内容。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">handle</span>(<span style="color:#e06c75">queue</span> <span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">req</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">queue</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">req</span>.<span style="color:#e06c75">resultChan</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#e06c75">req</span>.<span style="color:#61afef;font-weight:bold">f</span>(<span style="color:#e06c75">req</span>.<span style="color:#e06c75">args</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	显然，要使其变得更加现实，需要做更多的工作，但是这段代码是一个速率受限、并行且非阻塞的RPC系统的框架，而且没有一个互斥锁。</p>
<h3 id="并行">并行</h3>
<p>​	这些想法的另一个应用是将计算并行化到多个CPU核心上。如果计算可以分成可以独立执行的不同部分，那么它就可以被并行化，并使用信道来指示每个部分何时完成。</p>
<p>​	假设我们需要对一组项的向量执行一个昂贵的操作，而且每个项的操作值是独立的，就像这个理想化的例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Vector</span> []<span style="color:#e5c07b">float64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// 对v[i]、v[i+1] … 一直到v[n-1]执行操作。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">v</span> <span style="color:#e06c75">Vector</span>) <span style="color:#61afef;font-weight:bold">DoSome</span>(<span style="color:#e06c75">i</span>, <span style="color:#e06c75">n</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">u</span> <span style="color:#e06c75">Vector</span>, <span style="color:#e06c75">c</span> <span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> ; <span style="color:#e06c75">i</span> &lt; <span style="color:#e06c75">n</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">v</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">+=</span> <span style="color:#e06c75">u</span>.<span style="color:#61afef;font-weight:bold">Op</span>(<span style="color:#e06c75">v</span>[<span style="color:#e06c75">i</span>])
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">c</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#d19a66">1</span>    <span style="color:#7f848e">// 指示该部分已完成
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	我们在一个循环中独立地启动每个部分，每个CPU一个部分。它们可以以任何顺序完成，但这无关紧要；我们只需通过在启动所有goroutine后从通道中取出信号来计算完成信号的数量。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">const</span> <span style="color:#e06c75">numCPU</span> = <span style="color:#d19a66">4</span> <span style="color:#7f848e">// CPU核心数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">v</span> <span style="color:#e06c75">Vector</span>) <span style="color:#61afef;font-weight:bold">DoAll</span>(<span style="color:#e06c75">u</span> <span style="color:#e06c75">Vector</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">c</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">numCPU</span>)  <span style="color:#7f848e">// 可选的缓冲区大小。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#e06c75">numCPU</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">go</span> <span style="color:#e06c75">v</span>.<span style="color:#61afef;font-weight:bold">DoSome</span>(<span style="color:#e06c75">i</span><span style="color:#56b6c2">*</span><span style="color:#e5c07b">len</span>(<span style="color:#e06c75">v</span>)<span style="color:#56b6c2">/</span><span style="color:#e06c75">numCPU</span>, (<span style="color:#e06c75">i</span><span style="color:#56b6c2">+</span><span style="color:#d19a66">1</span>)<span style="color:#56b6c2">*</span><span style="color:#e5c07b">len</span>(<span style="color:#e06c75">v</span>)<span style="color:#56b6c2">/</span><span style="color:#e06c75">numCPU</span>, <span style="color:#e06c75">u</span>, <span style="color:#e06c75">c</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 取出信道中的信号。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#e06c75">numCPU</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">c</span>    <span style="color:#7f848e">// 等待一个任务完成
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 全部完成。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	与其为numCPU创建一个常量值，我们可以询问运行时适当的值是多少。函数<code>runtime.NumCPU</code>返回机器中硬件CPU核心的数量，因此我们可以编写：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">numCPU</span> = <span style="color:#e06c75">runtime</span>.<span style="color:#61afef;font-weight:bold">NumCPU</span>()
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	还有一个函数<code>runtime.GOMAXPROCS</code>，它报告（或设置）Go程序可以同时运行的用户指定的核心数。默认值为<code>runtime.NumCPU</code>的值，但可以通过设置类似命名的shell环境变量或调用带有正整数参数的函数来覆盖。调用它时，如果使用零，则只是查询该值。因此，如果我们想遵守用户的资源请求，我们应该编写：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">numCPU</span> = <span style="color:#e06c75">runtime</span>.<span style="color:#61afef;font-weight:bold">GOMAXPROCS</span>(<span style="color:#d19a66">0</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	一定要注意不要混淆并发的概念 - 结构化一个程序为独立执行的组件 - 和并行化的概念 - 在多个CPU上并行执行计算以提高效率。尽管Go的并发特性可以使一些问题易于结构化为并行计算，但Go是一种并发语言，而不是一种并行语言，不是所有并行化问题都适合Go的模型。有关区别的讨论，请参见<a href="../../GoBlog/2013/ConcurrencyIsNotParallelism">这一博客文章</a>中引用的演讲。</p>
<h3 id="一个泄漏的缓冲区">一个泄漏的缓冲区</h3>
<p>​	并发编程的工具甚至可以使非并发的想法更容易表达。以下是一个从RPC包中抽象出来的示例。客户端 goroutine 循环从某些来源（例如网络）接收数据。为避免分配和释放缓冲区，它保持一个空闲列表，并使用缓冲的通道来表示它。如果通道为空，则会分配一个新的缓冲区。一旦消息缓冲区准备好，它就会被发送到 <code>serverChan</code> 上的服务器。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">freeList</span> = <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Buffer</span>, <span style="color:#d19a66">100</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">serverChan</span> = <span style="color:#e5c07b">make</span>(<span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Buffer</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">client</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">var</span> <span style="color:#e06c75">b</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Buffer</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 如果有可用的缓冲区，则获取一个；如果没有，则分配一个新的。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">select</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">b</span> = <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">freeList</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 已获取一个；无需进行更多操作。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">default</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 没有空闲的，所以分配一个新的。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">b</span> = <span style="color:#e5c07b">new</span>(<span style="color:#e06c75">Buffer</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">load</span>(<span style="color:#e06c75">b</span>)              <span style="color:#7f848e">// 从网络读取下一条消息。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">serverChan</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#e06c75">b</span>      <span style="color:#7f848e">// 发送到服务器。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	服务器循环从客户端接收每条消息，处理它并将缓冲区返回到空闲列表中。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">server</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">b</span> <span style="color:#56b6c2">:=</span> <span style="color:#56b6c2">&lt;-</span><span style="color:#e06c75">serverChan</span>    <span style="color:#7f848e">// 等待任务。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#61afef;font-weight:bold">process</span>(<span style="color:#e06c75">b</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// 如果有空间，则重用缓冲区。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">select</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">case</span> <span style="color:#e06c75">freeList</span> <span style="color:#56b6c2">&lt;-</span> <span style="color:#e06c75">b</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 缓冲区在空闲列表上；无需进行更多操作。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">default</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// 空闲列表已满，继续执行。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	客户端尝试从 <code>freeList</code> 中检索缓冲区；如果没有可用的，则分配一个新的。服务器将 <code>b</code> 发送到 <code>freeList</code> 上，除非列表已满，在这种情况下，缓冲区将被丢弃以供垃圾回收器回收。（在 <code>select</code> 语句中的<code>default</code>子句在没有其他 case 准备好的情况下执行，这意味着<code>selects</code>永远不会阻塞。）这个实现只用了几行代码就建立了一个泄漏的桶式空闲列表，依靠缓冲的通道和垃圾回收器进行簿记(bookkeeping)。</p>
<h2 id="错误">错误</h2>
<p>​	库程序常常需要向调用者返回某种错误指示。如前所述，Go 的多值返回使得返回详细的错误描述与常规返回值一样容易。使用这个特性提供详细的错误信息是一个好的编程风格。例如，正如我们将看到的那样，<code>os.Open</code> 不仅在失败时返回一个 nil 指针，它还返回一个错误值，描述出了问题所在。</p>
<p>​	按照惯例，错误类型为 <code>error</code>，它是一个简单的内置接口。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">type</span> <span style="color:#e5c07b">error</span> <span style="color:#c678dd">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">Error</span>() <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	一个库的作者可以自由地在底层实现这个接口，使用更丰富的模型，不仅可以看到错误，还可以提供一些上下文信息。正如前面提到的，除了通常的<code>*os.File</code>返回值外，<code>os.Open</code>还返回一个错误值。如果文件成功打开，错误将为<code>nil</code>，但是当出现问题时，它将包含一个<code>os.PathError</code>：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// PathError 记录错误和导致错误的操作和文件路径。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">PathError</span> <span style="color:#c678dd">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Op</span> <span style="color:#e5c07b">string</span>    <span style="color:#7f848e">// &#34;open&#34;, &#34;unlink&#34;, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">Path</span> <span style="color:#e5c07b">string</span>  <span style="color:#7f848e">// 关联的文件。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">Err</span> <span style="color:#e5c07b">error</span>    <span style="color:#7f848e">// 系统调用返回的错误。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">e</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">PathError</span>) <span style="color:#61afef;font-weight:bold">Error</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">e</span>.<span style="color:#e06c75">Op</span> <span style="color:#56b6c2">+</span> <span style="color:#98c379">&#34; &#34;</span> <span style="color:#56b6c2">+</span> <span style="color:#e06c75">e</span>.<span style="color:#e06c75">Path</span> <span style="color:#56b6c2">+</span> <span style="color:#98c379">&#34;: &#34;</span> <span style="color:#56b6c2">+</span> <span style="color:#e06c75">e</span>.<span style="color:#e06c75">Err</span>.<span style="color:#61afef;font-weight:bold">Error</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>PathError</code>的<code>Error</code>方法生成像这样的字符串：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">open</span> <span style="color:#56b6c2">/</span><span style="color:#e06c75">etc</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">passwx</span>: <span style="color:#e06c75">no</span> <span style="color:#e06c75">such</span> <span style="color:#e06c75">file</span> <span style="color:#e06c75">or</span> <span style="color:#e06c75">directory</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这样的错误，包括有问题的文件名、操作和触发它的操作系统错误，即使在远离引起错误的调用处打印，也很有用；它比纯粹的&quot;no such file or directory&quot;更具信息性。</p>
<p>​	在可能的情况下，错误字符串应该标识它们的来源，比如通过具有命名操作或生成错误的包的前缀。例如，在<code>image</code>包中，由于未知格式而导致解码错误的字符串表示为&quot;image: unknown format&rdquo;。</p>
<p>​	关心精确错误详情的调用方可以使用类型开关或类型断言查找特定错误并提取详细信息。对于<code>PathErrors</code>，这可能包括检查内部<code>Err</code>字段以进行可恢复的故障。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">try</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">try</span> &lt; <span style="color:#d19a66">2</span>; <span style="color:#e06c75">try</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">file</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Create</span>(<span style="color:#e06c75">filename</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">e</span>, <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">err</span>.(<span style="color:#56b6c2">*</span><span style="color:#e06c75">os</span>.<span style="color:#e06c75">PathError</span>); <span style="color:#e06c75">ok</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">e</span>.<span style="color:#e06c75">Err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">syscall</span>.<span style="color:#e06c75">ENOSPC</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#61afef;font-weight:bold">deleteTempFiles</span>()  <span style="color:#7f848e">// Recover some space.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">continue</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这里的第二个<code>if</code>语句是另一个类型断言。如果失败，<code>ok</code>将为false，<code>e</code>将为<code>nil</code>。如果成功，<code>ok</code>将为true，这意味着错误的类型是<code>*os.PathError</code>，那么<code>e</code>也是这样的，我们可以检查更多关于错误的信息。</p>
<h3 id="panic">Panic</h3>
<p>The usual way to report an error to a caller is to return an <code>error</code> as an extra return value. The canonical <code>Read</code> method is a well-known instance; it returns a byte count and an <code>error</code>. But what if the error is unrecoverable? Sometimes the program simply cannot continue.</p>
<p>向调用者报告错误的通常方法是返回一个错误作为额外的返回值。典型的Read方法是一个著名的例子；它返回一个字节数和一个错误。但是如果错误是无法恢复的呢？有时程序根本无法继续。</p>
<p>​	向调用者报告错误的通常方式是作为额外的返回值返回<code>error</code>。经典的 <code>Read</code> 方法是一个众所周知的例子，它返回一个字节数和一个错误。但是如果错误是不可恢复的呢？有时程序就是不能继续执行。</p>
<p>For this purpose, there is a built-in function <code>panic</code> that in effect creates a run-time error that will stop the program (but see the next section). The function takes a single argument of arbitrary type—often a string—to be printed as the program dies. It&rsquo;s also a way to indicate that something impossible has happened, such as exiting an infinite loop.</p>
<p>为此，有一个内置的函数panic，它实际上创造了一个运行时错误，将停止程序（但见下一节）。该函数需要一个任意类型的参数——通常是一个字符串——在程序死亡时被打印出来。这也是一种表示发生了不可能的事情的方法，比如退出一个无限循环。</p>
<p>​	为此，有一个内置函数 <code>panic</code>，实际上创建一个运行时错误，将停止程序（但请参见下一节）。该函数接受一个任意类型的单个参数，通常是一个字符串，用于在程序停止时打印。这也是一种指示发生了不可能的事情（比如退出一个无限循环）的方法。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// A toy implementation of cube root using Newton&#39;s method.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">// 一个使用牛顿法的立方根玩具实现。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">CubeRoot</span>(<span style="color:#e06c75">x</span> <span style="color:#e5c07b">float64</span>) <span style="color:#e5c07b">float64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">z</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">x</span><span style="color:#56b6c2">/</span><span style="color:#d19a66">3</span>   <span style="color:#7f848e">// 任意初始值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">:=</span> <span style="color:#d19a66">0</span>; <span style="color:#e06c75">i</span> &lt; <span style="color:#d19a66">1e6</span>; <span style="color:#e06c75">i</span><span style="color:#56b6c2">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">prevz</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">z</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">z</span> <span style="color:#56b6c2">-=</span> (<span style="color:#e06c75">z</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">z</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">z</span><span style="color:#56b6c2">-</span><span style="color:#e06c75">x</span>) <span style="color:#56b6c2">/</span> (<span style="color:#d19a66">3</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">z</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">z</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#61afef;font-weight:bold">veryClose</span>(<span style="color:#e06c75">z</span>, <span style="color:#e06c75">prevz</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">z</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// A million iterations has not converged; something is wrong. 百万次迭代没有收敛；有些问题。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e5c07b">panic</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;CubeRoot(%g) did not converge&#34;</span>, <span style="color:#e06c75">x</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这只是一个示例，但真正的库函数应该避免 <code>panic</code>。如果问题可以被掩盖或绕过，让事情继续运行总是比将整个程序关闭更好。一个可能的反例是在初始化期间：如果库确实不能设置自身，可能会出现 panic，可以这么说。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">user</span> = <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;USER&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">init</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">user</span> <span style="color:#56b6c2">==</span> <span style="color:#98c379">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">panic</span>(<span style="color:#98c379">&#34;no value for $USER&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="recover">Recover</h3>
<p>​	当调用<code>panic</code>时（包括隐式调用，例如索引超出切片界限或类型断言失败的运行时错误），它会立即停止当前函数的执行，并开始解开the goroutine的栈，同时运行任何延迟的函数。如果这种解开栈的操作到达the goroutines的顶部，则程序将停止。但是，可以使用内置的<code>recover</code>函数来重新获得the goroutine的控制权并恢复正常执行。</p>
<p>​	调用<code>recover</code>会停止解开栈的操作，并返回传递给<code>panic</code>的参数。因为解开栈时运行的唯一代码是在延迟的函数中，所以<code>recover</code>仅在延迟的函数中有用。</p>
<p>​	<code>recover</code>的一个应用是在服务器内部关闭一个失败的goroutine，而不会杀死其他正在执行的goroutines。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">server</span>(<span style="color:#e06c75">workChan</span> <span style="color:#56b6c2">&lt;-</span><span style="color:#c678dd">chan</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Work</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">work</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">range</span> <span style="color:#e06c75">workChan</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">go</span> <span style="color:#61afef;font-weight:bold">safelyDo</span>(<span style="color:#e06c75">work</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">safelyDo</span>(<span style="color:#e06c75">work</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Work</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#c678dd">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">recover</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Println</span>(<span style="color:#98c379">&#34;work failed:&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#61afef;font-weight:bold">do</span>(<span style="color:#e06c75">work</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	在这个例子中，如果 <code>do(work)</code> 发生恐慌，结果将被记录，并且 goroutine 将在不干扰其他 goroutine 的情况下干净地退出。在延迟闭包中不需要执行任何其他操作；调用 <code>recover</code> 将完全处理该条件。</p>
<p>​	因为 <code>recover</code> 总是返回 <code>nil</code>，除非直接从延迟函数中调用，所以延迟代码可以调用库例程，这些库例程本身使用 <code>panic</code> 和 <code>recover</code> 而不会失败。例如，<code>safelyDo</code> 中的延迟函数在调用 <code>recover</code> 之前可能会调用一个日志记录函数，而该日志记录代码将在恐慌状态下不受影响地运行。</p>
<p>With our recovery pattern in place, the <code>do</code> function (and anything it calls) can get out of any bad situation cleanly by calling <code>panic</code>. We can use that idea to simplify error handling in complex software. Let&rsquo;s look at an idealized version of a <code>regexp</code> package, which reports parsing errors by calling <code>panic</code> with a local error type. Here&rsquo;s the definition of <code>Error</code>, an <code>error</code> method, and the <code>Compile</code> function.</p>
<p>有了我们的恢复模式，do函数（以及它调用的任何东西）可以通过调用panic干净利落地摆脱任何糟糕的情况。我们可以用这个想法来简化复杂软件中的错误处理。让我们看看一个理想化版本的regexp包，它通过调用本地错误类型的panic来报告解析错误。这里有Error的定义，一个错误方法，以及Compile函数。</p>
<p>​	有了我们的恢复模式，<code>do</code> 函数（以及它调用的任何内容）都可以通过调用 <code>panic</code> 干净地摆脱任何不良情况。我们可以利用这个想法简化复杂软件中的错误处理。让我们来看一个<code>regexp</code>包的理想化版本，它通过使用一个本地的错误类型，通过调用 <code>panic</code> 来报告解析错误。这是 <code>Error</code>、<code>Error</code> 方法和 <code>Compile</code> 函数的定义。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Error 是解析错误的类型；它满足 error 接口。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">type</span> <span style="color:#e06c75">Error</span> <span style="color:#e5c07b">string</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">e</span> <span style="color:#e06c75">Error</span>) <span style="color:#61afef;font-weight:bold">Error</span>() <span style="color:#e5c07b">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">string</span>(<span style="color:#e06c75">e</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// error 是 *Regexp 的一个方法，它通过 panic 来报告解析错误。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> (<span style="color:#e06c75">regexp</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Regexp</span>) <span style="color:#e5c07b">error</span>(<span style="color:#e06c75">err</span> <span style="color:#e5c07b">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">panic</span>(<span style="color:#61afef;font-weight:bold">Error</span>(<span style="color:#e06c75">err</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Compile 返回正则表达式的解析表示。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">Compile</span>(<span style="color:#e06c75">str</span> <span style="color:#e5c07b">string</span>) (<span style="color:#e06c75">regexp</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">Regexp</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">regexp</span> = <span style="color:#e5c07b">new</span>(<span style="color:#e06c75">Regexp</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 如果出现解析错误，doParse 将 panic。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">defer</span> <span style="color:#c678dd">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">:=</span> <span style="color:#e5c07b">recover</span>(); <span style="color:#e06c75">e</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">regexp</span> = <span style="color:#e5c07b">nil</span>    <span style="color:#7f848e">// 清空返回值。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">err</span> = <span style="color:#e06c75">e</span>.(<span style="color:#e06c75">Error</span>) <span style="color:#7f848e">// 如果不是解析错误，则重新 panic。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">regexp</span>.<span style="color:#61afef;font-weight:bold">doParse</span>(<span style="color:#e06c75">str</span>), <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	如果 <code>doParse</code> 发生恐慌，恢复块将把返回值设置为 <code>nil</code>——延迟函数可以修改命名返回值。然后，它将在将 <code>err</code> 赋值时检查问题是否为解析错误，方法是断言它具有本地类型 <code>Error</code>。如果不是，则类型断言将失败，导致运行时错误，其将继续栈展开，就好像没有中断一样。这个检查意味着如果发生了一些意外情况，比如越界，代码将失败，即使我们使用 <code>panic</code> 和 <code>recover</code> 来处理解析错误也是如此。</p>
<p>​	有了错误处理，<code>error</code> 方法（因为它是绑定到一个类型的方法，因此它具有与内置 <code>error</code> 类型相同的名称是可以的，甚至是自然的）使报告解析错误变得容易，而不必手动展开解析栈：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">pos</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">re</span>.<span style="color:#e5c07b">error</span>(<span style="color:#98c379">&#34;&#39;*&#39; illegal at start of expression&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	虽然这种模式很有用，但应该仅在一个包内使用。<code>Parse</code>函数将其内部的<code>panic</code>调用转换为<code>error</code>值，不会向客户端暴露<code>panics</code>。这是一个值得遵循的好规则。</p>
<p>​	顺便说一下，如果出现实际错误，这种重新panic的惯用语会更改panic的值。但是，原始失败和新的失败都会在崩溃报告中呈现，因此问题的根本原因仍然可见。因此，这种简单的重新panic方法通常足够了——毕竟这是一个崩溃——但如果您只想显示原始值，您可以编写更多的代码来过滤意外问题，并使用原始错误重新panic。这留给读者作为一个练习。</p>
<h2 id="a-web-server-一个web服务器">A web server 一个web服务器</h2>
<p>Let&rsquo;s finish with a complete Go program, a web server. This one is actually a kind of web re-server. Google provides a service at <code>chart.apis.google.com</code> that does automatic formatting of data into charts and graphs. It&rsquo;s hard to use interactively, though, because you need to put the data into the URL as a query. The program here provides a nicer interface to one form of data: given a short piece of text, it calls on the chart server to produce a QR code, a matrix of boxes that encode the text. That image can be grabbed with your cell phone&rsquo;s camera and interpreted as, for instance, a URL, saving you typing the URL into the phone&rsquo;s tiny keyboard.</p>
<p>让我们用一个完整的Go程序来结束，一个网络服务器。这个实际上是一种网络再服务器。Google在chart.apis.google.com上提供了一个服务，可以将数据自动格式化为图表和图形。不过，它很难交互使用，因为你需要把数据作为查询放入URL。这里的程序为一种形式的数据提供了一个更好的接口：给定一个简短的文本，它调用图表服务器来产生一个QR码，一个编码文本的方框矩阵。该图像可以用手机的摄像头抓取，并解释为，例如，一个URL，省得你在手机的小键盘上输入URL。</p>
<p>Here&rsquo;s the complete program. An explanation follows.</p>
<p>这里是完整的程序。下面是一个解释。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">package</span> <span style="color:#e06c75">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;html/template&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#98c379">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">addr</span> = <span style="color:#e06c75">flag</span>.<span style="color:#61afef;font-weight:bold">String</span>(<span style="color:#98c379">&#34;addr&#34;</span>, <span style="color:#98c379">&#34;:1718&#34;</span>, <span style="color:#98c379">&#34;http service address&#34;</span>) <span style="color:#7f848e">// Q=17, R=18
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">templ</span> = <span style="color:#e06c75">template</span>.<span style="color:#61afef;font-weight:bold">Must</span>(<span style="color:#e06c75">template</span>.<span style="color:#61afef;font-weight:bold">New</span>(<span style="color:#98c379">&#34;qr&#34;</span>).<span style="color:#61afef;font-weight:bold">Parse</span>(<span style="color:#e06c75">templateStr</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">flag</span>.<span style="color:#61afef;font-weight:bold">Parse</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">Handle</span>(<span style="color:#98c379">&#34;/&#34;</span>, <span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">HandlerFunc</span>(<span style="color:#e06c75">QR</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">ListenAndServe</span>(<span style="color:#56b6c2">*</span><span style="color:#e06c75">addr</span>, <span style="color:#e5c07b">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#98c379">&#34;ListenAndServe:&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">QR</span>(<span style="color:#e06c75">w</span> <span style="color:#e06c75">http</span>.<span style="color:#e06c75">ResponseWriter</span>, <span style="color:#e06c75">req</span> <span style="color:#56b6c2">*</span><span style="color:#e06c75">http</span>.<span style="color:#e06c75">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">templ</span>.<span style="color:#61afef;font-weight:bold">Execute</span>(<span style="color:#e06c75">w</span>, <span style="color:#e06c75">req</span>.<span style="color:#61afef;font-weight:bold">FormValue</span>(<span style="color:#98c379">&#34;s&#34;</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">const</span> <span style="color:#e06c75">templateStr</span> = <span style="color:#98c379">`
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;title&gt;QR Link Generator&lt;/title&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;/head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379"></span><span style="color:#7f848e">{{</span><span style="color:#c678dd">if</span> <span style="color:#e06c75">.</span><span style="color:#7f848e">}}</span><span style="color:#98c379">
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;img src=&#34;http://chart.apis.google.com/chart?chs=300x300&amp;cht=qr&amp;choe=UTF-8&amp;chl=</span><span style="color:#7f848e">{{</span><span style="color:#e06c75">.</span><span style="color:#7f848e">}}</span><span style="color:#98c379">&#34; /&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379"></span><span style="color:#7f848e">{{</span><span style="color:#e06c75">.</span><span style="color:#7f848e">}}</span><span style="color:#98c379">
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379"></span><span style="color:#7f848e">{{</span><span style="color:#c678dd">end</span><span style="color:#7f848e">}}</span><span style="color:#98c379">
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;form action=&#34;/&#34; name=f method=&#34;GET&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">    &lt;input maxLength=1024 size=70 name=s value=&#34;&#34; title=&#34;Text to QR Encode&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">    &lt;input type=submit value=&#34;Show QR&#34; name=qr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;/form&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;/body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">&lt;/html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#98c379">`</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The pieces up to <code>main</code> should be easy to follow. The one flag sets a default HTTP port for our server. The template variable <code>templ</code> is where the fun happens. It builds an HTML template that will be executed by the server to display the page; more about that in a moment.</p>
<p>到main为止的部分应该很容易理解。一个标志是为我们的服务器设置一个默认的HTTP端口。模板变量templ是最有趣的地方。它建立了一个HTML模板，将由服务器执行，以显示页面；稍后会有更多关于这个的内容。</p>
<p>The <code>main</code> function parses the flags and, using the mechanism we talked about above, binds the function <code>QR</code> to the root path for the server. Then <code>http.ListenAndServe</code> is called to start the server; it blocks while the server runs.</p>
<p>主函数解析标志，并使用我们上面谈到的机制，将函数QR与服务器的根路径绑定。然后调用http.ListenAndServe来启动服务器；当服务器运行时，它就会阻塞。</p>
<p><code>QR</code> just receives the request, which contains form data, and executes the template on the data in the form value named <code>s</code>.</p>
<p>QR只是接收包含表单数据的请求，并在名为s的表单值中的数据上执行模板。</p>
<p>The template package <code>html/template</code> is powerful; this program just touches on its capabilities. In essence, it rewrites a piece of HTML text on the fly by substituting elements derived from data items passed to <code>templ.Execute</code>, in this case the form value. Within the template text (<code>templateStr</code>), double-brace-delimited pieces denote template actions. The piece from <code>{{if .}}</code> to <code>{{end}}</code> executes only if the value of the current data item, called <code>.</code> (dot), is non-empty. That is, when the string is empty, this piece of the template is suppressed.</p>
<p>模板包html/template很强大；这个程序只是触及了它的功能。从本质上讲，它通过替换从传递给templ.Execute的数据项中得到的元素，在本例中是表单值，来临时重写一段HTML文本。在模板文本（templateStr）中，以双括号分隔的部分表示模板动作。从{{if .}}到{{end}}的部分只有在当前数据项的值（称为.（点））非空时才会执行。也就是说，当字符串为空时，模板的这一块被抑制。</p>
<p>The two snippets <code>{{.}}</code> say to show the data presented to the template—the query string—on the web page. The HTML template package automatically provides appropriate escaping so the text is safe to display.</p>
<p>这两个切片{{.}}说的是要在网页上显示呈现给模板的数据——查询字符串。HTML模板包会自动提供适当的转义，这样文本就可以安全地显示。</p>
<p>The rest of the template string is just the HTML to show when the page loads. If this is too quick an explanation, see the <a href="https://go.dev/pkg/html/template/" target="_blank" rel="noopener">documentation</a> for the template package for a more thorough discussion.</p>
<p>模板字符串的其余部分只是在页面加载时显示的HTML。如果这解释得太快，请看模板包的文档以获得更全面的讨论。</p>
<p>And there you have it: a useful web server in a few lines of code plus some data-driven HTML text. Go is powerful enough to make a lot happen in a few lines.</p>
<p>就这样：几行代码加上一些数据驱动的HTML文本，就有了一个有用的网络服务器。Go的功能足够强大，几行代码就能实现很多事情。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f7e354cc6775c1e27d6c64bc392338ad">2 - Go Fuzzing</h1>
    
	<h1 id="go-fuzzing">Go Fuzzing</h1>
<blockquote>
<p>原文：<a href="https://go.dev/security/fuzz/" target="_blank" rel="noopener">https://go.dev/security/fuzz/</a></p>
</blockquote>
<p>​	从Go 1.18开始，Go在其标准工具链中支持模糊测试。<a href="https://google.github.io/oss-fuzz/getting-started/new-project-guide/go-lang/#native-go-fuzzing-support" target="_blank" rel="noopener">OSS-Fuzz支持</a>本地Go模糊测试。</p>
<p>​	请尝试使用<a href="../../GettingStarted/TutorialGettingStartedWithFuzzing">Go进行模糊测试的教程</a>。</p>
<h2 id="概述">概述</h2>
<p>​	模糊测试是一种自动化测试，它持续操作程序的输入，以查找错误。Go模糊测试使用覆盖率指导，智能地遍历被模糊测试的代码，查找并向用户报告故障。由于它可以触及人类经常错过的边缘情况，模糊测试对于寻找安全漏洞和漏洞特别有价值。</p>
<p>​	下面是一个模糊测试的示例，强调了其主要组成部分。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/Fuzzing_img/example.png"
     alt="Example code showing the overall fuzz test, with a fuzz target within it. Before the fuzz target is a corpus addition with f.Add, and the parameters of the fuzz target are highlighted as the fuzzing arguments."
     
/>




</p>
<h2 id="编写模糊测试">编写模糊测试</h2>
<h3 id="要求">要求</h3>
<p>以下是模糊测试必须遵循的规则。</p>
<ul>
<li>模糊测试必须是一个名为<code>FuzzXxx</code>的函数，它只接受<code>*testing.F</code>，并且没有返回值。</li>
<li>模糊测试必须在<code>*_test.go</code>文件中才能运行。</li>
<li>一个<a href="https://go.dev/security/fuzz/#glos-fuzz-target" target="_blank" rel="noopener">模糊目标</a>必须是对<code>(*testing.F).Fuzz</code>的方法调用，它接受一个<code>*testing.T</code>作为第一个参数，后跟模糊参数。没有返回值。</li>
<li>每个模糊测试必须恰好有一个模糊目标。</li>
<li>所有种子语料库条目的类型必须与模糊测试参数的类型相同，顺序也相同。这对于调用<code>(*testing.F).Add</code>和模糊测试的testdata/fuzz目录中的任何语料库文件都是如此。</li>
<li>模糊参数只能是以下类型：
<ul>
<li><code>string</code>, <code>[]byte</code></li>
<li><code>int</code>, <code>int8</code>, <code>int16</code>, <code>int32</code>/<code>rune</code>, <code>int64</code></li>
<li><code>uint</code>, <code>uint8</code>/<code>byte</code>, <code>uint16</code>, <code>uint32</code>, <code>uint64</code></li>
<li><code>float32</code>, <code>float64</code></li>
<li><code>bool</code></li>
</ul>
</li>
</ul>
<h3 id="建议-suggestions">建议 Suggestions</h3>
<p>​	下面是一些建议，它们将帮助你充分利用模糊测试。</p>
<ul>
<li>模糊目标应该是快速和确定的，这样模糊测试引擎就能有效地工作，新的故障和代码覆盖率就能轻易地重现。</li>
<li>由于模糊目标是以非确定性的顺序在多个工作进程中并行调用的，因此模糊目标的状态不应持续到每次调用结束之后，并且模糊目标的行为也不应依赖于全局状态。</li>
</ul>
<h2 id="运行模糊测试">运行模糊测试</h2>
<p>​	有两种运行模糊测试的模式：作为单元测试（默认的 <code>go test</code>），或使用模糊测试（<code>go test -fuzz=FuzzTestName</code>）。</p>
<p>​	默认情况下，模糊测试的运行方式与单元测试非常相似。每个<a href="#seed-corpus">种子语料库条目（seed corpus entry）</a>都会针对模糊测试目标进行测试，在退出前报告任何失败的情况。</p>
<p>​	要启用模糊测试，请在运行 <code>go test</code> 时使用 <code>-fuzz</code> 标志，并提供一个与单个模糊测试相匹配的正则表达式。默认情况下，该包中的所有其他测试将在模糊测试开始前运行。这是为了确保模糊测试不会报告任何已经被现有测试发现的问题。</p>
<p>​	请注意，你需要决定运行模糊测试的时间长度。如果没有发现任何错误，模糊测试的执行很可能会无限期地运行。未来将支持使用OSS-Fuzz等工具连续运行这些模糊测试，见<a href="https://github.com/golang/go/issues/50192" target="_blank" rel="noopener">Issue #50192</a>。</p>
<p>!!! warning &ldquo;注意&rdquo;
注意：应在支持覆盖率仪器（目前为AMD64和ARM64）的平台上运行模糊测试，这样语料库才能在运行时有意义地增长，并在模糊测试期间覆盖更多代码。</p>
<h3 id="命令行输出">命令行输出</h3>
<p>​	当模糊测试进行时，<a href="#fuzzing-engine">模糊测试引擎（fuzzing engine）</a>会生成新的输入并将其运行到提供的模糊目标中。默认情况下，它继续运行，直到发现一个<a href="#failing-input">失败的输入（failing input）</a>，或者用户取消这个过程（例如用 Ctrl^C）。</p>
<p>​	输出的格式类似于以下内容：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>~ go <span style="color:#e5c07b">test</span> -fuzz FuzzFoo
</span></span><span style="display:flex;"><span>fuzz: elapsed: 0s, gathering baseline coverage: 0/192 completed
</span></span><span style="display:flex;"><span>fuzz: elapsed: 0s, gathering baseline coverage: 192/192 completed, now fuzzing with <span style="color:#d19a66">8</span> workers
</span></span><span style="display:flex;"><span>fuzz: elapsed: 3s, execs: <span style="color:#d19a66">325017</span> <span style="color:#56b6c2">(</span>108336/sec<span style="color:#56b6c2">)</span>, new interesting: <span style="color:#d19a66">11</span> <span style="color:#56b6c2">(</span>total: 202<span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>fuzz: elapsed: 6s, execs: <span style="color:#d19a66">680218</span> <span style="color:#56b6c2">(</span>118402/sec<span style="color:#56b6c2">)</span>, new interesting: <span style="color:#d19a66">12</span> <span style="color:#56b6c2">(</span>total: 203<span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>fuzz: elapsed: 9s, execs: <span style="color:#d19a66">1039901</span> <span style="color:#56b6c2">(</span>119895/sec<span style="color:#56b6c2">)</span>, new interesting: <span style="color:#d19a66">19</span> <span style="color:#56b6c2">(</span>total: 210<span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>fuzz: elapsed: 12s, execs: <span style="color:#d19a66">1386684</span> <span style="color:#56b6c2">(</span>115594/sec<span style="color:#56b6c2">)</span>, new interesting: <span style="color:#d19a66">21</span> <span style="color:#56b6c2">(</span>total: 212<span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      foo 12.692s
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	开头几行表示在模糊测试开始前收集 &ldquo;基准覆盖率（baseline coverage）&quot;。</p>
<p>​	为了收集基准覆盖率，模糊测试引擎会执行<a href="#seed-corpus">种子语料库（seed corpus）</a>和<a href="#generated-corpus">生成语料库（generated corpus）</a>，以确保没有发生错误，并了解现有语料库已经提供的代码覆盖率。</p>
<p>​	随后的几行提供了有关当前模糊测试执行的见解：</p>
<ul>
<li>elapsed：从进程开始到现在已经过去了多少时间</li>
<li>execs：针对模糊目标运行的输入总数（自最后一行日志以来的平均execs/sec)</li>
<li>new interesting：在这次模糊测试执行过程中，被添加到生成的语料库中的 &ldquo;有趣（interesting）&ldquo;输入的总数（与整个语料库的总大小有关）。</li>
</ul>
<p>​	要使输入 &ldquo;有趣（interesting）&quot;，它必须将代码覆盖范围扩大到现有生成的语料库所能达到的范围。典型的情况是，新的有趣输入的数量在开始时快速增长，最终放缓，随着新的分支被发现，偶尔会有爆发。</p>
<p>​	随着语料库中的输入开始覆盖更多的代码行，你应该期望看到“新的有趣的（new interesting）”数量随着时间的推移逐渐减少，如果模糊测试引擎发现新的代码路径，则偶尔会出现爆发。</p>
<h3 id="失败的输入">失败的输入</h3>
<p>​	模糊测试可能由于以下几个原因而失败：</p>
<ul>
<li>代码或测试中出现了panic 。</li>
<li>模糊目标直接或通过<code>t.Error</code>或<code>t.Fatal</code>等方法调用了<code>t.Fail</code>。</li>
<li>发生了一个不可恢复的错误，如<code>os.Exit</code>或栈溢出。</li>
<li>模糊目标执行时间过长。目前，模糊目标的执行超时时间为 1 秒。这可能由于死锁或无限循环而失败，或由于代码中的预期行为而失败。这就是为什么<a href="#suggestions">建议你的模糊目标要快速的一个原因</a>。</li>
</ul>
<p>​	如果出现错误，模糊测试引擎将尝试将输入最小化为仍能产生错误的最小可读值。有关配置此功能的信息，请参阅<a href="#custom-settings">自定义设置（custom-settings）</a>部分。</p>
<p>​	一旦最小化完成，错误信息将被记录下来，并且输出将以以下形式结束：</p>
<pre tabindex="0"><code>    Failing input written to testdata/fuzz/FuzzFoo/a878c3134fe0404d44eb1e662e5d8d4a24beb05c3d68354903670ff65513ff49
    To re-run:
    go test -run=FuzzFoo/a878c3134fe0404d44eb1e662e5d8d4a24beb05c3d68354903670ff65513ff49
FAIL
exit status 1
FAIL    foo 0.839s
</code></pre><p>​	模糊测试引擎将这个<a href="#failing-input">失败的输入（failing input）</a>写入了该模糊测试的种子语料库，现在它将被默认为与<code>go test</code>一起运行，一旦该bug被修复，它将作为回归测试。</p>
<p>​	下一步是诊断问题，修复错误，通过重新运行<code>go test</code>来验证修复，并提交包含新testdata文件的补丁，以充当回归测试。</p>
<h3 id="自定义设置-custom-settings">自定义设置 Custom settings</h3>
<p>​	默认的go命令设置应该适用于大多数模糊测试用例。因此，通常情况下，在命令行上执行的模糊测试应如下所示：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go <span style="color:#e5c07b">test</span> -fuzz<span style="color:#56b6c2">={</span>FuzzTestName<span style="color:#56b6c2">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	然而，<code>go</code>命令在运行模糊测试时确实提供了一些设置。这些设置在 <a href="../../References/CommandDocumentation/go">cmd/go 包</a>的文档中都有记载。</p>
<p>​	在此强调几个：</p>
<ul>
<li><code>-fuzztime</code>：在退出前执行模糊目标的总时间或迭代次数，默认为无限期。</li>
<li><code>-fuzzminimizetime</code>：在每次最小化尝试中，模糊目标将被执行的时间或迭代次数，默认为60秒。你可以通过在进行模糊测试时设置<code>-fuzzminimizetime 0</code>来完全禁用最小化。</li>
<li><code>-parallel</code>：同时运行的模糊测试进程的数量，默认为<code>$GOMAXPROCS</code>。目前，在进行模糊测试时设置<code>-cpu</code>无效。</li>
</ul>
<h2 id="语料库文件格式-corpus-file-format">语料库文件格式 Corpus file format</h2>
<p>​	语料库文件采用一种特殊的格式进行编码。这种格式用于<a href="#seed-corpus">种子语料库（seed corpus）</a>和<a href="#generated-corpus">生成语料库（generated corpus）</a>。</p>
<p>​	以下是一个语料库文件的示例：</p>
<pre tabindex="0"><code>go test fuzz v1
[]byte(&#34;hello\\xbd\\xb2=\\xbc ⌘&#34;)
int64(572293)
</code></pre><p>​	第一行是用来告知模糊测试引擎文件的编码版本。虽然目前没有计划未来的编码格式版本，但设计必须支持这种可能性。</p>
<p>​	接下来的每一行都是构成语料库条目的值，如果需要，可以直接复制到Go代码中。</p>
<p>​	在上面的示例中，我们有一个<code>[]byte</code>，后跟一个<code>int64</code>。这些类型必须与模糊测试的参数完全匹配，按照这个顺序。这些类型的模糊目标应该是这样的：</p>
<pre tabindex="0"><code>f.Fuzz(func(*testing.T, []byte, int64) {})
</code></pre><p>​	指定你自己的种子语料库值的最简单方法是使用<code>(*testing.F).Add</code>方法。在上面的示例中，看起来会是这样的：</p>
<pre tabindex="0"><code>f.Add([]byte(&#34;hello\\xbd\\xb2=\\xbc ⌘&#34;), int64(572293))
</code></pre><p>​	然而，你可能有一些大型二进制文件，不希望将其作为代码复制到测试中，而是作为单独的种子语料库条目保留在<code>testdata/fuzz/{FuzzTestName}</code>目录下。golang.org/x/tools/cmd/file2fuzz上的<a href="https://pkg.go.dev/golang.org/x/tools/cmd/file2fuzz" target="_blank" rel="noopener">file2fuzz</a>工具可以用来将这些二进制文件转换成<code>[]byte</code>编码的语料库文件。</p>
<p>​	要使用这个工具：</p>
<pre tabindex="0"><code>$ go install golang.org/x/tools/cmd/file2fuzz@latest
$ file2fuzz
</code></pre><h2 id="资源-resources">资源 Resources</h2>
<p>（a）教程：</p>
<ul>
<li>试试<a href="../../GettingStarted/TutorialGettingStartedWithFuzzing">Go的模糊测试教程</a>，深入了解新概念。</li>
<li>如果想了解更简短的Go模糊测试入门教程，请看<a href="../../GoBlog/2021/FuzzingIsBetaReady">博文</a>。</li>
</ul>
<p>（b）文档：</p>
<ul>
<li><a href="../../StdLib/testing/index">testing包</a>文档描述了用于编写模糊测试时使用的 <code>testing.F</code> 类型。</li>
<li><a href="../../References/CommandDocumentation/go">cmd/go 包</a>文档描述了与模糊测试相关的标志。</li>
</ul>
<p>（c）技术细节：</p>
<ul>
<li>
<p><a href="https://golang.org/s/draft-fuzzing-design" target="_blank" rel="noopener">Design draft 设计草案</a></p>
</li>
<li>
<p><a href="https://golang.org/issue/44551" target="_blank" rel="noopener">Proposal 提议</a></p>
</li>
</ul>
<h2 id="术语表-glossary">术语表 Glossary</h2>
<h3 id="corpus-entry-语料库条目">corpus entry 语料库条目</h3>
<p>​	语料库中的一个输入，可以在模糊测试时使用。这可以是一个特殊格式的文件，也可以是对<code>（*testing.F）.Add</code>的调用。</p>
<h3 id="coverage-guidance-覆盖率指导">coverage guidance 覆盖率指导</h3>
<p>​	一种模糊测试方法，它使用代码覆盖率的扩展来确定哪些语料库条目值得保留以供将来使用。</p>
<h3 id="failing-input-失败的输入">failing input 失败的输入</h3>
<p>​	失败的输入是一个语料库条目，它在与模糊目标运行时将导致错误或恐慌。</p>
<h3 id="fuzz-target-模糊目标">fuzz target 模糊目标</h3>
<p>​	对于语料库条目和生成的值执行的模糊测试功能。它是通过向<code>(*testing.F).Fuzz</code>传递函数来提供给模糊测试的。</p>
<h3 id="fuzz-test-模糊测试">fuzz test 模糊测试</h3>
<p>​	测试文件中的一个函数，其形式为<code>func FuzzXxx(*testing.F)</code>，可用于进行模糊测试。</p>
<h3 id="fuzzing-模糊测试">fuzzing 模糊测试</h3>
<p>​	一种自动测试，它不断地操纵程序的输入，以发现问题，如代码可能易受影响的缺陷或<a href="#vulnerability">漏洞（vulnerability）</a>。</p>
<h3 id="fuzzing-arguments-模糊测试参数">fuzzing arguments 模糊测试参数</h3>
<p>​	将传递给模糊目标的类型，并由<a href="#mutator">突变器（mutator）</a>进行突变。</p>
<h3 id="fuzzing-engine-模糊测试引擎">fuzzing engine 模糊测试引擎</h3>
<pre><code>用于管理模糊测试的工具，包括维护语料库、调用突变器、识别新的覆盖范围和报告失败。
</code></pre>
<h3 id="generated-corpus-生成的语料库">generated corpus 生成的语料库</h3>
<p>​	一个由模糊测试引擎在模糊测试过程中长期维护的语料库，以跟踪进展。它被存储在<code>$GOCACHE/fuzz</code>中。这些条目只在模糊测试时使用。</p>
<h3 id="mutator-突变器">mutator 突变器</h3>
<p>​	一个在模糊测试时使用的工具，它在将语料库条目传递给模糊测试目标之前随机地处理这些条目。</p>
<h3 id="package-包">package 包</h3>
<p>​	在同一目录下的源文件的集合，它们被编译在一起。参见Go语言规范中的<a href="https://go.dev/ref/spec#Packages" target="_blank" rel="noopener">包部分</a>。</p>
<h3 id="seed-corpus-种子语料库">seed corpus 种子语料库</h3>
<p>​	用户提供的用于模糊测试的语料库，可用于指导模糊引擎。它由模糊测试中<code>f.Add</code>调用提供的语料库条目，以及包中testdata/fuzz/{FuzzTestName}目录下的文件组成。无论是否进行模糊测试，这些条目都会在<code>go test</code>中默认运行。</p>
<h3 id="test-file-测试文件">test file 测试文件</h3>
<p>​	格式为<code>xxx_test.go</code>的文件，可能包含测试、基准测试、示例和模糊测试。</p>
<h3 id="vulnerability-漏洞">vulnerability 漏洞</h3>
<p>​	代码中对安全敏感的弱点，可被攻击者利用。</p>
<h2 id="反馈-feedback">反馈 Feedback</h2>
<p>​	如果你遇到任何问题或对功能有想法，请提出<a href="https://github.com/golang/go/issues/new?&amp;labels=fuzz" target="_blank" rel="noopener">问题</a>。</p>
<p>​	关于该功能的讨论和一般反馈，你也可以参与Gophers Slack的<a href="https://gophers.slack.com/archives/CH5KV1AKE" target="_blank" rel="noopener">#fuzzing频道</a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-64347b3c9393800b1cbd487bdfc4157f">3 - Go垃圾收集器指南</h1>
    
	<h1 id="a-guide-to-the-go-garbage-collector-go垃圾收集器指南">A Guide to the Go Garbage Collector Go垃圾收集器指南</h1>
<blockquote>
<p>原文：https://go.dev/doc/gc-guide</p>
</blockquote>
<h2 id="introduction-简介">Introduction 简介</h2>
<p>This guide is intended to aid advanced Go users in better understanding their application costs by providing insights into the Go garbage collector. It also provides guidance on how Go users may use these insights to improve their applications&rsquo; resource utilization. It does not assume any knowledge of garbage collection, but does assume familiarity with the Go programming language.</p>
<p>本指南旨在通过提供对 Go 垃圾收集器的深入了解，帮助 Go 高级用户更好地理解其应用程序的成本。它还提供了关于Go用户如何使用这些见解来提高其应用程序的资源利用率的指导。本书并不假定有任何关于垃圾收集的知识，但假定熟悉Go编程语言。</p>
<p>The Go language takes responsibility for arranging the storage of Go values; in most cases, a Go developer need not care about where these values are stored, or why, if at all. In practice, however, these values often need to be stored in computer <strong>physical memory</strong> and physical memory is a finite resource. Because it is finite, memory must be managed carefully and recycled in order to avoid running out of it while executing a Go program. It&rsquo;s the job of a Go implementation to allocate and recycle memory as needed.</p>
<p>Go 语言负责安排 Go 值的存储；在大多数情况下，Go 开发人员不需要关心这些值的存储位置，或者为什么存储，如果有的话。然而，在实践中，这些值往往需要存储在计算机物理内存中，而物理内存是一种有限的资源。因为它是有限的，所以必须仔细管理和回收内存，以避免在执行Go程序时耗尽内存。Go实现的工作就是根据需要分配和回收内存。</p>
<p>Another term for automatically recycling memory is <strong>garbage collection</strong>. At a high level, a garbage <em>collector</em> (or GC, for short) is a system that recycles memory on behalf of the application by identifying which parts of memory are no longer needed. The Go standard toolchain provides a runtime library that ships with every application, and this runtime library includes a garbage collector.</p>
<p>自动回收内存的另一个术语是垃圾收集。在高层次上，垃圾收集器（简称GC）是一个代表应用程序回收内存的系统，它可以识别哪些部分的内存不再需要。Go标准工具链提供了一个运行时库，与每个应用程序一起提供，这个运行时库包括一个垃圾收集器。</p>
<p>Note that the existence of a garbage collector as described by this guide is not guaranteed by the <a href="https://go.dev/ref/spec" target="_blank" rel="noopener">Go specification</a>, only that the underlying storage for Go values is managed by the language itself. This omission is intentional and enables the use of radically different memory management techniques.</p>
<p>请注意，本指南所描述的垃圾收集器的存在并没有得到Go规范的保证，只是说Go值的底层存储由语言本身管理。这种遗漏是有意为之的，它使人们能够使用完全不同的内存管理技术。</p>
<p>Therefore, this guide is about a specific implementation of the Go programming language and <em>may not apply to other implementations</em>. Specifically, this following guide applies to the standard toolchain (the <code>gc</code> Go compiler and tools). Gccgo and Gollvm both use a very similar GC implementation so many of the same concepts apply, but details may vary.</p>
<p>因此，本指南是关于Go编程语言的一个特定实现，可能不适用于其他实现。具体来说，以下指南适用于标准工具链（gc Go编译器和工具）。Gccgo和Gollvm都使用非常相似的GC实现，因此许多相同的概念都适用，但细节可能会有所不同。</p>
<p>Furthermore, this is a living document and will change over time to best reflect the latest release of Go. This document currently describes the garbage collector as of Go 1.19.</p>
<p>此外，这是一个活的文件，会随着时间的推移而改变，以最好地反映Go的最新版本。本文档目前描述的是Go 1.19的垃圾收集器。</p>
<h3 id="where-go-values-live-go-价值的所在">Where Go Values Live Go 价值的所在</h3>
<p>Before we dive into the GC, let&rsquo;s first discuss the memory that doesn&rsquo;t need to be managed by the GC.</p>
<p>在我们深入了解GC之前，我们首先讨论一下不需要由GC管理的内存。</p>
<p>For instance, non-pointer Go values stored in local variables will likely not be managed by the Go GC at all, and Go will instead arrange for memory to be allocated that&rsquo;s tied to the <a href="https://go.dev/ref/spec#Declarations_and_scope" target="_blank" rel="noopener">lexical scope</a> in which it&rsquo;s created. In general, this is more efficient than relying on the GC, because the Go compiler is able to predetermine when that memory may be freed and emit machine instructions that clean up. Typically, we refer to allocating memory for Go values this way as &ldquo;stack allocation,&rdquo; because the space is stored on the goroutine stack.</p>
<p>例如，存储在局部变量中的非指针式Go值可能根本不需要由Go GC管理，Go会安排分配与创建词法范围相关的内存。一般来说，这比依赖GC更有效，因为Go编译器能够预先确定该内存何时被释放，并发出机器指令进行清理。通常情况下，我们把以这种方式为Go值分配内存称为 &ldquo;堆栈分配&rdquo;，因为这些空间被存储在goroutine堆栈中。</p>
<p>Go values whose memory cannot be allocated this way, because the Go compiler cannot determine its lifetime, are said to <em>escape to the heap</em>. &ldquo;The heap&rdquo; can be thought of as a catch-all for memory allocation, for when Go values need to be placed <em>somewhere</em>. The act of allocating memory on the heap is typically referred to as &ldquo;dynamic memory allocation&rdquo; because both the compiler and the runtime can make very few assumptions as to how this memory is used and when it can be cleaned up. That&rsquo;s where a GC comes in: it&rsquo;s a system that specifically identifies and cleans up dynamic memory allocations.</p>
<p>由于Go编译器无法确定Go值的寿命，因此不能以这种方式分配内存的Go值被称为逃逸到堆中。&ldquo;堆 &ldquo;可以被认为是内存分配的集合体，用于Go值需要放置的地方。在堆上分配内存的行为通常被称为 &ldquo;动态内存分配&rdquo;，因为编译器和运行时对这些内存的使用情况以及何时清理都不能做出任何假设。这就是GC的作用：它是一个专门识别和清理动态内存分配的系统。</p>
<p>There are many reasons why a Go value might need to escape to the heap. One reason could be that its size is dynamically determined. Consider for instance the backing array of a slice whose initial size is determined by a variable, rather than a constant. Note that escaping to the heap must also be transitive: if a reference to a Go value is written into another Go value that has already been determined to escape, that value must also escape.</p>
<p>有许多原因导致Go值可能需要转移到堆中。其中一个原因可能是它的大小是动态确定的。例如，考虑一个分片的支持数组，其初始大小是由一个变量而不是常数决定的。请注意，逃逸到堆中也必须是超越性的：如果对一个Go值的引用被写入另一个已经被确定为逃逸的Go值中，该值也必须逃逸。</p>
<p>Whether a Go value escapes or not is a function of the context in which it is used and the Go compiler&rsquo;s escape analysis algorithm. It would be fragile and difficult to try to enumerate precisely when values escape: the algorithm itself is fairly sophisticated and changes between Go releases. For more details on how to identify which values escape and which do not, see the section on <a href="https://go.dev/doc/gc-guide#Eliminating_heap_allocations" target="_blank" rel="noopener">eliminating heap allocations</a>.</p>
<p>一个Go值是否转义是由它的使用环境和围棋编译器的转义分析算法决定的。试图精确地列举值的转义是很脆弱和困难的：算法本身是相当复杂的，而且在不同的Go版本中会有变化。关于如何识别哪些值逃逸，哪些值不逃逸的更多细节，请参见消除堆分配的章节。</p>
<h3 id="tracing-garbage-collection-追踪垃圾回收">Tracing Garbage Collection 追踪垃圾回收</h3>
<p>Garbage collection may refer to many different methods of automatically recycling memory; for example, reference counting. In the context of this document, garbage collection refers to <strong>tracing</strong> garbage collection, which identifies in-use, so-called <strong>live</strong>, objects by following pointers transitively.</p>
<p>垃圾收集可以指许多不同的自动回收内存的方法；例如，引用计数。在本文的上下文中，垃圾收集指的是跟踪垃圾收集，它通过跟踪指针来识别正在使用的，所谓的活的对象。</p>
<p>Let&rsquo;s define these terms more rigorously.</p>
<p>让我们更严格地定义这些术语</p>
<ul>
<li><strong>Object</strong>—An object is a dynamically allocated piece of memory that contains one or more Go values.</li>
<li><strong>Pointer</strong>—A memory address that references any value within an object. This naturally includes Go values of the form <code>*T</code>, but also includes parts of built-in Go values. Strings, slices, channels, maps, and interface values all contain memory addresses that the GC must trace.</li>
<li>对象&ndash;一个对象是动态分配的一块内存，包含一个或多个Go值。</li>
<li>指针&ndash;引用对象中任何数值的内存地址。这自然包括*T形式的围棋值，但也包括内置围棋值的一部分。字符串、片断、通道、地图和接口值都包含GC必须追踪的内存地址。</li>
</ul>
<p>Together, objects and pointers to other objects form the <strong>object graph</strong>. To identify live memory, the GC walks the object graph starting at the program&rsquo;s <strong>roots</strong>, pointers that identify objects that are definitely in-use by the program. Two examples of roots are local variables and global variables. The process of walking the object graph is referred to as <strong>scanning</strong>.</p>
<p>对象和指向其他对象的指针共同构成了对象图。为了识别活的内存，GC从程序的根部开始行走对象图，即识别程序肯定在使用的对象的指针。根的两个例子是局部变量和全局变量。漫步对象图的过程被称为扫描。</p>
<p>This basic algorithm is common to all tracing GCs. Where tracing GCs differ is what they do once they discover memory is live. Go&rsquo;s GC uses the mark-sweep technique, which means that in order to keep track of its progress, the GC also <strong>marks</strong> the values it encounters as live. Once tracing is complete, the GC then walks over all memory in the heap and makes all memory that is <em>not</em> marked available for allocation. This process is called <strong>sweeping</strong>.</p>
<p>这种基本算法是所有追踪型GC所共有的。追踪型GC的不同之处在于一旦发现内存是活的，它们会做什么。Go的GC使用标记扫描技术，这意味着为了跟踪其进度，GC也会将其遇到的值标记为活的。一旦追踪完成，GC就会遍历堆中的所有内存，并使所有未被标记的内存可供分配。这个过程被称为清扫。</p>
<p>One alternative technique you may be familiar with is to actually <em>move</em> the objects to a new part of memory and leave behind a forwarding pointer that is later used to update all the application&rsquo;s pointers. We call a GC that moves objects in this way a <strong>moving</strong> GC; Go has a <strong>non-moving</strong> GC.</p>
<p>你可能熟悉的另一种技术是将对象实际移动到内存的一个新的部分，并留下一个转发指针，这个指针后来被用来更新所有应用程序的指针。我们把以这种方式移动对象的GC称为移动GC；Go有一个非移动GC。</p>
<h2 id="the-gc-cycle-gc循环">The GC cycle GC循环</h2>
<p>Because the Go GC is a mark-sweep GC, it broadly operates in two phases: the mark phase, and the sweep phase. While this statement might seem tautological, it contains an important insight: it&rsquo;s not possible to release memory back to be allocated until <em>all</em> memory has been traced, because there may still be an un-scanned pointer keeping an object alive. As a result, the act of sweeping must be entirely separated from the act of marking. Furthermore, the GC may also not be active at all, when there&rsquo;s no GC-related work to do. The GC continuously rotates through these three phases of sweeping, off, and marking in what&rsquo;s known as the <strong>GC cycle</strong>. For the purposes of this document, consider the GC cycle starting with sweeping, turning off, then marking.</p>
<p>因为Go的GC是一个标记-扫描的GC，所以它大致分两个阶段运行：标记阶段和扫描阶段。虽然这句话看起来是同义的，但它包含了一个重要的见解：在所有的内存都被追踪到之前，是不可能将内存释放回来分配的，因为可能还有一个未被扫描的指针保持着一个对象。因此，清扫的行为必须与标记的行为完全分开。此外，当没有GC相关的工作要做时，GC也可能根本就不活动。在所谓的GC周期中，GC不断地在清扫、关闭和标记这三个阶段中轮流工作。为了本文的目的，考虑GC周期从清扫开始，关闭，然后标记。</p>
<p>The next few sections will focus on building intuition for the costs of the GC to aid users in tweaking GC parameters for their own benefit.</p>
<p>接下来的几节将着重于建立对GC成本的直觉，以帮助用户为自己的利益调整GC参数。</p>
<h3 id="understanding-costs-了解成本">Understanding costs 了解成本</h3>
<p>The GC is inherently a complex piece of software built on even more complex systems. It&rsquo;s easy to become mired in detail when trying to understand the GC and tweak its behavior. This section is intended to provide a framework for reasoning about the cost of the Go GC and tuning parameters.</p>
<p>GC本质上是一个复杂的软件，建立在更复杂的系统之上。在试图理解GC和调整它的行为时，很容易陷入细节的困扰。本节旨在为推理Go GC的成本和调整参数提供一个框架。</p>
<p>To begin with, consider this model of GC cost based on three simple axioms.</p>
<p>首先，考虑这个基于三个简单公理的GC成本模型。</p>
<ol>
<li>
<p>The GC involves only two resources: CPU time, and physical memory.</p>
</li>
<li>
<p>GC只涉及两种资源。CPU时间，和物理内存。</p>
</li>
<li>
<p>The GC&rsquo;s memory costs consist of live heap memory, new heap memory allocated before the mark phase, and space for metadata that, even if proportional to the previous costs, are small in comparison.</p>
</li>
<li>
<p>GC的内存成本由活堆内存、标记阶段前分配的新堆内存和元数据空间组成，即使与之前的成本成正比，相比之下也是很小的。</p>
<p>注意：活堆内存是指被前一个GC周期确定为活的内存，而新堆内存是指在当前周期分配的任何内存，这些内存到最后可能是活的，也可能不是。</p>
<p><em>Note: live heap memory is memory that was determined to be live by the previous GC cycle, while new heap memory is any memory allocated in the current cycle, which may or may not be live by the end.</em></p>
</li>
<li>
<p>The GC&rsquo;s CPU costs are modeled as a fixed cost per cycle, and a marginal cost that scales proportionally with the size of the live heap.</p>
</li>
<li>
<p>GC的CPU成本被建模为每个周期的固定成本，以及与活堆大小成比例的边际成本。</p>
<p>注意：渐进地讲，清扫的规模比标记和扫描要差，因为它必须执行与整个堆的大小成比例的工作，包括被确定为不活的内存（即 &ldquo;死&rdquo;）。然而，在目前的实现中，清扫比标记和扫描快得多，以至于在本讨论中可以忽略其相关的成本。</p>
<p><em>Note: Asymptotically speaking, sweeping scales worse than marking and scanning, as it must perform work proportional to the size of the whole heap, including memory that is determined to be not live (i.e. &ldquo;dead&rdquo;). However, in the current implementation sweeping is so much faster than marking and scanning that its associated costs can be ignored in this discussion.</em></p>
</li>
</ol>
<p>This model is simple but effective: it accurately categorizes the dominant costs of the GC. However, this model says nothing about the magnitude of these costs, nor how they interact. To model that, consider the following situation, referred to from here on as the <strong>steady-state</strong>.</p>
<p>这个模型简单而有效：它准确地分类了GC的主导成本。然而，这个模型没有说明这些成本的大小，也没有说明它们如何相互作用。为了建立这个模型，考虑以下情况，从这里开始称为稳定状态。</p>
<ul>
<li>
<p>The rate at which the application allocates new memory (in bytes per second) is constant. 应用程序分配新内存的速度（以字节/秒计）是恒定的。</p>
<p><em>Note: it&rsquo;s important to understand that this allocation rate is completely separate from whether or not this new memory is live. None of it could be live, all of it could be live, or some of it could be live. (On top of this, some old heap memory could also die, so it&rsquo;s not necessarily the case that if that memory is live, the live heap size grows.)</em></p>
<p>注意：重要的是要理解这个分配率与这个新内存是否是活的完全分开。这些内存可能都不是活的，可能都是活的，也可能有些是活的。(除此之外，一些旧的堆内存也可能死亡，因此，如果这些内存是活的，活的堆大小就不一定会增长）。</p>
<p><em>To put this more concretely, consider a web service that allocates 2 MiB of total heap memory for each request that it handles. During the request, at most 512 KiB of that 2 MiB stays live while the request is in flight, and when the service is finished handling the request, all that memory dies. Now, for the sake of simplicity suppose each request takes about 1 second to handle end-to-end. Then, a steady stream of requests, say 100 requests per second, results in an allocation rate of 200 MiB/s and a 50 MiB peak live heap.</em></p>
<p>为了更具体地说明这一点，考虑一个网络服务，为它处理的每个请求分配2 MiB的总堆内存。在请求过程中，2 MiB中最多有512 KiB是活的，而当服务处理完请求后，所有的内存都死了。现在，为了简单起见，假设每个请求需要大约1秒钟来处理端到端。那么，一个稳定的请求流，比如每秒100个请求，会导致200 MiB/s的分配率和50 MiB的峰值活堆。</p>
</li>
<li>
<p>The application&rsquo;s object graph looks roughly the same each time (objects are similarly sized, there&rsquo;s a roughly constant number of pointers, the maximum depth of the graph is roughly constant). 应用程序的对象图每次看起来都大致相同（对象的大小相似，指针的数量大致恒定，图的最大深度大致恒定）。</p>
<p>Another way to think about this is that the marginal costs of GC are constant. 另一种思考方式是，GC的边际成本是不变的</p>
</li>
</ul>
<p><em>Note: the steady-state may seem contrived, but it&rsquo;s representative of the behavior of an application under some constant workload. Naturally, workloads can change even while an application is executing, but typically application behavior looks like a bunch of these steady-states strung together with some transient behavior in between.</em></p>
<p>注意：稳态似乎是刻意的，但它代表了一个应用程序在某些恒定工作负载下的行为。当然，即使在应用程序执行过程中，工作负载也会发生变化，但通常情况下，应用程序的行为看起来就像一堆这些稳定状态串在一起，中间有一些瞬时行为。</p>
<p><em>Note: the steady-state makes no assumptions about the live heap. It may be growing with each subsequent GC cycle, it may shrink, or it may stay the same. However, trying to encompass all of these situations in the explanations to follow is tedious and not very illustrative, so the guide will focus on examples where the live heap remains constant. The <a href="https://go.dev/doc/gc-guide#GOGC" target="_blank" rel="noopener">GOGC section</a> explores the non-constant live heap scenario in some more detail.</em></p>
<p>注意：稳定状态没有对实时堆进行假设。它可能会随着每个后续的GC周期而增长，可能会缩小，也可能保持不变。然而，试图在接下来的解释中包含所有这些情况是很乏味的，也不太容易说明问题，所以本指南将集中在活堆保持不变的例子上。GOGC部分更详细地探讨了非恒定活堆的情况。</p>
<p>In the steady-state while the live heap size is constant, every GC cycle is going to look identical in the cost model as long as the GC executes after the same amount of time has passed. That&rsquo;s because in that fixed amount of time, with a fixed rate of allocation by the application, a fixed amount of new heap memory will be allocated. So with the live heap size constant, and that new heap memory constant, memory use is always going to be the same. And because the live heap is the same size, the marginal GC CPU costs will be the same, and the fixed costs will be incurred at some regular interval.</p>
<p>在稳定状态下，当活堆大小不变时，只要GC在相同的时间内执行，每个GC周期在成本模型中都是一样的。这是因为在这个固定的时间内，在应用程序的固定分配率下，将分配一个固定数量的新堆内存。因此，在实时堆大小不变，新堆内存不变的情况下，内存的使用总是相同的。因为实时堆的大小是一样的，所以边际GC的CPU成本也是一样的，而固定成本将在某个固定的时间段内发生。</p>
<p>Now consider if the GC were to shift the point at which it runs <em>later</em> in time. Then, more memory would be allocated but each GC cycle would still incur the same CPU cost. However over some other fixed window of time fewer GC cycles would finish, resulting in a lower overall CPU cost. The opposite would be true if the GC decided to start <em>earlier</em> in time: less memory would be allocated and CPU costs would be incurred more often.</p>
<p>现在考虑一下，如果GC在时间上将其运行的时间点移后。那么，更多的内存将被分配，但每个GC周期仍将产生相同的CPU成本。然而，在其他一些固定的时间窗口中，完成的GC周期会更少，从而导致总体CPU成本的降低。如果GC决定在更早的时间开始，情况就会相反：分配的内存会更少，CPU成本会更多。</p>
<p>This situation represents the fundamental trade-off between CPU time and memory that a GC can make, controlled by how often the GC actually executes. In other words, the trade-off is entirely defined by <strong>GC frequency</strong>.</p>
<p>这种情况代表了GC可以在CPU时间和内存之间进行的基本权衡，由GC实际执行的频率控制。换句话说，这种权衡完全由GC的频率决定。</p>
<p>One more detail remains to be defined, and that&rsquo;s when the GC should decide to start. Note that this directly sets the GC frequency in any particular steady-state, defining the trade-off. In Go, deciding when the GC should start is the main parameter which the user has control over.</p>
<p>还有一个细节需要定义，那就是GC应该何时决定开始。请注意，这直接设定了任何特定稳定状态下的GC频率，定义了权衡。在Go中，决定GC何时启动是用户可以控制的主要参数。</p>
<h3 id="gogc">GOGC</h3>
<p>At a high level, GOGC determines the trade-off between GC CPU and memory.</p>
<p>在高层次上，GOGC决定了GC CPU和内存之间的权衡。</p>
<p>It works by determining the target heap size after each GC cycle, a target value for the total heap size in the next cycle. The GC&rsquo;s goal is to finish a collection cycle before the total heap size exceeds the target heap size. Total heap size is defined as the live heap size at the end of the previous cycle, plus any new heap memory allocated by the application since the previous cycle. Meanwhile, target heap memory is defined as:</p>
<p>它的工作方式是在每个GC周期后确定目标堆大小，即下一个周期的总堆大小的目标值。GC的目标是在总堆大小超过目标堆大小之前完成一个收集周期。总堆大小被定义为上一周期结束时的活堆大小，加上自上一周期以来由应用程序分配的任何新的堆内存。同时，目标堆内存被定义为：</p>
<p><em>Target heap memory = Live heap + (Live heap + GC roots) * GOGC / 100</em></p>
<p>目标堆内存=活堆+（活堆+GC根）*GOGC/100</p>
<p>As an example, consider a Go program with a live heap size of 8 MiB, 1 MiB of goroutine stacks, and 1 MiB of pointers in global variables. Then, with a GOGC value of 100, the amount of new memory that will be allocated before the next GC runs will be 10 MiB, or 100% of the 10 MiB of work, for a total heap footprint of 18 MiB. With a GOGC value of 50, then it&rsquo;ll be 50%, or 5 MiB. With a GOGC value of 200, it&rsquo;ll be 200%, or 20 MiB.</p>
<p>作为一个例子，考虑一个Go程序，其活堆大小为8 MiB，goroutine栈为1 MiB，全局变量中的指针为1 MiB。那么，在GOGC值为100的情况下，在下一次GC运行前分配的新内存量将是10 MiB，或者是10 MiB工作的100%，总的堆占用量为18 MiB。如果GOGC值为50，那么它将是50%，或5 MiB。如果GOGC值为200，则为200%，即20 MiB。</p>
<p><em>Note: GOGC includes the root set only as of Go 1.18. Previously, it would only count the live heap. Often, the amount of memory in goroutine stacks is quite small and the live heap size dominates all other sources of GC work, but in cases where programs had hundreds of thousands of goroutines, the GC was making poor judgements.</em></p>
<p>注意：从Go 1.18开始，GOGC只包括根集。在此之前，它只计算实时堆。通常情况下，goroutine栈中的内存量相当小，活堆大小主导了所有其他GC工作的来源，但在程序有成百上千个goroutine的情况下，GC会做出错误的判断。</p>
<p>The heap target controls GC frequency: the bigger the target, the longer the GC can wait to start another mark phase and vice versa. While the precise formula is useful for making estimates, it&rsquo;s best to think of GOGC in terms of its fundamental purpose: a parameter that picks a point in the GC CPU and memory trade-off. The key takeaway is that <strong>doubling GOGC will double heap memory overheads and roughly halve GC CPU cost</strong>, and vice versa. (To see a full explanation as to why, see the <a href="https://go.dev/doc/gc-guide#Additional_notes_on_GOGC" target="_blank" rel="noopener">appendix</a>.)</p>
<p>堆的目标控制着GC的频率：目标越大，GC等待开始另一个标记阶段的时间就越长，反之亦然。虽然精确的公式对于做出估计很有用，但最好还是从它的基本目的来考虑GOGC：一个在GC的CPU和内存权衡中挑选一个点的参数。关键的启示是，GOGC翻倍将使堆内存开销翻倍，而GC CPU成本大约减半，反之亦然。(要看关于原因的完整解释，请看附录）。</p>
<p><em>Note: the target heap size is just a target, and there are several reasons why the GC cycle might not finish right at that target. For one, a large enough heap allocation can simply exceed the target. However, other reasons appear in GC implementations that go beyond the <a href="https://go.dev/doc/gc-guide#Understanding_costs" target="_blank" rel="noopener">GC model</a> this guide has been using thus far. For some more detail, see the <a href="https://go.dev/doc/gc-guide#Latency" target="_blank" rel="noopener">latency section</a>, but the complete details may be found in the <a href="https://go.dev/doc/gc-guide#Additional_resources" target="_blank" rel="noopener">additional resources</a>.</em></p>
<p>注意：目标堆大小只是一个目标，有几个原因导致GC周期可能不会在这个目标上完成。首先，一个足够大的堆分配可以简单地超过目标。然而，其他原因出现在GC实现中，这些原因超出了本指南迄今为止所使用的GC模型。关于一些更多的细节，请看延迟部分，但完整的细节可以在附加资源中找到。</p>
<p>GOGC may be configured through either the <code>GOGC</code> environment variable (which all Go programs recognize), or through the <a href="https://pkg.go.dev/runtime/debug#SetGCPercent" target="_blank" rel="noopener"><code>SetGCPercent</code></a> API in the <code>runtime/debug</code> package.</p>
<p>GOGC可以通过GOGC环境变量（所有Go程序都能识别），或者通过运行时/调试包中的SetGCPercent API进行配置。</p>
<p>Note that GOGC may also be used to turn off the GC entirely (provided the <a href="https://go.dev/doc/gc-guide#Memory_limit" target="_blank" rel="noopener">memory limit</a> does not apply) by setting <code>GOGC=off</code> or calling <code>SetGCPercent(-1)</code>. Conceptually, this setting is equivalent to setting GOGC to a value of infinity, as the amount of new memory before a GC is triggered is unbounded.</p>
<p>请注意，GOGC也可以通过设置GOGC=off或调用SetGCPercent(-1)来完全关闭GC（只要内存限制不适用）。从概念上讲，这种设置相当于将GOGC设置为无穷大的值，因为在触发GC之前的新内存量是无界的。</p>
<p>To better understand everything we&rsquo;ve discussed so far, try out the interactive visualization below that is built on the <a href="https://go.dev/doc/gc-guide#Understanding_costs" target="_blank" rel="noopener">GC cost model</a> discussed earlier. This visualization depicts the execution of some program whose non-GC work takes 10 seconds of CPU time to complete. In the first second it performs some initialization step (growing its live heap) before settling into a steady-state. The application allocates 200 MiB in total, with 20 MiB live at a time. It assumes that the only relevant GC work to complete comes from the live heap, and that (unrealistically) the application uses no additional memory.</p>
<p>为了更好地理解我们到目前为止所讨论的一切，请尝试一下下面的交互式可视化，它是建立在前面讨论的GC成本模型上的。这个可视化描述了一些程序的执行情况，其非GC工作需要10秒的CPU时间来完成。在第一秒中，它在进入稳定状态之前执行了一些初始化步骤（增长其实时堆）。该程序总共分配了200MB的空间，每次有20MB。它假设要完成的唯一相关的GC工作来自实时堆，并且（不现实地）应用程序没有使用额外的内存。</p>
<p>Use the slider to adjust the value of GOGC to see how the application responds in terms of total duration and GC overhead. Each GC cycle ends while the new heap drops to zero. The time taken while the new heap drops to zero is the combined time for the mark phase for cycle N, and the sweep phase for the cycle N+1. Note that this visualization (and all the visualizations in this guide) assume the application is paused while the GC executes, so GC CPU costs are fully represented by the time it takes for new heap memory to drop to zero. This is only to make visualization simpler; the same intuition still applies. The X axis shifts to always show the full CPU-time duration of the program. Notice that additional CPU time used by the GC increases the overall duration.</p>
<p>使用滑块来调整GOGC的值，看看应用程序在总时长和GC开销方面是如何反应的。每个GC周期结束时，新的堆会下降到零。新堆降到零时所花的时间是N周期的标记阶段和N+1周期的扫描阶段的综合时间。请注意，这个可视化（以及本指南中的所有可视化）假设应用程序在GC执行时是暂停的，所以GC的CPU成本完全由新堆内存下降到零的时间来表示。这只是为了使可视化更简单；同样的直觉仍然适用。X轴的移动总是显示程序的全部CPU时间。请注意，GC使用的额外CPU时间会增加整个持续时间。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/AGuideToTheGoGarbageCollector_img/gogc1.gif"
     alt="gogc1"
     
/>




</p>
<p>Notice that the GC always incurs some CPU and peak memory overhead. As GOGC increases, CPU overhead decreases, but peak memory increases proportionally to the live heap size. As GOGC decreases, the peak memory requirement decreases at the expense of additional CPU overhead.</p>
<p>请注意，GC总是会产生一些CPU和峰值内存的开销。随着GOGC的增加，CPU开销减少，但是峰值内存与活堆大小成比例地增加。随着GOGC的减少，峰值内存的要求也会减少，但代价是额外的CPU开销。</p>
<p><em>Note: the graph displays CPU time, not wall-clock time to complete the program. If the program runs on 1 CPU and fully utilizes its resources, then these are equivalent. A real-world program likely runs on a multi-core system and does not 100% utilize the CPUs at all times. In these cases the wall-time impact of the GC will be lower.</em></p>
<p>注意：该图显示的是CPU时间，而不是完成程序的挂钟时间。如果程序在1个CPU上运行并充分利用其资源，那么这些时间是相等的。现实世界的程序很可能在多核系统上运行，并不是在任何时候都能100%利用CPU。在这种情况下，GC的壁垒时间影响会比较小。</p>
<p><em>Note: the Go GC has a minimum total heap size of 4 MiB, so if the GOGC-set target is ever below that, it gets rounded up. The visualization reflects this detail.</em></p>
<p>注意：Go GC的最小总堆大小为4 MiB，所以如果GOGC设置的目标低于这个大小，它就会被舍弃。可视化反映了这个细节。</p>
<p>Here&rsquo;s another example that&rsquo;s a little bit more dynamic and realistic. Once again, the application takes 10 CPU-seconds to complete without the GC, but the steady-state allocation rate increases dramatically half-way through, and the live heap size shifts around a bit in the first phase. This example demonstrates how the steady-state might look when the live heap size is actually changing, and how a higher allocation rate leads to more frequent GC cycles.</p>
<p>下面是另一个更加动态和现实的例子。再一次，这个应用程序在没有GC的情况下需要10个CPU秒才能完成，但是稳态分配率在中途急剧增加，并且实时堆的大小在第一阶段有一些变化。这个例子展示了当活堆大小实际发生变化时，稳态是怎样的，以及更高的分配率如何导致更频繁的GC周期。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/AGuideToTheGoGarbageCollector_img/gogc2.gif"
     alt="gogc2"
     
/>




</p>
<h3 id="memory-limit-内存限制">Memory limit 内存限制</h3>
<p>Until Go 1.19, GOGC was the sole parameter that could be used to modify the GC&rsquo;s behavior. While it works great as a way to set a trade-off, it doesn&rsquo;t take into account that available memory is finite. Consider what happens when there&rsquo;s a transient spike in the live heap size: because the GC will pick a total heap size proportional to that live heap size, GOGC must be configured such for the <em>peak</em> live heap size, even if in the usual case a higher GOGC value provides a better trade-off.</p>
<p>在Go 1.19之前，GOGC是唯一可以用来修改GC行为的参数。虽然它作为一种设置权衡的方式非常好，但它没有考虑到可用内存是有限的。考虑一下当实时堆大小出现瞬时峰值时会发生什么：因为GC会选择一个与实时堆大小成比例的总堆大小，GOGC必须为实时堆的峰值大小进行配置，即使在通常情况下，更高的GOGC值可以提供更好的权衡。</p>
<p>The visualization below demonstrates this transient heap spike situation.</p>
<p>下面的可视化图展示了这种瞬时堆峰值的情况。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/AGuideToTheGoGarbageCollector_img/gogc3.gif"
     alt="gogc3"
     
/>




</p>
<p>If the example workload is running in a container with a bit over 60 MiB of memory available, then GOGC can&rsquo;t be increased beyond 100, even though the rest of the GC cycles have the available memory to make use of that extra memory. Furthermore, in some applications, these transient peaks can be rare and hard to predict, leading to occasional, unavoidable, and potentially costly out-of-memory conditions.</p>
<p>如果这个例子的工作负载是在一个可用内存超过60 MiB的容器中运行的，那么GOGC就不能增加到100以上，即使其余的GC周期有可用的内存来利用这些额外的内存。此外，在一些应用中，这些瞬时的峰值可能是罕见的，而且很难预测，导致偶尔的、不可避免的、潜在的昂贵的内存不足情况。</p>
<p>That&rsquo;s why in the 1.19 release, Go added support for setting a runtime memory limit. The memory limit may be configured either via the <code>GOMEMLIMIT</code> environment variable which all Go programs recognize, or through the <code>SetMemoryLimit</code> function available in the <code>runtime/debug</code> package.</p>
<p>这就是为什么在1.19版本中，Go增加了对设置运行时内存限制的支持。内存限制可以通过所有Go程序都认可的GOMEMLIMIT环境变量，或者通过运行时/调试包中的SetMemoryLimit函数来配置。</p>
<p>This memory limit sets a maximum on the <em>total amount of memory that the Go runtime can use</em>. The specific set of memory included is defined in terms of <a href="https://pkg.go.dev/runtime#MemStats" target="_blank" rel="noopener"><code>runtime.MemStats</code></a> as the expression</p>
<p>这个内存限制设定了Go运行时可以使用的最大内存总量。包括的具体内存集在 runtime.MemStats 方面定义为表达式</p>
<pre tabindex="0"><code>Sys` `-` `HeapReleased
</code></pre><p>or equivalently in terms of the <a href="https://pkg.go.dev/runtime/metrics" target="_blank" rel="noopener"><code>runtime/metrics</code></a> package,</p>
<p>或等同于在运行时/指标包方面，</p>
<pre tabindex="0"><code>/memory/classes/total:bytes` `-` `/memory/classes/heap/released:bytes
</code></pre><p>Because the Go GC has explicit control over how much heap memory it uses, it sets the total heap size based on this memory limit and how much other memory the Go runtime uses.</p>
<p>因为Go GC可以明确控制它所使用的堆内存，它根据这个内存限制和Go运行时使用的其他内存的数量来设置总的堆大小。</p>
<p>The visualization below depicts the same single-phase steady-state workload from the GOGC section, but this time with an extra 10 MiB of overhead from the Go runtime and with an adjustable memory limit. Try shifting around both GOGC and the memory limit and see what happens.</p>
<p>下面的可视化图描述了GOGC部分的相同的单阶段稳态工作负载，但这次Go运行时额外增加了10 MiB的开销，并且有一个可调整的内存限制。试着改变GOGC和内存限制的位置，看看会发生什么。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/AGuideToTheGoGarbageCollector_img/gogc4.gif"
     alt="gogc4"
     
/>




</p>
<p>Notice that when the memory limit is lowered below the peak memory that&rsquo;s determined by GOGC (42 MiB for a GOGC of 100), the GC runs more frequently to keep the peak memory within the limit.</p>
<p>请注意，当内存限制降低到由GOGC决定的峰值内存以下时（GOGC为100时为42 MiB），GC会更频繁地运行以保持峰值内存在限制范围内。</p>
<p>Returning to our previous example of the transient heap spike, by setting a memory limit and turning up GOGC, we can get the best of both worlds: no memory limit breach, and better resource economy. Try out the interactive visualization below.</p>
<p>回到我们之前的瞬时堆峰值的例子，通过设置内存限制和调高GOGC，我们可以得到两全其美的结果：没有内存限制的破坏，以及更好的资源经济性。试试下面的交互式可视化。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/AGuideToTheGoGarbageCollector_img/gogc5.gif"
     alt="gogc5"
     
/>




</p>
<p>Notice that with some values of GOGC and the memory limit, peak memory use stops at whatever the memory limit is, but that the rest of the program&rsquo;s execution still obeys the total heap size rule set by GOGC.</p>
<p>请注意，在GOGC和内存限制的某些值下，峰值内存的使用会在内存限制处停止，但程序执行的其余部分仍然遵守GOGC设置的总堆大小规则。</p>
<p>This observation leads to another interesting detail: even when GOGC is set to off, the memory limit is still respected! In fact, this particular configuration represents a <em>maximization of resource economy</em> because it sets the minimum GC frequency required to maintain some memory limit. In this case, <em>all</em> of the program&rsquo;s execution has the heap size rise to meet the memory limit.</p>
<p>这个观察结果引出了另一个有趣的细节：即使GOGC被设置为关闭，内存限制仍然被遵守！事实上，这个特殊的配置代表了对内存限制的理解。事实上，这种特殊的配置代表了资源经济的最大化，因为它设定了维持某种内存限制所需的最小GC频率。在这种情况下，所有程序的执行都有堆的大小上升以满足内存限制。</p>
<p>Now, while the memory limit is clearly a powerful tool, <strong>the use of a memory limit does not come without a cost</strong>, and certainly doesn&rsquo;t invalidate the utility of GOGC.</p>
<p>现在，虽然内存限制显然是一个强大的工具，但使用内存限制并不是没有代价的，当然也不会使GOGC的效用失效。</p>
<p>Consider what happens when the live heap grows large enough to bring total memory use close to the memory limit. In the steady-state visualization above, try turning GOGC off and then slowly lowering the memory limit further and further to see what happens. Notice that the total time the application takes will start to grow in an unbounded manner as the GC is constantly executing to maintain an impossible memory limit.</p>
<p>考虑一下当实时堆增长到足以使总的内存使用量接近内存限制时会发生什么。在上面的稳态可视化中，尝试关闭GOGC，然后慢慢地将内存限制进一步降低，看看会发生什么。请注意，由于GC不断执行以维持不可能的内存限制，程序所需的总时间将开始无限制地增长。</p>
<p>This situation, where the program fails to make reasonable progress due to constant GC cycles, is called <strong>thrashing</strong>. It&rsquo;s particularly dangerous because it effectively stalls the program. Even worse, it can happen for exactly the same situation we were trying to avoid with GOGC: a large enough transient heap spike can cause a program to stall indefinitely! Try reducing the memory limit (around 30 MiB or lower) in the transient heap spike visualization and notice how the worst behavior specifically starts with the heap spike.</p>
<p>这种情况，即程序由于不断的GC循环而无法取得合理的进展，被称为 thrashing。它特别危险，因为它有效地使程序停滞。更糟糕的是，它的发生与我们试图用GOGC来避免的情况完全一样：一个足够大的瞬时堆尖峰可以导致程序无限期地停滞 试着减少瞬时堆尖峰可视化中的内存限制（大约30 MiB或更低），并注意到最糟糕的行为是如何专门从堆尖峰开始的。</p>
<p>In many cases, an indefinite stall is worse than an out-of-memory condition, which tends to result in a much faster failure.</p>
<p>在许多情况下，无限期的停滞比内存不足的情况更糟糕，因为内存不足的情况往往会导致更快的故障。</p>
<p>For this reason, the memory limit is defined to be <strong>soft</strong>. The Go runtime makes no guarantees that it will maintain this memory limit under all circumstances; it only promises some reasonable amount of effort. This relaxation of the memory limit is critical to avoiding thrashing behavior, because it gives the GC a way out: let memory use surpass the limit to avoid spending too much time in the GC.</p>
<p>出于这个原因，内存限制被定义为软限制。Go运行时并不保证在任何情况下都能维持这个内存限制；它只承诺了一些合理的努力。这种对内存限制的放松对于避免激动行为至关重要，因为它给了GC一条出路：让内存使用超过限制，以避免在GC中花费太多时间。</p>
<p>How this works internally is the GC sets an upper limit on the amount of CPU time it can use over some time window (with some hysteresis for very short transient spikes in CPU use). This limit is currently set at roughly 50%, with a <code>2 * GOMAXPROCS</code> CPU-second window. The consequence of limiting GC CPU time is that the GC&rsquo;s work is delayed, meanwhile the Go program may continue allocating new heap memory, even beyond the memory limit.</p>
<p>这在内部是如何运作的呢？GC对它在一些时间窗口内可以使用的CPU时间设置了一个上限（对于CPU使用中非常短的瞬时峰值有一些滞后）。这个限制目前被设定为大约50%，有一个2*GOMAXPROCS CPU秒的窗口。限制GC CPU时间的后果是GC的工作被延迟，同时Go程序可以继续分配新的堆内存，甚至超过内存限制。</p>
<p>The intuition behind the 50% GC CPU limit is based on the worst-case impact on a program with ample available memory. In the case of a misconfiguration of the memory limit, where it is set too low mistakenly, the program will slow down at most by 2x, because the GC can&rsquo;t take more than 50% of its CPU time away.</p>
<p>50%的GC CPU限制背后的直觉是基于对一个有充足可用内存的程序的最坏情况的影响。在内存限制配置错误的情况下，即错误地设置了过低的内存限制，程序最多只能减慢2倍，因为GC不可能占用超过50%的CPU时间。</p>
<p><em>Note: the visualizations on this page do not simulate the GC CPU limit.</em></p>
<p>注意：本页面上的视觉效果并没有模拟GC的CPU限制。</p>
<h4 id="suggested-uses-建议的用途">Suggested uses 建议的用途</h4>
<p>While the memory limit is a powerful tool, and the Go runtime takes steps to mitigate the worst behaviors from misuse, it&rsquo;s still important to use it thoughtfully. Below is a collection of tidbits of advice about where the memory limit is most useful and applicable, and where it might cause more harm than good.</p>
<p>虽然内存限制是一个强大的工具，而且Go运行时采取了一些措施来减轻滥用的最坏行为，但深思熟虑地使用它仍然很重要。以下是关于内存限制最有用和最适用的地方，以及它可能造成更多伤害的地方的建议集。</p>
<ul>
<li>
<p><strong>Do</strong> take advantage of the memory limit when the execution environment of your Go program is entirely within your control, and the Go program is the only program with access to some set of resources (i.e. some kind of memory reservation, like a container memory limit). 当你的Go程序的执行环境完全在你的控制范围内，并且Go程序是唯一可以访问某些资源集（即某种内存保留，如容器内存限制）的程序时，请利用内存限制。</p>
<p>A good example is the deployment of a web service into containers with a fixed amount of available memory.</p>
<p>一个很好的例子是将网络服务部署到有固定可用内存的容器中。</p>
<p><strong>In this case, a good rule of thumb is to leave an additional 5-10% of headroom to account for memory sources the Go runtime is unaware of.</strong></p>
<p>在这种情况下，一个好的经验法则是留出额外的5-10%的空间，以考虑Go运行时不知道的内存来源。</p>
</li>
<li>
<p><strong>Do</strong> feel free to adjust the memory limit in real time to adapt to changing conditions. 请放心地实时调整内存限制，以适应不断变化的条件。</p>
<p>A good example is a cgo program where C libraries temporarily need to use substantially more memory.</p>
<p>一个很好的例子是在Cgo程序中，C库暂时需要使用大量的内存。</p>
</li>
<li>
<p><strong>Don&rsquo;t</strong> set GOGC to off with a memory limit if the Go program might share some of its limited memory with other programs, and those programs are generally decoupled from the Go program. Instead, keep the memory limit since it may help to curb undesirable transient behavior, but set GOGC to some smaller, reasonable value for the average case. 如果围棋程序可能与其他程序共享一些有限的内存，而这些程序通常与围棋程序解耦，则不要将GOGC设置为关闭内存限制。相反，保留内存限制，因为它可能有助于抑制不良的瞬时行为，但对于一般情况，将GOGC设置为较小的、合理的值。</p>
<p>While it may be tempting to try and &ldquo;reserve&rdquo; memory for co-tenant programs, unless the programs are fully synchronized (e.g. the Go program calls some subprocess and blocks while its callee executes), the result will be less reliable as inevitably both programs will need more memory. Letting the Go program use less memory when it doesn&rsquo;t need it will generate a more reliable result overall. This advice also applies to overcommit situations, where the sum of memory limits of containers running on one machine may exceed the actual physical memory available to the machine.</p>
<p>虽然尝试为共同租户程序 &ldquo;保留 &ldquo;内存可能很诱人，但除非程序是完全同步的（例如Go程序调用一些子进程并在其被调用者执行时进行阻塞），否则结果将不太可靠，因为不可避免地两个程序都需要更多的内存。当Go程序不需要内存时，让它少用点内存，总体上会产生更可靠的结果。这个建议也适用于过度提交的情况，在一台机器上运行的容器的内存限制之和可能超过机器实际可用的物理内存。</p>
</li>
<li>
<p><strong>Don&rsquo;t</strong> use the memory limit when deploying to an execution environment you don&rsquo;t control, especially when your program&rsquo;s memory use is proportional to its inputs. 当部署到一个你无法控制的执行环境时，不要使用内存限制，特别是当你的程序的内存使用与它的输入成正比时。</p>
<p>A good example is a CLI tool or a desktop application. Baking a memory limit into the program when it&rsquo;s unclear what kind of inputs it might be fed, or how much memory might be available on the system can lead to confusing crashes and poor performance. Plus, an advanced end-user can always set a memory limit if they wish.</p>
<p>一个很好的例子是CLI工具或一个桌面应用程序。当不清楚可能会有什么样的输入，或者系统上可能有多少内存时，在程序中设置内存限制会导致混乱的崩溃和糟糕的性能。另外，如果高级的最终用户愿意，他们总是可以设置一个内存限制。</p>
</li>
<li>
<p><strong>Don&rsquo;t</strong> set a memory limit to avoid out-of-memory conditions when a program is already close to its environment&rsquo;s memory limits. 当程序已经接近其环境的内存限制时，不要设置内存限制来避免内存不足的情况。</p>
<p>This effectively replaces an out-of-memory risk with a risk of severe application slowdown, which is often not a favorable trade, even with the efforts Go makes to mitigate thrashing. In such a case, it would be much more effective to either increase the environment&rsquo;s memory limits (and <em>then</em> potentially set a memory limit) or decrease GOGC (which provides a much cleaner trade-off than thrashing-mitigation does).</p>
<p>这实际上是将内存不足的风险换成了严重的应用减速的风险，这通常不是一个有利的交易，即使Go为减轻激动所做的努力。在这种情况下，增加环境的内存限制（然后可能设置一个内存限制）或减少GOGC（这提供了一个比缓冲更干净的权衡）会更有效。</p>
</li>
</ul>
<h3 id="latency-延迟">Latency 延迟</h3>
<p>The visualizations in this document have modeled the application as paused while the GC is executing. GC implementations do exist that behave this way, and they&rsquo;re referred to as &ldquo;stop-the-world&rdquo; GCs. 本文中的可视化演示将应用程序建模为在GC执行过程中暂停。确实存在这样的 GC 实现，它们被称为 &ldquo;停止-世界 &ldquo;GC。</p>
<p>The Go GC, however, is not fully stop-the-world and does most of its work concurrently with the application. This is primarily to reduce application <em>latencies</em>. Specifically, the end-to-end duration of a single unit of computation (e.g. a web request). Thus far, this document mainly considered application <em>throughput</em> (e.g. web requests handled per second). Note that each example in the <a href="https://go.dev/doc/gc-guide#The_GC_cycle" target="_blank" rel="noopener">GC cycle</a> section focused on the total CPU duration of an executing program. However, such a duration is far less meaningful for say, a web service. While throughput is still important for a web service (i.e. queries per second), often the latency of each individual request matters even more.</p>
<p>然而，Go GC 并不完全是 &ldquo;stop-the-world&rdquo;，它的大部分工作是与应用程序同时进行的。这主要是为了减少应用程序的延迟。具体来说，就是单个计算单元（如一个网络请求）的端到端持续时间。到目前为止，本文主要考虑了应用的吞吐量（如每秒处理的网络请求）。请注意，GC周期部分的每个例子都集中在一个执行程序的总CPU持续时间上。然而，对于网络服务来说，这样的持续时间远没有那么有意义。虽然吞吐量对网络服务来说仍然很重要（即每秒的查询次数），但通常每个单独请求的延迟甚至更重要。</p>
<p>In terms of latency, a stop-the-world GC may require a considerable length of time to execute both its mark and sweep phases, during which the application, and in the context of a web service, any in-flight request, is unable to make further progress. Instead, the Go GC avoids making the length of any global application pauses proportional to the size of the heap, and that the core tracing algorithm is performed while the application is actively executing. (The pauses are more strongly proportional to GOMAXPROCS algorithmically, but most commonly are dominated by the time it takes to stop running goroutines.) Collecting concurrently is not without cost: in practice it often leads to a design with lower throughput than an equivalent stop-the-world garbage collector. However, it&rsquo;s important to note that <em>lower latency does not inherently mean lower throughput</em>, and the performance of the Go garbage collector has steadily improved over time, in both latency and throughput.</p>
<p>就延迟而言，停止-世界GC可能需要相当长的时间来执行其标记和扫描阶段，在此期间，应用程序，以及在网络服务的背景下，任何飞行中的请求，都无法取得进一步进展。相反，Go GC避免了使任何全局应用暂停的长度与堆的大小成正比，而且核心跟踪算法是在应用积极执行时执行的。(暂停在算法上与GOMAXPROCS成正比，但最常见的是由停止运行goroutines的时间主导）。并发收集并不是没有代价的：在实践中，它常常导致设计的吞吐量低于同等的停止-世界垃圾收集器。然而，需要注意的是，较低的延迟并不意味着较低的吞吐量，随着时间的推移，Go垃圾收集器的性能在延迟和吞吐量方面都有了稳步的提高。</p>
<p>The concurrent nature of Go&rsquo;s current GC does not invalidate anything discussed in this document so far: none of the statements relied on this design choice. GC frequency is still the primary way the GC trades off between CPU time and memory for throughput, and in fact, it also takes on this role for latency. This is because most of the costs for the GC are incurred while the mark phase is active.</p>
<p>Go当前GC的并发性并没有使本文迄今为止所讨论的任何内容失效：没有一个说法是依赖于这种设计选择的。GC频率仍然是GC在CPU时间和内存之间交换吞吐量的主要方式，事实上，它在延迟方面也承担了这个角色。这是因为GC的大部分成本是在标记阶段活动时产生的。</p>
<p>The key takeaway then, is that <strong>reducing GC frequency may also lead to latency improvements</strong>. This applies not only to reductions in GC frequency from modifying tuning parameters, like increasing GOGC and/or the memory limit, but also applies to the optimizations described in the <a href="https://go.dev/doc/gc-guide#Optimization_guide" target="_blank" rel="noopener">optimization guide</a>.</p>
<p>因此，关键的启示是，减少GC频率也可能导致延迟的改善。这不仅适用于通过修改调谐参数来减少GC频率，比如增加GOGC和/或内存限制，而且也适用于优化指南中描述的优化。</p>
<p>However, latency is often more complex to understand than throughput, because it is a product of the moment-to-moment execution of the program and not just an aggregation of costs. As a result, the connection between latency and GC frequency is less direct. Below is a list of possible sources of latency for those inclined to dig deeper.</p>
<p>然而，延迟的理解往往比吞吐量更复杂，因为它是程序时刻执行的产物，而不仅仅是成本的聚合。因此，延迟和GC频率之间的联系不太直接。下面是一个可能的延迟来源的列表，供那些倾向于深入研究的人参考。</p>
<ol>
<li>Brief stop-the-world pauses when the GC transitions between the mark and sweep phases,</li>
<li>当GC在标记和扫描阶段之间转换时，会出现短暂的停止-世界的暂停。</li>
<li>调度延迟，因为GC在标记阶段需要25%的CPU资源。</li>
<li>用户goroutines协助GC应对高分配率。</li>
<li>当GC处于标记阶段时，指针的写入需要额外的工作，以及</li>
<li>正在运行的goroutines必须暂停，以便对其根部进行扫描。</li>
<li>Scheduling delays because the GC takes 25% of CPU resources when in the mark phase,</li>
<li>User goroutines assisting the GC in response to a high allocation rate,</li>
<li>Pointer writes requiring additional work while the GC is in the mark phase, and</li>
<li>Running goroutines must be suspended for their roots to be scanned.</li>
</ol>
<p>These latency sources are visible in <a href="https://go.dev/doc/diagnostics#execution-tracer" target="_blank" rel="noopener">execution traces</a>, except for pointer writes requiring additional work.</p>
<p>这些延迟源在执行跟踪中是可见的，除了需要额外工作的指针写入。</p>
<h3 id="additional-resources-额外的资源">Additional resources 额外的资源</h3>
<p>While the information presented above is accurate, it lacks the detail to fully understand costs and trade-offs in the Go GC&rsquo;s design. For more information, see the following additional resources.</p>
<p>虽然上面介绍的信息是准确的，但它缺乏细节，不能完全理解Go GC设计中的成本和权衡。欲了解更多信息，请参见以下额外资源。</p>
<ul>
<li><a href="https://gchandbook.org/" target="_blank" rel="noopener">The GC Handbook</a>—An excellent general resource and reference on garbage collector design.</li>
<li><a href="https://google.github.io/tcmalloc/design.html" target="_blank" rel="noopener">TCMalloc</a>—Design document for the C/C++ memory allocator TCMalloc, which the Go memory allocator is based on.</li>
<li><a href="https://go.dev/blog/go15gc" target="_blank" rel="noopener">Go 1.5 GC announcement</a>—The blog post announcing the Go 1.5 concurrent GC, which describes the algorithm in more detail.</li>
<li><a href="https://go.dev/blog/ismmkeynote" target="_blank" rel="noopener">Getting to Go</a>—An in-depth presentation about the evolution of Go&rsquo;s GC design up to 2018.</li>
<li><a href="https://docs.google.com/document/d/1wmjrocXIWTr1JxU-3EQBI6BK6KgtiFArkG47XK73xIQ/edit" target="_blank" rel="noopener">Go 1.5 concurrent GC pacing</a>—Design document for determining when to start a concurrent mark phase.</li>
<li><a href="https://github.com/golang/go/issues/30333" target="_blank" rel="noopener">Smarter scavenging</a>—Design document for revising the way the Go runtime returns memory to the operating system.</li>
<li><a href="https://github.com/golang/go/issues/35112" target="_blank" rel="noopener">Scalable page allocator</a>—Design document for revising the way the Go runtime manages memory it gets from the operating system.</li>
<li><a href="https://github.com/golang/go/issues/44167" target="_blank" rel="noopener">GC pacer redesign (Go 1.18)</a>—Design document for revising the algorithm to determine when to start a concurrent mark phase.</li>
<li><a href="https://github.com/golang/go/issues/48409" target="_blank" rel="noopener">Soft memory limit (Go 1.19)</a>—Design document for the soft memory limit.</li>
<li>The GC Handbook&ndash;关于垃圾收集器设计的优秀通用资源和参考资料。
TCMalloc-C/C++内存分配器TCMalloc的设计文档，Go内存分配器就是基于此设计的。
Go 1.5 GC 公告-宣布 Go 1.5 并发 GC 的博文，其中更详细地描述了该算法。
Getting to Go-关于Go的GC设计到2018年的演变的深入介绍。
Go 1.5 并发 GC 步伐-确定何时开始并发标记阶段的设计文件。
更加智能的清扫-设计文档，用于修改 Go 运行时向操作系统返回内存的方式。
可扩展的页面分配器&ndash;设计文档，用于修改 Go 运行时管理从操作系统获得的内存的方式。
GC pacer的重新设计（Go 1.18）&ndash;设计文件，用于修改确定何时开始并发标记阶段的算法。
软内存限制（Go 1.19）&ndash;关于软内存限制的设计文档。</li>
</ul>
<h2 id="a-note-about-virtual-memory-关于虚拟内存的说明">A note about virtual memory 关于虚拟内存的说明</h2>
<p>This guide has largely focused on the physical memory use of the GC, but a question that comes up regularly is what exactly that means and how it compares to virtual memory (typically presented in programs like <code>top</code> as &ldquo;VSS&rdquo;).</p>
<p>本指南主要关注GC的物理内存使用，但经常出现的一个问题是这到底是什么意思，以及它与虚拟内存（通常在top等程序中以 &ldquo;VSS &ldquo;表示）的比较。</p>
<p>Physical memory is memory housed in the actual physical RAM chip in most computers. <a href="https://en.wikipedia.org/wiki/Virtual_memory" target="_blank" rel="noopener">Virtual memory</a> is an abstraction over physical memory provided by the operating system to isolate programs from one another. It&rsquo;s also typically acceptable for programs to reserve virtual address space that doesn&rsquo;t map to any physical addresses at all.</p>
<p>物理内存是存放在大多数计算机中的实际物理RAM芯片中的内存。虚拟内存是由操作系统提供的对物理内存的一种抽象，以使程序相互隔离。通常情况下，程序保留的虚拟地址空间也是可以接受的，它根本没有映射到任何物理地址。</p>
<p><strong>Because virtual memory is just a mapping maintained by the operating system, it is typically very cheap to make large virtual memory reservations that don&rsquo;t map to physical memory.</strong></p>
<p>因为虚拟内存只是一个由操作系统维护的映射，所以一般来说，保留大量的虚拟内存而不映射到物理内存是非常便宜的。</p>
<p>The Go runtime generally relies upon this view of the cost of virtual memory in a few ways:</p>
<p>Go运行时通常在几个方面依赖于这种对虚拟内存成本的看法：</p>
<ul>
<li>
<p>The Go runtime never deletes virtual memory that it maps. Instead, it uses special operations that most operating systems provide to explicitly release any physical memory resources associated with some virtual memory range. Go运行时从不删除其映射的虚拟内存。相反，它使用大多数操作系统提供的特殊操作来明确释放与某些虚拟内存范围相关的任何物理内存资源。</p>
<p>This technique is used explicitly to manage the <a href="https://go.dev/doc/gc-guide#Memory_limit" target="_blank" rel="noopener">memory limit</a> and return memory to the operating system that the Go runtime no longer needs. The Go runtime also releases memory it no longer needs continuously in the background. See <a href="https://go.dev/doc/gc-guide#Additional_resources" target="_blank" rel="noopener">the additional resources</a> for more information.</p>
<p>这种技术被明确用于管理内存限制，并将Go运行时不再需要的内存返回给操作系统。Go运行时也在后台持续释放它不再需要的内存。更多信息请参见附加资源。</p>
</li>
<li>
<p>On 32-bit platforms, the Go runtime reserves between 128 MiB and 512 MiB of address space up-front for the heap to limit fragmentation issues. 在32位平台上，Go运行时预先为堆保留128 MiB到512 MiB的地址空间，以限制碎片化问题。</p>
</li>
<li>
<p>The Go runtime uses large virtual memory address space reservations in the implementation of several internal data structures. On 64-bit platforms, these typically have a minimum virtual memory footprint of about 700 MiB. On 32-bit platforms, their footprint is negligible. Go运行时在实现几个内部数据结构时使用了大量的虚拟内存地址空间保留。在64位平台上，这些结构的最小虚拟内存占用空间约为700 MiB。在32位平台上，它们的足迹可以忽略不计。</p>
</li>
</ul>
<p>As a result, virtual memory metrics such as &ldquo;VSS&rdquo; in <code>top</code> are typically not very useful in understanding a Go program&rsquo;s memory footprint. Instead, focus on &ldquo;RSS&rdquo; and similar measurements, which more directly reflect physical memory usage.</p>
<p>因此，虚拟内存指标，如top中的 &ldquo;VSS&rdquo;，通常对了解Go程序的内存占用情况没有多大作用。相反，要关注 &ldquo;RSS &ldquo;和类似的测量指标，它们能更直接地反映物理内存的使用情况。</p>
<h2 id="optimization-guide-优化指南">Optimization guide 优化指南</h2>
<h3 id="identifying-costs-识别成本">Identifying costs 识别成本</h3>
<p>Before trying to optimize how your Go application interacts with the GC, it&rsquo;s important to first identify that the GC is a major cost in the first place.</p>
<p>在尝试优化您的 Go 程序与 GC 的交互方式之前，首先要确定 GC 首先是一个主要成本。</p>
<p>The Go ecosystem provides a number of tools for identifying costs and optimizing Go applications. For a brief overview of these tools, see the <a href="https://go.dev/doc/diagnostics" target="_blank" rel="noopener">guide on diagnostics</a>. Here, we&rsquo;ll focus on a subset of these tools and a reasonable order to apply them in in order to understand GC impact and behavior.</p>
<p>Go 生态系统提供了许多工具用于识别成本和优化 Go 应用程序。关于这些工具的简要概述，请参阅诊断指南。在此，我们将重点介绍这些工具的一个子集，以及应用这些工具的合理顺序，以了解GC的影响和行为。</p>
<ol>
<li>
<p>**CPU profiles **CPU配置文件</p>
<p>A good place to start is with <a href="https://pkg.go.dev/runtime/pprof#hdr-Profiling_a_Go_program" target="_blank" rel="noopener">CPU profiling</a>. CPU profiling provides an overview of where CPU time is spent, though to the untrained eye it may be difficult to identify the magnitude of the role the GC plays in a particular application. Luckily, understanding how the GC fits in mostly boils down to knowing what different functions in the <code>runtime</code> package mean. Below is a useful subset of these functions for interpreting CPU profiles.</p>
<p>一个好的开始是CPU剖析。CPU剖析提供了一个关于CPU时间使用情况的概述，尽管对于未经训练的人来说，可能很难确定GC在一个特定的应用程序中所扮演的角色的大小。幸运的是，理解GC的作用主要归结为了解<code>runtime</code>包中的不同函数的含义。下面是这些函数的一个有用的子集，用于解释CPU配置文件。</p>
<p><em>Note: the functions listed below are not leaf functions, so they may not show up in the default the <code>pprof</code> tool provides with the <code>top</code> command. Instead, use the <code>top -cum</code> command or use the <code>list</code> command on these functions directly and focus on the cumulative percent column.</em></p>
<p>注意：下面列出的函数不是叶子函数，所以它们可能不会出现在pprof工具提供的默认的top命令中。相反，使用top -cum命令或者直接对这些函数使用list命令，并关注累积百分比这一栏。</p>
</li>
<li>
<ul>
<li>
<p><strong><code>runtime.gcBgMarkWorker</code></strong>: Entrypoint to the dedicated mark worker goroutines. Time spent here scales with GC frequency and the complexity and size of the object graph. It represents a baseline for how much time the application spends marking and scanning. runtime.gcBgMarkWorker。专用标记工作程序的入口点。这里花费的时间随着GC频率和对象图的复杂性和大小而变化。它代表了应用程序花在标记和扫描上的时间的基线。</p>
<p><em>Note: In a largely idle Go application, the Go GC is going to use up additional (idle) CPU resources to get its job done faster. As a result, this symbol may represent a large fraction of samples, that it believes are free. One common reason this can happen is if an application runs entirely in one goroutine but</em> <code>GOMAXPROCS</code> <em>is &gt;1.</em></p>
<p>注意：在一个基本空闲的Go应用程序中，Go GC将使用额外的（空闲的）CPU资源来更快地完成其工作。因此，这个符号可能代表了很大一部分的样本，它认为这些样本是空闲的。发生这种情况的一个常见原因是，如果一个应用程序完全在一个goroutine中运行，但GOMAXPROCS&gt;1。</p>
</li>
<li>
<p><strong><code>runtime.mallocgc</code></strong>: Entrypoint to the memory allocator for heap memory. A large amount of cumulative time spent here (&gt;15%) typically indicates a lot of memory being allocated. runtime.mallocgc: 堆内存分配器的入口点。在这里花费的大量累计时间（&gt;15%）通常表明有大量的内存被分配。</p>
</li>
<li>
<p><strong><code>runtime.gcAssistAlloc</code></strong>: Function goroutines enter to yield some of their time to assist the GC with scanning and marking. A large amount of cumulative time spent here (&gt;5%) indicates that the application is likely out-pacing the GC with respect to how fast it&rsquo;s allocating. It indicates a particularly high degree of impact from the GC, and also represents time the application spend marking and scanning. Note that this is included in the <code>runtime.mallocgc</code> call tree, so it will inflate that as well. runtime.gcAssistAlloc。函数goroutines进入，让出部分时间来协助GC进行扫描和标记。在这里花费的大量累计时间（&gt;5%）表明，应用程序在分配速度方面很可能超过了GC的速度。它表明GC的影响程度特别高，也代表了应用程序花在标记和扫描上的时间。请注意，这包括在runtime.mallocgc的调用树中，所以它也会使其膨胀。</p>
</li>
</ul>
</li>
<li>
<p>**Execution traces **执行跟踪</p>
<p>While CPU profiles are great for identifying where time is spent in aggregate, they&rsquo;re less useful for indicating performance costs that are more subtle, rare, or related to latency specifically. Execution traces on the other hand provide a rich and deep view into a short window of a Go program&rsquo;s execution. They contain a variety of events related to the Go GC and specific execution paths can be directly observed, along with how the application might interact with the Go GC. All the GC events tracked are conveniently labeled as such in the trace viewer. 虽然CPU配置文件对于识别总体上花费的时间是很好的，但对于显示更微妙的、罕见的或与延迟具体相关的性能成本来说，它们就不太有用。另一方面，执行跟踪提供了一个丰富而深入的视角，可以看到Go程序执行的短暂窗口。它们包含与Go GC相关的各种事件，可以直接观察到具体的执行路径，以及应用程序如何与Go GC互动。所有被跟踪的GC事件在跟踪查看器中都有相应的标签，非常方便。</p>
<p>See the <a href="https://pkg.go.dev/runtime/trace" target="_blank" rel="noopener">documentation for the <code>runtime/trace</code></a> package for how to get started with execution traces.</p>
<p>关于如何开始使用执行跟踪，请参见runtime/trace包的文档。</p>
</li>
<li>
<p>**GC traces ** GC跟踪</p>
<p>When all else fails, the Go GC provides a few different specific traces that provide much deeper insights into GC behavior. These traces are always printed directly to STDERR, one line per GC cycle, and are configured through the <code>GODEBUG</code> environment variable that all Go programs recognize. They&rsquo;re mostly useful for debugging the Go GC itself since they require some familiarity with the specifics of the GC&rsquo;s implementation, but nonetheless can occasionally be useful to gain a better understanding of GC behavior.</p>
<p>当所有其他方法都失败时，Go GC提供了一些不同的特定跟踪，可以更深入地了解GC行为。这些痕迹总是直接打印到STDERR，每个GC周期一行，并通过所有Go程序都能识别的GODEBUG环境变量进行配置。它们主要用于调试 Go GC 本身，因为它们需要对 GC 的具体实现有一定的了解，但尽管如此，偶尔也能对 GC 行为有更好的理解。</p>
<p>The core GC trace is enabled by setting <code>GODEBUG=gctrace=1</code>. The output produced by this trace is documented in the <a href="https://pkg.go.dev/runtime#hdr-Environment_Variables" target="_blank" rel="noopener">environment variables section in the documentation for the <code>runtime</code> package.</a></p>
<p>通过设置GODEBUG=gctrace=1，可以启用核心GC跟踪。这个跟踪所产生的输出在运行时软件包的环境变量部分有记录。</p>
<p>A supplementary GC trace called the &ldquo;pacer trace&rdquo; provides even deeper insights and is enabled by setting <code>GODEBUG=gcpacertrace=1</code>. Interpreting this output requires an understanding of the GC&rsquo;s &ldquo;pacer&rdquo; (see <a href="https://go.dev/doc/gc-guide#Additional_resources" target="_blank" rel="noopener">additional resources</a>), which is outside the scope of this guide.</p>
<p>一个被称为 &ldquo;pacer trace &ldquo;的补充GC跟踪提供了更深入的见解，通过设置GODEBUG=gcpacertrace=1来启用。解读这个输出需要了解GC的 &ldquo;pacer&rdquo;（见额外资源），这不在本指南的范围之内。</p>
</li>
</ol>
<h3 id="eliminating-heap-allocations-消除堆的分配">Eliminating heap allocations 消除堆的分配</h3>
<p>One way to reduce costs from the GC is to have the GC manage fewer values to begin with. The techniques described below can produce some of the largest improvements in performance, because as the <a href="https://go.dev/doc/gc-guide#GOGC" target="_blank" rel="noopener">GOGC section</a> demonstrated, the allocation rate of a Go program is a major factor in GC frequency, the key cost metric used by this guide.</p>
<p>减少GC成本的一个方法是让GC从一开始就管理更少的值。下面描述的技术可以产生一些最大的性能改进，因为正如GOGC部分所展示的，Go程序的分配率是影响GC频率的主要因素，而GC频率是本指南所使用的关键成本指标。</p>
<h4 id="heap-profiling-堆分析">Heap profiling 堆分析</h4>
<p>After <a href="https://go.dev/doc/gc-guide#Identifying_costs" target="_blank" rel="noopener">identifying that the GC is a source of significant costs</a>, the next step in eliminating heap allocations is to find out where most of them are coming from. For this purpose, memory profiles (really, heap memory profiles) are very useful. Check out the <a href="https://pkg.go.dev/runtime/pprof#hdr-Profiling_a_Go_program" target="_blank" rel="noopener">documentation</a> for how to get started with them.</p>
<p>在确定GC是重要成本的来源之后，消除堆分配的下一步是找出其中大部分的分配来自哪里。为了这个目的，内存剖析（实际上是堆内存剖析）是非常有用的。请查看文档，了解如何开始使用它们。</p>
<p>Memory profiles describe where in the program heap allocations come from, identifying them by the stack trace at the point they were allocated. Each memory profile can break down memory in four ways.</p>
<p>内存配置文件描述了程序中堆分配的位置，通过堆栈跟踪来识别它们被分配的位置。每个内存配置文件可以从四个方面对内存进行分解。</p>
<ul>
<li><code>inuse_objects</code>—Breaks down the number of objects that are live.</li>
<li><code>inuse_space</code>—Breaks down live objects by how much memory they use in bytes.</li>
<li><code>alloc_objects</code>—Breaks down the number of objects that have been allocated since the Go program began executing.</li>
<li><code>alloc_space</code>—Breaks down the total amount of memory allocated since the Go program began executing.</li>
<li>inuse_objects-分解出活的对象的数量。</li>
<li>inuse_space&ndash;通过它们使用的内存的字节数来细分活的对象。</li>
<li>alloc_objects-列出Go程序开始执行后被分配的对象的数量。</li>
<li>alloc_space-列出了自Go程序开始执行以来分配的内存总量。</li>
</ul>
<p>Switching between these different views of heap memory may be done with either the <code>-sample_index</code> flag to the <code>pprof</code> tool, or via the <code>sample_index</code> option when the tool is used interactively.</p>
<p>在这些不同的堆内存视图之间的切换可以通过pprof工具的-sample_index标志完成，或者在交互式使用工具时通过sample_index选项完成。</p>
<p><em>Note: memory profiles by default only sample a subset of heap objects so they will not contain information about every single heap allocation. However, this is sufficient to find hot-spots. To change the sampling rate, see <a href="https://pkg.go.dev/runtime#pkg-variables" target="_blank" rel="noopener"><code>runtime.MemProfileRate</code></a>.</em></p>
<p>注意：默认情况下，内存配置文件只对堆对象的一个子集进行采样，所以它们不会包含每个堆分配的信息。然而，这足以发现热点问题。要改变采样率，请看runtime.MemProfileRate。</p>
<p>For the purposes of reducing GC costs, <code>alloc_space</code> is typically the most useful view as it directly corresponds to the allocation rate. This view will indicate allocation hot spots that would provide the most benefit.</p>
<p>为了降低GC成本，alloc_space通常是最有用的视图，因为它直接对应于分配率。这个视图将指出能提供最大好处的分配热点。</p>
<h4 id="escape-analysis-逃逸分析">Escape analysis 逃逸分析</h4>
<p>Once candidate heap allocation sites have been identified with the help of <a href="https://go.dev/doc/gc-guide#Heap_profiling" target="_blank" rel="noopener">heap profiles</a>, how can they be eliminated? The key is to leverage the Go compiler&rsquo;s escape analysis to have the Go compiler find alternative, and more efficient storage for this memory, for example in the goroutine stack. Luckily, the Go compiler has the ability to describe why it decides to escape a Go value to the heap. With that knowledge, it becomes a matter of reorganizing your source code to change the outcome of the analysis (which is often the hardest part, but outside the scope of this guide).</p>
<p>一旦在堆配置文件的帮助下确定了候选的堆分配点，如何消除它们呢？关键是利用Go编译器的逃逸分析，让Go编译器为这些内存找到其他更有效的存储方式，例如在goroutine栈中。幸运的是，Go编译器有能力描述它为什么决定将Go值转移到堆中。有了这些知识，重新组织你的源代码以改变分析的结果就成了一个问题（这往往是最难的部分，但不在本指南的范围内）。</p>
<p>As for how to access the information from the Go compiler&rsquo;s escape analysis, the simplest way is through a debug flag supported by the Go compiler that describes all optimizations it applied or did not apply to some package in a text format. This includes whether or not values escape. Try the following command, where <code>[package]</code> is some Go package path.</p>
<p>至于如何从Go编译器的逃逸分析中获取信息，最简单的方法是通过Go编译器支持的调试标志，以文本格式描述它对某些包应用或未应用的所有优化。这包括数值是否转义。试试下面的命令，其中 [package] 是一些 Go 包的路径。</p>
<pre tabindex="0"><code>$ go build -gcflags=-m=3 [package]
</code></pre><p>This information can also be visualized as an overlay in VS Code. This overlay is configured and enabled in the VS Code Go plugin settings.</p>
<p>这些信息也可以在VS Code中以叠加的方式可视化。这个覆盖是在VS Code Go插件设置中配置并启用的。</p>
<ol>
<li>Set the <a href="https://github.com/golang/vscode-go/wiki/settings#uicodelenses" target="_blank" rel="noopener"><code>ui.codelenses</code> setting to include <code>gc_details</code> </a>.</li>
<li>Enable the overlay for escape analysis by <a href="https://github.com/golang/vscode-go/wiki/settings#uidiagnosticannotations" target="_blank" rel="noopener">setting <code>ui.diagnostic.annotations</code> to include <code>escape</code> </a>.</li>
<li>将ui.codelenses设置为包括gc_details 。</li>
<li>通过将ui.diagnostic.annotations设置为包括escape，启用用于转义分析的覆盖层。</li>
</ol>
<p>Finally, the Go compiler provides this information in a machine-readable (JSON) format that may be used to build additional custom tooling. For more information on that, see the <a href="https://cs.opensource.google/go/go/&#43;/master:src/cmd/compile/internal/logopt/log_opts.go;l=25;drc=351e0f4083779d8ac91c05afebded42a302a6893" target="_blank" rel="noopener">documentation in the source Go code</a>.</p>
<p>最后，Go编译器以机器可读的（JSON）格式提供这些信息，可用于建立额外的自定义工具。关于这方面的更多信息，请参见 Go 源代码中的文档。</p>
<h3 id="implementation-specific-optimizations-特定于实现的优化">Implementation-specific optimizations 特定于实现的优化</h3>
<p>The Go GC is sensitive to the demographics of live memory, because a complex graph of objects and pointers both limits parallelism and generates more work for the GC. As a result, the GC contains a few optimizations for specific common structures. The most directly useful ones for performance optimization are listed below.</p>
<p>Go GC 对实时内存的人口统计很敏感，因为对象和指针的复杂图形既限制了并行性，也为 GC 产生了更多的工作。因此，GC包含了一些针对特定通用结构的优化。下面列出了对性能优化最直接有用的优化。</p>
<p><em>Note: Applying the optimizations below may reduce the readability of your code by obscuring intent, and may fail to hold up across Go releases. Prefer to apply these optimizations only in the places they matter most. Such places may be identified by using the tools listed in the <a href="https://go.dev/doc/gc-guide#Identifying_costs" target="_blank" rel="noopener">section on identifying costs</a>.</em></p>
<p>注意：应用下面的优化可能会掩盖你的意图而降低你的代码的可读性，并且可能无法在Go的各个版本中保持不变。最好是只在最重要的地方应用这些优化。这些地方可以通过使用识别成本一节中列出的工具来识别。</p>
<ul>
<li>
<p>Pointer-free values are segregated from other values. 无指针值与其他值是分开的。</p>
<p>As a result, it may be advantageous to eliminate pointers from data structures that do not strictly need them, as this reduces the cache pressure the GC exerts on the program. As a result, data structures that rely on indices over pointer values, while less well-typed, may perform better. This is only worth doing if it&rsquo;s clear that the object graph is complex and the GC is spending a lot of time marking and scanning.</p>
<p>因此，从不严格需要指针的数据结构中消除指针可能是有利的，因为这可以减少GC对程序的缓存压力。因此，依靠指针值的索引的数据结构，虽然类型不那么好，但可能表现得更好。只有在明确了对象图很复杂，并且GC花了很多时间来标记和扫描的情况下，才值得这样做。</p>
</li>
<li>
<p>The GC will stop scanning values at the last pointer in the value. GC会在值中的最后一个指针处停止扫描值。</p>
<p>As a result, it may be advantageous to group pointer fields in struct-typed values at the beginning of the value. This is only worth doing if it&rsquo;s clear the application spends a lot of its time marking and scanning. (In theory the compiler can do this automatically, but it is not yet implemented, and struct fields are arranged as written in the source code.)</p>
<p>因此，将结构类型的值中的指针字段在值的开头分组可能是有利的。只有在应用程序明显花费大量时间进行标记和扫描时才值得这样做。(理论上，编译器可以自动做到这一点，但目前还没有实现，结构字段是按照源代码中的写法排列的)。</p>
</li>
</ul>
<p>Furthermore, the GC must interact with nearly every pointer it sees, so using indices into an slice, for example, instead of pointers, can aid in reducing GC costs.</p>
<p>此外，GC必须与它所看到的几乎每一个指针进行交互，所以使用索引进入一个片断，例如，代替指针，可以帮助减少GC成本。</p>
<h2 id="appendix-附录">Appendix 附录</h2>
<h3 id="additional-notes-on-gogc-关于gogc的补充说明">Additional notes on GOGC 关于GOGC的补充说明</h3>
<p>The <a href="https://go.dev/doc/gc-guide#GOGC" target="_blank" rel="noopener">GOGC section</a> claimed that doubling GOGC doubles heap memory overheads and halves GC CPU costs. To see why, let&rsquo;s break it down mathematically.</p>
<p>GOGC部分声称，将GOGC翻倍可以使堆内存开销翻倍，并使GC的CPU成本减半。为了了解原因，让我们从数学上进行分解。</p>
<p>Firstly, the heap target sets a target for the total heap size. This target, however, mainly influences the new heap memory, because the live heap is fundamental to the application.</p>
<p>首先，堆目标为总的堆大小设定了一个目标。然而，这个目标主要影响新的堆内存，因为活堆是应用程序的基础。</p>
<p><em>Target heap memory = Live heap + (Live heap + GC roots) * GOGC / 100</em></p>
<p>目标堆内存=活堆+（活堆+GC根）*GOGC/100</p>
<p><em>Total heap memory = Live heap + New heap memory</em></p>
<p>总堆内存=活堆+新堆内存</p>
<p><em>⇒</em></p>
<p><em>New heap memory = (Live heap + GC roots) * GOGC / 100</em></p>
<p>新堆内存=（活堆+GC根）*GOGC/100</p>
<p>From this we can see that doubling GOGC would also double the amount of new heap memory that application will allocate each cycle, which captures heap memory overheads. Note that <em>Live heap + GC roots</em> is an approximation of the amount of memory the GC needs to scan.</p>
<p>从中我们可以看出，将GOGC翻倍也会使应用程序每个周期分配的新堆内存量翻倍，这就抓住了堆内存的开销。注意，Live heap + GC roots是GC需要扫描的内存量的近似值。</p>
<p>Next, let&rsquo;s look at GC CPU cost. Total cost can be broken down as the cost per cycle, times GC frequency over some time period T.</p>
<p>接下来，我们来看看GC的CPU成本。总成本可以分解为每个周期的成本，乘以某个时间段T的GC频率。</p>
<p><em>Total GC CPU cost = (GC CPU cost per cycle) * (GC frequency) * T</em></p>
<p>GC CPU总成本=（GC CPU每周期成本）*（GC频率）*T</p>
<p>GC CPU cost per cycle can be derived from the <a href="https://go.dev/doc/gc-guide#Understanding_costs" target="_blank" rel="noopener">GC model</a>:</p>
<p>每周期的GC CPU成本可以从GC模型中得出：</p>
<p><em>GC CPU cost per cycle = (Live heap + GC roots) * (Cost per byte) + Fixed cost</em></p>
<p>每周期的GC CPU成本=（活堆+GC根）*（每字节成本）+固定成本</p>
<p>Note that sweep phase costs are ignored here as mark and scan costs dominate.</p>
<p>注意，这里忽略了扫频阶段的成本，因为标记和扫描成本占主导地位。</p>
<p>The steady-state is defined by a constant allocation rate and a constant cost per byte, so in the steady-state we can derive a GC frequency from this new heap memory:</p>
<p>稳态是由一个恒定的分配率和每字节的恒定成本定义的，所以在稳态下，我们可以从这个新的堆内存中得出GC频率。</p>
<p><em>GC frequency = (Allocation rate) / (New heap memory) = (Allocation rate) / ((Live heap + GC roots) * GOGC / 100)</em></p>
<p>GC频率=（分配率）/（新堆内存）=（分配率）/（（活堆+GC根）*GOGC/100）。</p>
<p>Putting this together, we get the full equation for the total cost:</p>
<p>把这些放在一起，我们可以得到总成本的完整方程式：</p>
<p><em>Total GC CPU cost = (Allocation rate) / ((Live heap + GC roots) * GOGC / 100) * ((Live heap + GC roots) * (Cost per byte) + Fixed cost) * T</em></p>
<p>总的GC CPU成本=（分配率）/（（活堆+GC根）<em>GOGC/100）</em>（（活堆+GC根）*（每字节成本）+固定成本）*T</p>
<p>For a sufficiently large heap (which represents most cases), the marginal costs of a GC cycle dominate the fixed costs. This allows for a significant simplification of the total GC CPU cost formula.</p>
<p>对于一个足够大的堆（这代表了大多数情况），GC周期的边际成本主导了固定成本。这使得GC CPU总成本的计算公式得到了极大的简化。</p>
<p><em>Total GC CPU cost = (Allocation rate) / (GOGC / 100) * (Cost per byte) * T</em></p>
<p>总的GC CPU成本=（分配率）/（GOGC/100）*（每字节成本）*T</p>
<p>From this simplified formula, we can see that if we double GOGC, we halve total GC CPU cost. (Note that the visualizations in this guide do simulate fixed costs, so the GC CPU overheads reported by them will not exactly halve when GOGC doubles.) Furthermore, GC CPU costs are largely determined by allocation rate and the cost per byte to scan memory. For more information on how to reduce these costs specifically, see the <a href="https://go.dev/doc/gc-guide#Optimization_guide" target="_blank" rel="noopener">optimization guide</a>.</p>
<p>从这个简化的公式中，我们可以看到，如果我们把GOGC增加一倍，就可以把GC的CPU总成本降低一半。(请注意，本指南中的可视化演示确实模拟了固定成本，所以当GOGC翻倍时，它们所报告的GC CPU开销不会完全减半）。此外，GC的CPU成本主要由分配率和扫描内存的每字节成本决定。关于如何具体减少这些成本的更多信息，请参阅优化指南。</p>
<p><em>Note: there exists a discrepancy between the size of the live heap, and the amount of that memory the GC actually needs to scan: the same size live heap but with a different structure will result in a different CPU cost, but the same memory cost, resulting a different trade-off. This is why the structure of the heap is part of the definition of the steady-state. The heap target should arguably only include the scannable live heap as a closer approximation of memory the GC needs to scan, but this leads to degenerate behavior when there&rsquo;s a very small amount of scannable live heap but the live heap is otherwise large.</em></p>
<p>注意：在实时堆的大小和GC实际需要扫描的该内存的数量之间存在差异：同样大小的实时堆，但结构不同，将导致不同的CPU成本，但内存成本相同，导致不同的权衡。这就是为什么堆的结构是稳定状态定义的一部分。可以说，堆的目标应该只包括可扫描的活堆，作为GC需要扫描的内存的更近似值，但这导致了当可扫描的活堆数量非常少，但活堆却很大时的退化行为。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e44c1396e12544d7a53fb01b7eb37b34">4 - 开发模块</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-388c645443b15a8b90e9ac0a6e58db20">4.1 - 开发和发布模块</h1>
    
	<h1 id="developing-and-publishing-modules---开发和发布模块">Developing and publishing modules - 开发和发布模块</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/modules/developing" target="_blank" rel="noopener">https://go.dev/doc/modules/developing</a></p>
</blockquote>
<p>​	您可以将相关的包收集到模块中，然后发布该模块供其他开发人员使用。本主题概述了开发和发布模块的概述。</p>
<p>​	为了支持模块的开发、发布和使用，您需要使用以下内容：</p>
<ul>
<li>通过该流程，您可以开发和发布模块，并随时间进行新版本的修订。请参阅&quot;开发和发布模块的工作流程&quot;。</li>
<li>设计实践，帮助模块的用户理解并以稳定的方式升级到新版本。请参阅&quot;设计和开发&quot;。</li>
<li>一个去中心化系统，用于发布模块和检索其代码。您可以将自己的模块从自己的存储库中提供给其他开发人员使用，并发布一个版本号。请参阅&quot;去中心化发布&quot;。</li>
<li>一个包搜索引擎和文档浏览器（pkg.go.dev），开发人员可以在其中找到您的模块。请参阅&quot;包发现&quot;。</li>
<li>一种模块版本编号约定，以向使用您的模块的开发人员传达稳定性和向后兼容性的期望。请参阅&quot;版本控制&quot;。</li>
<li>Go 工具可以使其他开发人员更轻松地管理依赖项，包括获取您的模块源代码、升级等。请参阅&quot;<a href="../../ManagingDependencies">管理依赖项</a>&quot;。</li>
</ul>
<p>另请参阅</p>
<ul>
<li>如果您只是想使用其他人开发的包，这个主题不适合你。请参阅&quot;<a href="../../ManagingDependencies">管理依赖项</a>&quot;。</li>
<li>有关包括一些模块开发基础的教程，请参阅&quot;<a href="../../../GettingStarted/TutorialCreateAGoModule">教程：创建一个Go模块</a>&quot;。</li>
</ul>
<h2 id="开发和发布模块的工作流程">开发和发布模块的工作流程</h2>
<p>​	当您想要为其他人发布模块时，您需要采用一些约定，以便使用这些模块更加容易。</p>
<p>​	以下高级步骤在&quot;<a href="../ModuleReleaseAndVersioningWorkflow">模块发布和版本控制工作流程</a>&ldquo;中有更详细的描述。</p>
<ol>
<li>设计和编写模块包含的包。</li>
<li>使用确保通过 Go 工具可供其他人使用的约定将代码提交到存储库。</li>
<li>发布模块以使其可供开发人员发现。</li>
<li>随时间修订模块，使用一种版本编号约定来表示每个版本的稳定性和向后兼容性。</li>
</ol>
<h2 id="设计与开发">设计与开发</h2>
<p>​	如果模块中的函数和包形成了一个一致的整体，那么其他开发人员将更容易找到和使用您的模块。在设计模块的公共API时，请尽量使其功能集中和离散化。</p>
<p>​	此外，考虑到向后兼容性来设计和开发模块有助于其用户在升级时最小化其代码的重构。您可以在代码中使用某些技术，以避免发布破坏向后兼容性的版本。有关这些技术的更多信息，请参见Go博客中的&rdquo;<a href="../../../GoBlog/2020/KeepingYourModulesCompatible">保持模块兼容</a>&quot;。</p>
<p>​	在发布模块之前，您可以使用&quot;replace&quot;指令在本地文件系统上引用它。这使编写客户端代码来调用模块中的函数更容易，同时模块仍处于开发中。有关更多信息，请参见&quot;<a href="../ModuleReleaseAndVersioningWorkflow">模块发布和版本控制工作流程</a>&ldquo;中的&quot;针对未发布模块的编码&rdquo;。</p>
<h2 id="去中心化发布">去中心化发布</h2>
<p>​	在Go中，您通过在存储库中标记其代码来发布模块，以使其他开发人员可以使用它。您无需将模块推送到集中式服务，因为Go工具可以直接从您的存储库（使用省略了协议的URL作为模块路径）或代理服务器下载您的模块。</p>
<p>​	在其代码中导入您的包后，开发人员使用Go工具（包括<code>go get</code>命令）下载您的模块代码以进行编译。为支持此模型，您需要遵循使Go工具（代表另一个开发人员）从您的存储库检索模块源代码的惯例和最佳实践。例如，Go工具使用您指定的模块路径以及您用于标记模块发布的模块版本号来定位并下载模块以供其用户使用。</p>
<p>​	有关源和发布惯例和最佳实践的更多信息，请参见&quot;<a href="../ManagingModuleSource">管理模块源</a>&quot;。</p>
<p>​	有关发布模块的逐步说明，请参见&quot;<a href="../PublishingAModule">发布模块</a>&quot;。</p>
<h2 id="包发现">包发现</h2>
<p>​	在您发布了模块并有人使用Go工具获取它之后，它将出现在Go包发现站点<a href="https://pkg.go.dev/" target="_blank" rel="noopener">pkg.go.dev</a>上。在那里，开发人员可以搜索该站点以找到它并阅读其文档。</p>
<p>​	要开始使用该模块，开发人员从该模块中导入包，然后运行<code>go get</code>命令以下载其源代码以进行编译。</p>
<p>​	有关开发人员如何找到和使用模块的更多信息，请参见&quot;<a href="../../ManagingDependencies">管理依赖项</a>&quot;。</p>
<h2 id="版本控制">版本控制</h2>
<p>​	随着时间的推移，当你对模块进行修订和改进时，你会分配版本号（基于语义化版本控制模型），旨在标识每个版本的稳定性和向后兼容性。这有助于使用你的模块的开发人员确定模块何时稳定，以及升级是否可能包含行为上的重大更改。你可以通过在代码库中标记模块的源代码来指示模块的版本号。</p>
<p>​	关于开发主版本更新的更多信息，请参见<a href="../DevelopingAmajorVersionUpdate">开发主版本更新</a>。</p>
<p>​	关于如何使用 Go 模块的语义化版本控制模型的更多信息，请参见<a href="../ModuleVersionNumbering">模块版本编号</a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-28b79d99d0eba6421a1ed3af03cc3fcb">4.2 - 模块发布和版本管理的工作流程</h1>
    
	<h1 id="module-release-and-versioning-workflow---模块发布和版本管理的工作流程">Module release and versioning workflow - 模块发布和版本管理的工作流程</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/modules/release-workflow" target="_blank" rel="noopener">https://go.dev/doc/modules/release-workflow</a></p>
</blockquote>
<p>When you develop modules for use by other developers, you can follow a workflow that helps ensure a reliable, consistent experience for developers using the module. This topic describes the high-level steps in that workflow.</p>
<p>当你开发模块供其他开发者使用时，你可以遵循一个工作流程，以帮助确保使用该模块的开发者获得可靠、一致的体验。本主题描述了该工作流程中的高级步骤。</p>
<p>For an overview of module development, see <a href="https://go.dev/doc/modules/developing" target="_blank" rel="noopener">Developing and publishing modules</a>.</p>
<p>关于模块开发的概述，请参阅开发和发布模块。</p>
<p><strong>See also</strong></p>
<p>另见</p>
<ul>
<li>If you’re merely wanting to use external packages in your code, be sure to see <a href="https://go.dev/doc/modules/managing-dependencies" target="_blank" rel="noopener">Managing dependencies</a>.如果你只是想在你的代码中使用外部包，一定要看管理依赖性。</li>
<li>With each new version, you signal the changes to your module with its version number. For more, see <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.在每一个新的版本中，你都要用版本号来表示你的模块的变化。更多信息，请参见模块版本号。</li>
</ul>
<h2 id="common-workflow-steps-常见的工作流程步骤">Common workflow steps 常见的工作流程步骤</h2>
<p>The following sequence illustrates release and versioning workflow steps for an example new module. For more about each step, see the sections in this topic.</p>
<p>下面的顺序说明了一个新模块例子的发布和版本管理工作流程步骤。关于每个步骤的更多信息，请参见本主题中的章节。</p>
<ol>
<li>
<p><strong>Begin a module</strong> and organize its sources to make it easier for developers to use and for you to maintain.开始一个模块，并组织它的源代码，使它更容易被开发人员使用，也更容易被你维护。</p>
<p>If you’re brand new to developing modules, check out <a href="https://go.dev/doc/tutorial/create-module" target="_blank" rel="noopener">Tutorial: Create a Go module</a>.如果你是开发模块的新手，请查看教程。创建一个Go模块。</p>
<p>In Go’s decentralized module publishing system, how you organize your code matters. For more, see <a href="https://go.dev/doc/modules/managing-source" target="_blank" rel="noopener">Managing module source</a>.在Go的分散式模块发布系统中，你如何组织你的代码很重要。更多信息，请看管理模块源代码。</p>
</li>
<li>
<p>Set up to <strong>write local client code</strong> that calls functions in the unpublished module.设置编写本地客户端代码，调用未发布模块中的函数。</p>
<p>Before you publish a module, it’s unavailable for the typical dependency management workflow using commands such as <code>go get</code>. A good way to test your module code at this stage is to try it while it is in a directory local to your calling code.在你发布一个模块之前，它在典型的依赖性管理工作流程中是不可用的，比如使用 go get 命令。在这个阶段，测试你的模块代码的一个好方法是，当它在你的调用代码的本地目录中时，就可以尝试它。</p>
<p>See <a href="https://go.dev/doc/modules/release-workflow#unpublished" target="_blank" rel="noopener">Coding against an unpublished module</a> for more about local development.关于本地开发的更多信息，请参见针对未发布模块的编码。</p>
</li>
<li>
<p>When the module’s code is ready for other developers to try it out, <strong>begin publishing v0 pre-releases</strong> such as alphas and betas. See <a href="https://go.dev/doc/modules/release-workflow#pre-release" target="_blank" rel="noopener">Publishing pre-release versions</a> for more.当模块的代码准备好供其他开发者试用时，开始发布预发布版本，如alphas和betas。参见发布预发布版本以了解更多信息。</p>
</li>
<li>
<p><strong>Release a v0</strong> that’s not guaranteed to be stable, but which users can try out. For more, see <a href="https://go.dev/doc/modules/release-workflow#first-unstable" target="_blank" rel="noopener">Publishing the first (unstable) version</a>.发布一个不保证稳定的v0版本，但用户可以试用。更多内容请参见发布第一个（不稳定）版本。</p>
</li>
<li>
<p>After your v0 version is published, you can (and should!) continue to <strong>release new versions</strong> of it.在你的v0版本发布之后，你可以（而且应该！）继续发布新的版本。</p>
<p>These new versions might include bug fixes (patch releases), additions to the module’s public API (minor releases), and even breaking changes. Because a v0 release makes no guarantees of stability or backward compatibility, you can make breaking changes in its versions.这些新版本可能包括错误的修正（补丁发布），对模块的公共API的补充（次要发布），甚至是突破性的改变。因为v0版本不保证稳定性或向后兼容性，所以你可以在其版本中进行破坏性的修改。</p>
<p>For more, see <a href="https://go.dev/doc/modules/release-workflow#bug-fixes" target="_blank" rel="noopener">Publishing bug fixes</a> and <a href="https://go.dev/doc/modules/release-workflow#non-breaking" target="_blank" rel="noopener">Publishing non-breaking API changes</a>.更多信息，请参阅发布错误修复和发布非破坏性的API变化。</p>
</li>
<li>
<p>When you’re getting a stable version ready for release, you <strong>publish pre-releases as alphas and betas</strong>. For more, see <a href="https://go.dev/doc/modules/release-workflow#pre-release" target="_blank" rel="noopener">Publishing pre-release versions</a>.当你准备发布一个稳定的版本时，你可以将预发布版本作为alphas和betas发布。更多信息，请参见发布预发布版本。</p>
</li>
<li>
<p>Release a v1 as the <strong>first stable release</strong>.发布一个v1版本作为第一个稳定版本。</p>
<p>This is the first release that makes commitments about the module’s stability. For more, see <a href="https://go.dev/doc/modules/release-workflow#first-stable" target="_blank" rel="noopener">Publishing the first stable version</a>.这是对模块的稳定性做出承诺的第一个版本。更多信息，请参见发布第一个稳定版本。</p>
</li>
<li>
<p>In the v1 version, <strong>continue to fix bugs</strong> and, where necessary, make additions to the module’s public API.在v1版本中，继续修复bug，必要时对模块的公共API进行补充。</p>
<p>For more, see <a href="https://go.dev/doc/modules/release-workflow#bug-fixes" target="_blank" rel="noopener">Publishing bug fixes</a> and <a href="https://go.dev/doc/modules/release-workflow#non-breaking" target="_blank" rel="noopener">Publishing non-breaking API changes</a>.更多信息，请参见发布错误修复和发布非破坏性的API变化。</p>
</li>
<li>
<p>When it can’t be avoided, publish breaking changes in a <strong>new major version</strong>.当无法避免时，在一个新的主要版本中发布破坏性变化。</p>
<p>A major version update – such as from v1.x.x to v2.x.x – can be a very disruptive upgrade for your module’s users. It should be a last resort. For more, see <a href="https://go.dev/doc/modules/release-workflow#breaking" target="_blank" rel="noopener">Publishing breaking API changes</a>.一个主要的版本更新&ndash;比如从v1.x.x到v2.x.x&ndash;对你的模块用户来说可能是一个非常有破坏性的升级。这应该是最后的手段。更多信息，请看发布破坏性的API变化。</p>
</li>
</ol>
<h2 id="coding-against-an-unpublished-module-针对未发布的模块进行编码">Coding against an unpublished module 针对未发布的模块进行编码</h2>
<p>When you begin developing a module or a new version of a module, you won’t yet have published it. Before you publish a module, you won’t be able to use Go commands to add the module as a dependency. Instead, at first, when writing client code in a different module that calls functions in the unpublished module, you’ll need to reference a copy of the module on the local file system.</p>
<p>当你开始开发一个模块或一个模块的新版本时，你还没有发布它。在你发布模块之前，你无法使用Go命令将该模块作为一个依赖项添加。相反，一开始，当在不同的模块中写客户端代码调用未发布的模块中的函数时，你需要在本地文件系统中引用该模块的一个副本。</p>
<p>You can reference a module locally from the client module’s go.mod file by using the <code>replace</code> directive in the client module’s go.mod file. For more information, see in <a href="https://go.dev/doc/modules/managing-dependencies#local_directory" target="_blank" rel="noopener">Requiring module code in a local directory</a>.</p>
<p>你可以通过在客户端模块的go.mod文件中使用替换指令，在本地引用一个模块。更多信息，请参见《要求本地目录中的模块代码》。</p>
<h2 id="publishing-pre-release-versions-发布预发布版本">Publishing pre-release versions 发布预发布版本</h2>
<p>You can publish pre-release versions to make a module available for others to try it out and give you feedback. A pre-release version includes no guarantee of stability.</p>
<p>你可以发布预发布版本，让其他人试用模块并给你反馈。预发布版本不包括稳定性的保证。</p>
<p>Pre-release version numbers are appended with a pre-release identifier. For more on version numbers, see <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.</p>
<p>预发布的版本号后面有一个预发布的标识符。更多关于版本号的信息，请参见模块版本号。</p>
<p>Here are two examples:</p>
<p>这里有两个例子：</p>
<pre tabindex="0"><code>v0.2.1-beta.1
v1.2.3-alpha
</code></pre><p>When making a pre-release available, keep in mind that developers using the pre-release will need to explicitly specify it by version with the <code>go get</code> command. That’s because, by default, the <code>go</code> command prefers release versions over pre-release versions when locating the module you’re asking for. So developers must get the pre-release by specifying it explicitly, as in the following example:</p>
<p>在提供预发布版本时，请记住，使用预发布版本的开发者需要用go get命令明确指定它的版本。这是因为，默认情况下，go命令在定位你所要求的模块时，更倾向于选择发布版本而不是预发布版本。因此，开发者必须通过明确指定预发布版本来获得预发布版本，如下面的例子：</p>
<pre tabindex="0"><code>go get example.com/theirmodule@v1.2.3-alpha
</code></pre><p>You publish a pre-release by tagging the module code in your repository, specifying the pre-release identifier in the tag. For more, see <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">Publishing a module</a>.</p>
<p>你可以通过在你的版本库中标记模块代码来发布预发布版本，在标记中指定预发布版本的标识符。更多信息请参见发布模块。</p>
<h2 id="publishing-the-first-unstable-version-发布第一个不稳定版本">Publishing the first (unstable) version 发布第一个（不稳定）版本</h2>
<p>As when you publish a pre-release version, you can publish release versions that don’t guarantee stability or backward compatibility, but give your users an opportunity to try out the module and give you feedback.</p>
<p>就像你发布预发布版本一样，你可以发布不保证稳定性或向后兼容性的发布版本，但给你的用户一个机会来试用模块并给你反馈。</p>
<p>Unstable releases are those whose version numbers are in the v0.x.x range. A v0 version makes no stability or backward compatibility guarantees. But it gives you a way to get feedback and refine your API before making stability commitments with v1 and later. For more see, <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.</p>
<p>不稳定的版本是指那些版本号在v0.x.x范围内的版本。v0版本没有稳定性或向后兼容性的保证。但它为你提供了一种方法，让你在对v1及以后的版本做出稳定性承诺之前获得反馈并完善你的API。更多信息请见，模块的版本编号。</p>
<p>As with other published versions, you can increment the minor and patch parts of the v0 version number as you make changes toward releasing a stable v1 version. For example, after releasing a v.0.0.0, you might release a v0.0.1 with the first set of bug fixes.</p>
<p>与其他发布的版本一样，当你为发布稳定的v1版本而进行修改时，你可以增加v0版本号的次要部分和补丁部分。例如，在发布了v.0.0.0之后，你可以发布带有第一组错误修复的v0.0.1。</p>
<p>Here’s an example version number:</p>
<p>下面是一个版本号的例子：</p>
<pre tabindex="0"><code>v0.1.3
</code></pre><p>You publish an unstable release by tagging the module code in your repository, specifying a v0 version number in the tag. For more, see <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">Publishing a module</a>.</p>
<p>你可以通过在你的版本库中标记模块代码来发布一个不稳定的版本，并在标记中指定一个v0的版本号。更多信息，请看发布模块。</p>
<h2 id="publishing-the-first-stable-version-发布第一个稳定版本">Publishing the first stable version 发布第一个稳定版本</h2>
<p>Your first stable release will have a v1.x.x version number. The first stable release follows pre-release and v0 releases through which you got feedback, fixed bugs, and stabilized the module for users.</p>
<p>你的第一个稳定版本会有一个v1.x.x的版本号。第一个稳定版本是在预发布和v0版本之后发布的，通过这些版本你可以得到反馈，修复错误，并为用户稳定模块。</p>
<p>With a v1 release, you’re making the following commitments to developers using your module:</p>
<p>有了v1版本，你就对使用你的模块的开发者做出了以下承诺：</p>
<ul>
<li>They can upgrade to the major version’s subsequent minor and patch releases without breaking their own code. 他们可以升级到主要版本的后续次要版本和补丁版本，而不会破坏自己的代码。</li>
<li>You won’t be making further changes to the module’s public API – including its function and method signatures – that break backward compatibility.你不会对模块的公共API（包括其函数和方法签名）做进一步的修改，从而破坏向后的兼容性。</li>
<li>You won’t be removing any exported types, which would break backward compatibility.你不会删除任何导出的类型，这将破坏后向兼容性。</li>
<li>Future changes to your API (such as adding a new field to a struct) will be backward compatible and will be included in a new minor release.未来对你的API的改变（比如给结构添加一个新的字段）将是向后兼容的，并将包含在一个新的次要版本中。</li>
<li>Bug fixes (such as a security fix) will be included in a patch release or as part of a minor release.错误修复（如安全修复）将包含在补丁发布中或作为小版本的一部分。</li>
</ul>
<p><strong>Note:</strong> While your first major version might be a v0 release, a v0 version does not signal stability or backward compatibility guarantees. As a result, when you increment from v0 to v1, you needn’t be mindful of breaking backward compatibility because the v0 release was not considered stable.</p>
<p>注意：虽然你的第一个主要版本可能是v0版本，但v0版本并不代表稳定性或向后兼容性的保证。因此，当你从v0增加到v1时，你不需要注意破坏后向兼容性，因为v0版本不被视为稳定。</p>
<p>For more about version numbers, see <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.</p>
<p>欲了解更多关于版本号的信息，请参见模块版本号。</p>
<p>Here’s an example of a stable version number:</p>
<p>下面是一个稳定版本号的例子：</p>
<pre tabindex="0"><code>v1.0.0
</code></pre><p>You publish a first stable release by tagging the module code in your repository, specifying a v1 version number in the tag. For more, see <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">Publishing a module</a>.</p>
<p>你通过在你的版本库中标记模块代码来发布第一个稳定版本，并在标记中指定v1的版本号。更多信息，请参见发布模块。</p>
<h2 id="publishing-bug-fixes-发布错误修复">Publishing bug fixes 发布错误修复</h2>
<p>You can publish a release in which the changes are limited to bug fixes. This is known as a patch release.</p>
<p>你可以发布一个变化仅限于错误修复的版本。这就是所谓的补丁发布。</p>
<p>A <em>patch release</em> includes only minor changes. In particular, it includes no changes to the module’s public API. Developers of consuming code can upgrade to this version safely and without needing to change their code.</p>
<p>补丁发布只包括微小的变化。特别是，它不包括对模块的公共API的改变。消耗代码的开发者可以安全地升级到这个版本，而不需要改变他们的代码。</p>
<p><strong>Note:</strong> Your patch release should try not to upgrade any of that module’s own transitive dependencies by more than a patch release. Otherwise, someone upgrading to the patch of your module could wind up accidentally pulling in a more invasive change to a transitive dependency that they use.</p>
<p>注意：你的补丁版本应该尽量不要将该模块自身的横向依赖关系升级到一个以上的补丁版本。否则，升级到你的模块的补丁的人可能会意外地对他们使用的过渡性依赖关系进行更多的修改。</p>
<p>A patch release increments the patch part of the module’s version number. For more see, <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.</p>
<p>补丁的发布会增加模块的版本号中的补丁部分。更多信息请看，模块版本号。</p>
<p>In the following example, v1.0.1 is a patch release.</p>
<p>在下面的例子中，v1.0.1是一个补丁版本。</p>
<p>Old version: <code>v1.0.0</code></p>
<p>New version: <code>v1.0.1</code></p>
<p>You publish a patch release by tagging the module code in your repository, incrementing the patch version number in the tag. For more, see <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">Publishing a module</a>.</p>
<p>你可以通过在版本库中标记模块代码来发布一个补丁版本，在标记中增加补丁版本号。更多信息请参见发布模块。</p>
<h2 id="publishing-non-breaking-api-changes-发布非破坏性的api变更">Publishing non-breaking API changes 发布非破坏性的API变更</h2>
<p>You can make non-breaking changes to your module’s public API and publish those changes in a <em>minor</em> version release.</p>
<p>你可以对你的模块的公共API进行非破坏性的修改，并将这些修改发布在一个小版本中。</p>
<p>This version changes the API, but not in a way that breaks calling code. This might include changes to a module’s own dependencies or the addition of new functions, methods, struct fields, or types. Even with the changes it includes, this kind of release guarantees backward compatibility and stability for existing code that calls the module’s functions.</p>
<p>这个版本会改变API，但不会破坏调用代码。这可能包括对模块本身的依赖性的改变，或者增加新的函数、方法、结构域或类型。即使它包括了一些变化，这种版本也能保证调用该模块功能的现有代码的向后兼容性和稳定性。</p>
<p>A minor release increments the minor part of the module’s version number. For more, see <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.</p>
<p>一个次要版本会增加模块的版本号的次要部分。更多信息请参见模块版本号。</p>
<p>In the following example, v1.1.0 is a minor release.</p>
<p>在下面的例子中，v1.1.0是一个次要版本。</p>
<p>Old version: <code>v1.0.1</code></p>
<p>New version: <code>v1.1.0</code></p>
<p>You publish a minor release by tagging the module code in your repository, incrementing the minor version number in the tag. For more, see <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">Publishing a module</a>.</p>
<p>你可以通过在版本库中标记模块代码来发布一个次要版本，在标记中增加次要版本号。更多信息请参见发布模块。</p>
<h2 id="publishing-breaking-api-changes-发布破坏性的api变化">Publishing breaking API changes 发布破坏性的API变化</h2>
<p>You can publish a version that breaks backward compatibility by publishing a <em>major</em> version release.</p>
<p>你可以通过发布一个主要版本来发布一个破坏后向兼容性的版本。</p>
<p>A major version release doesn’t guarantee backward compatibility, typically because it includes changes to the module’s public API that would break code using the module’s previous versions.</p>
<p>一个主要版本的发布并不能保证向后兼容，通常是因为它包括对模块的公共API的修改，这些修改会破坏使用该模块以前版本的代码。</p>
<p>Given the disruptive effect a major version upgrade can have on code relying on the module, you should avoid a major version update if you can. For more about major version updates, see <a href="https://go.dev/doc/modules/major-version" target="_blank" rel="noopener">Developing a major version update</a>. For strategies to avoid making breaking changes, see the blog post <a href="https://blog.golang.org/module-compatibility" target="_blank" rel="noopener">Keeping your modules compatible</a>.</p>
<p>考虑到主要版本升级对依赖该模块的代码可能产生的破坏性影响，如果可以的话，你应该避免主要版本更新。更多关于主要版本更新的信息，请看开发主要版本更新。关于避免破坏性修改的策略，请看博客文章《保持你的模块的兼容性》。</p>
<p>Where publishing other kinds of versions requires essentially tagging the module code with the version number, publishing a major version update requires more steps.</p>
<p>发布其他类型的版本只需要在模块代码上标记版本号，而发布主要版本更新需要更多的步骤。</p>
<ol>
<li>
<p>Before beginning development of the new major version, in your repository create a place for the new version’s source. 在开始开发新的主要版本之前，在你的版本库中为新版本的源代码创建一个地方。</p>
<p>One way to do this is to create a new branch in your repository that is specifically for the new major version and its subsequent minor and patch versions. For more, see <a href="https://go.dev/doc/modules/managing-source" target="_blank" rel="noopener">Managing module source</a>.一种方法是在你的版本库中创建一个新的分支，专门用于新的主版本及其后续的次版本和补丁版本。更多信息请参见管理模块源代码。</p>
</li>
<li>
<p>In the module’s go.mod file, revise the module path to append the new major version number, as in the following example:在模块的go.mod文件中，修改模块的路径，添加新的主要版本号，如下面的例子。</p>
<pre tabindex="0"><code>example.com/mymodule/v2
</code></pre><p>Given that the module path is the module’s identifier, this change effectively creates a new module. It also changes the package path, ensuring that developers won’t unintentionally import a version that breaks their code. Instead, those wanting to upgrade will explicitly replace occurrences of the old path with the new one.考虑到模块路径是模块的标识符，这一改变有效地创建了一个新模块。它也改变了包的路径，确保开发者不会无意中导入一个破坏他们代码的版本。相反，那些想要升级的人将明确地用新的路径来替换旧的路径的出现。</p>
</li>
<li>
<p>In your code, change any package paths where you’re importing packages in the module you’re updating, including packages in the module you’re updating. You need to do this because you changed your module path.在你的代码中，改变任何你要导入的模块中的包的路径，包括你要更新的模块中的包。你需要这样做是因为你改变了你的模块路径。</p>
</li>
<li>
<p>As with any new release, you should publish pre-release versions to get feedback and bug reports before publishing an official release.与任何新版本一样，在发布正式版本之前，你应该发布预发布版本以获得反馈和错误报告。</p>
</li>
<li>
<p>Publish the new major version by tagging the module code in your repository, incrementing the major version number in the tag – such as from v1.5.2 to v2.0.0.通过在你的版本库中标记模块代码来发布新的主要版本，在标记中增加主要版本号&ndash;比如从v1.5.2到v2.0.0。</p>
<p>For more, see <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">Publishing a module</a>.</p>
<p>更多信息请参见发布模块。</p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3fcbbc0c292c78a6aa83a34dd6c946a2">4.3 - 管理模块来源</h1>
    
	<h1 id="managing-module-source---管理模块来源">Managing module source - 管理模块来源</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/modules/managing-source" target="_blank" rel="noopener">https://go.dev/doc/modules/managing-source</a></p>
</blockquote>
<p>When you’re developing modules to publish for others to use, you can help ensure that your modules are easier for other developers to use by following the repository conventions described in this topic.</p>
<p>当你开发模块并发布给其他人使用时，你可以通过遵循本主题中描述的版本库惯例，帮助确保你的模块更容易被其他开发者使用。</p>
<p>This topic describes actions you might take when managing your module repository. For information about the sequence of workflow steps you’d take when revising from version to version, see <a href="https://go.dev/doc/modules/release-workflow" target="_blank" rel="noopener">Module release and versioning workflow</a>.</p>
<p>本主题描述了你在管理你的模块库时可能采取的行动。关于你在修订版本时采取的工作流程步骤的顺序，请参阅模块发布和版本工作流程。</p>
<p>Some of the conventions described here are required in modules, while others are best practices. This content assumes you’re familiar with the basic module use practices described in <a href="https://go.dev/doc/modules/managing-dependencies" target="_blank" rel="noopener">Managing dependencies</a>.</p>
<p>这里描述的一些惯例在模块中是必须的，而另一些则是最佳实践。本内容假定你已经熟悉了管理依赖关系中描述的基本模块使用惯例。</p>
<p>Go supports the following repositories for publishing modules: Git, Subversion, Mercurial, Bazaar, and Fossil.</p>
<p>Go支持以下发布模块的存储库。Git、Subversion、Mercurial、Bazaar和Fossil。</p>
<p>For an overview of module development, see <a href="https://go.dev/doc/modules/developing" target="_blank" rel="noopener">Developing and publishing modules</a>.</p>
<p>关于模块开发的概述，请参阅开发和发布模块。</p>
<h2 id="how-go-tools-find-your-published-module-go工具如何找到你发布的模块">How Go tools find your published module Go工具如何找到你发布的模块</h2>
<p>In Go’s decentralized system for publishing modules and retrieving their code, you can publish your module while leaving the code in your repository. Go tools rely on naming rules that have repository paths and repository tags indicating a module’s name and version number. When your repository follows these requirements, your module code is downloadable from your repository by Go tools such as the <a href="https://go.dev/ref/mod#go-get" target="_blank" rel="noopener"><code>go get</code> command</a>.</p>
<p>在 Go 的发布模块和检索其代码的分散系统中，你可以发布你的模块，同时将代码留在你的仓库中。Go工具依赖于命名规则，这些规则有版本库路径和版本库标签，表明模块的名称和版本号。当你的版本库遵循这些要求时，你的模块代码就可以被Go工具（如go get命令）从你的版本库下载。</p>
<p>When a developer uses the <code>go get</code> command to get source code for packages their code imports, the command does the following:</p>
<p>当开发者使用go get命令来获取他们的代码所导入的包的源代码时，该命令会做以下工作：</p>
<ol>
<li>From <code>import</code> statements in Go source code, <code>go get</code> identifies the module path within the package path.从 Go 源代码中的导入语句，go get 识别包路径中的模块路径。</li>
<li>Using a URL derived from the module path, the command locates the module source on a module proxy server or at its repository directly.使用从模块路径导出的URL，该命令在模块代理服务器上或直接在其存储库中定位模块源。</li>
<li>Locates source for the module version to download by matching the module’s version number to a repository tag to discover the code in the repository. When a version number to use is not yet known, <code>go get</code> locates the latest release version.通过将模块的版本号与资源库的标签相匹配来发现资源库中的代码，从而找到要下载的模块版本的源。当使用的版本号还不知道时，go get会找到最新的发布版本。</li>
<li>Retrieves module source and downloads it to the developer’s local module cache.检索模块源并下载到开发者的本地模块缓存。</li>
</ol>
<h2 id="organizing-code-in-the-repository-在版本库中组织代码">Organizing code in the repository 在版本库中组织代码</h2>
<p>You can keep maintenance simple and improve developers&rsquo; experience with your module by following the conventions described here. Getting your module code into a repository is generally as simple as with other code.</p>
<p>你可以通过遵循这里描述的惯例来保持维护的简单性，并改善开发者对你的模块的体验。将你的模块代码放入版本库通常和其他代码一样简单。</p>
<p>The following diagram illustrates a source hierarchy for a simple module with two packages.</p>
<p>下图说明了一个有两个包的简单模块的源代码层次结构。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/DevelopingModules/ManagingModuleSource_img/source-hierarchy.png"
     alt="Diagram illustrating a module source code hierarchy"
     
/>




</p>
<p>Diagram illustrating a module source code hierarchy</p>
<p>图示模块源代码的层次结构</p>
<p>Your initial commit should include files listed in the following table:</p>
<p>你的初始提交应该包括下表中所列的文件：</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>LICENSE</td>
<td>The module&rsquo;s license. 模块的许可证。</td>
</tr>
<tr>
<td>go.mod</td>
<td>Describes the module, including its module path (in effect, its name) and its dependencies. For more, see the <a href="https://go.dev/doc/modules/gomod-ref" target="_blank" rel="noopener">go.mod reference</a>.The module path will be given in a module directive, such as:<code>module example.com/mymodule</code>For more about choosing a module path, see <a href="https://go.dev/doc/modules/managing-dependencies#naming_module" target="_blank" rel="noopener">Managing dependencies</a>.Though you can edit the go.mod file, you&rsquo;ll find it more reliable to make changes through <code>go</code> commands.描述模块，包括它的模块路径（实际上是它的名字）和它的依赖关系。更多信息请参见 go.mod 参考。模块路径将在一个模块指令中给出，例如模块 example.com/mymodule。关于选择模块路径的更多信息，请参见管理依赖关系。尽管你可以编辑go.mod文件，但你会发现通过go命令进行修改更为可靠。</td>
</tr>
<tr>
<td>go.sum</td>
<td>Contains cryptographic hashes that represent the module&rsquo;s dependencies. Go tools use these hashes to authenticate downloaded modules, attempting to confirm that the downloaded module is authentic. Where this confirmation fails, Go will display a security error.The file will be empty or not present when there are no dependencies. You shouldn&rsquo;t edit this file except by using the <code>go mod tidy</code> command, which removes unneeded entries.包含代表模块依赖关系的加密哈希值。Go工具使用这些哈希值来验证下载的模块，试图确认下载的模块是真实的。如果确认失败，Go 会显示一个安全错误。当没有依赖关系时，该文件将为空或不存在。你不应该编辑这个文件，除非使用 go mod tidy 命令，它可以删除不需要的条目。</td>
</tr>
<tr>
<td>Package directories and .go sources.</td>
<td>Directories and .go files that comprise the Go packages and sources in the module.组成模块中Go包和源的目录和.go文件。</td>
</tr>
</tbody>
</table>
<p>From the command-line, you can create an empty repository, add the files that will be part of your initial commit, and commit with a message. Here’s an example using git:</p>
<p>在命令行中，你可以创建一个空的仓库，添加将成为初始提交的一部分的文件，并提交一个消息。下面是一个使用git的例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git init
</span></span><span style="display:flex;"><span>$ git add --all
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#98c379">&#34;mycode: initial commit&#34;</span>
</span></span><span style="display:flex;"><span>$ git push
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="choosing-repository-scope-选择版本库范围">Choosing repository scope 选择版本库范围</h2>
<p>You publish code in a module when the code should be versioned independently from code in other modules.</p>
<p>当你在一个模块中发布代码时，该代码应该独立于其他模块的代码进行版本管理。</p>
<p>Designing your repository so that it hosts a single module at its root directory will help keep maintenance simpler, particularly over time as you publish new minor and patch versions, branch into new major versions, and so on. However, if your needs require it, you can instead maintain a collection of modules in a single repository.</p>
<p>设计你的版本库，使其在根目录下承载单一的模块，将有助于保持更简单的维护，特别是随着时间的推移，你发布新的次要和补丁版本，分支到新的主要版本，等等。然而，如果你的需求需要，你可以在一个版本库中维护一系列的模块。</p>
<h3 id="sourcing-one-module-per-repository-每个版本库采购一个模块">Sourcing one module per repository 每个版本库采购一个模块</h3>
<p>You can maintain a repository that has a single module’s source in it. In this model, you place your go.mod file at the repository root, with package subdirectories containing Go source beneath.</p>
<p>你可以维护一个只有一个模块源代码的版本库。在这种模式下，你把go.mod文件放在版本库根目录下，下面是包含Go源代码的包子目录。</p>
<p>This is the simplest approach, making your module likely easier to manage over time. It helps you avoid the need to prefix a module version number with a directory path.</p>
<p>这是最简单的方法，使你的模块可能更容易长期管理。它可以帮助你避免在模块的版本号前加上目录路径。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/DevelopingModules/ManagingModuleSource_img/single-module.png"
     alt="Diagram illustrating a single module&amp;rsquo;s source in its repository"
     
/>




</p>
<p>Diagram illustrating a single module&rsquo;s source in its repository</p>
<p>图示单个模块在其资源库中的源代码</p>
<h3 id="sourcing-multiple-modules-in-a-single-repository-在一个资源库中采购多个模块">Sourcing multiple modules in a single repository 在一个资源库中采购多个模块</h3>
<p>You can publish multiple modules from a single repository. For example, you might have code in a single repository that constitutes multiple modules, but want to version those modules separately.</p>
<p>你可以从一个资源库发布多个模块。例如，你可能在一个版本库中拥有构成多个模块的代码，但想分别对这些模块进行版本管理。</p>
<p>Each subdirectory that is a module root directory must have its own go.mod file.</p>
<p>每个作为模块根目录的子目录必须有自己的 go.mod 文件。</p>
<p>Sourcing module code in subdirectories changes the form of the version tag you must use when publishing a module. You must prefix the version number part of the tag with the name of the subdirectory that is the module root. For more about version numbers, see <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.</p>
<p>在子目录中采购模块代码会改变你在发布模块时必须使用的版本标签的形式。你必须在标签的版本号部分前面加上作为模块根目录的子目录的名称。更多关于版本号的信息，请参见模块版本号。</p>
<p>For example, for module <code>example.com/mymodules/module1</code> below, you would have the following for version v1.2.3:</p>
<p>例如，对于下面的模块example.com/mymodules/module1，你会有以下版本v1.2.3：</p>
<ul>
<li>
<p>Module path: <code>example.com/mymodules/module1</code> 模块路径: example.com/mymodules/module1</p>
</li>
<li>
<p>Version tag: <code>module1/v1.2.3</code>  版本标签： module1/v1.2.3</p>
</li>
<li>
<p>Package path imported by a user: <code>example.com/mymodules/module1/package1</code></p>
<p>用户导入的软件包路径: example.com/mymodules/module1/package1</p>
</li>
<li>
<p>Module path as given in a user’s require directive: <code>example.com/mymodules/module1 module1/v1.2.3</code></p>
<p>用户在require指令中给出的模块路径：example.com/mymodules/module1 module1/v1.2.3</p>
</li>
</ul>
<p>


<img src="/docs/UsingAndUnderstandingGo/DevelopingModules/ManagingModuleSource_img/multiple-modules.png"
     alt="Diagram illustrating two modules in a single repository"
     
/>




</p>
<p>Diagram illustrating two modules in a single repository</p>
<p>图中说明了单个资源库中的两个模块</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-53061c1f4e0b7a54f74893a63869a0fc">4.4 - 开发主版本更新</h1>
    
	<h1 id="developing-a-major-version-update---开发主版本更新">Developing a major version update - 开发主版本更新</h1>
<p>​	当您在潜在的新版本中所做的更改无法保证模块用户的向后兼容性时，您必须更新到一个主要版本。例如，如果您更改了模块的公共API以使其破坏使用先前版本模块的客户端代码，则将进行此更改。</p>
<blockquote>
<p>注意：每种发布类型——主要、次要、修订或预发布——对于模块的用户都有不同的含义。这些用户依赖于这些差异来理解发布对其自身代码所代表的风险水平。换句话说，在准备发布时，请确保其版本号准确反映了自上一版本发布以来的更改性质。有关版本号的更多信息，请参阅<a href="../ModuleVersionNumbering">模块版本编号</a>。</p>
</blockquote>
<p>另请参阅</p>
<ul>
<li>有关模块开发的概述，请参阅 <a href="../DevelopingAndPublishingModules">开发和发布模块</a>。</li>
<li>有关端到端的视图，请参阅 <a href="../ModuleReleaseAndVersioningWorkflow">模块发布和版本控制工作流程</a>。</li>
</ul>
<h2 id="主要版本更新的注意事项">主要版本更新的注意事项</h2>
<p>​	仅当绝对必要时，您才应更新到新的主要版本。主要版本更新对您和模块的用户都会产生重大变动。在考虑进行主要版本更新时，请考虑以下内容：</p>
<ul>
<li>
<p>向用户明确新的主要版本发布对以前主要版本的支持意味着什么。</p>
<p>以前的版本是否已废弃？是否像以前一样受到支持？您是否将维护以前的版本，包括修复bug？</p>
</li>
<li>
<p>准备好承担两个版本的维护工作：旧版本和新版本。例如，如果您在其中一个版本中修复了bug，则通常会将这些修复移植到另一个版本中。</p>
</li>
<li>
<p>请记住，新的主要版本从依赖管理的角度来看是一个新模块。在您发布之后，您的用户需要更新以使用新模块，而不仅仅是简单地升级。</p>
<p>这是因为新的主要版本具有不同的模块路径，与前一个主要版本不同。例如，对于其模块路径为<code>example.com/mymodule</code>的模块，而v2版本的模块路径为<code>example.com/mymodule/v2</code>。</p>
</li>
<li>
<p>当您开发一个新的主要版本时，您还必须更新代码导入包的导入路径，无论从哪个模块导入包。如果你的模块的用户想升级到新的主要版本，他们也必须更新他们的导入路径。</p>
</li>
</ul>
<h2 id="为主要版本发布创建分支">为主要版本发布创建分支</h2>
<p>​	在准备开发一个新的主版本时，处理源代码的最直接方法是在上一个主版本的最新版本上对版本库进行分支。</p>
<p>​	例如，在命令提示符下，你可以切换到模块的根目录，然后在那里创建一个新的 v2 分支。</p>
<pre tabindex="0"><code>$ cd mymodule
$ git checkout -b v2
Switched to a new branch &#34;v2&#34;
</code></pre><p>


<img src="/docs/UsingAndUnderstandingGo/DevelopingModules/DevelopingAmajorVersionUpdate_img/v2-branch-module.png"
     alt="Diagram illustrating a repository branched from master to v2"
     
/>




</p>
<p>一张描绘从主分支(master)分支出v2版本的仓库的图示
{: caption }</p>
<p>​	一旦你创建了源代码的分支，你就需要对新版本的源代码进行以下更改：</p>
<ul>
<li>在新版本的go.mod文件中，在模块路径中添加新的主版本号，如下所示：
<ul>
<li>现有版本: <code>example.com/mymodule</code></li>
<li>新版本: <code>example.com/mymodule/v2</code></li>
</ul>
</li>
<li>在你的Go代码中，更新每个导入的包路径，在你从该模块中导入一个包时，将主版本号附加到模块路径部分。
<ul>
<li>旧的导入语句: <code>import &quot;example.com/mymodule/package1&quot;</code></li>
<li>新的导入语句: <code>import &quot;example.com/mymodule/v2/package1&quot;</code></li>
</ul>
</li>
</ul>
<p>​	有关发布步骤，请参阅<a href="../PublishingAModule">发布模块</a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-17f6e72f0c269f4326bd16907a32d204">4.5 - 发布模块</h1>
    
	<h1 id="publishing-a-module---发布模块">Publishing a module - 发布模块</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">https://go.dev/doc/modules/publishing</a></p>
</blockquote>
<p>When you want to make a module available for other developers, you publish it so that it’s visible to Go tools. Once you’ve published the module, developers importing its packages will be able to resolve a dependency on the module by running commands such as <code>go get</code>.</p>
<p>当你想把一个模块提供给其他开发者时，你可以发布它，这样它就能被Go工具看到。一旦你发布了模块，导入其软件包的开发者就可以通过运行go get等命令来解决对该模块的依赖。</p>
<blockquote>
<p><strong>Note:</strong> Don’t change a tagged version of a module after publishing it. For developers using the module, Go tools authenticate a downloaded module against the first downloaded copy. If the two differ, Go tools will return a security error. Instead of changing the code for a previously published version, publish a new version.注意：不要在发布模块后改变模块的标记版本。对于使用该模块的开发者来说，Go工具会根据第一个下载的副本来验证下载的模块。如果两者不同，Go工具将返回一个安全错误。不要改变之前发布的版本的代码，而是发布一个新的版本。</p>
</blockquote>
<p><strong>See also</strong></p>
<p>另见</p>
<ul>
<li>For an overview of module development, see <a href="https://go.dev/doc/modules/developing" target="_blank" rel="noopener">Developing and publishing modules</a>关于模块开发的概述，见开发和发布模块</li>
<li>For a high-level module development workflow – which includes publishing – see <a href="https://go.dev/doc/modules/release-workflow" target="_blank" rel="noopener">Module release and versioning workflow</a>.关于高层次的模块开发工作流程&ndash;包括发布&ndash;见模块发布和版本工作流程。</li>
</ul>
<h2 id="publishing-steps-发布步骤">Publishing steps 发布步骤</h2>
<p>Use the following steps to publish a module.</p>
<p>使用下面的步骤来发布模块。</p>
<ol>
<li>
<p>Open a command prompt and change to your module’s root directory in the local repository.打开命令提示符，切换到本地版本库中模块的根目录。</p>
</li>
<li>
<p>Run <code>go mod tidy</code>, which removes any dependencies the module might have accumulated that are no longer necessary.运行go mod tidy，删除模块可能积累的不再需要的任何依赖关系。</p>
<pre tabindex="0"><code>$ go mod tidy
</code></pre></li>
<li>
<p>Run <code>go test ./...</code> a final time to make sure everything is working.最后一次运行go test ./&hellip;以确保一切正常。</p>
<p>This runs the unit tests you’ve written to use the Go testing framework.这将运行你编写的单元测试，以使用Go测试框架。</p>
<pre tabindex="0"><code>$ go test ./...
ok      example.com/mymodule       0.015s
</code></pre></li>
<li>
<p>Tag the project with a new version number using the <code>git tag</code> command.使用git tag命令给项目贴上新的版本号。</p>
<p>For the version number, use a number that signals to users the nature of changes in this release. For more, see <a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">Module version numbering</a>.对于版本号，请使用一个能向用户表明此版本中变化性质的数字。更多信息请参见模块的版本号。</p>
<pre tabindex="0"><code>$ git commit -m &#34;mymodule: changes for v0.1.0&#34;
$ git tag v0.1.0
</code></pre></li>
<li>
<p>Push the new tag to the origin repository.推送新的标签到原点仓库。</p>
<pre tabindex="0"><code>$ git push origin v0.1.0
</code></pre></li>
<li>
<p>Make the module available by running the <a href="https://go.dev/cmd/go/#hdr-List_packages_or_modules" target="_blank" rel="noopener"><code>go list</code> command</a> to prompt Go to update its index of modules with information about the module you’re publishing.通过运行 go list 命令使模块可用，以提示 Go 用你要发布的模块的信息更新其模块索引。</p>
<p>Precede the command with a statement to set the <code>GOPROXY</code> environment variable to a Go proxy. This will ensure that your request reaches the proxy.在命令的前面加上一条语句，将GOPROXY环境变量设置为Go代理。这将确保你的请求到达代理。</p>
<pre tabindex="0"><code>$ GOPROXY=proxy.golang.org go list -m example.com/mymodule@v0.1.0
</code></pre></li>
</ol>
<p>Developers interested in your module import a package from it and run the <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener"><code>go get</code> command</a> just as they would with any other module. They can run the <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener"><code>go get</code> command</a> for latest versions or they can specify a particular version, as in the following example:</p>
<p>对你的模块感兴趣的开发者从你的模块中导入一个包，然后像对待其他模块一样运行 go get 命令。他们可以运行go get命令获取最新的版本，也可以指定一个特定的版本，就像下面的例子：</p>
<pre tabindex="0"><code>$ go get example.com/mymodule@v0.1.0
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dfd8c9c2a4a530522308f654362d2b44">4.6 - 模块的版本编号</h1>
    
	<h1 id="module-version-numbering---模块的版本编号">Module version numbering - 模块的版本编号</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/modules/version-numbers" target="_blank" rel="noopener">https://go.dev/doc/modules/version-numbers</a></p>
</blockquote>
<p>A module’s developer uses each part of a module’s version number to signal the version’s stability and backward compatibility. For each new release, a module’s release version number specifically reflects the nature of the module’s changes since the preceding release.</p>
<p>一个模块的开发者使用一个模块的版本号的每一部分来表示该版本的稳定性和向后兼容性。对于每一个新的版本，模块的发布版本号具体反映了模块自前一个版本以来的变化性质。</p>
<p>When you’re developing code that uses external modules, you can use the version numbers to understand an external module’s stability when you’re considering an upgrade. When you’re developing your own modules, your version numbers will signal your modules&rsquo; stability and backward compatibility to other developers.</p>
<p>当你在开发使用外部模块的代码时，当你考虑升级时，你可以使用版本号来了解外部模块的稳定性。当你开发你自己的模块时，你的版本号将向其他开发者表明你的模块的稳定性和向后兼容性。</p>
<p>This topic describes what module version numbers mean.</p>
<p>本主题描述了模块版本号的含义。</p>
<p><strong>See also</strong></p>
<p>另见</p>
<ul>
<li>When you’re using external packages in your code, you can manage those dependencies with Go tools. For more, see <a href="https://go.dev/doc/modules/managing-dependencies" target="_blank" rel="noopener">Managing dependencies</a>.当你在代码中使用外部包时，你可以用Go工具管理这些依赖关系。更多信息，请参见管理依赖关系。</li>
<li>If you’re developing modules for others to use, you apply a version number when you publish the module, tagging the module in its repository. For more, see <a href="https://go.dev/doc/modules/publishing" target="_blank" rel="noopener">Publishing a module</a>.如果你正在开发模块供他人使用，你可以在发布模块时应用一个版本号，在其仓库中标记该模块。更多信息，请参见发布模块。</li>
</ul>
<p>A released module is published with a version number in the semantic versioning model, as in the following illustration:</p>
<p>发布的模块在语义版本模型中带有一个版本号，如下图所示：</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/DevelopingModules/ModuleVersionNnumbering_img/version-number.png"
     alt="Diagram illustrating a semantic version number showing major version 1, minor version 4, patch version 0, and pre-release version beta 2"
     
/>




</p>
<p>Diagram illustrating a semantic version number showing major version 1, minor version 4, patch version 0, and pre-release version beta 2</p>
<p>语义版本号示意图，显示主版本1、次版本4、补丁版本0和预发布版本β2</p>
<p>The following table describes how the parts of a version number signify a module’s stability and backward compatibility.</p>
<table>
<thead>
<tr>
<th>Version stage 版本阶段</th>
<th>Example  例子</th>
<th>Message to developers 给开发者的信息</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://go.dev/doc/modules/version-numbers#in-development" target="_blank" rel="noopener">In development</a></td>
<td>Automatic pseudo-version numberv<strong>0</strong>.x.x</td>
<td>Signals that the module is still <strong>in development and unstable</strong>. This release carries no backward compatibility or stability guarantees.标志着该模块仍在开发中，不稳定。这个版本没有向后兼容性或稳定性保证。</td>
</tr>
<tr>
<td><a href="https://go.dev/doc/modules/version-numbers#major" target="_blank" rel="noopener">Major version</a></td>
<td>v<strong>1</strong>.x.x</td>
<td>Signals <strong>backward-incompatible public API changes</strong>. This release carries no guarantee that it will be backward compatible with preceding major versions.主要版本v1.x.x 标志着向后不兼容的公共API变化。该版本不保证与之前的主要版本向后兼容。</td>
</tr>
<tr>
<td><a href="https://go.dev/doc/modules/version-numbers#minor" target="_blank" rel="noopener">Minor version</a></td>
<td>vx.<strong>4</strong>.x</td>
<td>Signals <strong>backward-compatible public API changes</strong>. This release guarantees backward compatibility and stability.次要版本vx.4.x标志着向后兼容的公共API变化。此版本保证向后兼容和稳定。</td>
</tr>
<tr>
<td><a href="https://go.dev/doc/modules/version-numbers#patch" target="_blank" rel="noopener">Patch version</a></td>
<td>vx.x.<strong>1</strong></td>
<td>Signals <strong>changes that don&rsquo;t affect the module&rsquo;s public API</strong> or its dependencies. This release guarantees backward compatibility and stability.补丁版本vx.x.1 标志着不影响模块的公共API或其依赖关系的变化。这个版本保证了向后的兼容性和稳定性。</td>
</tr>
<tr>
<td><a href="https://go.dev/doc/modules/version-numbers#pre-release" target="_blank" rel="noopener">Pre-release version</a></td>
<td>vx.x.x-<strong>beta.2</strong></td>
<td>Signals that this is a <strong>pre-release milestone, such as an alpha or beta</strong>. This release carries no stability guarantees.预发布版本 vx.x.x-beta.2 标志着这是一个预发布的里程碑，例如 alpha 或 beta。这个版本没有稳定性保证。</td>
</tr>
</tbody>
</table>
<h2 id="in-development-开发中">In development 开发中</h2>
<p>Signals that the module is still in development and <strong>unstable</strong>. This release carries no backward compatibility or stability guarantees.</p>
<p>标志着该模块仍在开发中，不稳定。这个版本没有向后兼容性或稳定性保证。</p>
<p>The version number can take one of the following forms:</p>
<p>版本号可以采取以下形式之一：</p>
<p>**Pseudo-version number **伪版本号</p>
<blockquote>
<p>v0.0.0-20170915032832-14c0d48ead0c</p>
</blockquote>
<p><strong>v0 number</strong> v0编号</p>
<blockquote>
<p>v0.x.x</p>
</blockquote>
<h3 id="pseudo-version-number-伪版本号">Pseudo-version number 伪版本号</h3>
<p>When a module has not been tagged in its repository, Go tools will generate a pseudo-version number for use in the go.mod file of code that calls functions in the module.</p>
<p>当一个模块在其仓库中没有被标记时，Go工具将生成一个伪版本号，用于调用该模块函数的代码的go.mod文件中。</p>
<p><strong>Note:</strong> As a best practice, always allow Go tools to generate the pseudo-version number rather than creating your own.</p>
<p>注意: 作为一个最佳实践，总是让Go工具生成伪版本号，而不是自己创建。</p>
<p>Pseudo-versions are useful when a developer of code consuming the module’s functions needs to develop against a commit that hasn’t been tagged with a semantic version tag yet.</p>
<p>当使用模块函数的代码开发人员需要针对尚未被标记为语义版本标签的提交进行开发时，伪版本号非常有用。</p>
<p>A pseudo-version number has three parts separated by dashes, as shown in the following form:</p>
<p>伪版本号有三个部分，用破折号隔开，如以下形式所示：</p>
<h4 id="syntax-语法">Syntax 语法</h4>
<p><em>baseVersionPrefix</em>-<em>timestamp</em>-<em>revisionIdentifier</em></p>
<h4 id="parts-部件">Parts 部件</h4>
<ul>
<li><strong>baseVersionPrefix</strong> (vX.0.0 or vX.Y.Z-0) is a value derived either from a semantic version tag that precedes the revision or from vX.0.0 if there is no such tag.timestamp（yymmddhhmmss）是该修订版的UTC时间。在Git中，这是提交时间，而不是作者时间。</li>
<li><strong>timestamp</strong> (yymmddhhmmss) is the UTC time the revision was created. In Git, this is the commit time, not the author time.revisionIdentifier (abcdefabcdef) 是提交哈希值的12个字符的前缀，或者在Subversion中，是一个零填充的版本号。</li>
<li><strong>revisionIdentifier</strong> (abcdefabcdef) is a 12-character prefix of the commit hash, or in Subversion, a zero-padded revision number.</li>
</ul>
<h3 id="v0-number-v0号">v0 number v0号</h3>
<p>A module published with a v0 number will have a formal semantic version number with a major, minor, and patch part, as well as an optional pre-release identifier.</p>
<p>一个以v0编号发布的模块将有一个正式的语义上的版本号，包括主要、次要和补丁部分，以及一个可选的预发布标识符。</p>
<p>Though a v0 version can be used in production, it makes no stability or backward compatibility guarantees. In addition, versions v1 and later are allowed to break backward compatibility for code using the v0 versions. For this reason, a developer with code consuming functions in a v0 module is responsible for adapting to incompatible changes until v1 is released.</p>
<p>尽管v0版本可以在生产中使用，但它不做任何稳定性或向后兼容性的保证。此外，v1及以后的版本允许打破使用v0版本的代码的向后兼容性。由于这个原因，拥有消耗v0模块功能的代码的开发者有责任适应不兼容的变化，直到v1版本发布。</p>
<h2 id="pre-release-version-预发布版本">Pre-release version 预发布版本</h2>
<p>Signals that this is a pre-release milestone, such as an alpha or beta. This release carries no stability guarantees.</p>
<p>标志着这是一个预发布的里程碑，如alpha或beta。这个版本没有稳定性保证。</p>
<h4 id="example-例如">Example 例如</h4>
<pre tabindex="0"><code>vx.x.x-beta.2
</code></pre><p>A module’s developer can use a pre-release identifier with any major.minor.patch combination by appending a hyphen and the pre-release identifier.</p>
<p>一个模块的开发者可以在任何major.minor.patch组合中使用预发布标识符，方法是在预发布标识符后面加上一个连字符。</p>
<h2 id="minor-version-次要版本">Minor version 次要版本</h2>
<p>Signals backward-compatible changes to the module’s public API. This release guarantees backward compatibility and stability.</p>
<p>标志着模块的公共API向后兼容的变化。这个版本保证了向后的兼容性和稳定性。</p>
<h4 id="example-例如-1">Example 例如</h4>
<pre tabindex="0"><code>vx.4.x
</code></pre><p>This version changes the module’s public API, but not in a way that breaks calling code. This might include changes to a module’s own dependencies or the addition of new functions, methods, struct fields, or types.</p>
<p>这个版本改变了模块的公共API，但不是以破坏调用代码的方式。这可能包括对模块本身的依赖性的改变，或增加新的函数、方法、结构域或类型。</p>
<p>In other words, this version might include enhancements through new functions that another developer might want to use. However, a developer using previous minor versions needn’t change their code otherwise.</p>
<p>换句话说，这个版本可能包括通过另一个开发者可能想要使用的新函数进行的增强。然而，使用以前次要版本的开发者不需要改变他们的代码。</p>
<h2 id="patch-version-补丁版本">Patch version 补丁版本</h2>
<p>Signals changes that don’t affect the module’s public API or its dependencies. This release guarantees backward compatibility and stability.</p>
<p>标志着不影响模块的公共API或其依赖关系的变化。这个版本保证了向后的兼容性和稳定性。</p>
<h4 id="example-例如-2">Example 例如</h4>
<pre tabindex="0"><code>vx.x.1
</code></pre><p>An update that increments this number is only for minor changes such as bug fixes. Developers of consuming code can upgrade to this version safely without needing to change their code.</p>
<p>递增这个数字的更新只针对微小的变化，如错误修复。消耗代码的开发者可以安全地升级到这个版本而不需要改变他们的代码。</p>
<h2 id="major-version-主要版本">Major version 主要版本</h2>
<p>Signals backward-incompatible changes in a module’s public API. This release carries no guarantee that it will be backward compatible with preceding major versions.</p>
<p>标志着一个模块的公共API向后兼容的变化。这个版本不保证它能向后兼容之前的主要版本。</p>
<h4 id="example-例如-3">Example 例如</h4>
<p>v1.x.x</p>
<p>A v1 or above version number signals that the module is stable for use (with exceptions for its pre-release versions).</p>
<p>一个v1或以上的版本号表示该模块可以稳定使用（其预发布版本除外）。</p>
<p>Note that because a version 0 makes no stability or backward compatibility guarantees, a developer upgrading a module from v0 to v1 is responsible for adapting to changes that break backward compatibility.</p>
<p>请注意，由于0版本没有稳定性或向后兼容性的保证，开发者要负责将模块从v0升级到v1，以适应破坏向后兼容性的变化。</p>
<p>A module developer should increment this number past v1 only when necessary because the version upgrade represents significant disruption for developers whose code uses function in the upgraded module. This disruption includes backward-incompatible changes to the public API, as well as the need for developers using the module to update the package path wherever they import packages from the module.</p>
<p>一个模块的开发者只有在必要的时候才应该把这个数字增加到v1以上，因为版本升级对那些代码使用升级后的模块功能的开发者来说意味着重大的破坏。这种干扰包括对公共API的向后兼容的改变，以及使用该模块的开发者需要在他们从该模块导入包的地方更新包路径。</p>
<p>A major version update to a number higher than v1 will also have a new module path. That’s because the module path will have the major version number appended, as in the following example:</p>
<p>一个主要的版本更新到高于v1的数字，也会有一个新的模块路径。这是因为模块路径将附加主要的版本号，如下面的例子：</p>
<pre tabindex="0"><code>module example.com/mymodule/v2 v2.0.0
</code></pre><p>A major version update makes this a new module with a separate history from the module’s previous version. If you’re developing modules to publish for others, see “Publishing breaking API changes” in <a href="https://go.dev/doc/modules/release-workflow" target="_blank" rel="noopener">Module release and versioning workflow</a>.</p>
<p>一个主要版本的更新使得这是一个新的模块，与该模块之前的版本有一个独立的历史。如果你开发的模块要为他人发布，请参阅模块发布和版本工作流程中的 &ldquo;发布破坏性的API变化&rdquo;。</p>
<p>For more on the module directive, see <a href="https://go.dev/doc/modules/gomod-ref" target="_blank" rel="noopener">go.mod reference</a>.</p>
<p>关于模块指令的更多信息，请参见go.mod参考。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d66f876e1b2cca6160e41de2ccdbcb68">5 - 管理依赖项</h1>
    
	<h1 id="managing-dependencies---管理依赖项">Managing dependencies - 管理依赖项</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/modules/managing-dependencies" target="_blank" rel="noopener">https://go.dev/doc/modules/managing-dependencies</a></p>
</blockquote>
<p>​	当你的代码使用外部包时，这些包（作为模块分发）就成为了依赖。随着时间的推移，你可能需要升级它们或替换它们。Go 提供了依赖项管理工具，帮助您在纳入外部依赖时保持 Go 应用程序的安全。</p>
<p>​	本主题介绍了如何执行任务来管理代码中的依赖项。你可以用 Go 工具来执行其中的大多数任务。本主题还介绍了如何执行一些其他与依赖项有关的任务，您可能会发现这些任务很有用。</p>
<p>还请参见：</p>
<ul>
<li>如果你刚开始将依赖项作为模块来使用，请参阅<a href="../../GettingStarted/TutorialGetStartedWithGo">Getting started tutorial （入门教程）</a>，以获得简短的介绍。</li>
<li>使用 <code>go</code> 命令来管理依赖项有助于确保你的需求保持一致，以及 go.mod 文件内容的有效性。关于命令的参考，请看<a href="../../References/CommandDocumentation/go">Command go</a>。你也可以在命令行中输入<code>go help command-name</code>来获得帮助，如<code>go help mod tidy</code>。</li>
<li>编辑 <code>go.mod</code>文件时使用的用于进行依赖项更改的 Go 命令。关于该文件的内容，请参阅 <a href="../../References/gomodFileReference">go.mod file reference（go.mod文件参考）</a>。</li>
<li>让你的编辑器或 IDE 了解 Go 模块可以使管理它们的工作更容易。关于支持 Go 的编辑器的更多信息，请参阅 <a href="../EditorPluginsAndIDEs">Editor plugins and IDEs（编辑器插件和 IDE）</a>。</li>
<li>本主题不介绍如何开发、发布和版本模块供他人使用。有关这方面的更多信息，请参见 <a href="../DevelopingModules/DevelopingAndPublishingModules">Developing and publishing modules（开发和发布模块）</a>。</li>
</ul>
<h2 id="workflow-for-using-and-managing-dependencies-使用和管理依赖项的工作流程">Workflow for using and managing dependencies 使用和管理依赖项的工作流程</h2>
<p>​	你可以通过Go工具获取并使用有用的包。在 <a href="https://pkg.go.dev/" target="_blank" rel="noopener">pkg.go.dev</a> 上，你可以搜索你觉得有用的包，然后使用 <code>go</code> 命令将这些包导入你自己的代码中，以调用它们的功能。</p>
<p>​	下面列出了最常见的依赖项管理步骤。关于每个步骤的更多信息，请参见本主题中的章节。</p>
<ol start="6">
<li>
<p>在 <a href="https://pkg.go.dev/" target="_blank" rel="noopener">pkg.go.dev</a> 上<a href="#locating-and-importing-useful-packages">找到有用的包</a>。</p>
</li>
<li>
<p>在你的代码中<a href="#locating-and-importing-useful-packages">导入你想要的包</a>。</p>
</li>
<li>
<p>将你的代码添加到一个模块中以进行依赖项跟踪（如果尚未在模块中）。参见<a href="#enabling-dependency-tracking-in-your-code">启用依赖项跟踪</a></p>
</li>
<li>
<p><a href="#adding-a-dependency">将外部包添加为依赖项</a>，以便你可以管理它们。</p>
</li>
<li>
<p>随着时间的推移，根据需要<a href="#upgrading-or-downgrading-a-dependency">升级或降级依赖的版本</a>。</p>
</li>
</ol>
<h2 id="managing-dependencies-as-modules-将依赖项作为模块进行管理">Managing dependencies as modules 将依赖项作为模块进行管理</h2>
<p>​	在Go中，你可以将依赖项作为包含导入的包的模块来管理。这个过程得到了以下支持：</p>
<ul>
<li>用于发布模块和检索其代码的分散系统。开发者从他们自己的仓库中提供他们的模块供其他开发者使用，并以版本号进行发布。</li>
<li><strong>包搜索引擎</strong>和文档浏览器（<a href="https://pkg.go.dev/" target="_blank" rel="noopener">pkg.go.dev</a>），你可以在那里找到模块。参见<a href="#locating-and-importing-useful-packages">找到并导入有用的软件包</a>。</li>
<li>模块<strong>版本号约定</strong>，帮助你了解一个模块的稳定性和向后兼容性保证。参见<a href="../DevelopingModules/ModuleVersionNnumbering">模块版本号</a>。</li>
<li><strong>go tools</strong>使你更容易管理依赖项，包括获取模块的源代码、升级等等。更多内容请参见本主题的各个章节。</li>
</ul>
<h2 id="locating-and-importing-useful-packages-找到并导入有用的软件包">Locating and importing useful packages 找到并导入有用的软件包</h2>
<p>​	你可以在<a href="https://pkg.go.dev/" target="_blank" rel="noopener">pkg.go.dev</a>上搜索，以查找你觉得有用的功能包。</p>
<p>​	当你找到一个你想在你的代码中使用的包时，在页面顶部找到包的路径，点击复制路径按钮，将路径复制到你的剪贴板上。在你自己的代码中，将该路径粘贴到导入语句中，如下面的例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#98c379">&#34;rsc.io/quote&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	在你的代码导入包后，启用依赖项跟踪并使用该包的代码进行编译。更多信息，请参阅在你的代码中<a href="#enabling-dependency-tracking-in-your-code">启用依赖项跟踪</a>和<a href="#adding-a-dependency">添加依赖项</a>。</p>
<h2 id="enabling-dependency-tracking-in-your-code-在你的代码中启用依赖项跟踪">Enabling dependency tracking in your code 在你的代码中启用依赖项跟踪</h2>
<p>​	为了跟踪和管理你添加的依赖项，你首先要把你的代码放在自己的模块中。这将在你的源代码树的根目录下创建一个<code>go.mod</code>文件。你添加的依赖将被列在该文件中。</p>
<p>​	要将你的代码添加到自己的模块中，使用<a href="../../References/CommandDocumentation/go#go-mod-init">go mod init</a>命令。例如，从命令行切换到代码的根目录，然后运行下面例子中的命令：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go mod init example/mymodule
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>go mod init</code>命令的参数是你的模块的模块路径。如果可能的话，该模块路径应该是你的源代码的版本库位置。</p>
<p>​	如果一开始你不知道模块的最终仓库位置，请使用一个安全的替代品。这可能是你拥有的域名或你控制的其他名称（如你的公司名称），以及从模块的名称或源目录后的一个路径。更多信息，请参见<a href="#naming-a-module">模块的命名</a>。</p>
<p>​	当你使用 Go 工具来管理依赖项时，这些工具会更新 <code>go.mod</code> 文件，以便它维护你的依赖项的当前列表。</p>
<p>​	当你添加依赖项时，Go 工具还会创建一个 <code>go.sum</code> 文件，其中包含你所依赖模块的校验和。Go 使用它来验证下载的模块文件的完整性，特别是对于从事你项目的其他开发人员。</p>
<p>​	将<code>go.mod</code>和<code>go.sum</code>文件与你的代码一起包含在你的版本库中。</p>
<p>​	更多信息请参见 <a href="../../References/gomodFileReference">go.mod file reference（go.mod文件参考）</a>。</p>
<h2 id="naming-a-module-命名一个模块">Naming a module 命名一个模块</h2>
<p>​	当你运行 <code>go mod init</code> 来创建一个用于跟踪依赖项的模块时，你会指定一个模块路径作为模块的名称。该模块路径成为该模块中包的导入路径前缀。请确保指定一个不会与其他模块的路径冲突的模块路径。</p>
<p>​	至少，一个模块的路径只需要表明它的来源，比如公司、作者或所有者的名称。但是路径也可以更多的描述模块是什么或做什么。</p>
<p>​	模块路径通常采用以下形式：</p>
<pre tabindex="0"><code>&lt;prefix&gt;/&lt;descriptive-text&gt;
</code></pre><ul>
<li>
<p>前缀（prefix）通常是部分描述模块的字符串，例如描述其来源的字符串。这可能是：</p>
<ul>
<li>
<p>Go工具可以找到该模块源代码的版本库位置（如果你要发布该模块，则则需要这个位置）。</p>
<p>例如，它可能是<code>github.com/&lt;project-name&gt;/</code>。</p>
<p>如果你认为你可能会发布该模块供他人使用，请使用此最佳实践。关于发布的更多信息，请参阅 <a href="../DevelopingModules/DevelopingAndPublishingModules">Developing and publishing modules（开发和发布模块）</a>。</p>
</li>
<li>
<p>一个你控制的名称。</p>
<p>如果你不使用版本库名称，请确保选择一个你确信不会被他人使用的前缀。一个好的选择是你公司的名称。避免使用常见的术语，如<code>widgets</code>、<code>utilities</code>或<code>app</code>。</p>
</li>
</ul>
</li>
<li>
<p>对于描述性文本（descriptive text），一个好的选择是项目名称。记住，包名承载了描述功能的重任。模块路径为这些包名创建一个命名空间。</p>
</li>
</ul>
<p><strong>Reserved module path prefixes</strong> 保留的模块路径前缀</p>
<p>​	Go 保证以下字符串不会在包名中使用。</p>
<ul>
<li>
<p><code>test</code> - 你可以用<code>test</code>作为模块路径前缀，该模块的代码被设计用于本地测试另一个模块中的。</p>
<p>对于作为测试的一部分而创建的模块，请使用<code>test</code>路径前缀。例如，你的测试本身可能会运行<code>go mod init test</code>，然后以某种特殊方式设置该模块，以便用Go源代码分析工具进行测试。</p>
</li>
<li>
<p><code>example</code> - 在一些Go文档中用作模块路径前缀，例如在教程中，你创建一个模块只是为了跟踪依赖项。</p>
<p>请注意，Go 文档也使用 <code>example.com</code> 来说明例子可能是一个已发布的模块。</p>
</li>
</ul>
<h2 id="adding-a-dependency-添加一个依赖项">Adding a dependency 添加一个依赖项</h2>
<p>​	一旦你导入一个已发布的模块，你就可以使用 <a href="../../References/CommandDocumentation/go#add-dependencies-to-current-module-and-install-them">go get</a> 命令将该模块作为一个依赖项来管理。</p>
<p>该命令做了以下工作：</p>
<ul>
<li>
<p>如果需要，它会在<code>go.mod</code>文件中添加<code>require</code>指令，用于构建在命令行上命名的包所需的模块。一个<code>require</code>指令可以追踪模块所依赖的模块的最小版本。更多信息请参见 <a href="../../References/gomodFileReference">go.mod file reference（go.mod文件参考）</a>。</p>
</li>
<li>
<p>如果需要，它会下载模块的源代码，这样你就可以编译依赖于它们的包。它可以从模块代理（如<code>proxy.golang.org</code>）或直接从版本控制库下载模块。源代码被缓存在本地。</p>
<p>你可以设置Go工具下载模块的位置。更多信息请参见<a href="#specifying-a-module-proxy-server">指定模块代理服务器</a>。</p>
</li>
</ul>
<p>下面介绍几个例子。</p>
<ul>
<li>
<p>要在你的模块中添加一个包的所有依赖项，运行类似下面的命令（&quot;<code>.</code> &ldquo;指的是当前目录中的包）：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get .
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>要添加一个特定的依赖项，请将其模块路径指定为命令的参数。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get example.com/theirmodule
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>​	该命令还对其下载的每个模块进行认证。这可以确保它与模块发布时没有变化。如果模块在发布后发生了变化——例如，开发者改变了提交的内容——Go工具会显示一个安全错误。这种认证检查可以保护你免受可能被篡改的模块的影响。</p>
<h2 id="getting-a-specific-dependency-version-获取特定的依赖版本">Getting a specific dependency version 获取特定的依赖版本</h2>
<p>​	你可以通过在 <code>go get</code> 命令中指定一个依赖模块的版本来获取它的特定版本。该命令会更新你<code>go.mod</code>文件中的<code>require</code>指令（当然你也可以手动更新）。</p>
<p>你可能想这样做，如果：</p>
<ul>
<li>你想获得一个特定的预发布版本的模块以进行试用。</li>
<li>你发现你目前需要的版本不适合你，因此希望获得一个你知道可以依赖的版本。</li>
<li>你想升级或降级一个你已经需要的模块。</li>
</ul>
<p>下面是使用<a href="../../References/CommandDocumentation/go#add-dependencies-to-current-module-and-install-them">go get</a>命令的例子：</p>
<ul>
<li>
<p>要获得一个特定的版本，请在模块路径后面加上<code>@</code>符号和你想要的版本：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get example.com/theirmodule@v1.3.4
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>要获得最新的版本，请在模块路径后加上<code>@latest</code>：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get example.com/theirmodule@latest
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>​	下面的<code>go.mod</code>文件<code>require</code>指令例子（详见<a href="../../References/gomodFileReference">go.mod file reference（go.mod文件参考）</a>）说明了如何要求一个特定的版本号：</p>
<pre tabindex="0"><code>require example.com/theirmodule v1.3.4
</code></pre><h2 id="discovering-available-updates-发现可用的更新">Discovering available updates 发现可用的更新</h2>
<p>​	你可以检查你当前模块中已经使用的依赖项是否有更新的版本。使用<code>go list</code>命令来显示你的模块的依赖项列表，以及该模块的最新版本。一旦你发现了可用的升级版本，你就可以在你的代码中试用它们，以决定是否升级到新版本。</p>
<p>​	关于<code>go list</code>命令的更多信息，见<a href="../../References/GoModulesReference/Module-awareCommands#go-list-m">go list -m</a>。</p>
<p>​	这里有几个例子。</p>
<ul>
<li>
<p>列出当前模块的所有依赖模块，以及每个模块的最新版本：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go list -m -u all
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>显示某个特定模块的最新版本：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go list -m -u example.com/theirmodule
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="upgrading-or-downgrading-a-dependency-升级或降级一个依赖项">Upgrading or downgrading a dependency 升级或降级一个依赖项</h2>
<p>​	你可以使用 Go 工具来发现可用的版本，然后添加不同的版本作为依赖项，从而升级或降级依赖项模块。</p>
<ol>
<li>要发现新的版本，请使用 <code>go list</code> 命令，如 <a href="#discovering-available-updates">发现可用的更新</a> 中所述。</li>
<li>要添加一个特定的版本作为依赖项，使用 <code>go get</code> 命令，如 <a href="#getting-a-specific-dependency-version">获取特定的依赖项版本</a> 中所述。</li>
</ol>
<h2 id="synchronizing-your-codes-dependencies-同步你代码的依赖项">Synchronizing your code’s dependencies 同步你代码的依赖项</h2>
<p>​	你可以确保正在管理的代码中所有导入的包的依赖项，同时还可以删除你不再导入的包的依赖项。</p>
<p>​	当你对你的代码和依赖项进行更改后时，这可能很有用，可能创建了一个管理的依赖项和下载的模块的集合，这些模块不再与你代码中导入的包所特别需要的集合相匹配。</p>
<p>​	为了保持你的管理依赖项集的整洁，使用 <code>go mod tidy</code> 命令。该命令使用你的代码中导入的包集合，编辑你的<code>go.mod</code>文件，以添加必要但缺少的模块。它还会删除那些不提供任何相关包的未使用的模块。</p>
<p>​	该命令没有参数，只有一个标志，即<code>-v</code>，可以打印出被删除模块的信息。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go mod tidy
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="developing-and-testing-against-unpublished-module-code-针对未发布的模块代码进行开发和测试">Developing and testing against unpublished module code 针对未发布的模块代码进行开发和测试</h2>
<p>​	你可以指定你的代码使用可能尚未发布的依赖模块。这些模块的代码可能在它们各自的版本库中，或者在这些版本库的fork中，或者在与当前模块一起使用的驱动器中。</p>
<p>​	你可能想在以下情况下这样做：</p>
<ul>
<li>你想对一个外部模块的代码进行自己的修改，比如在 fork和/或clone之后。例如，你可能想对该模块进行修复，然后将其作为拉动请求发送给该模块的开发者。</li>
<li>你正在构建一个新的模块，但还没有发布，因此它在存储库中是不可用的，而 <code>go get</code> 命令可以访问它。</li>
</ul>
<h3 id="requiring-module-code-in-a-local-directory-要求本地目录中的模块代码">Requiring module code in a local directory 要求本地目录中的模块代码</h3>
<p>​	你可以指定所需模块的代码和需要它的代码在同一个本地驱动器上。你可能会发现这在以下情况下很有用：</p>
<ul>
<li>开发你自己的独立模块，并希望从当前模块中进行测试。</li>
<li>修复外部模块的问题或添加功能，并希望从当前模块进行测试。(注意，你也可以从你自己的fork库中要求外部模块。更多信息，请看 <a href="#requiring-external-module-code-from-your-own-repository-fork-fork">从你自己的版本库分叉中获取外部模块代码</a>）。</li>
</ul>
<p>​	要告诉 Go 命令使用模块代码的本地副本，请使用 <code>go.mod</code> 文件中的 <code>replace</code> 指令来替换 <code>require</code> 指令中给出的模块路径。关于指令的更多信息，请参见 <a href="../../References/gomodFileReference">go.mod file reference（go.mod文件参考）</a>。</p>
<p>​	在下面的<code>go.mod</code>文件例子中，当前模块需要外部模块<code>example.com/theirmodule</code>，使用了一个不存在的版本号（<code>v0.0.0-unpublished</code>），以确保替换正常工作。然后<code>replace</code>指令用<code>./theirmodule</code>替换原来的模块路径，这个目录与当前模块的目录处于同一级别。</p>
<pre tabindex="0"><code>module example.com/mymodule

go 1.16

require example.com/theirmodule v0.0.0-unpublished

replace example.com/theirmodule v0.0.0-unpublished =&gt; ../theirmodule
</code></pre><p>​	当设置<code>require</code>/<code>replace</code>对时，使用<a href="../../References/CommandDocumentation/go#go-mod-edit">go mod edit</a>和<a href="../../References/CommandDocumentation/go#add-dependencies-to-current-module-and-install-them">go get</a>命令来确保文件描述的需求保持一致。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go mod edit -replace<span style="color:#56b6c2">=</span>example.com/theirmodule@v0.0.0-unpublished<span style="color:#56b6c2">=</span>../theirmodule
</span></span><span style="display:flex;"><span>$ go get example.com/theirmodule@v0.0.0-unpublished
</span></span></code></pre></td></tr></table>
</div>
</div><p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：当你使用`replace` 指令时，Go工具不会像[添加依赖项](#adding-a-dependency)中描述的那样对外部模块进行认证。
</code></pre>
<p>​	更多关于版本号的信息，请参见<a href="../DevelopingModules/ModuleVersionNnumbering">模块版本号</a>。</p>
<h3 id="requiring-external-module-code-from-your-own-repository-fork-要求从你自己的仓库fork的外部模块代码">Requiring external module code from your own repository fork 要求从你自己的仓库fork的外部模块代码</h3>
<p>​	当你 fork了一个外部模块的仓库时（例如修复模块代码中的问题或增加一个功能），你可以让 Go 工具使用你的fork来获取模块的源代码。这对于测试来自你自己代码的更改非常有用。(注意，你还可以要求在本地驱动器上的目录中的模块代码与需要它的模块一起使用。更多信息，请参见 <a href="#requiring-module-code-in-a-local-directory">要求本地目录下的模块代码</a>）。</p>
<p>​	为此，你可以在<code>go.mod</code>文件中使用<code>replace</code>指令，将外部模块的原始路径替换为仓库中 fork 的路径。这样，Go工具在编译时就会使用替换路径（fork 的位置），例如，同时允许你不改变原始模块路径中的<code>import</code>语句。</p>
<p>​	关于<code>replace</code>指令的更多信息，请参见 <a href="../../References/gomodFileReference">go.mod file reference（go.mod文件参考）</a>。</p>
<p>​	在下面的<code>go.mod</code>文件例子中，当前模块需要外部模块<code>example.com/theirmodule</code>。<code>replace</code>指令用<code>example.com/myfork/theirmodule</code>替换了原来的模块路径，这是一个模块自己的仓库的fork。</p>
<pre tabindex="0"><code>module example.com/mymodule

go 1.16

require example.com/theirmodule v1.2.3

replace example.com/theirmodule v1.2.3 =&gt; example.com/myfork/theirmodule v1.2.3-fixed
</code></pre><p>​	在设置<code>require</code>/<code>replace</code>对时，使用Go工具命令来确保文件描述的需求保持一致。使用 <a href="../../References/GoModulesReference/Module-awareCommands#go-list-m">go list</a> 命令来获取当前模块使用的版本。然后使用 [go mod edit](<a href="../../References/CommandDocumentation/go#go-mod-edit">go get</a>) 命令将所需模块替换为分叉模块：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go list -m example.com/theirmodule
</span></span><span style="display:flex;"><span>example.com/theirmodule v1.2.3
</span></span><span style="display:flex;"><span>$ go mod edit -replace<span style="color:#56b6c2">=</span>example.com/theirmodule@v1.2.3<span style="color:#56b6c2">=</span>example.com/myfork/theirmodule@v1.2.3-fixed
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意：当你使用<code>replace</code>指令时，Go工具不会像<a href="#adding-a-dependency">添加依赖项</a>中描述的那样对外部模块进行认证。</p>
<p>​	更多关于版本号的信息，请参见 <a href="../DevelopingModules/ModuleVersionNnumbering">模块版本号</a>。</p>
<h2 id="getting-a-specific-commit-using-a-repository-identifier">Getting a specific commit using a repository identifier</h2>
<p>​	你可以使用 <code>go get</code> 命令来添加某个模块的未发布代码，这些代码来自其版本库中的某个特定提交。</p>
<p>​	要做到这一点，你需要使用 <code>go get</code> 命令，用 <code>@</code> 符号指定你想要的代码。当你使用 <code>go get</code> 命令时，该命令将在你的 <code>go.mod</code> 文件中添加一个 <code>require</code> 指令，该指令需要外部模块，使用基于提交细节的伪版本号。</p>
<p>​	下面的例子提供了一些说明。它们基于源代码位于 git 版本库中的模块。</p>
<ul>
<li>
<p>要获得特定提交的模块，请附加<code>@commithash</code>的形式：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get example.com/theirmodule@4cf76c2
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>要获得特定分支的模块，请添加<code>@branchname</code>的形式：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get example.com/theirmodule@bugfixes
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="removing-a-dependency-移除一个依赖项">Removing a dependency 移除一个依赖项</h2>
<p>​	当你的代码不再使用某个模块的任何包时，你可以停止跟踪该模块作为一个依赖项。</p>
<p>​	要停止跟踪所有未使用的模块，运行<a href="../../References/CommandDocumentation/go#add-missing-and-remove-unused-modules">go mod tidy</a>命令。这个命令还可能添加（构建模块中的包）所缺失的依赖。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go mod tidy
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	要移除一个特定的依赖项，使用<a href="../../References/CommandDocumentation/go#add-dependencies-to-current-module-and-install-them">go get</a>命令，指定模块的模块路径并附加<code>@none</code>，如下面的例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go get example.com/theirmodule@none
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>go get</code>命令也会降级或移除依赖于被移除模块的其他依赖项。</p>
<h2 id="specifying-a-module-proxy-server-指定一个模块代理服务器">Specifying a module proxy server 指定一个模块代理服务器</h2>
<p>​	当你使用Go工具来处理模块时，这些工具默认从<code>proxy.golang.org</code>（一个由Google运营的公共模块镜像）或直接从模块的版本库下载模块。你可以指定Go工具应该使用另一个代理服务器来下载和验证模块。</p>
<p>​	如果你（或你的团队）已经建立或选择了要使用的不同的模块代理服务器，则可能需要执行此操作。例如，有些人建立了一个模块代理服务器，以便更好地控制依赖项的使用方式。</p>
<p>​	为了指定另一个模块代理服务器供Go工具使用，将<code>GOPROXY</code>环境变量设置为一个或多个服务器的URL。<strong>Go工具将按照你指定的顺序尝试每个URL</strong>。默认情况下，<code>GOPROXY</code>首先指定一个公共的Google运行的模块代理，然后直接从模块库中下载（如其模块路径中指定的）：</p>
<pre tabindex="0"><code>GOPROXY=&#34;https://proxy.golang.org,direct&#34;
</code></pre><p>​	关于<code>GOPROXY</code>环境变量的更多信息，包括支持其他行为的值，见<a href="../../References/gomodFileReference">go.mod file reference（go.mod文件参考）</a>。</p>
<p>​	你可以将该变量设置为其他模块代理服务器的URL，用<strong>逗号或管道</strong>来分隔URL。</p>
<ul>
<li>
<p>当你使用<strong>逗号</strong>时，Go工具只有在当前URL返回HTTP 404或410时才会尝试列表中的下一个URL。</p>
<pre tabindex="0"><code>GOPROXY=&#34;https://proxy.example.com,https://proxy2.example.com&#34;
</code></pre></li>
<li>
<p>当你使用管道时，Go工具将尝试列表中的下一个URL，无论HTTP错误代码如何。</p>
<pre tabindex="0"><code>GOPROXY=&#34;https://proxy.example.com|https://proxy2.example.com&#34;
</code></pre></li>
</ul>
<p>​	Go模块经常在版本控制服务器和模块代理上开发和发布，而这些服务器和代理在公共互联网上是不存在的。你可以设置<code>GOPRIVATE</code>环境变量。你可以设置<code>GOPRIVATE</code>环境变量来配置<code>go</code>命令从私人来源下载和构建模块。然后<code>go</code>命令就可以从私人来源下载和构建模块了。</p>
<p><code>GOPRIVATE</code>或<code>GONOPROXY</code>环境变量可以被设置为匹配模块前缀的<code>glob</code>模式列表，这些模块前缀是私有的，不应该从任何代理处请求。例如：</p>
<pre tabindex="0"><code>GOPRIVATE=*.corp.example.com,*.research.example.com
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4448fa1622a7c7da135f42cb4c56e6db">6 - 编辑器插件和IDEs</h1>
    
	<h1 id="editor-plugins-and-ides---编辑器插件和ides">Editor plugins and IDEs - 编辑器插件和IDEs</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/editors" target="_blank" rel="noopener">https://go.dev/doc/editors</a></p>
</blockquote>
<h2 id="简介">简介</h2>
<p>​	本文列出了Go生态系统（Go ecosystem）中常用的编辑器插件和集成开发环境，这些插件和环境可以使Go开发更有成效、更无缝。支持Go开发的编辑器和集成开发环境的全面清单可在<a href="https://go.dev/wiki/IDEsAndTextEditorPlugins" target="_blank" rel="noopener">这个wiki</a>上找到。</p>
<h2 id="选项">选项</h2>
<p>​	Go 生态系统提供了各种编辑器插件和 IDE，以增强您的日常编辑、导航、测试和调试体验。</p>
<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=golang.go" target="_blank" rel="noopener">Visual Studio Code</a>：Go 扩展提供对Go编程语言的支持</li>
<li><a href="https://www.jetbrains.com/go" target="_blank" rel="noopener">GoLand</a>：GoLand是作为独立的IDE或作为IntelliJ IDEA Ultimate的插件发布的。</li>
<li><a href="https://github.com/fatih/vim-go" target="_blank" rel="noopener">vim</a>：vim-go插件提供Go编程语言支持</li>
</ul>
<p>请注意，这些只是一些顶级的解决方案；更全面的社区维护的IDE和文本编辑器插件列表可以在<a href="https://go.dev/wiki/IDEsAndTextEditorPlugins" target="_blank" rel="noopener">这个wiki</a>上找到。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-94848c962fb3b9db41da11bf016f896d">7 - 访问数据库</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-86563934400c94be245ac338fd26a603">7.1 - 访问关系型数据库</h1>
    
	<h1 id="accessing-relational-databases---访问关系型数据库">Accessing relational databases - 访问关系型数据库</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/" target="_blank" rel="noopener">https://go.dev/doc/database/</a></p>
</blockquote>
<p>​	使用 Go，您可以将各种数据库和数据访问方法纳入您的应用程序中。本节的主题描述了如何使用标准库的<a href="https://pkg.go.dev/database/sql" target="_blank" rel="noopener">database/sql</a>包来访问关系型数据库。</p>
<p>​	关于Go的数据访问的介绍性教程，请看 <a href="../../../GettingStarted/TutorialAccessingARelationalDatabase">Tutorial: Accessing a relational database</a>。</p>
<p>​	Go 也支持其他数据访问技术，包括用于更高级别的访问关系型数据库的 ORM 库，以及非关系型 NoSQL 数据存储。</p>
<ul>
<li><strong>对象-关系映射（ORM）库（Object-relational mapping (ORM) libraries）</strong>。虽然<code>database/sql</code> 包包括用于低级数据访问逻辑的函数，但您也可以使用 Go 来访问更高抽象级别的数据存储。关于Go的两个流行的对象-关系映射（ORM）库的更多信息，请参见<a href="https://gorm.io/index.html" target="_blank" rel="noopener">GORM</a>和<a href="https://entgo.io/" target="_blank" rel="noopener">ent</a> (<a href="https://pkg.go.dev/entgo.io/ent" target="_blank" rel="noopener">package reference</a>)。</li>
<li><strong>NoSQL 数据存储.</strong> Go 社区已经为大多数 NoSQL 数据存储开发了驱动程序，包括 <a href="https://docs.mongodb.com/drivers/go/" target="_blank" rel="noopener">MongoDB</a>和 <a href="https://docs.couchbase.com/go-sdk/current/hello-world/overview.html" target="_blank" rel="noopener">Couchbase</a>。您可以搜索<a href="https://pkg.go.dev/" target="_blank" rel="noopener">pkg.go.dev</a> 获取更多信息。</li>
</ul>
<h3 id="supported-database-management-systems-支持的数据库管理系统">Supported database management systems 支持的数据库管理系统</h3>
<p>​	Go 支持所有最常见的关系型数据库管理系统，包括 <code>MySQL</code>、<code>Oracle</code>、<code>Postgres</code>、<code>SQL Server</code>、<code>SQLite</code> 等。</p>
<p>​	你可以在 <a href="https://github.com/golang/go/wiki/SQLDrivers" target="_blank" rel="noopener">SQLDrivers</a>页面找到完整的驱动列表。</p>
<h3 id="functions-to-execute-queries-or-make-database-changes-执行查询或更改数据库的函数">Functions to execute queries or make database changes 执行查询或更改数据库的函数</h3>
<p>​	<code>database/sql</code>包包含专门为你正在执行的数据库操作设计的函数。例如，虽然你可以使用<code>Query</code>或<code>QueryRow</code>来执行查询，但<code>QueryRow</code>是为只需要一行的情况而设计的，省去了返回只包括一行记录的<code>sql.Rows</code>的开销。你可以使用<code>Exec</code>函数用SQL语句对数据库进行修改，如<code>INSERT</code>, <code>UPDATE</code>, 或<code>DELETE</code>。</p>
<p>​	更多内容，请参见以下内容：</p>
<ul>
<li><a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing SQL statements that don’t return data （执行不返回数据的SQL语句）</a></li>
<li><a href="../QueryingForData">Querying for data （查询数据）</a></li>
</ul>
<h3 id="transactions-事务">Transactions 事务</h3>
<p>​	通过<code>sql.Tx</code>，您可以编写代码来执行事务中的数据库操作。在一个事务中，多个操作可以一起执行，并以最后的提交（commit）来结束，以便在一个原子步骤中应用所有的更改，或者以回滚（rollback）来丢弃（discard ）它们。</p>
<p>​	关于事务的更多信息，请参见<a href="../ExecutingTransactions">Executing transactions （执行事务）</a>。</p>
<h3 id="query-cancellation-查询的取消">Query cancellation 查询的取消</h3>
<p>​	当你希望能够取消一个数据库操作时，你可以使用<code>context.Context</code>，例如，当客户端的连接关闭或操作运行的时间超过期望时。</p>
<p>​	对于任何数据库操作，你可以使用一个<code>database/sql</code>包函数，该函数将<code>Context</code>作为一个实参。使用<code>Context</code>，你可以为操作指定一个超时或最后期限。你还可以使用 <code>Context</code> 将取消请求通过应用程序传播到执行 SQL 语句的函数，确保在不再需要资源时释放资源。</p>
<p>​	更多信息请参见<a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations （取消正在进行的操作）</a>。</p>
<h3 id="managed-connection-pool-管理连接池">Managed connection pool 管理连接池</h3>
<p>​	当你使用<code>sql.DB</code>数据库句柄时，你正在与一个内置的连接池连接，该连接池根据你代码的需要创建和处置连接。通过<code>sql.DB</code>的句柄是用Go进行数据库访问的最常见方式。更多信息请参见<a href="../OpeningADatabaseHandle">Opening a database handle （打开数据库句柄）</a> 。</p>
<p>​	<code>database/sql</code>包为你管理连接池。然而，对于更高级的需求，可以按照<a href="https://go.dev/doc/database/manage-connections#connection_pool_properties" target="_blank" rel="noopener">Setting connection pool properties （设置连接池属性）</a>中的说明设置连接池属性。</p>
<p>​	对于那些需要单一保留连接的操作，<code>database/sql</code>包提供了<a href="https://pkg.go.dev/database/sql#Conn" target="_blank" rel="noopener">sql.Conn</a>。当使用<code>sql.Tx</code>的事务是一个糟糕的选择时，<code>Conn</code>就特别有用。</p>
<p>​	例如，你的代码可能需要：</p>
<ul>
<li>通过<code>DDL</code>进行模式更改，包括包含其自身事务语义的逻辑。将<code>sql</code>包的事务函数与SQL事务语句混合在一起是一种不好的做法，正如在<a href="https://go.dev/doc/database/execute-transactions" target="_blank" rel="noopener">Executing transactions （执行事务）</a> 中所描述的那样。</li>
<li>执行创建临时表的查询锁定操作。</li>
</ul>
<p>​	更多内容请参见 <a href="../ManagingConnections#using-dedicated-connections">Using dedicated connections （使用专用连接）</a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-42d595491e1585d79dd5b5bef1ea2b3e">7.2 - 打开一个数据库句柄</h1>
    
	<h1 id="opening-a-database-handle---打开一个数据库句柄">Opening a database handle - 打开一个数据库句柄</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/open-handle" target="_blank" rel="noopener">https://go.dev/doc/database/open-handle</a></p>
</blockquote>
<p>​	<a href="https://pkg.go.dev/database/sql" target="_blank" rel="noopener">database/sql</a>包通过减少你需要的管理连接来简化数据库访问。与许多数据访问API不同，使用<code>database/sql</code>，你不需要明确地打开一个连接，进行工作，然后关闭连接。相反，你的代码会打开一个代表连接池的数据库句柄，然后用这个句柄执行数据访问操作，仅在需要释放资源（比如那些被检索的行或预处理语句所持有的资源）时才调用<code>Close</code>方法。</p>
<p>​	换句话说，它是由<a href="https://pkg.go.dev/database/sql#DB" target="_blank" rel="noopener">sql.DB</a>表示的数据库句柄，代表你的代码来处理连接、打开和关闭连接。当你的代码使用句柄来执行数据库操作时，这些操作对数据库有并发的访问。更多信息请参见<a href="../ManagingConnections">Managing connections （管理连接）</a>。</p>
<p>注意：你也可以保留一个数据库连接。更多信息，请参见 <a href="../ManagingConnections#using-dedicated-connections">Using dedicated connections （使用专用连接）</a>。</p>
<p>​	除了<code>database/sql</code>包中的API之外，Go社区还为所有最常见的（以及许多不常见的）数据库管理系统（DBMSes）开发了驱动程序。</p>
<p>当打开一个数据库句柄时，请遵循以下高级步骤：</p>
<ol>
<li>
<p>找到一个驱动程序。</p>
<p>驱动程序会在你的Go代码和数据库之间转换（translates）请求和响应。更多信息，请参见 <a href="#locating-and-importing-a-database-driver">Locating and importing a database driver （找到并导入数据库驱动程序）</a>。</p>
</li>
<li>
<p>打开一个数据库句柄。</p>
<p>在你导入驱动程序后，你可以为特定的数据库打开一个句柄。更多信息，请参见<a href="#opening-a-database-handle">Opening a database handle （打开一个数据库句柄）</a>。</p>
</li>
<li>
<p>确认连接。</p>
<p>一旦你打开了一个数据库句柄，你的代码就可以检查是否有连接可用。更多信息，请参见<a href="#confirming-a-connection">Confirming a connection （确认连接）</a>。</p>
</li>
</ol>
<p>​	你的代码通常不会明确地打开或关闭数据库连接——那是由数据库句柄完成的。<strong>然而，你的代码应该释放它沿途获得的资源</strong>，例如包含查询结果的<code>sql.Rows</code>。更多信息请参见<a href="#freeing-resources">Freeing resources（释放资源）</a>。</p>
<h3 id="locating-and-importing-a-database-driver-找到并导入数据库驱动程序">Locating and importing a database driver 找到并导入数据库驱动程序</h3>
<p>​	你需要一个支持你所使用的数据库管理系统的数据库驱动程序。要为你的数据库找到一个驱动，请看<a href="https://github.com/golang/go/wiki/SQLDrivers" target="_blank" rel="noopener">SQLDrivers</a>。</p>
<p>​	为了使你的代码能够使用该驱动程序，你可以像导入其他Go包一样导入它。下面是一个例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#98c379">&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	注意，如果你没有直接从驱动包中调用任何函数——比如它被<code>sql</code>包隐式使用——你需要使用空白导入，它在导入路径前加了一个下划线：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">_</span> <span style="color:#98c379">&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：作为一个最佳实践，请避免使用数据库驱动程序自己的API进行数据库操作。相反，使用`database/sql`包中的函数。这将有助于保持你的代码与DBMS的松耦合，使你在需要时更容易切换到不同的DBMS。
</code></pre>
<h3 id="opening-a-database-handle-打开一个数据库句柄">Opening a database handle 打开一个数据库句柄</h3>
<p>​	<code>sql.DB</code>数据库句柄提供了从数据库读取和写入数据库的能力，无论是单独的还是在一个事务中。</p>
<p>​	你可以通过调用<code>sql.Open</code>（它接收一个连接字符串）或者<code>sql.OpenDB</code>（它接收一个<code>driver.Connector</code>）来获得一个数据库句柄。两者都返回一个指向<a href="https://pkg.go.dev/database/sql#DB" target="_blank" rel="noopener">sql.DB</a>的指针。</p>
<p>注意：请确保你的数据库凭证不在你的Go源代码中。更多信息请参见<a href="#storing-database-credentials">Storing database credentials （存储数据库凭证）</a> 。</p>
<h4 id="opening-with-a-connection-string-用连接字符串打开">Opening with a connection string 用连接字符串打开</h4>
<p>​	当你想使用连接字符串进行连接时，请使用<a href="https://pkg.go.dev/database/sql#Open" target="_blank" rel="noopener">sql.Open</a>函数。字符串的格式将根据你使用的驱动程序而有所不同。</p>
<p>下面是一个关于MySQL的例子：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">db</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;mysql&#34;</span>, <span style="color:#98c379">&#34;username:password@tcp(127.0.0.1:3306)/jazzrecords&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	然而，你可能会发现，以更结构化的方式捕获连接属性会使你的代码更具可读性。这些细节会因驱动而异。</p>
<p>​	例如，你可以把前面的例子换成下面的例子，它使用MySQL驱动的<a href="https://pkg.go.dev/github.com/go-sql-driver/mysql#Config" target="_blank" rel="noopener">Config</a>来指定属性，并使用<a href="https://pkg.go.dev/github.com/go-sql-driver/mysql#Config.FormatDSN" target="_blank" rel="noopener">FormatDSN</a>方法来构建一个连接字符串。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Specify connection properties.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">cfg</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">mysql</span>.<span style="color:#e06c75">Config</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">User</span>:   <span style="color:#e06c75">username</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Passwd</span>: <span style="color:#e06c75">password</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Net</span>:    <span style="color:#98c379">&#34;tcp&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Addr</span>:   <span style="color:#98c379">&#34;127.0.0.1:3306&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DBName</span>: <span style="color:#98c379">&#34;jazzrecords&#34;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Get a database handle.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">db</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;mysql&#34;</span>, <span style="color:#e06c75">cfg</span>.<span style="color:#61afef;font-weight:bold">FormatDSN</span>())
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="opening-with-a-connector-用一个连接器打开">Opening with a Connector 用一个连接器打开</h4>
<p>​	当你想利用连接字符串中没有的特定驱动程序的连接特性时，请使用<a href="https://pkg.go.dev/database/sql#OpenDB" target="_blank" rel="noopener">sql.OpenDB</a>函数。每个驱动都支持自己的连接属性集，通常提供了定制特定于DBMS的连接请求的方式。</p>
<p>​	将前面的<code>sql.Open</code>例子改成使用<code>sql.OpenDB</code>，你可以用下面的代码创建一个句柄：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Specify connection properties.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">cfg</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">mysql</span>.<span style="color:#e06c75">Config</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">User</span>:   <span style="color:#e06c75">username</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Passwd</span>: <span style="color:#e06c75">password</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Net</span>:    <span style="color:#98c379">&#34;tcp&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Addr</span>:   <span style="color:#98c379">&#34;127.0.0.1:3306&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">DBName</span>: <span style="color:#98c379">&#34;jazzrecords&#34;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Get a driver-specific connector.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">connector</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">mysql</span>.<span style="color:#61afef;font-weight:bold">NewConnector</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">cfg</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Get a database handle.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">db</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">OpenDB</span>(<span style="color:#e06c75">connector</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="handling-errors-处理错误">Handling errors 处理错误</h4>
<p>​	你的代码应该检查是否在尝试创建句柄时出错，比如用<code>sql.Open</code>。这不会是一个连接错误。相反，如果<code>sql.Open</code>无法初始化句柄，你会得到一个错误。这可能发生，例如，如果它无法解析你指定的<code>DSN</code>。</p>
<h3 id="confirming-a-connection-确认一个连接">Confirming a connection 确认一个连接</h3>
<p>​	当你打开一个数据库句柄时，<code>sql</code>包可能不会立即自己创建一个新的数据库连接。相反，它可能会在你的代码需要它时创建连接。如果你不会马上使用数据库，并且想确认连接可以被建立，可以调用<a href="https://pkg.go.dev/database/sql#DB.Ping" target="_blank" rel="noopener">Ping</a>或<a href="https://pkg.go.dev/database/sql#DB.PingContext" target="_blank" rel="noopener">PingContext</a>。</p>
<p>下面的例子中的代码对数据库进行ping，以确认连接。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">db</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">sql</span>.<span style="color:#61afef;font-weight:bold">Open</span>(<span style="color:#98c379">&#34;mysql&#34;</span>, <span style="color:#e06c75">connString</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Confirm a successful connection.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Ping</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="storing-database-credentials-存储数据库凭证">Storing database credentials 存储数据库凭证</h3>
<p>​	避免在你的Go源代码中存储数据库凭证（credentials ），这可能会将你的数据库内容暴露给其他人。相反，要想办法将其存储在代码之外的位置，但对代码是可用的。例如，考虑一个保密应用程序，该应用程序存储凭据并提供一个 API，您的代码可以使用该 API 检索凭据，以便对 DBMS 进行身份验证。</p>
<p>​	一种流行的方法是在程序启动前将秘密存储在环境中，可能是从秘密管理器中加载，然后你的 Go 程序可以使用 <a href="https://pkg.go.dev/os#Getenv" target="_blank" rel="noopener">os.Getenv</a> 读取这些秘密：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">username</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;DB_USER&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e06c75">password</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">os</span>.<span style="color:#61afef;font-weight:bold">Getenv</span>(<span style="color:#98c379">&#34;DB_PASS&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	这种方法还允许你为本地测试自己设置环境变量。</p>
<h3 id="freeing-resources-释放资源">Freeing resources 释放资源</h3>
<p>​	虽然您没有显式地管理或关闭<code>database/sql</code>包提供连接，但你的代码应该在不再需要时释放它所获得的资源。这些可能包括由表示从查询返回的数据的<code>sql.Rows</code>或代表预处理语句的<code>sql.Stmt</code>持有的资源。</p>
<p>​	通常，你通过推迟对<code>Close</code>函数的调用来关闭资源，以便在外层函数退出之前释放资源。</p>
<p>​	在下面的例子中，代码延迟<code>Close</code>，以释放由<a href="https://pkg.go.dev/database/sql#Rows" target="_blank" rel="noopener">sql.Rows</a>持有的资源。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * FROM album WHERE artist = ?&#34;</span>, <span style="color:#e06c75">artist</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop through returned rows.
</span></span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6f0765d11129073b820ce005805beee4">7.3 - 执行不返回数据的SQL语句</h1>
    
	<h1 id="executing-sql-statements-that-dont-return-data---执行不返回数据的sql语句">Executing SQL statements that don&rsquo;t return data - 执行不返回数据的SQL语句</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/change-data" target="_blank" rel="noopener">https://go.dev/doc/database/change-data</a></p>
</blockquote>
<p>​	当你执行不返回数据的数据库操作时，请使用<code>database/sql</code>包的<code>Exec</code>或<code>ExecContext</code>方法。以这种方式执行的SQL语句包括<code>INSERT</code>, <code>DELETE</code>, 和<code>UPDATE</code>。</p>
<p>​	当你的查询可能返回行时，请改为使用<code>Query</code>或<code>QueryContext</code>方法。更多信息请参见 <a href="../QueryingForData">Querying a database （查询数据库）</a>。</p>
<p>​	<code>ExecContext</code>方法的工作原理与<code>Exec</code>方法相同，但有一个额外的<code>context.Context</code>参数，如 <a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations （取消正在进行的操作）</a> 中所述。</p>
<p>​	下面的例子中的代码使用<a href="https://pkg.go.dev/database/sql#DB.Exec" target="_blank" rel="noopener">DB.Exec</a>来执行一条语句，将一个新的记录专辑添加到一个<code>album</code>表中。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">AddAlbum</span>(<span style="color:#e06c75">alb</span> <span style="color:#e06c75">Album</span>) (<span style="color:#e5c07b">int64</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">result</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Exec</span>(<span style="color:#98c379">&#34;INSERT INTO album (title, artist) VALUES (?, ?)&#34;</span>, <span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Title</span>, <span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Artist</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;AddAlbum: %v&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Get the new album&#39;s generated ID for the client.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">id</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">result</span>.<span style="color:#61afef;font-weight:bold">LastInsertId</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#d19a66">0</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;AddAlbum: %v&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Return the new album&#39;s ID.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">id</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<code>DB.Exec</code>返回值：一个<a href="https://pkg.go.dev/database/sql#Result" target="_blank" rel="noopener">sql.Result</a>和一个错误。当错误为<code>nil</code>时，你可以使用<code>Result</code>来获得最后插入的项目的ID（如在例子中）或检索受操作影响的行数。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：预处理语句中的参数占位符根据你所使用的`DBMS`和驱动而不同。例如，`Postgres`的[pq driver](https://pkg.go.dev/github.com/lib/pq)需要一个类似于`$1`的占位符，而不是`?`.
</code></pre>
<p>​	如果你的代码将重复执行相同的SQL语句，考虑使用一个<code>sql.Stmt</code>来从SQL语句中创建一个可重复使用的预处理语句。更多信息请参见 <a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：不要使用字符串格式化函数，如`fmt.Sprintf`来组合一个SQL语句！ 你可能会引入一个[SQL注入的风险](https://go.dev/doc/database/sql-injection)。更多信息，请参见[Avoiding SQL injection risk（避免SQL注入风险）](../AvoidingSQLInjectionRisk)。
</code></pre>
<h4 id="functions-for-executing-sql-statements-that-dont-return-rows-用于执行不返回行的sql语句的函数">Functions for executing SQL statements that don’t return rows 用于执行不返回行的SQL语句的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description 描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.Exec</code> <code>DB.ExecContext</code></td>
<td>单独执行一条 SQL 语句。</td>
</tr>
<tr>
<td><code>Tx.Exec</code> <code>Tx.ExecContext</code></td>
<td>在较大的事务中执行 SQL 语句。有关详细信息，请参阅请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Stmt.Exec</code> <code>Stmt.ExecContext</code></td>
<td>执行一个预处理SQL语句。更多信息，请参见 <a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</td>
</tr>
<tr>
<td><code>Conn.ExecContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8dbd333e5db3daf03f3ae397f9564c2b">7.4 - 查询数据</h1>
    
	<h1 id="querying-for-data---查询数据">Querying for data - 查询数据</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/querying" target="_blank" rel="noopener">https://go.dev/doc/database/querying</a></p>
</blockquote>
<p>​	当执行一个返回数据的SQL语句时，使用<code>database/sql</code>包中提供的<code>Query</code>方法之一。每个方法都会返回一个行（<code>Row</code>）或多个行（<code>Rows</code>），你可以使用<code>Scan</code>方法将其数据复制到变量。你会使用这些方法，例如，执行<code>SELECT</code>语句。</p>
<p>​	当执行一个不返回数据的语句时，你可以改用<code>Exec</code>或<code>ExecContext</code>方法。更多信息请参见 <a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing statements that don’t return data（执行不返回数据的语句）</a>。</p>
<p>​	<code>database/sql</code>包提供了两种执行结果查询的方法：</p>
<ul>
<li><strong>查询单行</strong>  —— <code>QueryRow</code> 最多只能从数据库中返回一个单行。更多信息请参见 <a href="#querying-for-a-single-row">Querying for a single row （查询单行）</a>。</li>
<li>查询多行 —— <code>Query</code> 将所有匹配的行作为一个<code>Rows</code>结构体（你的代码可以循环遍历）返回，。更多信息，请参见 <a href="#querying-for-multiple-rows">Querying for multiple rows 查询多行</a>。</li>
</ul>
<p>​	如果你的代码将重复执行相同的SQL语句，请考虑使用预处理语句。更多信息，请参见 <a href="../UsingPreparedStatements">Using prepared statements （使用预处理语句）</a> 。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：不要使用字符串格式化函数，如`fmt.Sprintf`来组合一个SQL语句！你可能会引入一个SQL注入的风险。更多信息，请参见避免[SQL注入风险](https://go.dev/doc/database/sql-injection)。
</code></pre>
<h3 id="querying-for-a-single-row-查询单行">Querying for a single row 查询单行</h3>
<p>​	<code>QueryRow</code>最多只能检索一条数据库记录，例如当你想通过一个唯一的ID来查询数据。如果查询返回多条记录，<code>Scan</code>方法会丢弃除第一条以外的所有记录。</p>
<p>​	<code>QueryRowContext</code>的工作方式与<code>QueryRow</code>类似，但有一个<code>context.Context</code>实参。更多信息请参见 <a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations（取消正在进行的操作）</a>。</p>
<p>​	下面的例子使用一个查询来找出是否有足够的库存来支持购买。如果有足够的库存，该SQL语句返回<code>true</code>，如果没有则返回<code>false</code>。<a href="https://pkg.go.dev/database/sql#Row.Scan" target="_blank" rel="noopener">Row.Scan</a>通过一个指针将布尔型的返回值复制到<code>enough</code>变量中。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">canPurchase</span>(<span style="color:#e06c75">id</span> <span style="color:#e5c07b">int</span>, <span style="color:#e06c75">quantity</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e5c07b">bool</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">enough</span> <span style="color:#e5c07b">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Query for a value based on a single row.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">QueryRow</span>(<span style="color:#98c379">&#34;SELECT (quantity &gt;= ?) from album where id = ?&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">id</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">enough</span>); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">ErrNoRows</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;canPurchase %d: unknown album&#34;</span>, <span style="color:#e06c75">id</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span>, <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;canPurchase %d: %v&#34;</span>, <span style="color:#e06c75">id</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">enough</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意：准备预处理语句中的参数占位符根据你所使用的<code>DBMS</code>和驱动而不同。例如，<code>Postgres</code>的<a href="https://pkg.go.dev/github.com/lib/pq" target="_blank" rel="noopener">pq driver</a>需要一个类似于<code>$1</code>的占位符，而不是<code>?</code>。</p>
<h4 id="handling-errors-处理错误">Handling errors 处理错误</h4>
<p>​	<code>QueryRow</code>本身不返回错误。相反，<code>Scan</code>报告来自组合查询和扫描的任何错误。当查询没有找到记录时，它返回<a href="https://pkg.go.dev/database/sql#ErrNoRows" target="_blank" rel="noopener">sql.ErrNoRows</a>。</p>
<h4 id="functions-for-returning-a-single-row-用于返回单行的函数">Functions for returning a single row 用于返回单行的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description <strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.QueryRow</code> <code>DB.QueryRowContext</code></td>
<td>单独运行一个单行查询。</td>
</tr>
<tr>
<td><code>Tx.QueryRow</code> <code>Tx.QueryRowContext</code></td>
<td>在较大的事务中运行一个单行查询。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Stmt.QueryRow</code> <code>Stmt.QueryRowContext</code></td>
<td>使用预处理语句运行一个单行查询。更多信息，请参见 <a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</td>
</tr>
<tr>
<td><code>Conn.QueryRowContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>
<h3 id="querying-for-multiple-rows-查询多行">Querying for multiple rows 查询多行</h3>
<p>​	你可以使用<code>Query</code>或<code>QueryContext</code>查询多条记录，它们返回一个代表查询结果的<code>Rows</code>。你的代码使用<a href="https://pkg.go.dev/database/sql#Rows.Next" target="_blank" rel="noopener">Rows.Next</a>对返回的行进行迭代。每次迭代都会调用<code>Scan</code>来将列值复制到变量中。</p>
<p>​	<code>QueryContext</code>的工作方式与<code>Query</code>类似，但有一个<code>context.Context</code>实参。更多信息请参见 <a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations （取消正在进行的操作）</a>。</p>
<p>​	下面的例子执行了一个查询，返回指定艺术家的专辑。这些专辑被返回到一个<code>sql.Rows</code>中。该代码使用<a href="https://pkg.go.dev/database/sql#Rows.Scan" target="_blank" rel="noopener">Rows.Scan</a>将列值复制到由指针表示的变量中。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">albumsByArtist</span>(<span style="color:#e06c75">artist</span> <span style="color:#e5c07b">string</span>) ([]<span style="color:#e06c75">Album</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * FROM album WHERE artist = ?&#34;</span>, <span style="color:#e06c75">artist</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">nil</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// An album slice to hold data from returned rows.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">albums</span> []<span style="color:#e06c75">Album</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Loop through rows, using Scan to assign column data to struct fields.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Next</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">var</span> <span style="color:#e06c75">alb</span> <span style="color:#e06c75">Album</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">ID</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Title</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Artist</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Price</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">alb</span>.<span style="color:#e06c75">Quantity</span>); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">albums</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">albums</span> = <span style="color:#e5c07b">append</span>(<span style="color:#e06c75">albums</span>, <span style="color:#e06c75">album</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> = <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Err</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">albums</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">albums</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意对[rows.Close](https://pkg.go.dev/database/sql#Rows.Close)的延迟调用。无论函数如何返回，这都会释放rows所持有的任何资源。循环处理所有的行也会隐式地关闭它，但最好使用`defer`来确保无论如何都会关闭`rows`。
</code></pre>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：预处理语句中的参数占位符根据你所使用的`DBMS`和驱动而不同。例如，`Postgres`的[pq driver](https://pkg.go.dev/github.com/lib/pq)需要一个类似于`$1`的占位符，而不是`?`。
</code></pre>
<h4 id="handling-errors-处理错误-1">Handling errors 处理错误</h4>
<p>Be sure to check for an error from <code>sql.Rows</code> after looping over query results. If the query failed, this is how your code finds out.</p>
<p>​	在循环查询结果后，一定要从<code>sql.Rows</code>中检查是否有错误。如果查询失败了，代码就是这样查找的。</p>
<h4 id="functions-for-returning-multiple-rows-返回多行记录的函数">Functions for returning multiple rows 返回多行记录的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description 描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.Query</code> <code>DB.QueryContext</code></td>
<td>单独运行一个查询。</td>
</tr>
<tr>
<td><code>Tx.Query</code> <code>Tx.QueryContext</code></td>
<td>在较大的事务中运行一个查询。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Stmt.Query</code> <code>Stmt.QueryContext</code></td>
<td>使用预处理语句运行一个查询。更多信息，请参见<a href="../UsingPreparedStatements">Using prepared statements（使用预处理语句）</a>。</td>
</tr>
<tr>
<td><code>Conn.QueryContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>
<h3 id="handling-nullable-column-values-处理可为null的列值">Handling nullable column values 处理可为null的列值</h3>
<p>​	<code>database/sql</code>包提供了几种特殊的类型，当一个列的值可能为<code>null</code>时，你可以作为<code>Scan</code>函数的实参使用。每种类型都包括一个<code>Valid</code>字段，用于报告值是否为非<code>null</code>，如果是的话，还包括一个持有该值的字段。</p>
<p>​	下面的例子中的代码查询了一个客户名称。如果名字的值是<code>null</code>的，代码会替换另一个值在应用程序中使用。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">var</span> <span style="color:#e06c75">s</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">NullString</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">QueryRow</span>(<span style="color:#98c379">&#34;SELECT name FROM customer WHERE id = ?&#34;</span>, <span style="color:#e06c75">id</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">s</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Find customer name, using placeholder if not present.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">name</span> <span style="color:#56b6c2">:=</span> <span style="color:#98c379">&#34;Valued Customer&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">s</span>.<span style="color:#e06c75">Valid</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">name</span> = <span style="color:#e06c75">s</span>.<span style="color:#e06c75">String</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>sql</code>包参考资料中可以看到更多关于每种类型的信息：</p>
<ul>
<li><a href="https://pkg.go.dev/database/sql#NullBool" target="_blank" rel="noopener"><code>NullBool</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullFloat64" target="_blank" rel="noopener"><code>NullFloat64</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullInt32" target="_blank" rel="noopener"><code>NullInt32</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullInt64" target="_blank" rel="noopener"><code>NullInt64</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullString" target="_blank" rel="noopener"><code>NullString</code></a></li>
<li><a href="https://pkg.go.dev/database/sql#NullTime" target="_blank" rel="noopener"><code>NullTime</code></a></li>
</ul>
<h3 id="getting-data-from-columns-从列中获取数据">Getting data from columns 从列中获取数据</h3>
<p>​	在循环查询返回的行时，您可以使用<code>Scan</code>将行的列值复制到Go值，如<a href="https://pkg.go.dev/database/sql#Rows.Scan" target="_blank" rel="noopener">Rows.Scan</a>参考中所述。</p>
<p>​	所有驱动程序都支持一组基本的数据转换，例如将SQL <code>INT</code>转换为Go <code>int</code>。一些驱动程序扩展了这一转换集；详情请参见各个驱动程序的文档。</p>
<p>​	正如你所期望的，<code>Scan</code>将从列类型转换为类似的Go类型。例如，<code>Scan</code>将从SQL <code>CHAR</code>、<code>VARCHAR</code>和<code>TEXT</code>转换为Go <code>string</code>。但是，<code>Scan</code>也会执行转换为另一种适合列值的Go类型。例如，如果列是一个总是包含数字的<code>VARCHAR</code>，你可以指定一个数值Go类型，比如<code>int</code>，来接收这个值，<code>Scan</code>将使用<code>strconv.Atoi</code>对其进行转换。</p>
<p>​	关于<code>Scan</code>函数进行转换的更多细节，请参见<a href="https://pkg.go.dev/database/sql#Rows.Scan" target="_blank" rel="noopener">Rows.Scan</a>参考。</p>
<h3 id="handling-multiple-result-sets-处理多个结果集">Handling multiple result sets 处理多个结果集</h3>
<p>​	当你的数据库操作可能返回多个结果集时，你可以通过使用<a href="https://pkg.go.dev/database/sql#Rows.NextResultSet" target="_blank" rel="noopener">Rows.NextResultSet</a>来检索这些结果。这可能很有用，例如，当你发送分别查询多个表的 SQL 时，为每个表返回一个结果集。</p>
<p>​	<code>Rows.NextResultSet</code>准备好下一个结果集，以便调用<code>Rows.Next</code>检索下一个结果集的第一条记录。它返回一个布尔值，表明是否存在下一个结果集。</p>
<p>​	下面的例子中的代码使用<code>DB.Query</code>来执行两个SQL语句。第一个结果集来自过程中的第一个查询，检索<code>album</code>表中的所有记录。下一个结果集是来自于第二个查询，从<code>song</code>表中检索记录。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * from album; SELECT * from song;&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop through the first result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Next</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Advance to next result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">NextResultSet</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Loop through the second result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">for</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Next</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle second set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">// Check for any error in either result set.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Err</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c5858600d7babffd325d37bb0b207ba8">7.5 - 使用预处理语句</h1>
    
	<h1 id="using-prepared-statements---使用预处理语句">Using prepared statements - 使用预处理语句</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/prepared-statements" target="_blank" rel="noopener">https://go.dev/doc/database/prepared-statements</a></p>
</blockquote>
<p>​	你可以为重复使用定义一个预处理语句。这可以避免每次代码执行数据库操作时<code>重新创建语句的开销</code>，从而帮助代码更快地运行。</p>
<p>注意：预处理语句中的参数占位符根据你所使用的<code>DBMS</code>和驱动而不同。例如，<code>Postgres</code>的<a href="https://pkg.go.dev/github.com/lib/pq" target="_blank" rel="noopener">pq driver</a>需要一个像<code>$1</code>这样的占位符，而不是<code>?</code>。</p>
<h3 id="what-is-a-prepared-statement-什么是预处理语句">What is a prepared statement? 什么是预处理语句？</h3>
<p>​	预处理语句是由<code>DBMS</code>解析并保存的SQL，通常包含占位符，但没有实际参数值。之后，可以用一组参数值来执行该语句。</p>
<h3 id="how-you-use-prepared-statements-你如何使用预处理语句">How you use prepared statements 你如何使用预处理语句</h3>
<p>​	当你希望重复执行相同的SQL时，你可以使用一个<code>sql.Stmt</code>来提前准备SQL语句，然后根据需要执行它。</p>
<p>​	下面的例子创建了一个预处理语句，从数据库中选择一个特定的相册。<a href="https://pkg.go.dev/database/sql#DB.Prepare" target="_blank" rel="noopener">DB.Prepare</a>返回一个<code>sql.Stmt</code>，代表一个给定的SQL文本的预处理语句。你可以将SQL语句的参数传递给<code>Stmt.Exec</code>、<code>Stmt.QueryRow</code>或<code>Stmt.Query</code>来运行该语句。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// AlbumByID retrieves the specified album.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">AlbumByID</span>(<span style="color:#e06c75">id</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e06c75">Album</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Define a prepared statement. You&#39;d typically define the statement
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// elsewhere and save it for use in functions such as this one.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">stmt</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Prepare</span>(<span style="color:#98c379">&#34;SELECT * FROM album WHERE id = ?&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">album</span> <span style="color:#e06c75">Album</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Execute the prepared statement, passing in an id value for the
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// parameter whose placeholder is ?
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">stmt</span>.<span style="color:#61afef;font-weight:bold">QueryRow</span>(<span style="color:#e06c75">id</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">ID</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Title</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Artist</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Price</span>, <span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">album</span>.<span style="color:#e06c75">Quantity</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">ErrNoRows</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// Handle the case of no rows returned.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">album</span>, <span style="color:#e06c75">err</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">album</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="prepared-statement-behavior-预处理语句的行为">Prepared statement behavior 预处理语句的行为</h3>
<p>​	一个准备好的<a href="https://pkg.go.dev/database/sql#Stmt" target="_blank" rel="noopener">sql.Stmt</a>提供了常用的<code>Exec</code>、<code>QueryRow</code>和<code>Query</code>方法来调用其语句。关于使用这些方法的更多信息，请参阅<a href="../QueryingForData">Querying for data （查询数据）</a> 和 <a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing SQL statements that don’t return data（执行不返回数据的SQL语句）</a>。</p>
<p>​	然而，由于一个<code>sql.Stmt</code>已经代表了一个预设的SQL语句，它的<code>Exec</code>、<code>QueryRow</code>和<code>Query</code>方法只接受与占位符对应的SQL参数值，而忽略了SQL文本。</p>
<p>​	你可以用不同的方式定义一个新的<code>sql.Stmt</code>，这取决于你将如何使用它。</p>
<ul>
<li><code>DB.Prepare</code>和<code>DB.PrepareContext</code>创建了一个预处理语句，该语句可以在事务外单独执行，就像<code>DB.Exec</code>和<code>DB.Query</code>一样。</li>
<li><code>Tx.Prepare</code>、<code>Tx.PrepareContext</code>、<code>Tx.Stmt</code>和<code>Tx.StmtContext</code>创建一个预处理语句，以便在一个特定的事务中使用。<code>Prepare</code>和<code>PrepareContext</code>使用SQL文本来定义语句。<code>Stmt</code>和<code>StmtContext</code>使用<code>DB.Prepare</code>或<code>DB.PrepareContext</code>的结果。也就是说，它们将一个非事务用的<code>sql.Stmt</code>转换为这个事务用的<code>sql.Stmt</code>。</li>
<li><code>Conn.PrepareContext</code>从一个代表保留连接的<code>sql.Conn</code>创建一个预处理语句。</li>
</ul>
<p>​	一定要记住，在代码使用语句完成时，调用<code>stmt.Close</code>。这将释放任何可能与之相关的数据库资源（如底层连接）。对于只是一个函数中的局部变量的语句，<code>defer stmt.Close()</code>就足够了。</p>
<h4 id="functions-for-creating-a-prepared-statement-创建预处理语句的函数">Functions for creating a prepared statement 创建预处理语句的函数</h4>
<table>
<thead>
<tr>
<th>Function 函数</th>
<th>Description 描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB.Prepare</code> <code>DB.PrepareContext</code></td>
<td>准备独立执行的语句，或者使用 <code>Tx.Stmt</code> 将其转换为事务内准备的语句。</td>
</tr>
<tr>
<td><code>Tx.Prepare</code> <code>Tx.PrepareContext</code> <code>Tx.Stmt</code> <code>Tx.StmtContext</code></td>
<td>准备一个在特定事务中使用的语句。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</td>
</tr>
<tr>
<td><code>Conn.PrepareContext</code></td>
<td>用于保留连接。更多信息，请参见<a href="../ManagingConnections">Managing connections（ 管理连接）</a>。</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-290927c232ccde52de6f12a80617f3a8">7.6 - 执行事务</h1>
    
	<h1 id="executing-transactions---执行事务">Executing transactions - 执行事务</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/execute-transactions" target="_blank" rel="noopener">https://go.dev/doc/database/execute-transactions</a></p>
</blockquote>
<p>​	你可以使用表示事务的<a href="https://pkg.go.dev/database/sql#Tx" target="_blank" rel="noopener">sql.Tx</a>来执行数据库事务。除了表示特定于事务语义的<code>Commit</code>和<code>Rollback</code>方法之外，<code>sql.Tx</code>还有所有用来执行普通数据库操作的方法。要获取<code>sql.Tx</code>，可以调用<code>DB.Begin</code>或<code>DB.BeginTx</code>。</p>
<p>​	一个<a href="https://en.wikipedia.org/wiki/Database_transaction" target="_blank" rel="noopener">数据库事务</a>将多个操作作为更大目标的一部分进行分组。所有的操作都必须成功，或者都不能成功，在这两种情况下都要保持数据的完整性。通常，一个事务的工作流程包括：</p>
<ol>
<li>开始事务。</li>
<li>执行一系列的数据库操作。</li>
<li>如果没有发生错误，提交事务以进行数据库更改。</li>
<li>如果发生错误，回滚事务使数据库保持不变。</li>
</ol>
<p>​	<code>sql</code>包提供了开始和结束事务的方法，以及执行中间的数据库操作的方法。这些方法与上述工作流程中的四个步骤相对应。</p>
<ul>
<li>
<p>开始一个事务</p>
<p><a href="https://pkg.go.dev/database/sql#DB.Begin" target="_blank" rel="noopener">DB.Begin</a>或<a href="https://pkg.go.dev/database/sql#DB.BeginTx" target="_blank" rel="noopener">DB.BeginTx</a>开始一个新的数据库事务，返回一个代表它的<code>sql.Tx</code>。</p>
</li>
<li>
<p>执行数据库操作。</p>
<p>使用一个<code>sql.Tx</code>，你可以在一系列使用单一连接的操作中查询或更新数据库。为了支持这一点，<code>Tx</code>导出了以下方法：</p>
<ul>
<li>
<p><a href="https://pkg.go.dev/database/sql#Tx.Exec" target="_blank" rel="noopener">Exec</a> 和 <a href="https://pkg.go.dev/database/sql#Tx.ExecContext" target="_blank" rel="noopener">ExecContext</a> ，用于通过SQL语句（如<code>INSERT</code>、<code>UPDATE</code>和<code>DELETE</code>）进行数据库更改。</p>
<p>更多信息请参见<a href="../ExecutingSQLStatementsThatDoNotReturnData">Executing statements that don’t return data（执行不返回数据的语句）</a>。</p>
</li>
<li>
<p><a href="https://pkg.go.dev/database/sql#Tx.Query" target="_blank" rel="noopener">Query</a>，<a href="https://pkg.go.dev/database/sql#Tx.QueryContext" target="_blank" rel="noopener">QueryContext</a>，<a href="https://pkg.go.dev/database/sql#Tx.QueryRow" target="_blank" rel="noopener">QueryRow</a> ，<a href="https://pkg.go.dev/database/sql#Tx.QueryRowContext" target="_blank" rel="noopener">QueryRowContext</a> 用于返回行的操作。</p>
<p>更多信息，请参见 <a href="../QueryingForData">Querying for data （查询数据）</a>。</p>
</li>
<li>
<p><a href="https://pkg.go.dev/database/sql#Tx.Prepare" target="_blank" rel="noopener">Prepare</a>，<a href="https://pkg.go.dev/database/sql#Tx.PrepareContext" target="_blank" rel="noopener">PrepareContext</a>，<a href="https://pkg.go.dev/database/sql#Tx.Stmt" target="_blank" rel="noopener">Stmt</a>，<a href="https://pkg.go.dev/database/sql#Tx.StmtContext" target="_blank" rel="noopener">StmtContext</a>用于预先定义预处理语句。</p>
<p>更多信息，请参见<a href="../UsingPreparedStatements">Using prepared statements （使用预处理语句）</a>。</p>
</li>
</ul>
</li>
<li>
<p>用以下方法之一结束事务：</p>
<ul>
<li>
<p>使用<a href="https://pkg.go.dev/database/sql#Tx.Commit" target="_blank" rel="noopener">Tx.Commit</a>提交事务。</p>
<p>如果<code>Commit</code>成功（返回<code>nil</code>错误），那么所有的查询结果都被确认为有效，所有执行的更新都作为一个单一的原子变化应用到数据库中。如果<code>Commit</code>失败，那么<code>Tx</code>上的所有<code>Query</code>和<code>Exec</code>的结果都应该被视为无效而丢弃。</p>
</li>
<li>
<p>使用<a href="https://pkg.go.dev/database/sql#Tx.Rollback" target="_blank" rel="noopener">Tx.Rollback</a>来回滚事务。</p>
<p>即使<code>Tx.Rollback</code>失败，该事务也不再有效，也不会被提交到数据库。</p>
</li>
</ul>
</li>
</ul>
<h3 id="best-practices-最佳实践">Best practices 最佳实践</h3>
<p>​	遵循下面的最佳实践，可以更好地了解事务有时需要的复杂语义和连接管理。</p>
<ul>
<li>使用本节中描述的API来管理事务。<strong>不要直接使用与事务相关的SQL语句</strong>，如<code>BEGIN</code>和<code>COMMIT</code>——这样做会使你的数据库处于不可预测的状态，尤其是在并发程序中。</li>
<li>当使用事务时，注意<strong>不要直接调用非事务的</strong><code>sql.DB</code>方法，因为这些方法会在事务之外执行，将会给你的代码提供一个不一致的数据库状态，甚至导致<strong>死锁</strong>。</li>
</ul>
<h3 id="example-例子">Example 例子</h3>
<p>​	下面的例子中的代码使用一个事务来创建新专辑的客户订单。在这一过程中，代码将：</p>
<ol>
<li>开始一个事务。</li>
<li>延迟该事务的回滚。如果事务成功，它将在函数退出前被提交，使延迟的回滚调用成为no-op。如果事务失败，它将不会被提交，这意味着回滚将在函数退出时被调用。</li>
<li>确认客户订购的专辑有足够的库存。</li>
<li>如果有足够的存货，更新存货数量，用订购的专辑数量来减少它。</li>
<li>创建一个新的订单，并为客户检索新订单的生成ID。</li>
<li>提交事务并返回ID。</li>
</ol>
<p>​	这个例子使用了<code>Tx</code>方法，这些方法需要一个<code>context.Context</code>实参。这使得函数的执行——包括数据库操作——在其运行时间过长或客户端连接关闭的情况下有可能被取消。更多信息请参见<a href="../CancelingIn-progressDatabaseOperations">Canceling in-progress operations（取消正在进行的操作）</a>。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// CreateOrder creates an order for an album and returns the new order ID. =&gt; CreateOrder 为 album 创建一个订单，并返回新的订单 ID。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">CreateOrder</span>(<span style="color:#e06c75">ctx</span> <span style="color:#e06c75">context</span>.<span style="color:#e06c75">Context</span>, <span style="color:#e06c75">albumID</span>, <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">custID</span> <span style="color:#e5c07b">int</span>) (<span style="color:#e06c75">orderID</span> <span style="color:#e5c07b">int64</span>, <span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Create a helper function for preparing failure results.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">fail</span> <span style="color:#56b6c2">:=</span> <span style="color:#c678dd">func</span>(<span style="color:#e06c75">err</span> <span style="color:#e5c07b">error</span>) (<span style="color:#e5c07b">int64</span>, <span style="color:#e5c07b">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;CreateOrder: %v&#34;</span>, <span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Get a Tx for making transaction requests.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">tx</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">BeginTx</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#e5c07b">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Defer a rollback in case anything fails.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">Rollback</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Confirm that album inventory is enough for the order. =&gt; 确认专辑有足够的库存。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">var</span> <span style="color:#e06c75">enough</span> <span style="color:#e5c07b">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> = <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">QueryRowContext</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#98c379">&#34;SELECT (quantity &gt;= ?) from album where id = ?&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">albumID</span>).<span style="color:#61afef;font-weight:bold">Scan</span>(<span style="color:#56b6c2">&amp;</span><span style="color:#e06c75">enough</span>); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">sql</span>.<span style="color:#e06c75">ErrNoRows</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;no such album&#34;</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> !<span style="color:#e06c75">enough</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Errorf</span>(<span style="color:#98c379">&#34;not enough inventory&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Update the album inventory to remove the quantity in the order.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">_</span>, <span style="color:#e06c75">err</span> = <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">ExecContext</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#98c379">&#34;UPDATE album SET quantity = quantity - ? WHERE id = ?&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">albumID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Create a new row in the album_order table.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">result</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">ExecContext</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#98c379">&#34;INSERT INTO album_order (album_id, cust_id, quantity, date) VALUES (?, ?, ?, ?)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">albumID</span>, <span style="color:#e06c75">custID</span>, <span style="color:#e06c75">quantity</span>, <span style="color:#e06c75">time</span>.<span style="color:#61afef;font-weight:bold">Now</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Get the ID of the order item just created.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">orderID</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">result</span>.<span style="color:#61afef;font-weight:bold">LastInsertId</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Commit the transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> = <span style="color:#e06c75">tx</span>.<span style="color:#61afef;font-weight:bold">Commit</span>(); <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#61afef;font-weight:bold">fail</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Return the order ID.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">orderID</span>, <span style="color:#e5c07b">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4784cd31c145b2e3eaed935268e74931">7.7 - 取消正在进行的操作</h1>
    
	<h1 id="canceling-in-progress-operations---取消正在进行的操作">Canceling in-progress operations - 取消正在进行的操作</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/cancel-operations" target="_blank" rel="noopener">https://go.dev/doc/database/cancel-operations</a></p>
</blockquote>
<p>​	你可以通过使用Go <a href="https://pkg.go.dev/context#Context" target="_blank" rel="noopener">context.Context</a>来管理正在进行的操作。<code>Context</code>是一个标准的Go数据值，可以报告它所表示的整体操作是否已经被取消，是否不再需要。通过在应用程序中的函数调用和服务中传递<code>context.Context</code>，这些（函数调用和服务）可以提前停止工作，并在不再需要其处理时返回一个错误。关于<code>Context</code>的更多信息，请参阅 <a href="../../../GoBlog/2014/GoConcurrencyPatternsContext">Go并发模式：Context</a>。</p>
<p>例如，你可能想：</p>
<ul>
<li>结束长期运行的操作，包括需要太长时间才能完成的数据库操作。</li>
<li>传播来自其他地方的取消请求，例如当客户端关闭连接时。</li>
</ul>
<p>​	许多为Go开发者提供的API都包含接受<code>Context</code>实参的方法，这使得在整个应用程序中更容易使用<code>Context</code>。</p>
<h3 id="canceling-database-operations-after-a-timeout-在超时后取消数据库操作">Canceling database operations after a timeout 在超时后取消数据库操作</h3>
<p>​	你可以使用 <code>Context</code> 来设置一个超时或最后期限，超时后的操作将被取消。要派生一个带有超时或最后期限的<code>Context</code>，请调用<a href="https://pkg.go.dev/context#WithTimeout" target="_blank" rel="noopener">context.WithTimeout</a>或<a href="https://pkg.go.dev/context#WithDeadline" target="_blank" rel="noopener">context.WithDeadline</a>。</p>
<p>​	下面的超时例子中的代码派生了一个Context，并将其传递给<code>sql.DB</code> <a href="https://pkg.go.dev/database/sql#DB.QueryContext" target="_blank" rel="noopener">QueryContext</a>方法。</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">QueryWithTimeout</span>(<span style="color:#e06c75">ctx</span> <span style="color:#e06c75">context</span>.<span style="color:#e06c75">Context</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Create a Context with a timeout.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">queryCtx</span>, <span style="color:#e06c75">cancel</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">context</span>.<span style="color:#61afef;font-weight:bold">WithTimeout</span>(<span style="color:#e06c75">ctx</span>, <span style="color:#d19a66">5</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">time</span>.<span style="color:#e06c75">Second</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#61afef;font-weight:bold">cancel</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Pass the timeout Context with a query.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">QueryContext</span>(<span style="color:#e06c75">queryCtx</span>, <span style="color:#98c379">&#34;SELECT * FROM album&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#e06c75">err</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">defer</span> <span style="color:#e06c75">rows</span>.<span style="color:#61afef;font-weight:bold">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle returned rows.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	当一个上下文派生自一个外部上下文时，就像本例中<code>queryCtx</code>派生自<code>ctx</code>一样，如果外部上下文被取消，那么派生的上下文也会被自动取消。例如，在HTTP服务器中，<code>http.Request.Context</code>方法返回一个与请求相关的上下文。如果HTTP客户端断开连接或取消HTTP请求（在HTTP/2中可能），则该上下文就会被取消。将HTTP请求的上下文传递给上面的<code>QueryWithTimeout</code>会导致数据库查询提前停止，如果整个HTTP请求被取消或者查询时间超过5秒的话。</p>
<p>!!! warning &ldquo;注意&rdquo;</p>
<pre><code>注意：当你创建一个有超时或截止日期的新`Context`时，（一定记得）始终推迟对`cancel`函数的调用。这将在外层函数退出时释放新`Context`所持有的资源。它也会取消`queryCtx`，但是当函数返回时，就不会再有任何东西使用 `queryCtx` 了。
</code></pre>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b543af54c119472b0081204612c8645a">7.8 - 管理连接</h1>
    
	<h1 id="managing-connections---管理连接">Managing connections - 管理连接</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/manage-connections" target="_blank" rel="noopener">https://go.dev/doc/database/manage-connections</a></p>
</blockquote>
<p>​	对于绝大多数程序，你不需要调整<code>sql.DB</code>连接池的默认值。但是对于一些高级程序，你可能需要优化连接池的参数或者显式地处理连接。本主题解释了如何做。</p>
<p>​	<a href="https://pkg.go.dev/database/sql#DB" target="_blank" rel="noopener">sql.DB</a>数据库句柄对于多个goroutine的并发使用是安全的（意味着该句柄是其他语言可能称之为 &ldquo;<code>线程安全（thread-safe）</code> &ldquo;的）。其他一些数据库访问库是基于一次只能用于一个操作的连接。为了弥合这一差距，每个<code>sql.DB</code>都管理着一个与底层数据库的活动连接池，根据你 Go 程序的并行性需要创建新连接池。</p>
<p>​	连接池适用于大多数数据访问需求。当你调用一个<code>sql.DB</code>的<code>Query</code>或<code>Exec</code>方法时，<code>sql.DB</code>实现从池中检索一个可用的连接，或者在需要时创建一个连接。当不再需要连接时，包会将其返回到池中。这支持了数据库访问的高度并行性。</p>
<h3 id="setting-connection-pool-properties-设置连接池属性">Setting connection pool properties 设置连接池属性</h3>
<p>​	你可以设置属性来指导<code>sql</code>包如何管理连接池。要获得关于这些属性的效果的统计信息，请使用<a href="https://pkg.go.dev/database/sql#DB.Stats" target="_blank" rel="noopener">DB.Stats</a>。</p>
<h4 id="setting-the-maximum-number-of-open-connections-设置开放连接的最大数量">Setting the maximum number of open connections 设置开放连接的最大数量</h4>
<p>​	<a href="https://pkg.go.dev/database/sql#DB.SetMaxOpenConns" target="_blank" rel="noopener">DB.SetMaxOpenConns</a>对开放连接的数量进行了限制。超过这个限制，新的数据库操作将等待一个现有的操作完成，这时<code>sql.DB</code>将创建另一个连接。默认情况下，当需要一个连接的时候，<code>sql.DB</code>会在所有现有的连接都处于使用状态时创建一个新的连接。</p>
<p>​	请记住，设置限制使得数据库的使用类似于获取一个锁或信号，其结果是你的应用程序可能会在等待新的数据库连接时发生死锁（deadlock ）。</p>
<h4 id="setting-the-maximum-number-of-idle-connections-设置空闲连接的最大数量">Setting the maximum number of idle connections 设置空闲连接的最大数量</h4>
<p>​	<a href="https://pkg.go.dev/database/sql#DB.SetMaxIdleConns" target="_blank" rel="noopener">DB.SetMaxIdleConns</a>更改<code>sql.DB</code>维护的最大空闲连接数的限制。</p>
<p>​	当一个SQL操作在一个给定的数据库连接上完成后，它通常不会立即关闭：应用程序可能很快就会再次需要一个连接，保持开放的连接可以避免在下一个操作中重新连接到数据库。默认情况下，<code>sql.DB</code>在任何时候都保持两个空闲连接。提高这个限制可以避免在有大量并行性的程序中频繁的重新连接。</p>
<h4 id="setting-the-maximum-amount-a-time-a-connection-can-be-idle-设置一个连接可以空闲的最大时间量">Setting the maximum amount a time a connection can be idle 设置一个连接可以空闲的最大时间量</h4>
<p>​	<a href="https://pkg.go.dev/database/sql#DB.SetConnMaxIdleTime" target="_blank" rel="noopener">DB.SetConnMaxIdleTime</a>设置了一个连接在被关闭之前可以空闲的最大时间。这将导致<code>sql.DB</code>关闭那些空闲时间超过给定时间的连接。</p>
<p>​	默认情况下，当将空闲连接添加到连接池时，它将一直保持在那里，直到再次需要它为止。当使用<code>DB.SetMaxIdleConns</code>来增加并行活动爆发期间允许的空闲连接数时，也可以使用<code>DB.SetConnMaxIdleTime</code>安排在系统安静时释放这些连接。</p>
<h4 id="setting-the-maximum-lifetime-of-connections-设置连接的最大生存期">Setting the maximum lifetime of connections 设置连接的最大生存期</h4>
<p>​	使用<a href="https://pkg.go.dev/database/sql#DB.SetConnMaxLifetime" target="_blank" rel="noopener">DB.SetConnMaxLifetime</a>可以设置一个连接在被关闭之前可以保持开放的最大时间长度。</p>
<p>​	默认情况下，一个连接可以在任意长的时间内被使用和重复使用，但要遵守上述的限制。在一些系统中，比如那些使用负载平衡的数据库服务器的系统，确保应用程序在不重新连接的情况下不会使用某个特定的连接太久是很有帮助的。</p>
<h3 id="using-dedicated-connections-使用专用连接">Using dedicated connections 使用专用连接</h3>
<p>​	<code>database/sql</code>包包含一些函数，当数据库可能为在特定连接上执行的操作序列赋予隐式含义时，你可以使用这些函数。</p>
<p>​	最常见的例子是事务，它通常以<code>BEGIN</code>命令开始，以<code>COMMIT</code>或<code>ROLLBACK</code>命令结束，并在整个事务中包括这些命令之间的连接上发出的所有命令。对于这种使用情况，请使用<code>sql</code>包的事务支持。参见 在较大的事务中运行一个查询。更多信息，请参阅<a href="../ExecutingTransactions">Executing transactions （执行事务）</a> 。</p>
<p>​	对于其他必须在同一连接上执行一系列单独操作的使用情况，<code>sql</code>包提供了专用连接。<a href="https://pkg.go.dev/database/sql#DB.Conn" target="_blank" rel="noopener">DB.Conn</a>获得一个专用连接，即<a href="https://pkg.go.dev/database/sql#Conn" target="_blank" rel="noopener">sql.Conn</a>。<code>sql.Conn</code>有<code>BeginTx</code>、<code>ExecContext</code>、<code>PingContext</code>、<code>PrepareContext</code>、<code>QueryContext</code>和<code>QueryRowContext</code>等方法，这些方法的行为与DB上的同类方法类似，但只使用专用连接。当完成专用连接后，你的代码必须使用<code>Conn.Close</code>释放它。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96f2d73f83fdbd82143ebeae2e86894d">7.9 - 避免SQL注入风险</h1>
    
	<h1 id="avoiding-sql-injection-risk---避免sql注入风险">Avoiding SQL injection risk - 避免SQL注入风险</h1>
<blockquote>
<p>原文：<a href="https://go.dev/doc/database/sql-injection" target="_blank" rel="noopener">https://go.dev/doc/database/sql-injection</a></p>
</blockquote>
<p>​	你可以通过提供SQL参数值作为<code>sql</code>包的函数实参来避免SQL注入风险。<code>sql</code>包中的许多函数为SQL语句和用于该语句的参数值提供了参数（其他函数为预处理语句和参数提供一个参数）。</p>
<p>​	下面的例子中的代码使用<code>?</code> 符号作为<code>id</code>参数的占位符，该参数是作为函数实参提供的：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// Correct format for executing an SQL statement with parameters. =&gt; 执行带参数的SQL语句的正确格式。
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#98c379">&#34;SELECT * FROM user WHERE id = ?&#34;</span>, <span style="color:#e06c75">id</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	执行数据库操作的<code>sql</code>包函数从你提供的实参中创建预处理语句。在运行时，<code>sql</code>包将SQL语句变成一个预处理语句，并将其与独立的参数一起发送。</p>
<p>注意：参数占位符因你所使用的<code>DBMS</code>和驱动而不同。例如，<code>Postgres</code>的<a href="https://pkg.go.dev/github.com/lib/pq" target="_blank" rel="noopener">pq driver</a>接受<code>$1</code>这样的占位符形式，而不是 <code>?</code>。</p>
<p>​	你可能会想使用<code>fmt</code>包中的一个函数来把SQL语句组合成一个包含参数的字符串——比如这样：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#7f848e">// SECURITY RISK! =&gt; 安全风险!
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">rows</span>, <span style="color:#e06c75">err</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">db</span>.<span style="color:#61afef;font-weight:bold">Query</span>(<span style="color:#e06c75">fmt</span>.<span style="color:#61afef;font-weight:bold">Sprintf</span>(<span style="color:#98c379">&#34;SELECT * FROM user WHERE id = %s&#34;</span>, <span style="color:#e06c75">id</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<strong>这是不安全的!</strong> 当你这样做时，Go会组装整个SQL语句，用参数值替换<code>%s</code>格式的动词，然后再将完整的语句发送给DBMS。<strong>这会带来<a href="https://en.wikipedia.org/wiki/SQL_injection" target="_blank" rel="noopener">SQL注入</a>的风险</strong>，因为代码的调用者可能会发送一个意外的SQL代码片段作为<code>id</code>参数。该代码片段可能以不可预测的方式完成SQL语句，对你的应用程序造成危险。</p>
<p>​	例如，通过传递某个<code>%s</code>值，你可能会得到如下语句，这可能会返回你数据库中的所有用户记录：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#c678dd">SELECT</span> <span style="color:#56b6c2">*</span> <span style="color:#c678dd">FROM</span> <span style="color:#c678dd">user</span> <span style="color:#c678dd">WHERE</span> <span style="color:#e06c75">id</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span> <span style="color:#c678dd">OR</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">1</span>;
</span></span></code></pre></td></tr></table>
</div>
</div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ae4ef6beba2d885dff11c2a3a8afa065">8 - 诊断</h1>
    
	<h1 id="diagnostics-诊断">Diagnostics 诊断</h1>
<blockquote>
<p>原文：https://go.dev/doc/diagnostics</p>
</blockquote>
<h2 id="简介">简介</h2>
<p>​	Go 生态系统提供了大量的 API 和工具来诊断 Go 程序中的逻辑和性能问题。本页总结了可用的工具，并帮助Go用户为他们的具体问题选择合适的工具。</p>
<p>​	诊断解决方案可以分为以下几类：</p>
<ul>
<li><strong>Profiling（分析）</strong>：分析工具分析Go程序的复杂性和成本，如内存的使用和经常调用的函数，以识别 Go 程序中的昂贵部分。</li>
<li><strong>Tracing（跟踪）</strong>：跟踪是一种对代码进行检测的方法，以分析调用或用户请求的整个生命周期中的延迟情况。跟踪提供了一个概览，显示每个组件对系统中的整体延迟的贡献程度。跟踪可以横跨多个Go进程。</li>
<li><strong>Debugging（调试）</strong>：调试允许我们暂停Go程序并检查其执行情况。程序的状态和流程可以通过调试得到验证。</li>
<li><strong>Runtime statistics and events（运行时统计和事件）</strong>：运行时统计和事件的收集和分析提供了对 Go 程序健康状况的高级概述。度量指标的波动有助于我们识别吞吐量、利用率和性能的变化。</li>
</ul>
<p>!!! warning &ldquo;注意&rdquo;
注意：某些诊断工具可能会相互干扰。例如，精确的内存分析会使CPU分析出现偏差，而goroutine阻塞分析会影响调度器跟踪。单独使用工具来获取更精确的信息.</p>
<h2 id="profiling-分析">Profiling 分析</h2>
<p>​	分析对于识别昂贵或经常调用的代码段非常有用。Go 运行时以<a href="https://github.com/google/pprof/blob/master/doc/README.md" target="_blank" rel="noopener"> pprof 可视化工具</a>所需的格式提供<a href="../../StdLib/runtime/pprof"> 分析数据</a>。分析数据可以在测试期间通过<code>go test</code>或从<a href="../../StdLib/net/http_pprof/"> net/http/pprof</a> 包中提供的端点收集。用户需要收集分析数据，并使用 pprof 工具来筛选和可视化顶级代码路径.</p>
<p>​	<a href="../../StdLib/runtime/pprof">runtime/pprof</a>包提供的预定义配置文件（profiles）：</p>
<ul>
<li><strong>cpu</strong>: CPU 配置文件(profile)确定程序在主动消耗 CPU 周期时花费时间的位置（而不是在睡眠或等待 I/O 时）.</li>
<li><strong>heap</strong>: 堆配置文件报告内存分配样本；用于监视当前和历史内存使用情况，并检查内存泄漏.</li>
<li><strong>threadcreate</strong>: 线程创建配置文件报告导致创建新操作系统线程的程序部分.</li>
<li><strong>goroutine</strong>: Goroutine配置文件报告所有当前 goroutine 的栈跟踪.</li>
<li><strong>block</strong>: Block配置文件显示 goroutine 阻塞等待同步原语（包括计时器通道）的位置。默认情况下不启用阻塞配置文件；使用<code>runtime.SetBlockProfileRate</code>启用它.</li>
<li><strong>mutex</strong>: Mutex 配置文件报告锁的争夺情况。当您认为您的 CPU 由于mutex争夺而未充分利用时，请使用此配置文件。Mutex 配置文件默认未启用，请参阅 <code>runtime.SetMutexProfileFraction</code>启用它。</li>
</ul>
<p><strong>我可以使用哪些其他分析器来分析 Go 程序?</strong></p>
<p>​	在Linux上，可以使用<a href="https://perf.wiki.kernel.org/index.php/Tutorial" target="_blank" rel="noopener">perf工具</a>来对Go程序进行分析。<code>perf</code> 可以分析和展开 <code>cgo/SWIG</code> 代码和内核，因此有助于深入了解本机/内核性能瓶颈。在 macOS 上， <a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/" target="_blank" rel="noopener">Instruments</a> 套件可用于分析 Go 程序.</p>
<p><strong>我可以分析我的生产环境的服务吗</strong>？</p>
<p>​	是的。在生产环境中分析程序是安全的，但是启用某些profile（例如 CPU profile）会增加成本。您应该会看到性能下降。性能损失可以通过在生产中打开分析器之前测量分析器的开销来估计。</p>
<p>​	您可能希望定期分析您的生产环境的服务。特别是在具有单个进程的多个副本的系统中，定期选择随机副本是一个安全的选择。选择一个生产过程，每 Y 秒对其进行 X 秒分析，并保存结果以供可视化和分析；然后定期重复。可以手动和/或自动检查结果以发现问题。profile的收集可能会相互干扰，因此建议一次只收集一个profile。</p>
<p><strong>可视化分析数据的最佳方法是什么</strong>？</p>
<p>​	Go 工具使用 <code>go tool pprof</code>提供profile数据的文本、图形和<a href="http://valgrind.org/docs/manual/cl-manual.html" target="_blank" rel="noopener">callgrind</a>可视化。阅读 <a href="../../GoBlog/2011/ProfilingGoPrograms">分析 Go 程序</a>以查看其运行情况。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/Diagnostics_img/pprof-text.png"
     alt="img"
     
/>





以文本形式列出最昂贵的调用。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/Diagnostics_img/pprof-dot.png"
     alt="img"
     
/>





将最昂贵的调用可视化为图表。</p>
<p>Weblist 视图在 HTML 页面中逐行显示源代码的昂贵部分。在下面的示例中，在<code>runtime.concatstrings</code>中花费了 530 毫秒，每行的成本显示在列表中。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/Diagnostics_img/pprof-weblist.png"
     alt="img"
     
/>





将最昂贵的调用可视化为weblist.</p>
<p>​	可视化分析数据的另一种方法是<a href="http://www.brendangregg.com/flamegraphs.html" target="_blank" rel="noopener">flame graph（火焰图）</a>。火焰图允许您在特定的祖先路径中移动，因此您可以放大/缩小代码的特定部分。<a href="https://github.com/google/pprof" target="_blank" rel="noopener">上游 pprof</a> 支持火焰图.</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/Diagnostics_img/flame.png"
     alt="img"
     
/>





火焰图提供可视化来发现最昂贵的代码路径.</p>
<p><strong>我是否仅限于内置profiles</strong>？</p>
<p>​	除了运行时提供的内容之外，Go 用户还可以通过<a href="https://go.dev/pkg/runtime/pprof/#Profile" target="_blank" rel="noopener">pprof.Profile</a>创建他们的自定义profiles， 并使用现有工具来检查它们。</p>
<p><strong>我可以在不同的路径和端口上提供分析器处理程序 (/debug/pprof/&hellip;) 吗</strong>？</p>
<p>​	是的。默认情况下，<code>net/http/pprof</code>包将其处理程序注册到默认多路复用器（mux），但您也可以使用从包中导出的处理程序自行注册它们.</p>
<p>​	例如，以下示例将在 <code>/custom_debug_path/profile</code> 的 <code>:7777</code> 上为 pprof.Profile 处理程序提供服务：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#c678dd">package</span> <span style="color:#e06c75">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#98c379">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#98c379">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#98c379">&#34;net/http/pprof&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">func</span> <span style="color:#61afef;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">mux</span> <span style="color:#56b6c2">:=</span> <span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">NewServeMux</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">mux</span>.<span style="color:#61afef;font-weight:bold">HandleFunc</span>(<span style="color:#98c379">&#34;/custom_debug_path/profile&#34;</span>, <span style="color:#e06c75">pprof</span>.<span style="color:#e06c75">Profile</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#e06c75">log</span>.<span style="color:#61afef;font-weight:bold">Fatal</span>(<span style="color:#e06c75">http</span>.<span style="color:#61afef;font-weight:bold">ListenAndServe</span>(<span style="color:#98c379">&#34;:7777&#34;</span>, <span style="color:#e06c75">mux</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="tracing-跟踪">Tracing 跟踪</h2>
<p>​	跟踪是对代码进行检测的一种方式，以分析一连串调用的整个生命周期的延迟。Go 提供 <a href="https://godoc.org/golang.org/x/net/trace" target="_blank" rel="noopener">golang.org/x/net/trace</a> 包，作为每个 Go 节点的最小跟踪后端，并提供一个带有简单仪表盘的最小检测库。Go还提供了一个执行跟踪器来跟踪一个时间间隔内的运行时事件。</p>
<p>​	跟踪使我们能够：</p>
<ul>
<li>检测和分析Go进程中的应用延迟。</li>
<li>测量一长串调用中特定调用的成本。</li>
<li>弄清利用率和性能改进情况。如果没有跟踪数据，瓶颈并不总是那么明显。</li>
</ul>
<p>​	在单体系统中，从程序的构建块中收集诊断数据相对容易。所有模块都存在于一个进程中，并分享共同的资源来报告日志、错误和其他诊断信息。一旦你的系统超过了单一的进程，并开始成为分布式的，就很难跟踪从前端Web服务器到所有后端的调用，直到响应被返回给用户。这就是分布式跟踪在检测和分析你的生产系统方面发挥了很大作用。</p>
<p>​	分布式跟踪是一种对代码进行检测的方法，以分析用户请求的整个生命周期的延迟。当一个系统是分布式的，并且传统的分析和调试工具无法扩展时，您可能希望使用分布式跟踪工具来分析用户请求和 RPC 的性能。</p>
<p>​	分布式跟踪使我们能够：</p>
<ul>
<li>在一个大型系统中检测和分析应用程序的延迟。</li>
<li>在用户请求的生命周期内跟踪所有的RPC，并查看仅在生产环境中可见的集成问题。</li>
<li>找出可以应用于我们系统的性能改进。在收集跟踪数据之前，许多瓶颈是不明显的。</li>
</ul>
<p>​	Go生态系统为每个跟踪系统提供了各种分布式跟踪库，以及与后台无关的跟踪库。</p>
<p><strong>有没有一种方法可以自动拦截每个函数调用并创建跟踪？</strong></p>
<p>​	Go并没有提供自动拦截每个函数调用并创建跟踪跨度的方法。您需要手动检测您的代码以创建、结束和注释跨度。</p>
<p><strong>我应该如何在 Go 库中传播跟踪标头？</strong></p>
<p>​	你可以在<a href="../../StdLib/context#type-context">context.Context</a>中传播跟踪标识符和标记。目前业界还没有规范的跟踪键或跟踪头的常见表示形式。每个跟踪提供程序都负责在其 Go 库中提供传播实用程序。</p>
<p><strong>还有哪些来自标准库或运行时的低级事件可以包含在跟踪中？</strong></p>
<p>​	标准库和运行时正试图公开几个额外的API来通知低级别的内部事件。例如，<a href="https://go.dev/pkg/net/http/httptrace#ClientTrace" target="_blank" rel="noopener">httptrace.ClientTrace</a>提供了API来跟踪传出请求的生命周期中的低级别事件。目前正在努力从运行时执行跟踪器中检索低级别的运行时事件，并允许用户定义和记录他们的用户事件。</p>
<h2 id="debugging-调试">Debugging 调试</h2>
<p>​	调试是确定一个程序出现问题的原因的过程。调试器使我们能够了解一个程序的执行流程和当前状态。有几种调试方式；本节将只关注将调试器附加到程序和核心转储的调试。</p>
<p>​	Go用户大多使用以下调试器：</p>
<ul>
<li><a href="https://github.com/derekparker/delve" target="_blank" rel="noopener">Delve</a>：Delve是一个用于Go编程语言的调试器。它支持Go的运行时概念和内置类型。Delve正在努力成为一个功能齐全的可靠的Go程序调试器。</li>
<li><a href="https://go.dev/doc/gdb" target="_blank" rel="noopener">GDB</a>: Go通过标准Go编译器和Gccgo提供GDB支持。栈管理、线程和运行时所包含的方面与GDB所期望的执行模型有很大不同，以至于它们可能会混淆调试器，即使程序是用gccgo编译的。尽管GDB可以用来调试Go程序，但它并不理想，可能会造成混乱。</li>
</ul>
<p><strong>调试器与 Go 程序配合使用的情况如何？</strong></p>
<p>​	Go 的 <code>gc</code> 编译器执行一些优化，例如函数内联和变量寄存器化。这些优化有时会使得使用调试器进行调试更加困难。目前正在努力提高优化二进制文件生成的 DWARF 信息的质量。在这些改进可用之前，建议在构建要调试的代码时禁用优化。以下命令将使用没有编译器优化的方式构建一个包：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go build -gcflags<span style="color:#56b6c2">=</span><span style="color:#e06c75">all</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#34;-N -l&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	作为改进工作的一部分，Go 1.10 引入了一个新的编译器标志 <code>-dwarflocationlists</code>。该标志会导致编译器添加位置列表，从而帮助调试器与优化的二进制文件配合工作。以下命令将使用优化但包含 DWARF 位置列表的方式构建一个包：</p>
<div class="highlight"><div style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go build -gcflags<span style="color:#56b6c2">=</span><span style="color:#98c379">&#34;-dwarflocationlists=true&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>推荐的调试器用户界面是什么？</strong></p>
<p>​	尽管delve和gdb都提供了CLI，但大多数编辑器集成和IDE都提供了调试的特定用户界面。</p>
<p><strong>有可能用Go程序进行事后调试吗？</strong></p>
<p>​	核心转储文件是包含运行进程的内存转储和进程状态的文件。它主要用于程序的死后调试，并在程序仍在运行时了解其状态。这两种情况使得核心转储调试成为分析生产服务的良好诊断工具。可以从 Go 程序获取核心文件，并使用 delve 或 gdb 进行调试，请参阅<a href="https://go.dev/wiki/CoreDumpDebugging" target="_blank" rel="noopener">核心转储调试</a>页面以获取步骤指南。</p>
<h2 id="runtime-statistics-and-events-运行时统计和事件">Runtime statistics and events 运行时统计和事件</h2>
<p>​	运行时提供内部事件的统计和报告，供用户在运行时层面诊断性能和利用率问题。</p>
<p>​	用户可以监控这些统计信息，以更好地了解Go程序的整体健康状况和性能。一些经常被监控的统计信息和状态有：</p>
<ul>
<li><code>runtime.ReadMemStats</code>报告与堆分配和垃圾收集有关的指标。内存统计对于监控一个进程消耗了多少内存资源，进程是否能很好地利用内存，以及捕捉内存泄露都很有用。</li>
<li><code>debug.ReadGCStats</code> 读取有关垃圾收集的统计数据。它可以显示有多少资源花费在垃圾回收暂停上。它还会报告垃圾收集器暂停时间的时间线和百分位数。</li>
<li><code>debug.Stack</code> 返回当前的栈跟踪。栈跟踪对于查看当前有多少个goroutine在运行，它们在做什么，以及它们是否被阻塞是非常有用的。</li>
<li><code>debug.WriteHeapDump</code> 暂停所有goroutines的执行，允许你将堆转储到一个文件。堆转储是Go进程在某一特定时间的内存快照。它包含所有分配的对象以及goroutines、finalizers等。</li>
<li><code>runtime.NumGoroutine</code>返回当前goroutine的数量。该值可以被监控，以查看是否有足够的goroutine被利用，或者检测goroutine的泄漏。</li>
</ul>
<h3 id="execution-tracer-执行跟踪器">Execution tracer 执行跟踪器</h3>
<p>​	Go 自带的运行时执行跟踪器可以捕捉到大量的运行时事件。调度、系统调用、垃圾回收、堆大小和其他事件都由运行时收集，并可由go工具跟踪进行可视化。执行跟踪器是一个检测延迟和利用率问题的工具。您可以检查 CPU 的利用率以及网络或系统调用何时导致 goroutine 被抢占。</p>
<p>​	Tracer对以下方面很有用：</p>
<ul>
<li>了解你的goroutines是如何执行的。</li>
<li>了解一些核心的运行时事件，如GC运行。</li>
<li>识别不良的并行化执行。</li>
</ul>
<p>​	然而，它并不适合于识别热点，比如分析内存或CPU使用过量的原因。首先使用分析工具来代替，以解决这些问题。</p>
<p>


<img src="/docs/UsingAndUnderstandingGo/Diagnostics_img/tracer-lock.png"
     alt="img"
     
/>




</p>
<p>​	上面，go工具的跟踪可视化显示执行开始时很好，然后就变成了串行化。这表明可能存在对共享资源的锁争夺，造成了一个瓶颈。</p>
<p>​	参见<a href="https://go.dev/cmd/trace/" target="_blank" rel="noopener">go tool trace</a>跟踪，收集和分析运行时跟踪。</p>
<h3 id="godebug">GODEBUG</h3>
<p>​	如果<a href="https://go.dev/pkg/runtime/#hdr-Environment_Variables" target="_blank" rel="noopener">GODEBUG</a>环境变量被相应设置，运行时也会发出事件和信息。</p>
<ul>
<li>GODEBUG=gctrace=1 在每次收集时打印垃圾收集器事件，汇总收集的内存量和暂停的时间。</li>
<li>GODEBUG=inittrace=1 打印完成包初始化工作的执行时间和内存分配信息的摘要。</li>
<li>GODEBUG=schedtrace=X 打印每隔X毫秒的调度事件。</li>
</ul>
<p>​	GODEBUG环境变量可以用来禁止使用标准库和运行时中的指令集扩展。</p>
<ul>
<li>
<p>GODEBUG=cpu.all=off 禁止使用所有可选的指令集扩展。</p>
</li>
<li>
<p>GODEBUG=cpu.<code>extension</code>=off 禁止使用指定指令集扩展的指令。</p>
<p><code>extension</code>是指令集扩展的小写名称，如<code>sse41</code>或<code>avx</code>。</p>
</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 The Docsy Authors </small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
  <script src="/js/main.min.9069af235eb4d4956fc4dc29e5ca46caef0cdcae593856be4e33c99075bc5ea2.js" integrity="sha256-kGmvI1601JVvxNwp5cpGyu8M3K5ZOFa&#43;TjPJkHW8XqI=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>
<script src='/js/deal-zero-width-space.js'></script>
  </body>
</html>
